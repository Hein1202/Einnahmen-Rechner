<!DOCTYPE html>

<html lang="de">
<head><!--Fix F3: Removed visible annotation; PLZ remains default in Rubrik 2. No logic changed.--><style>
.sum-highlight {font-weight: bold;
  padding: 2px 4px;
  border-radius: 3px;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
.inline-status {margin-left:6px;font-style:italic; color:red;}
</style>
<style>
#detailedTable th, #detailedTable td {white-space: normal !important;
  word-break: break-word;
  text-align: center;
  padding: 6px 2px;
  font-size: 13px;
  min-width: 40px;
  max-width: 80px;}
#detailedTable table {width: 100%;
  table-layout: auto !important;}
#detailedTable {overflow-x: auto;
  width: 100%;
  max-width: 100vw;}
@media (max-width: 500px) {
  #detailedTable th, #detailedTable td {
    font-size: 11px;
    min-width: 36px;
    max-width: 60px;
    padding: 3px 1px;
  }
}
#detailedTable th {font-weight: bold; background: #f3e9d7;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<link href="https://fonts.googleapis.com/css2?family=VT323&amp;display=swap" rel="stylesheet"/>
<script>
window.monthWeightsA = {
  "01": 16.224, "02": 13.202, "03": 12.765, "04": 9.102,
  "05": 4.786, "06": 2.382, "07": 0.790, "08": 0.772,
  "09": 3.297, "10": 8.224, "11": 12.680, "12": 15.776
};

function clearWeightBasis(){
  document.querySelectorAll('input[name="weightBasis"]').forEach(r=> r.checked = false);
}
</script>
<style>
.hasPeriod2 #rubrik1Container #toggleWeightBtn {display: none !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
#rubrik2b {display: none;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>GasTrend Pro (Vers. 255.09.25)</title>
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- html2pdf.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
<style>
.example-group {display: none !important;}
body.code-unlocked .example-group {display: block !important;}
#resetCustomDate {margin-left: 0.5em;
    padding: 0.2em 0.4em;
    font-size: 1em;
    vertical-align: middle;
    cursor: pointer;
    background: transparent;
    border: none;}
#resetCustomDate:hover {color: #c00;}
.warning-custom {color: #c00;
    font-size: 0.9em;
    margin-top: 0.5em;
    display: none;}
button[onclick="printAsPDF()"] {font-size: 14px !important;
  padding: 8px 16px !important;}
#toggleCostCalcBtn {font-size: 14px !important;
  background-color: #f0f0f0 !important;
  color: #555 !important;
  border: 1px solid #ccc !important;
  box-shadow: none !important;
  padding: 6px 12px !important;}
*, *::before, *::after {box-sizing: border-box;}
body {background-color: #dcdcdc; margin: 0; padding: 0;}
#container {max-width: 500px; margin: 0 auto; padding: 20px; background-color: #fff;}
#zweiterZeitraum label[for="endDate2"] {margin-top: 2rem;
  display: block;}
#rubrik1Container label[for="endDate"] {margin-top:  2rem;}
#rubrik1Container {padding-bottom: 64px;}
.rubrik1-columns {display: flex; gap: 20px;}
.rubrik1-column, .input-left, .input-right {flex: 1;}
.rubrik1-column h3 {margin-bottom: 10px;}
.vertical-input-group {margin-bottom: 15px;}
.vertical-input-group label {display: block; margin-bottom: 5px; font-weight: bold;}
#zweiterZeitraum {margin-top: 20px; padding: 15px; border: 2px solid #333; border-radius: 5px; background-color: antiquewhite; display: none;}
input[type="text"], input[type="number"], input[type="date"], select {font-size: 15px;
      font-weight: bold;
      width: 100%;
      max-width: 150px;
      padding: 5px;
      border: 2px solid #000;
      background: #eee;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
      text-align: center;
      transition: border-color 0.3s, box-shadow 0.3s, background 0.3s;}
input[type="text"]:hover, input[type="number"]:hover, input[type="date"]:hover {background: #f7f7f7;}
input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus {background: #fff;
      border-color: #007BFF;
      box-shadow: 0 0 8px rgba(0,123,255,0.5);}
.errorMessage, .dateError, .warningMessage {color: red;
      font-size: 0.9em;
      margin-top: 5px;
      display: block;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;}
.errorMessage.visible, .dateError.visible, .warningMessage.visible {opacity: 1;}
button {font-size: 20px;
      padding: 15px 30px;
      margin: 10px 5px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      box-shadow: 0 5px 10px rgba(0,0,0,0.1);}
button:hover {background-color: #0056b3;}
button.rechenweg {font-size: 12px;
      padding: 5px 10px;
      background-color: #f0f0f0;
      color: #333;
      border: 1px solid #ccc;
      border-radius: 3px;
      box-shadow: none;}
button.rechenweg:hover {background-color: #e0e0e0;}
button.resetBtn {font-size: 12px;
      padding: 5px 10px;
      background-color: #f9f9f9;
      color: #555;
      border: 1px solid #ccc;
      border-radius: 3px;
      box-shadow: none;}
button.resetBtn:hover {background-color: #e9e9e9;}
.result {font-weight: bold; margin: 10px 0;}
.explanation {display: none; margin-top: 10px; font-style: italic; color: #333;}
.m3-conversion-item {margin-bottom: 20px;}
.kwh-calculation, .bordered-section {border: 2px solid #333;
      padding: 15px;
      margin-top: 20px;
      border-radius: 5px;
      background-color: antiquewhite;
      position: relative;}
.kwh-calculation {border-color: #007BFF;}
.section-number {position: absolute;
      top: 5px;
      right: 10px;
      font-size: 16px;
      font-weight: bold;
      color: #FF5733;}
.weight-sum {text-align: left;}
.day-input {display: none; margin-left: 10px;}
.highlighted {font-weight: bold; font-size: 16px; color: black;}
.input-group {display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-bottom: 15px;}
.aligned-inputs label {display: block; margin-bottom: 5px;}
.input-row {display: flex; flex-direction: row; gap: 20px; width: 100%;}
.info-icon {display: inline-block;
      font-size: 12px;
      color: #007BFF;
      margin-left: 5px;
      cursor: pointer;
      border: 1px solid #007BFF;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      text-align: center;
      line-height: 14px;}
.info-text {display: none;
      font-size: 0.9em;
      font-style: italic;
      color: #555;
      margin-top: 5px;
      border: 1px solid #ccc;
      padding: 5px;
      border-radius: 3px;
      background-color: #f9f9f9;
      text-align: center;}
#zaehlerstandInfo {display: none;
      font-size: 0.9em;
      font-style: italic;
      color: #555;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      padding: 5px;
      border-radius: 3px;
      background-color: #f9f9f9;
      text-align: center;}
#rubrik7 {border: 2px solid #FF5733;
      padding: 15px;
      background-color: antiquewhite;
      position: relative;
      display: block;
      text-align: left;}
.cost-columns {display: flex; flex-wrap: nowrap; gap: 10px; width: 100%;}
.cost-column-left, .cost-column-right {flex: 1 1 45%;}
.cost-column-left input, .cost-column-right input {width: 100%; max-width: 100%;}
.cost-column-left select, .cost-column-right select {width: 100%; max-width: 150px; font-size: 15px; font-weight: bold;}
.cost-column-left input[type="date"], .cost-column-right input[type="date"], #kwhAmount, #workPrice, #costResult, #kwhAmountManual, #workPriceManual, #costResultManual, #monthsCount, #basePrice, #installmentResult, #monthsCountManual, #basePriceManual, #installmentResultManual {max-width: 150px;}
.input-group label.klein {font-size: 0.8em;}
@media screen and (max-width: 600px) {
    
    #kwhAmount,
    #workPrice,
    #basePrice,
    #monthsCount,
    #kwhAmountManual,
    #workPriceManual,
    #basePriceManual,
    #monthsCountManual {
      width: 150px !important;
      max-width: 150px !important;
    }

    
    #kwhAmount,
    #workPrice,
    #basePrice,
    #monthsCount {
      width: 150px !important;
      max-width: 150px !important;
    }

      h2 { font-size: 1em; }
      .input-group input[type="number"],
      .input-group input[type="text"],
      input[type="date"],
      .cost-column-left select, .cost-column-right select { width: 90px; }
      .input-group label { font-size: 0.8em; }
    }
#showStandardTableBtn {display: block;
      font-size: 12px;
      padding: 5px 10px;
      margin: 10px 0;
      cursor: pointer;
      border: 1px solid #333;
      border-radius: 3px;
      background-color: #333;
      color: #fff;}
#originalWeights {position: absolute;
      top: 5px;
      right: 10px;
      width: 200px;
      background-color: antiquewhite;
      text-align: right;
      padding: 5px;
      border-left: 1px solid #aaa;
      z-index: 1000;
      display: none;}
#rubrik2 h2, .bordered-section h2 {font-size: 1.2em;}
#toggleWeightBtn {font-size: 14px;
      padding: 5px 10px;
      position: absolute;
      bottom: 10px;
      left: 10px;
      background-color: #e0e0e0;
      color: #333;
      border: 1px solid #ccc;
      box-shadow: none;}
#factor-container {margin-left: 90px;}
.highlight-or {font-weight: bold; color: #007BFF; margin-right: 5px;}
#zustandszahl {position: relative; left: -20px;}
#chartContainer {width: 100%;
      height: 200px;
      display: block;}
.month-block {margin-bottom: 15px;}
.dropdowns {margin: 5px 0;}
.dropdowns label {font-size: 0.9em;
      font-weight: normal;
      margin-top: 5px;}
#rubrik7 .cost-column-left input#fromMonth, #rubrik7 .cost-column-left input#toMonth {max-width: 150px;
  width: auto;}
#rubrik2 ul#monthWeightList .year-heading {list-style: none !important; margin-top: 0.5em; font-size: 1.1em; color: #007BFF;}
#rubrik3 .year-heading {margin-top: 0.5em; font-weight: bold; color: #FF5733;}
.bordered-section h1 {font-size: 1.4em;}
.bordered-section h3 {font-size: 1em;}
.section-number {font-size: 0.9em;}
@media (max-width: 600px) and (orientation: landscape) {
    .cost-columns {
      display: flex;
      flex-wrap: wrap;
    }
    .cost-column-left {
      order: 1;
      flex: 1 1 100%;
      max-width: 100%;
    }
    .cost-column-right {
      order: 2;
      flex: 1 1 100%;
      max-width: 100%;
    }
    .cost-column-left input, .cost-column-right input,
    .cost-column-left select, .cost-column-right select {
      width: 100%;
      max-width: none;
    }
  }
.cost-column-left, .cost-column-right {flex: 1 1 100%;
      max-width: 100%;}
.cost-column-left input, .cost-column-right input, .cost-column-left select, .cost-column-right select {width: 100%;
      max-width: none;}
}


    
    .cost-column-left input, .cost-column-right input, .cost-column-left select, .cost-column-right select {width: 150px !important;
      max-width: 150px !important;}
.cost-header-left p, .cost-header-right p {min-height: 2.4em;}
.cost-column-left .input-group label, .cost-column-right .input-group label {min-height: 1.6em;}
.cost-column-right .input-group:nth-of-type(4), .cost-column-right .input-group:nth-of-type(5) {margin-top: 1.6em;}
select:hover {background: #f7f7f7;}
select:focus {background: #fff;
  border-color: #007BFF;
  box-shadow: 0 0 8px rgba(0,123,255,0.5);
  outline: none;}
#m3ForecastExplanation span.result {font-weight: bold;
    color: #d32f2f;
    background-color: #fff3b0;
    padding: 1px 4px;
    border-radius: 3px;}
#m3ForecastExplanation span.result, #m3ForecastExplanation2 span.result {font-weight: bold !important;
  color: #d32f2f;
  background-color: #fff3b0;
  padding: 1px 4px;
  border-radius: 2px;}
#m3ForecastExplanation .result {font-weight: bold !important;
    color: inherit !important;
    background: none !important;}
.date1-wrapper button#example1, .date1-wrapper button#example2 {margin-top: 5px;
  font-size: 12px;
  padding: 5px 10px;}
#rubrik2 select#weightTableSelect {font-size: 12px !important;
  padding: 4px !important;}
#rubrik1Container .button-container button {padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    background-color: transparent;
    border: 1px solid #999;
    border-radius: 0.25rem;
    color: inherit;}
#rubrik1Container .button-container button:hover {background-color: rgba(0,0,0,0.05);}
#rubrik1Container .button-container {margin-top: 2rem !important;
    margin-bottom: 2rem !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
.cost-column-left input#costResult, .cost-column-right input#costResultManual, .cost-column-left input#installmentResult, .cost-column-right input#installmentResultManual {width: 150px !important;
  max-width: 150px !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
.cost-column-left select, .cost-column-right select {width: 150px !important;
  max-width: 150px !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
@media (max-width: 576px) {
  
  label[for="monthsCountManual"],
  #monthsCountManual {
    display: inline-block !important;
    vertical-align: middle !important;
    margin: 0 !important;
  }
}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
@media (max-width: 600px) {
  .cost-column-right label[for="monthsCountManual"],
  .cost-column-right input#monthsCountManual {
    margin-top: -0.5rem !important;
  }
}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
.day-input input[type=number] {width: 50px !important;
      max-width: 50px !important;
      padding: 4px !important;
      font-size: 16px !important;
      -moz-appearance: textfield !important;}
.day-input input[type=number]::-webkit-outer-spin-button, .day-input input[type=number]::-webkit-inner-spin-button {-webkit-appearance: none !important;
      margin: 0 !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
#rubrik1Container .button-container {margin-top:  2rem;
    display: flex;
    flex-direction: row;
    gap: 0.5rem;
    align-items: flex-start;
    margin-top:  2rem;
  
    margin-bottom: 2rem;}
@media (max-width: 600px) {
    #rubrik1Container .button-container {
    margin-top:  2rem;
      flex-direction: column;
      width: 100%;
    
    margin-bottom: 2rem;
  }
    #rubrik1Container .date-inputs {
      display: block;
    }
  }
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
#rubrik1Container .button-container {margin-top:  2rem;
    display: flex;
    flex-direction: row;
    gap: 0.5rem;
    align-items: flex-start;
    margin-top:  2rem;
  
    margin-bottom: 2rem;}
#rubrik1Container .button-container button {display: block;
    margin: 0;}
@media (max-width: 600px) {
    #rubrik1Container .button-container {
    margin-top:  2rem;
      flex-direction: column;
      width: 100%;
    
    margin-bottom: 2rem;
  }
    #rubrik1Container .date-inputs {
      display: block;
    }
  }
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
.example-group {display: inline-block; text-align: center; margin-right: 1em;}
.example-description {margin: 0.25em 0; font-size: 0.9em;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
#rubrik7 .cost-column-right .input-group:nth-of-type(4) label {position: relative;
  top: -0.6em;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
#rubrik7 .cost-column-right .input-group:nth-of-type(4), #rubrik7 .cost-column-right .input-group:nth-of-type(5) {margin-top: 0 !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
button.rechenweg {display: none !important;}
body.code-unlocked button.rechenweg {display: inline-block !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<script>
// Schalte Rechenweg-Buttons frei bei Eingabe des Codes 1202
document.addEventListener('DOMContentLoaded', function() {
  var codeInput = document.getElementById('secretCodeInput');
  if (!codeInput) return;
  codeInput.addEventListener('input', function() {
    if (this.value === '1202') {
      document.body.classList.add('code-unlocked');
    } else {
      document.body.classList.remove('code-unlocked');
    }
  });
});
</script>
<style>
#secretCodeInput {width: 30px !important;
  border: none !important;
  background: transparent !important;
  opacity: 0.2 !important;
  font-size: 0.75em !important;}
#secretCodeInput:focus {opacity: 1 !important;
  outline: none !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
#toggleCustomDateExp {display: inline-block !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
#toggleCustomDateExp {display: none !important;}
body.code-unlocked #toggleCustomDateExp {display: inline-block !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
#detailedTable {overflow-x: auto;
    max-width: 100%;}
#detailedTable table {width: 100%;
    border-collapse: collapse;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
.selected-row {background-color: #def;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
#rubrik3, #rubrik4, #rubrik5, #rubrik6, #rubrik7 {display: none;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
.cost-column-left input, .cost-column-right input, .cost-column-left select, .cost-column-right select {width: 150px !important;
  max-width: 150px !important;
  font-size: 14px;
  padding: 5px;
  box-sizing: border-box;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
#monthsCount, #monthsCountManual {width: 150px !important;
  max-width: 150px !important;
  font-size: 14px;
  padding: 5px;
  box-sizing: border-box;
  height: 30px;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
#rubrik7 .cost-column-right .input-group:nth-of-type(4) label {position: static !important;
  top: auto !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
#monthsCount, #monthsCountManual {padding-top: 6px !important;
  padding-bottom: 6px !important;
  line-height: 1.2 !important;
  height: 32px !important;
  vertical-align: middle !important;}
#rubrik7 .cost-column-left .input-group label, #rubrik7 .cost-column-right .input-group label {line-height: 1.2 !important;
  vertical-align: middle !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
#monthsCount, #monthsCountManual {height: 36px !important;
  padding: 6px 10px !important;
  font-size: 16px !important;
  line-height: 1.2 !important;
  margin-top: 0 !important;
  vertical-align: middle !important;}
#rubrik7 .input-group label {display: inline-block;
  margin-bottom: 6px !important;
  font-size: 15px;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
#rubrik7 .input-group {display: flex;
  flex-direction: column;
  justify-content: flex-start;}
#monthsCount, #monthsCountManual {height: 34px !important;
  padding: 6px 10px !important;
  font-size: 16px;
  margin: 0 !important;
  box-sizing: border-box;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
#rubrik7 .cost-column-right .input-group:nth-of-type(4), #rubrik7 .cost-column-right .input-group:nth-of-type(5) {margin-top: 0 !important;}
#rubrik7 .input-group {margin-bottom: 10px;}
#monthsCount, #monthsCountManual {height: 34px;
  padding: 6px 10px;
  font-size: 16px;
  margin: 0;
  box-sizing: border-box;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
#rubrik7 .cost-column-right .input-group:nth-of-type(4), #rubrik7 .cost-column-right .input-group:nth-of-type(5), #rubrik7 .cost-column-left .input-group:nth-of-type(4), #rubrik7 .cost-column-left .input-group:nth-of-type(5) {margin-top: 0 !important;}
#rubrik7 .cost-column-left .input-group, #rubrik7 .cost-column-right .input-group {margin-bottom: 10px !important;}
#monthsCount, #monthsCountManual, #installmentResult, #installmentResultManual {height: 34px !important;
  padding: 6px 10px !important;
  font-size: 16px;
  margin: 0 !important;
  box-sizing: border-box;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<!-- Gaszähler-Display Styles -->
<style>
.gas-meter-input {font-family: 'VT323', monospace;
      font-size: 20px !important;
      color: #000 !important;
      background: #000;
      border: 4px inset #333;
      border-radius: 8px;
      width: 200px;
      padding: 0.2em 0.5em;
      text-align: center;
      letter-spacing: 0.1em;
      box-shadow: 0 0 10px rgba(0,255,0,0.5);}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
#tbl, #detailedTable table {width: 100% !important;
    table-layout: fixed !important;}
#tbl th, #tbl td, #detailedTable th, #detailedTable td {overflow-wrap: break-word;
    word-wrap: break-word;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
#tbl td, #tbl th, #detailedTable td, #detailedTable th {white-space: nowrap !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
ul {list-style: none !important;
    margin: 0;
    padding-left: 0;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
ul, li {list-style: none !important;
    margin: 0 !important;
    padding: 0 !important;}
li::marker {content: none !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
#m3ForecastExplanation > strong {display: block;
  margin-bottom: 1em;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
#m3ForecastExplanation .sum-highlight {font-weight: normal !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
.period1-frame, .period2-frame {border: 2px solid #888;
  padding: 0.5em;
  margin-bottom: 1em;
  border-radius: 4px;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
.weight-frame {border: 2px solid #666;
    padding: 0.5em;
    margin-bottom: 1em;
    border-radius: 4px;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
#rubrik3 .weight-frame {border: none !important;
  padding: 0 !important;
  margin: 0 !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
#rubrik3 .weight-frame {border: none !important;
  padding: 0 !important;
  margin: 0 !important;}
#rubrik3 .period1-frame, #rubrik3 .period2-frame {border: 2px solid #888 !important;
  padding: 0.5em !important;
  margin-bottom: 1em !important;
  border-radius: 4px !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
#rubrik3 .weight-frame {border: none !important;
  padding: 0 !important;
  margin: 0 !important;}
#rubrik3 .period1-frame, #rubrik3 .period2-frame {border: 2px solid #888 !important;
  padding: 0.5em !important;
  margin-bottom: 1em !important;
  border-radius: 4px !important;
  display: block !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<style>
@keyframes pulse{
  0%,100%{opacity:1;transform:scale(1);}
  50%   {opacity:.6;transform:scale(1.03);}
}
#mainDataHint {animation:pulse 1.8s ease-in-out infinite;}
#mainDataHint.stop {animation:none;
  opacity:0;
  transition:opacity .4s;}
@media (prefers-reduced-motion: reduce){
  #mainDataHint{animation:none!important}
}
</style>
<style>
#rubrik2 .rub2b-fixed-btn {position: absolute; right: 8px; bottom: 8px; z-index: 9999; pointer-events: auto;}
#rubrik2 #toggleRubrik2bBtn {font-size:10px; padding:2px 6px; opacity:0.8;}
</style>
<style>
#rubrik2 .weight-btn-row {display: flex;
  gap: 8px;
  margin-bottom: 10px;
  flex-wrap: wrap;}
#rubrik2 .weight-btn-row > button {flex: 1 1 33%;
  min-width: 161px;}
@media (max-width: 600px) {
  #rubrik2 label[for="weightTableSelect"] {
    display: block;
    margin-bottom: 6px;
  }
  #rubrik2 select#weightTableSelect {
    width: 100% !important;
    max-width: 100% !important;
  }
  #rubrik2 .weight-btn-row {
    flex-direction: column;
  }
  #rubrik2 .weight-btn-row > button {
    width: 100%;
    min-width: 0;
    font-size: 14px;
    padding: 10px;
  }
}
</style>
<style>
@media (min-width: 601px) and (max-width: 900px) {
  #rubrik2 .weight-btn-row { justify-content: space-between; }
  #rubrik2 .weight-btn-row > button {
    flex: 0 1 calc(50% - 8px);
    max-width: calc(50% - 8px);
  }
  
  #rubrik2 .weight-btn-row > button:last-child {
    margin-left: auto;
    margin-right: auto;
  }
}
</style>
<style id="fix-weights-sidepanel-css">
#originalWeights {position:absolute; top:5px; right:10px; width:260px; max-height:80vh;
  overflow:auto; background:antiquewhite; border-left:1px solid #aaa;
  padding:8px 10px; z-index:1000; display:none; box-shadow:0 2px 10px rgba(0,0,0,.15);}
body.weights-panel-open #container {margin-right:280px;}
@media (max-width:700px){
  #originalWeights{ position:static; width:100%; max-height:none; box-shadow:none; }
  body.weights-panel-open #container{ margin-right:0; }
}
</style>
<style id="fix-weights-sidepanel-css-v2">
#originalWeights h4 {font-weight:bold;}
</style>
<script id="panel-renderer-static">
(function(){
  // Simple, reliable renderer that does not depend on other scripts
  window.showWeightsPanel = function(weights, title){
    var panel = document.getElementById('originalWeights');
    if(!panel){
      panel = document.createElement('div');
      panel.id = 'originalWeights';
      document.body.prepend(panel);
    }
    // Basic styles if not present
    panel.style.position = 'absolute';
    panel.style.top = '5px';
    panel.style.right = '10px';
    panel.style.width = '260px';
    panel.style.maxHeight = '80vh';
    panel.style.overflow = 'auto';
    panel.style.background = 'antiquewhite';
    panel.style.borderLeft = '1px solid #aaa';
    panel.style.padding = '8px 10px';
    panel.style.zIndex = '1000';
    panel.style.display = 'block';

    var months = ["01","02","03","04","05","06","07","08","09","10","11","12"];
    function fmt(v){
      if(typeof v === 'number') return v.toLocaleString('de-DE', {minimumFractionDigits:3, maximumFractionDigits:3});
      if(typeof v === 'string'){
        var n = parseFloat(v.replace(/\./g,'').replace(',','.'));
        if(!isNaN(n)) return n.toLocaleString('de-DE', {minimumFractionDigits:3, maximumFractionDigits:3});
      }
      return (v==null?'':String(v));
    }
    var rows = months.map(function(m){
      var v = weights ? weights[m] : '';
      return '<div style="display:flex;justify-content:space-between;padding:2px 0;"><span>'+m+'</span><strong>'+fmt(v)+'</strong></div>';
    }).join('');

    panel.innerHTML = [
      '<div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;margin-bottom:.5rem;">',
        '<h4 style="margin:0;">'+(title||'Monatsgewichte')+'</h4>',
        '<button type="button" id="closeWeightsPanel" style="border:1px solid #999;background:#f5f5f5;padding:2px 6px;cursor:pointer;">×</button>',
      '</div>',
      rows,
      '<hr><small style="opacity:.7;">Statische Monatsgewichte</small>'
    ].join('');

    var closeBtn = document.getElementById('closeWeightsPanel');
    if(closeBtn){
      closeBtn.onclick = function(){
        panel.style.display = 'none';
        document.body.classList.remove('weights-panel-open');
      };
    }
    document.body.classList.add('weights-panel-open');
  };
})();
</script>
<script id="static-monthWeightsB">
window.monthWeightsB = {
  "01": 20.231, "02": 12.340, "03": 11.944, "04": 8.086,
  "05": 1.525,  "06": 1.475,  "07": 1.525,  "08": 1.525,
  "09": 1.475,  "10": 7.025,  "11": 14.697, "12": 18.152
};
</script>
<style id="summer-warning-css-override">
body.second-period-ready #summerWarning {display: none !important;}
</style>
<style id="toggle-rubrik1b-css">
#toggleRubrik1bBtn {display: inline-block;
  margin-top: 10px;
  padding: 5px 10px;
  background-color: #e0e0e0;
  color: #000;
  border: 1px solid #bbb;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9em;}
#toggleRubrik1bBtn:hover {background-color: #c8c8c8;}
</style>
<style id="fix-toggle-rubrik1b">
#toggleRubrik1bBtn { display: none !important; }
body.summeronly #toggleRubrik1bBtn { display: inline-block !important; }
</style>
<style id="fix-secondperiod-open">
body.secondperiod-open #zweiterZeitraum { display: block !important; }
</style>
<style id="fx-rubrik1b-flash-css-v2">
#zweiterZeitraum { position: relative; }
#zweiterZeitraum.fx-flash {
  animation: rubrik1bFlash 900ms ease-out;
}
@keyframes rubrik1bFlash {
  0%   { box-shadow: inset 0 0 0 3px #ffd54f, 0 0 12px rgba(255,195,7,0.8); background-color: #fff3cd; }
  40%  { box-shadow: inset 0 0 0 2px #ffe082, 0 0 8px rgba(255,193,7,0.5); background-color: #fff8e1; }
  100% { box-shadow: none; background-color: transparent; }
}
</style>
<style id="rubrik5-yearheadings-css">
#rubrik5 #m3ConversionList .year-heading{
  margin: 8px 0 4px;
  padding-top: 6px;
  font-weight: 700;
  border-top: 1px dashed #bbb;
  color: #333;
}
</style>
<style id="rubrik5-monthstyle-css">
#rubrik5 #m3ConversionList li strong {
  font-weight: 700;            /* deutlich fetter für Monatsnamen */
}
#rubrik5 #m3ConversionList li .reading-strong {
  font-weight: 600;            /* Zählerstands-Zahl leicht fetter */
}
#rubrik5 #m3ConversionList li {
  font-size: 1.08em;           /* etwas größer als zuvor */
}
</style>
<style id="rubrik1b-inline-hint-css">
#rubrik1b-inline-hint {
  display: block;
  font-size: 0.9em;
  color: #555;
  margin-top: 6px;
  font-style: italic;
}
</style>
<style id="rubrik1-verbrauch-hinweis-css">
#rubrik1Container .verbrauch-hinweis {
  display: block;
  font-size: 0.9em;
  color: #555;
  margin-top: 6px;
  font-style: italic;
  border: 1px solid #ddd;
  background: #f9f9f9;
  padding: 6px 8px;
  border-radius: 3px;
}
</style>
<style id="rb1-inline-info-css">
#rubrik1Container .rb1-inline-wrap{
  position: relative;
  display: inline-block;
  margin-left: 6px;
  vertical-align: middle;
}
#rubrik1Container .rb1-inline-info{
  cursor:pointer;
  user-select:none;
  font-size: 0.95em;
  line-height:1;
  color:#444;
  display:inline-block;
}
#rubrik1Container .rb1-inline-info:focus{ outline: 2px solid #bbb; outline-offset:2px; border-radius: 3px; }
#rubrik1Container .rb1-info-popover{
  position:absolute;
  top: -2px;          /* leicht oberhalb ausrichten */
  left: 22px;         /* direkt rechts neben dem Icon */
  max-width: 360px;
  padding:8px 10px;
  background:#f6f6f6;
  border:1px solid #ddd;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  border-radius:6px;
  font-size:0.92em;
  color:#333;
  z-index: 100;
  display:none;
}
#rubrik1Container .rb1-info-popover.show{ display:block; }
</style>
<style id="rb1b-inline-info-css">
#rubrik1b, #rubrik1bContainer, #zweiterZeitraum, #rubrik1b-container { position: relative; }
#rubrik1b .rb1b-inline-wrap,
#rubrik1bContainer .rb1b-inline-wrap,
#zweiterZeitraum .rb1b-inline-wrap,
#rubrik1b-container .rb1b-inline-wrap{
  position: relative;
  display: inline-block;
  margin-left: 6px;
  vertical-align: middle;
}
#rubrik1b .rb1b-inline-info,
#rubrik1bContainer .rb1b-inline-info,
#zweiterZeitraum .rb1b-inline-info,
#rubrik1b-container .rb1b-inline-info{
  cursor:pointer;
  user-select:none;
  font-size: 0.95em;
  line-height:1;
  color:#444;
  display:inline-block;
}
#rubrik1b .rb1b-inline-info:focus,
#rubrik1bContainer .rb1b-inline-info:focus,
#zweiterZeitraum .rb1b-inline-info:focus,
#rubrik1b-container .rb1b-inline-info:focus{ outline: 2px solid #bbb; outline-offset:2px; border-radius: 3px; }
#rubrik1b .rb1b-info-popover,
#rubrik1bContainer .rb1b-info-popover,
#zweiterZeitraum .rb1b-info-popover,
#rubrik1b-container .rb1b-info-popover{
  position:absolute;
  top: -2px;
  left: 22px;
  max-width: 360px;
  padding:8px 10px;
  background:#f6f6f6;
  border:1px solid #ddd;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  border-radius:6px;
  font-size:0.92em;
  color:#333;
  z-index: 100;
  display:none;
}
#rubrik1b .rb1b-info-popover.show,
#rubrik1bContainer .rb1b-info-popover.show,
#zweiterZeitraum .rb1b-info-popover.show,
#rubrik1b-container .rb1b-info-popover.show{ display:block; }
</style>
<style>#zweiterZeitraum #rubrik1b-inline-hint{display:none!important}</style>
<style id="infoicons-scoped">
/* Nur Optik der Info-Icons ändern – ohne andere Styles zu berühren */
#rubrik1Container .rb1-inline-wrap .rb1-inline-info,
#rubrik1b .rb1b-inline-wrap .rb1b-inline-info,
#rubrik1b .rb1b-inline-wrap .rb1b-inline-info-top {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background-color: #007BFF;
  color: #fff;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  margin-left: 6px;
  line-height: 1;
  text-align: center;
  vertical-align: middle;
  transition: background-color 0.3s, transform 0.2s;
}
#rubrik1Container .rb1-inline-wrap .rb1-inline-info:hover,
#rubrik1b .rb1b-inline-wrap .rb1b-inline-info:hover,
#rubrik1b .rb1b-inline-wrap .rb1b-inline-info-top:hover {
  background-color: #0056b3;
  transform: scale(1.1);
}
</style>
<style id="infoicons-rubrik1b-top">
/* Rubrik 1b (Zweiter Zeitraum): oberes Info-Icon (class="info-icon") im gleichen Stil wie Rubrik 1 */
#zweiterZeitraum .info-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background-color: #007BFF;
  color: #fff;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  margin-left: 6px;
  line-height: 1;
  text-align: center;
  vertical-align: middle;
  transition: background-color 0.3s, transform 0.2s;
}
#zweiterZeitraum .info-icon:hover {
  background-color: #0056b3;
  transform: scale(1.1);
}
</style>
<style id="infoicons-rubrik1b-field">
/* Rubrik 1b: Info-Icon neben "Gaszählerstand Datum 1" angleichen */
#zweiterZeitraum .rb1b-inline-info,
#rubrik1b .rb1b-inline-info,
#rubrik1bContainer .rb1b-inline-info,
#rubrik1b-container .rb1b-inline-info {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background-color: #007BFF;
  color: #fff;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  margin-left: 6px;
  line-height: 1;
  text-align: center;
  vertical-align: middle;
  transition: background-color 0.3s, transform 0.2s;
}
#zweiterZeitraum .rb1b-inline-info:hover,
#rubrik1b .rb1b-inline-info:hover,
#rubrik1bContainer .rb1b-inline-info:hover,
#rubrik1b-container .rb1b-inline-info:hover {
  background-color: #0056b3;
  transform: scale(1.1);
}
</style>
<style id="infoicons-unify-look">
/* Gleicher Look für beide Icons in Rubrik 1b (oben + neben Feld) */
#zweiterZeitraum .info-icon,
#zweiterZeitraum .rb1b-inline-info {
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  width: 18px !important;
  height: 18px !important;
  border-radius: 50% !important;
  background-color: #007BFF !important;
  color: #fff !important;
  font-size: 14px !important;
  font-weight: bold !important;
  line-height: 1 !important;
  margin-left: 6px !important;
  text-align: center !important;
  vertical-align: middle !important;
  border: none !important;
  box-shadow: none !important;
  padding: 0 !important;
}
#zweiterZeitraum .info-icon:hover,
#zweiterZeitraum .rb1b-inline-info:hover {
  background-color: #0056b3 !important;
  transform: scale(1.1);
}
</style>
<style id="infoicons-rubrik4-scoped">
/* Rubrik 4: Info-Icons als blauer Kreis mit weißem "i" (wie Rubrik 1/1b) */
#rubrik4 .info-icon,
#rubrik4 .rb4-inline-info {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background-color: #007BFF;
  color: #fff;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  margin-left: 6px;
  line-height: 1;
  text-align: center;
  vertical-align: middle;
  transition: background-color 0.3s, transform 0.2s;
}
#rubrik4 .info-icon:hover,
#rubrik4 .rb4-inline-info:hover {
  background-color: #0056b3;
  transform: scale(1.1);
}
</style>
<style id="hide-inline-dwd">
/* Verhindert die doppelte Anzeige: Inline-Darstellung der Tabelle DWD ausblenden */
#originalWeightsB { display: none !important; }
</style>
<style>
.rechenweg-box { border: 1px solid #ccc; border-radius: 6px; padding: 8px 12px; margin-top: 8px; }
.rechenweg-box p {
  margin: 4px 0;
}
</style>

<style id="fix-plz-info-css">
#rb1PLZInfoPopover {
  font-weight: normal !important;
}
</style>


<style id="fix-a-info-css">
#rb1TableAInfoPopover {
  font-weight: normal !important;
  font-size: 0.9em !important;
  font-style: italic !important;
}
</style>


<style id="inline-status-css-fix">
#rubrik1Container .inline-status{
  display: inline-block;
  margin-left: 6px;
  vertical-align: middle;
}
</style>


<style id="hide-after-rubrik7-guard">
/* Hide any accidental siblings after Rubrik 7 inside the main container */
#container > #rubrik7 ~ * { display: none !important; }
</style>


<style id="rubrik5-monthcalc-css">
#rubrik5.show-monthcalc #m3ConversionList .explanation,
#rubrik5.show-monthcalc #m3ConversionList .calc,
#rubrik5.show-monthcalc #m3ConversionList .formel { display: block !important; }
#rubrik5 #m3ConversionList .explanation,
#rubrik5 #m3ConversionList .calc,
#rubrik5 #m3ConversionList .formel { display: none !important; }
</style>
<style id="rubrik5-monthcalc-css-strong">
#rubrik5.show-monthcalc #m3ConversionList .explanation { display: block !important; }
#rubrik5 #m3ConversionList .explanation { display: none !important; }
</style>

</head>
<!-- Helper functions for saving/restoring Rubrik 6 state -->
<script>
    function saveRubrik6State() {
      return Array.from(document.querySelectorAll('#monthSelectionList input[type="checkbox"]')).map(cb => ({
        month: cb.value,
        checked: cb.checked,
        day: document.getElementById(`day-${cb.value}`).value
      }));
    }
    function restoreRubrik6State(saved) {
      if (!saved) return;
      saved.forEach(({month, checked, day}) => {
        const cb = document.querySelector(`#monthSelectionList input[value="${month}"]`);
        if (cb) {
          cb.checked = checked;
          const dayInput = document.getElementById(`day-${month}`);
          if (dayInput) dayInput.value = day;
        }
      });
      toggleDayInputs();
      processSelectedMonths();
    }
  </script>
<body>
<div id="container">
<!-- Rubrik 1: Hauptzeitraum -->
<div class="bordered-section" id="rubrik1Container">
<span class="section-number">1</span>
<input id="secretCodeInput" type="text"/>
<h1>GasTrend Pro <span class="version" style="font-weight: normal; font-size: 0.6em; opacity: 0.6;">© 267.11.25</span></h1>
<div style="margin: 10px 0;">
  <button type="button" onclick="window.print()">Drucken: Gesamtbericht</button>
</div>
<p id="mainDataHint">Bitte geben Sie die Daten für den Hauptzeitraum ein:</p>
<div class="button-container">
<div class="example-group">
<button id="example1" type="button">Beispiel 1</button>
<p class="example-description">Ein Zeitraum</p>
</div>
<div class="example-group">
<button id="example2" type="button">Beispiel 2</button>
<p class="example-description">Zwei Zeiträume</p>
</div>
</div>
<div class="rubrik1-columns">
<div class="rubrik1-column">
<h3 id="zeitraum1Heading" style="display: none;">Zeitraum 1</h3>
<div class="vertical-input-group">
<label for="startDate">Ablesedatum (Start):</label>
<div class="date1-wrapper"><input class="dateInput" id="startDate" onblur="validateDateInput('startDate','startDateError'); calculate();" oninput="validateDateInput('startDate','startDateError'); calculate();" pattern="\d{2}\.\d{2}\.\d{4}" placeholder="TT.MM.JJJJ" required="" type="text"/>
</div>
<span class="errorMessage" id="startDateError"></span>
</div>
<div class="vertical-input-group">
<label for="startMeter">Gaszählerstand (Start, in m³):</label>
<input class="gas-meter-input" id="startMeter" onblur="calculate();" oninput="calculate();" required="" step="0.001" type="number"/>
<span class="rb1-inline-wrap">
<span class="rb1-inline-info" id="rb1InfoBtn" tabindex="0" title="Hinweis zum Verbrauchsmodus anzeigen">ⓘ</span>
<div aria-hidden="true" class="rb1-info-popover" id="rb1InfoPopover" role="tooltip">
<strong>Hinweis:</strong> Wenn keine Zählerstände vorliegen, können Sie alternativ den Gesamtverbrauch
    <em>(z. B. aus der Rechnung)</em> eingeben.<br/>
    Start = <strong>0</strong>, Ende = <strong>Verbrauch laut Abrechnung</strong>.
  </div>
</span>
</div>
<div class="vertical-input-group">
<label for="endDate">Ablesedatum (Ende):</label>
<input class="dateInput" id="endDate" onblur="validateDateInput('endDate','endDateError'); calculate();" oninput="validateDateInput('endDate','endDateError'); calculate();" pattern="\d{2}\.\d{2}\.\d{4}" placeholder="TT.MM.JJJJ" required="" type="text"/>
<span class="errorMessage" id="endDateError"></span>
</div>
<div class="vertical-input-group">
<label for="endMeter">Gaszählerstand (Ende, in m³):</label>
<input class="gas-meter-input" id="endMeter" onblur="calculate();" oninput="calculate();" required="" step="0.001" type="number"/>
<span class="errorMessage" id="endMeterError"></span>
</div>
<div class="result">
<label>m³-Differenz:</label>
<span id="m3Difference">0,000</span> m³
          </div>
<div class="vertical-input-group">
<label>Gewichtungsbasis:</label>
<label><input name="weightBasis" type="radio" value="plz"/> PLZ (dynamisch) <span class="rb1-inline-wrap"><span class="rb1-inline-info" id="rb1PLZInfoBtn" tabindex="0" title="Hinweis zu PLZ (dynamisch)">ⓘ</span><div class="rb1-info-popover" id="rb1PLZInfoPopover" role="tooltip">Die Monatsgewichte werden dynamisch berechnet aus historischen Wetterdaten des Dienstes Open-Meteo Historical. Dabei werden Temperaturmessungen des Deutschen Wetterdienstes (DWD) und internationale Reanalyse-Datensätze berücksichtigt. So wird das Klimaprofil der jeweiligen Postleitzahlregion möglichst genau abgebildet.</div></span></label>
<label><input name="weightBasis" type="radio" value="A"/> Tabelle A <span class="inline-status" id="tableAInlineMsg"></span> <span class="rb1-inline-wrap"><span class="rb1-inline-info" id="rb1TableAInfoBtn" tabindex="0" title="Hinweis zu Tabelle A">ⓘ</span><div aria-hidden="true" class="rb1-info-popover" id="rb1TableAInfoPopover" role="tooltip" style="font-weight: normal">Tabelle A nutzt feste Monatsgewichtungen gemäß den offiziellen Standardlastprofilen Gas (BDEW/TU München). Diese Werte dienen Energieversorgern als Grundlage für Verbrauchsprognosen.</div></span></label>
<label><input name="weightBasis" type="radio" value="B"/> Tabelle DWD <span class="inline-status" id="tableBInlineMsg"></span></label>
<span class="rb1-inline-wrap">
<span class="rb1-inline-info" id="rb1DWDInfoBtn" tabindex="0" title="Hinweis zu Tabelle DWD">ⓘ</span>
<div aria-hidden="true" class="rb1-info-popover" id="rb1DWDInfoPopover" role="tooltip">
Hinweis:</strong> Tabelle DWD enthält die durchschnittlichen Monatswerte des Deutschen Wetterdienstes (DWD), Jahr 2024.
  </div>
</span>
</div>
<!-- Duplicate toggle button for Rubrik 1b moved below m3 difference -->
<p id="rubrik1Error" style="color:red;"></p>
<span class="warningMessage" id="dateWarning"></span>
<span class="warningMessage" id="summerWarning"></span>
<!-- Reset-Button mit Hinweis -->
<button class="resetBtn" id="resetButton" onclick="resetHddTable(); resetAll()">Reset</button>
<span style="font-size: 0.8em; color: #555;">Setzt alle Eingaben und Berechnungen zurück</span>
</div>
</div>
<!-- PLZ-Eingabe nach m³-Differenz -->
<div class="vertical-input-group plz-only">
<label for="plzInputRubrik1">Postleitzahl:</label>
<input id="plzInputRubrik1" pattern="\d{4,5}" placeholder="z. B. 10115" type="text"/>
<span class="errorMessage" id="plzErrorRubrik1"></span>
</div>
<div class="button-container">
<button class="plz-only" id="fetchWeightsBtn" type="button" style="display:none">Berechnung starten</button><span id="fetchStatus" style="display:inline-block;width:12px;height:12px;border-radius:50%;background:#ccc;margin-left:10px;vertical-align:middle;"></span><span id="fetchMsg" style="margin-left:5px;font-style:italic;color:red;"></span>
</div>
<button class="rechenweg rechenweg" id="toggleWeightBtn" onclick="toggleWeightSection()">Berechnung der Gewichtungen einblenden</button>
<button id="toggleRubrik1bBtn">2. Zeitraum einblenden</button></div>
<!-- Rubrik 1b: Zweiter Zeitraum -->
<div class="bordered-section" id="zweiterZeitraum">
<span class="section-number">1b</span>
<h2>Zweiter Zeitraum</h2>
<span class="info-icon" onclick="toggleInfo('rubrik1bInfo')">ⓘ</span>
<div class="info-text" id="rubrik1bInfo">
        Beispiel: Zeitraum vom 03.08.2023 bis 15.04.2024 enthält sowohl Sommermonate (August–September) als auch Wintermonate (Oktober–April). Es werden für die Berechnung alle Wintermonate herangezogen.
      </div>
<p>Dieser Zeitraum sollte auch Wintermonate enthalten.</p>
<div class="vertical-input-group">
<label for="startDate2">Ablesedatum (Start):</label>
<input id="startDate2" onblur="validateDateInput('startDate2','startDate2Error'); validateRubrik1b()" oninput="validateDateInput('startDate2','startDate2Error'); validateRubrik1b()" type="text"/>
<span class="errorMessage" id="startDate2Error"></span>
</div>
<div class="vertical-input-group">
<label for="startMeter2">Gaszählerstand (Start, in m³):</label>
<input class="gas-meter-input" id="startMeter2" onblur="validateRubrik1b()" oninput="validateRubrik1b()" type="number"/>
<span class="rb1b-inline-wrap">
<span class="rb1b-inline-info" id="rb1bInfoBtn" tabindex="0" title="Hinweis zum Verbrauchsmodus anzeigen">ⓘ</span>
<div aria-hidden="true" class="rb1b-info-popover" id="rb1bInfoPopover" role="tooltip">
<strong>Hinweis:</strong> Wenn keine Zählerstände vorliegen, können Sie alternativ den Gesamtverbrauch
    <em>(z. B. aus der Rechnung)</em> eingeben.<br/>
    Start = <strong>0</strong>, Ende = <strong>Verbrauch laut Abrechnung</strong>.
  </div>
</span>
</div>
<div class="vertical-input-group">
<label for="endDate2">Ablesedatum (Ende):</label>
<input id="endDate2" onblur="validateDateInput('endDate2','endDate2Error'); validateRubrik1b()" oninput="validateDateInput('endDate2','endDate2Error'); validateRubrik1b()" type="text"/>
<span class="errorMessage" id="endDate2Error"></span>
</div>
<div class="vertical-input-group">
<label for="endMeter2">Gaszählerstand (Ende, in m³):</label>
<input class="gas-meter-input" id="endMeter2" onblur="validateRubrik1b()" oninput="validateRubrik1b()" type="number"/>
</div>
<div class="result">
<label>m³-Differenz:</label>
<span id="m3Difference2">0,000</span> m³
      </div>
<!-- Duplicate toggle button for Rubrik 1b, positioned under m³-Differenz -->
<button class="rechenweg rechenweg" id="toggleWeightBtnB" onclick="toggleWeightSection()" style="margin-top:10px;">
    Gewichtungen einblenden
  </button>
<!-- Duplicate toggle button for Rubrik 1b moved below m3 difference -->
<span class="errorMessage" id="winterWarning"></span>
<p class="errorMessage" id="rubrik1bError"></p>
<p class="errorMessage" id="meterError2"></p>
<div style="margin-top: 1rem; text-align: right;">
<button class="resetBtn" id="resetRubrik1bBtn" style="" type="button">Eingaben löschen</button>
</div>
</div>
<!-- Rubrik 2: Monate und Gewichtungen -->
<div class="bordered-section" id="rubrik2" style="display:none">
<div id="buttonHint" style="display:none; font-style:italic; font-size:0.9em; margin-top:5px;">
    Hinweis: Klicke auf eine Tabellenzeile, um sie hervorzuheben und den Berechnungsweg anzuzeigen.
  </div>
<span class="info-icon" id="rubrik2InfoIcon" onclick="toggleInfo('rubrik2InfoText')">ⓘ</span>
<div class="info-text" id="rubrik2InfoText" style="display:none;">Die Tabelle zeigt die monatlichen Heizgradtage (HDD) und rechnet sie in prozentuale Gewichtsanteile um. Die HDD-Daten stammen von der Open-Meteo Historical API.</div>
<div id="detailedTable" style="display:none; margin-top:10px;"></div>
<div id="calcDetails" style="margin-top:10px; font-size:0.9em;">
<div id="selectedMonthDisplay" style="font-weight:bold; margin-bottom:5px;"></div>
<div id="calcList" style="margin-top:10px; font-size:0.9em;"></div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
      const btn = document.getElementById('toggleDetailsBtn');
      const tableDiv = document.getElementById('detailedTable');
      btn.addEventListener('click', function() {
        if (tableDiv.style.display === 'none') {
          const gtz = window.gtzData || {};
          const sumHdd = window.sumHdd || Object.values(gtz).reduce((a,b)=>a+b,0);
          const water = 1/12;
          
let html = '<table border="1" cellpadding="5"><tr>' +
           '<th>Monat</th>' +
           '<th>HDD</th>' +
           '<th>Heiz<br>W.</th>' +
           '<th>WW<br>W.</th>' +
           '<th>Komb.</th>' +
           '<th>%</th></tr>';

          Object.keys(gtz).forEach(m => {
            const hdd = gtz[m];
            const heating = sumHdd>0 ? hdd/sumHdd : 0;
            const comb = 0.8*heating + 0.2*water;
            html += `<tr><td>${m}</td><td>${hdd.toFixed(3)}</td><td>${heating.toFixed(5)}</td><td>${water.toFixed(5)}</td><td>${comb.toFixed(5)}</td><td>${(comb*100).toFixed(3)}</td></tr>`;
          });
          
        // Summen berechnen
        const sumHddFooter = Object.values(gtz).reduce((a,b)=>a+b, 0);
        const sumPercentFooter = Object.keys(gtz).reduce((sum, m) => {
          const hdd = gtz[m];
          const heating = sumHddFooter> 0 ? hdd / sumHddFooter : 0;
          const comb = 0.8 * heating + 0.2 * (1/12);
          return sum + comb * 100;
        }, 0);
        html += `<tfoot><tr><th>Summe</th><th>${sumHddFooter.toFixed(3)}</th><th></th><th></th><th></th><th>${sumPercentFooter.toFixed(3)}</th></tr></tfoot>`;
    html += '</table>';
          tableDiv.innerHTML = html;
          tableDiv.style.display = 'block';
          btn.textContent = 'Monatanteile der Gradtage verbergen';
        } else {
          tableDiv.style.display = 'none';
          btn.textContent = 'Berechnung Monatanteile der Gradtage';
        }
      });
    });
  </script>
<span class="section-number">2</span>
<h2>Berechnung der Gewichtungen</h2>
<div style="margin-bottom: 1em; display: flex; align-items: center; gap: 1em;">
<label for="weightTableSelect" style="font-weight: bold; color: #175fa4;">Berechnungsbasis wählen:</label>
<select id="weightTableSelect" onchange="changeWeightTable()" style="font-size: 1em; border-radius: 0.4em; padding: 0.2em 0.6em;">
<option selected="selected" value="plz">PLZ/Jahr (dynamisch)</option>
<option value="A">Tabelle A (statisch)</option>
<option value="B">Tabelle DWD</option>
</select>
<script>
(function(){
  function setGtzDataFromCacheAndUpdate() {
    if (!window.cachedGtzData) return;
    window.gtzData = Object.assign({}, window.cachedGtzData);
    // Simuliere einen Klick auf den "Berechnung starten"-Button
    var btn = document.getElementById('fetchWeightsBtn');
    if(btn && btn.style.display !== 'none' && document.querySelector('input[name="weightBasis"][value="plz"]')?.checked) btn.click();
  }

  // Nach PLZ-Berechnung Cache befüllen
  let origFetch = window.fetch;
  window.fetch = function() {
    return origFetch.apply(this, arguments).then(resp => {
      let resp2 = resp.clone();
      resp2.json().then(data => {
        if (window.gtzData && typeof window.gtzData === "object") {
          window.cachedGtzData = Object.assign({}, window.gtzData);
        }
      }).catch(()=>{});
      return resp;
    });
  };

  // Umschalten im Dropdown abfangen
  document.addEventListener('DOMContentLoaded', function() {
    var select = document.getElementById('weightTableSelect');
    if(!select) return;
    select.addEventListener('change', function() {
      if(this.value === 'plz') {
        // Wenn Cache da, dynamische Daten wiederherstellen und UI aktualisieren
        if(window.cachedGtzData) setGtzDataFromCacheAndUpdate();
      }
    });
  });
})();
</script>
</div>
<br/>
<div class="weight-btn-row">
<button id="showHddTableBtn" onclick="toggleHddTable()">HDD-Tabelle einblenden</button>
<button id="showStandardTableBtn" onclick="toggleStandardTable()">Tabelle A einblenden</button>
<button id="showBTableBtn" onclick="toggleBTable()">Tabelle DWD einblenden</button>
</div>
<ul id="monthWeightList" style="display:none;"></ul>
<p class="explanation" id="monthWeightExplanation"></p>
<div style="margin-top:10px;">
<div class="weight-sum">
<h3>Summe der Gewichtungen</h3>
<p id="totalWeightSum"></p>
</div>
<div id="originalWeights"></div>
<div id="originalWeightsB" style="display:none;"></div>
</div>
<div class="rub2b-fixed-btn" id="rub2b-toggle-holder">
<button id="toggleRubrik2bBtn" style="font-size:10px; padding:2px 6px; opacity:0.75;" title="Rubrik 2b ein-/ausblenden">2b</button>
</div>
<div style="clear:both;"></div>
</div>
<div class="bordered-section" id="rubrik2b" style="display:none;">
<span class="section-number">2b</span>
<h2>Heizgradtage-Gewichtung (PLZ &amp; Jahr)</h2>
<h1>Automatischer GTZ‑Gewichtungsrechner nach Postleitzahl</h1>
<p>Dieses Werkzeug ermittelt automatisch <strong>tägliche Temperaturen</strong> aus der
<a href="https://open-meteo.com/" target="_blank">Open‑Meteo Archive‑API</a>,
berechnet daraus Heizgradtage <em>(Basis 20 °C / 15 °C)</em> und liefert
die prozentuale Monats‑Gewichtung (Summe = 100 %).<br/>
Gib einfach eine deutsche Postleitzahl und das gewünschte Jahr an – fertig.</p>
<div>
<label>Postleitzahl:
    <input id="plz" pattern="\d{4,5}" placeholder="z. B. 10115" required="" type="text"/>
</label>
<label>Jahr:
    <input id="jahr" max="2025" min="1950" type="number" value="2024"/>
</label>
<button id="go">PLZ laden &amp; HDD-Tabelle anzeigen</button><br/><div style="background-color:#fff8d5;padding:6px 10px;border-radius:4px;display:inline-block;margin-top:4px;color:#333;font-size:0.9em;">🔍 <strong>Hinweis:</strong> Diese Funktion dient <strong>Kontroll- und Testzwecken</strong>. Die geladenen Gewichte wirken sich nur aus, wenn die PLZ in <strong>Rubrik 1</strong> eingetragen und dort die Berechnung gestartet wird.</div>
</div>
<div class="error" id="msg"></div>
<table hidden="" id="tbl">
<thead>
<tr><th>Monat</th><th>GTZ</th><th>Gewichtung %</th></tr>
</thead>
<tbody></tbody>
<tfoot>
<tr><th>Summe</th><th id="sumGtz"></th><th id="sumWgt"></th></tr>
</tfoot>
</table>
<p class="hint">Quelle Temperaturen: Open‑Meteo Historical Weather API.
Geokodierung: <a href="https://nominatim.org/" target="_blank">Nominatim</a>.<br/>
Berechnungsformel: VDI 2067 (20/1 °C). Aktualisiert: <span id="upd"></span></p>
<script>
const months = ["Jan","Feb","Mär","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];

document.getElementById("go").addEventListener("click", async () => {
    const plz = document.getElementById("plz").value.trim();
    const year = parseInt(document.getElementById("jahr").value,10);
    const msg = document.getElementById("msg");
    msg.textContent = "";
    if(!/^\d{4,5}$/.test(plz)) { msg.textContent = "Bitte gültige deutsche PLZ eingeben."; return; }
    if(isNaN(year)) { msg.textContent = "Bitte gültiges Jahr eingeben."; return; }

    try {
        // 1) Geokodierung
        const geoUrl = `https://nominatim.openstreetmap.org/search?format=json&postalcode=${plz}&country=de&limit=1`;
        const geoResp = await fetch(geoUrl, { headers: { "User-Agent":"gtz-demo" }});
        const geoJson = await geoResp.json();
        if(!geoJson.length) throw new Error("PLZ nicht gefunden");
        const lat = parseFloat(geoJson[0].lat).toFixed(4);
        const lon = parseFloat(geoJson[0].lon).toFixed(4);

        // 2) Wetterdaten holen
        const start = `${year}-01-01`;
        const end   = `${year}-12-31`;
        const meteoUrl = `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${start}&end_date=${end}&daily=temperature_2m_max,temperature_2m_min&timezone=UTC`;
        const meteoResp = await fetch(meteoUrl);
        const data = await meteoResp.json();
        if(!data.daily || !data.daily.time) throw new Error("Keine Wetterdaten gefunden");

        // 3) HDD/GTZ berechnen
        const tmax = data.daily.temperature_2m_max;
        const tmin = data.daily.temperature_2m_min;
        const dates= data.daily.time;
        const gtzMonth = Array(12).fill(0);
        for(let i=0;i<dates.length;i++){
            const avg = (tmax[i] + tmin[i]) / 2;
            if(avg < 15){
                const hdd = 20 - avg;
                const m = new Date(dates[i]).getUTCMonth(); // 0-11
                gtzMonth[m] += hdd;
            }
        }

        // 4) Tabelle aktualisieren
        buildTable(gtzMonth);
        document.getElementById("upd").textContent = new Date().toLocaleString("de-DE");
        document.getElementById("tbl").hidden = false;

    } catch(err) {
        msg.textContent = err.message;
    }
});

function buildTable(gtzArr){
    const tbody = document.querySelector("#tbl tbody");
    tbody.innerHTML = "";
    const sum = gtzArr.reduce((a,b)=>a+b,0);
    gtzArr.forEach((v,idx)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${months[idx]}</td><td>${v.toFixed(3)}</td><td>${(v? 100*v/sum:0).toFixed(3)}</td>`;
        tbody.appendChild(tr);
    });
    document.getElementById("sumGtz").textContent = sum.toFixed(3);
    document.getElementById("sumWgt").textContent = "100.0";
}
</script>
</div>
<!-- Rubrik 3: Hochrechnung in m³ -->
<div class="bordered-section" id="rubrik3" style="display:none">
<!-- Beginn Rubrik 2b: Heizgradtage-Gewichtung (Stand-alone) -->
<style>
body {font-family:Arial,Helvetica,sans-serif;max-width:800px;margin:0 auto;padding:18px;}
h1 {font-size:1.6rem;margin-top:0}
label {display:inline-block;margin:6px 0}
input[type=text], input[type=number] {padding:4px 6px;font-size:1rem;margin-right:6px;width:120px}
button {padding:6px 16px;font-size:1rem;cursor:pointer;margin-top:10px}
table {border-collapse:collapse;width:100%;margin-top:14px}
th, td {border:1px solid #ccc;padding:6px 4px;text-align:right}
th:first-child, td:first-child {text-align:left}
tfoot th {background:#f3f3f3;font-weight:bold}
.hint {font-size:0.9rem;color:#555}
.error {color:#c00;font-weight:bold;padding:6px 0}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<script>

const months = ["Jan","Feb","Mär","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];

document.getElementById("go").addEventListener("click", async () => {
    const plz = document.getElementById("plz").value.trim();
    const year = parseInt(document.getElementById("jahr").value,10);
    const msg = document.getElementById("msg");
    msg.textContent = "";
    if(!/^\d{4,5}$/.test(plz)) { msg.textContent = "Bitte gültige deutsche PLZ eingeben."; return; }
    if(isNaN(year)) { msg.textContent = "Bitte gültiges Jahr eingeben."; return; }

    try {
        // 1) Geokodierung
        const geoUrl = `https://nominatim.openstreetmap.org/search?format=json&postalcode=${plz}&country=de&limit=1`;
        const geoResp = await fetch(geoUrl, { headers: { "User-Agent":"gtz-demo" }});
        const geoJson = await geoResp.json();
        if(!geoJson.length) throw new Error("PLZ nicht gefunden");
        const lat = parseFloat(geoJson[0].lat).toFixed(4);
        const lon = parseFloat(geoJson[0].lon).toFixed(4);

        // 2) Wetterdaten holen
        const start = `${year}-01-01`;
        const end   = `${year}-12-31`;
        const meteoUrl = `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${start}&end_date=${end}&daily=temperature_2m_max,temperature_2m_min&timezone=UTC`;
        const meteoResp = await fetch(meteoUrl);
        const data = await meteoResp.json();
        if(!data.daily || !data.daily.time) throw new Error("Keine Wetterdaten gefunden");

        // 3) HDD/GTZ berechnen
        const tmax = data.daily.temperature_2m_max;
        const tmin = data.daily.temperature_2m_min;
        const dates= data.daily.time;
        const gtzMonth = Array(12).fill(0);
        for(let i=0;i<dates.length;i++){
            const avg = (tmax[i] + tmin[i]) / 2;
            if(avg < 15){
                const hdd = 20 - avg;
                const m = new Date(dates[i]).getUTCMonth(); // 0-11
                gtzMonth[m] += hdd;
            }
        }

        // 4) Tabelle aktualisieren
        buildTable(gtzMonth);
        document.getElementById("upd").textContent = new Date().toLocaleString("de-DE");
        document.getElementById("tbl").hidden = false;

    } catch(err) {
        msg.textContent = err.message;
    }
});

function buildTable(gtzArr){
    const tbody = document.querySelector("#tbl tbody");
    tbody.innerHTML = "";
    const sum = gtzArr.reduce((a,b)=>a+b,0);
    gtzArr.forEach((v,idx)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${months[idx]}</td><td>${v.toFixed(3)}</td><td>${(v? 100*v/sum:0).toFixed(3)}</td>`;
        tbody.appendChild(tr);
    });
    document.getElementById("sumGtz").textContent = sum.toFixed(3);
    document.getElementById("sumWgt").textContent = "100.0";
}

</script>
<!-- Ende Rubrik 2b -->
<span class="section-number">3</span>
<h2>Hochrechnung in m³</h2>
<p id="m3Forecast"></p>
<p class="explanation" id="m3ForecastExplanation"></p>
<button class="rechenweg" onclick="toggleExplanation('m3ForecastExplanation', this)">Rechenweg anzeigen</button>
</div>
<!-- Rubrik 4: Umrechnung in kWh -->
<div class="bordered-section kwh-calculation" id="rubrik4">
<div id="rubrik4Toggle" class="rubrik4-toggle" style="margin-bottom:10px;">
  <label style="display:flex;align-items:center;gap:.5rem;font-weight:600;">
    <input type="checkbox" id="useCustomFactors" />
    Eigene Brennwert-/Zustandswerte eingeben
  </label>
  <!-- Der ursprüngliche Hinweistext wird weiter unten eingefügt -->
</div>
<!-- Der dynamische Hinweis wird weiter unten eingefügt -->

<div id="rubrik4-fields">

<div id="rubrik4Advanced">
<span class="section-number">4</span>
<h2>Umrechnung in kWh</h2>
<div class="aligned-inputs">
<div class="input-row">
<div class="input-left">
<label for="brennwert">Brennwert:
              <span class="info-icon" onclick="toggleInfo('brennwertInfoText')">ⓘ</span>
</label>
<input id="brennwert" onblur="calculateKWh(); processSelectedMonths();" oninput="calculateKWh(); processSelectedMonths();" style="width:100px;" type="text" value="10"/ inputmode="decimal" pattern="[-0-9\.,]*">
<span id="brennwertError" class="errorMessage"></span>
<div class="info-text" id="brennwertInfoText">
              Brennwert und Zustandszahl können aus der  Gasrechnung entnommen werden.Ohne eigene Angaben werden die vorgegebenen Standardwerte ( Brennwert 10, Zustandszahl 0,950 ) für die Berechnung verwendet
            </div>
</div>
<div class="input-right">
<label for="zustandszahl">Zustandszahl:</label>
<input id="zustandszahl" onblur="calculateKWh(); processSelectedMonths();" oninput="calculateKWh(); processSelectedMonths();" style="width:100px;" type="text" value="0.950"/ inputmode="decimal" pattern="[-0-9\.,]*">
<span id="zustandszahlError" class="errorMessage"></span>
</div>
</div>
<div id="factor-container" style="margin-top: 20px;">
<div style="text-align: center; margin-bottom: 10px;">
<span class="highlight-or">oder</span>
</div>
<div style="text-align: center;">
<label for="factor">Faktor:
              <span class="info-icon" onclick="toggleInfo('factorInfoText')">ⓘ</span>
</label>
</div>
<div style="text-align: center;">
<input id="factor" onblur="calculateKWh(); processSelectedMonths();" oninput="calculateKWh(); processSelectedMonths();" step="0.001" style="width:100px;" type="number"/>
</div>
<div class="info-text" id="factorInfoText">
            Falls nur der Faktor (Brennwert×Zustandszahl) vorliegt, können Sie diesen direkt eingeben.
          </div>
</div>
    <!-- Hinweistext für Rubrik 4: unterhalb des Faktor-Feldes platziert -->
    <small id="rubrik4Hint" style="display:block;color:#555;margin-top:4px;">Ohne Haken nutzen wir Standardwerte. Aktivieren zum Anpassen.</small>
    <div id="rubrik4-hint" style="display:none; margin-top:6px; font-size:0.9em;"></div>
</div>

<p id="kwhConversionResult" style="font-weight:bold; margin-top:10px;"></p>
<p class="explanation" id="kwhCalculationExplanation"></p>
<button class="rechenweg" onclick="toggleExplanation('kwhCalculationExplanation', this)">Rechenweg anzeigen</button>
</div>
</div>
</div>
<!-- Rubrik 5: Verteilung des hochgerechneten Verbrauchs -->
<div class="bordered-section" id="rubrik5" style="display:none">
<span class="section-number">5</span>
<h2 id="m3ConversionHeader">Verteilung des hochgerechneten Verbrauchs <span id="projectedM3Value">(…)</span> auf 12 Monate – mit voraussichtlichem Zählerstand zum Monatsende (alternativ: Datum eingeben)</h2>
<div style="text-align: right; margin: 6px 0 12px 0;">
  <button type="button" onclick="printRubrik('rubrik5')">Drucken: Rubrik 5</button>
</div>

<div style="margin-bottom:10px;">
<div id="customDateContainer" style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
<input id="customDateInputRubrik5" style="padding:4px; font-size:0.9em;" type="date"/><button id="resetCustomDate" title="Datum zurücksetzen" type="button">✖</button>
<button class="rechenweg" id="toggleCustomDateExp">Rechenweg anzeigen</button>
</div>
<div class="warning-custom" id="dateWarningCustom">
        ⚠️ Das gewählte Datum liegt außerhalb des 12-Monats-Zeitraums.
    </div>
</div>
<span class="errorMessage" id="customDateError" style="color:red; display:block; margin-bottom:10px;"></span>
<p id="customDateReading" style="font-weight:bold; margin:10px 0;"></p>
<div class="explanation" id="customDateExplanation"></div><script>
// Inline Toggle für Custom-Datum-Rechenweg
(function(){
  var btn = var btn = var btn = document.getElementById('toggleCustomDateExp');
  var expDiv = document.getElementById('customDateExplanation');
  if (!btn || !expDiv) return;
  btn.onclick = function(){
    if (expDiv.style.display === 'block') {
      expDiv.style.display = 'none';
      btn.innerText = 'Rechenweg anzeigen';
    } else {
      expDiv.style.display = 'block';
      btn.innerText = 'Rechenweg ausblenden';
    }
  };
})();
</script>
<ul id="m3ConversionList"></ul>
<canvas id="chartContainer"></canvas>

<div class="rubrik5-buttonbar" style="margin-top:8px; display:flex; justify-content:space-between; align-items:center; gap:8px;">
  <button onclick="document.getElementById('rubrik1Container').scrollIntoView({behavior:'smooth'});" style="margin-top:10px;font-size:14px;padding:5px 10px;">↑ Rubrik 1</button>
  <button type="button" class="rechenweg" id="toggleMonthProjectionExp" onclick="(function(){var r=document.getElementById('rubrik5');var b=document.getElementById('toggleMonthProjectionExp');if(r&&b){var on=r.classList.toggle('show-monthcalc');b.textContent=on?'Rechenweg für 12 Monate ausblenden':'Rechenweg für 12 Monate anzeigen';}})();return false;">Rechenweg für 12 Monate anzeigen</button>
</div>
</div>
<!-- Rubrik 6: Auswahl von Monaten -->
<div class="bordered-section" id="rubrik6" style="display:none">
<span class="section-number">6</span>
<h2>Auswahl von Monaten</h2>
<p>Wählen Sie den Zeitraum aus, den Sie weiter bearbeiten möchten.</p>
<p id="noSelectionHint"><em>Wenn keine Monate markiert sind, werden automatisch alle angezeigten Monate für die weitere Berechnung berücksichtigt.</em></p>
<ul id="monthSelectionList"></ul>
<!-- Statische Gesamtsumme Rubrik 6 -->
<p id="rubrik6TotalM3" style="font-weight:bold; margin-top:10px;">Gesamtverbrauch in m³: <span id="rubrik6TotalM3Value">0,000</span> m³</p>
<!-- Statische Gesamtsumme kWh Rubrik 6 -->
<p id="rubrik6TotalKwh" style="font-weight:bold; margin-top:5px;">Gesamtverbrauch in kWh: <span id="rubrik6TotalKwhValue">0,000</span> kWh</p>
<button class="rechenweg" onclick="toggleBlocks(this)">Rechenweg anzeigen</button>
<div id="monthBlocksContainer" style="display:none">
<div id="partialConsumptionResult"></div>
</div>
</div>
<!-- Rubrik 7: Kostenberechnung -->
<div class="bordered-section" id="rubrik7" style="border: 2px solid #FF5733;;display:none">
<span class="section-number">7</span>
<div style="text-align: center; margin-bottom: 10px;">
<button id="toggleCostCalcBtn" onclick="toggleCostCalc()" style="font-size:16px; padding:8px 16px;">Weitere Berechnungsmöglichkeiten anzeigen</button>
<button type="button" onclick="printRubrik('rubrik7')">Drucken: Rubrik 7</button>

</div>
<div id="costCalcContent" style="display:none;">
<div class="cost-columns">
<!-- Linke Spalte: Kostenberechnung 1 -->
<div class="cost-column-left">
<div class="cost-header-left">
<h2 style="font-weight:500;">Kostenberechnung</h2>
<p id="cost1Hint">( Gesamtverbrauch für alle 12 Monate )</p>
</div>
<div class="bordered-costs" style="border: none; padding: 0; margin-top: 0;">
<!-- Feld 1: Menge kWh -->
<div class="input-group">
<label for="kwhAmount">1. Menge kWh:</label>
<input id="kwhAmount" readonly="" step="0.001" type="text"/>
</div>
<!-- Feld 2: Arbeitspreis Cent -->
<div class="input-group">
<label for="workPrice">2. Arbeitspreis Cent:</label>
<input id="workPrice" onblur="calculateCost();" oninput="calculateCost();" step="0.001" type="number"/>
<label class="klein">Ergebnis:</label>
<input id="costResult" readonly="" type="text"/>
</div>
<!-- Feld 3: Grundpreis -->
<div class="input-group">
<label for="basePrice">3. Grundpreis:</label>
<input id="basePrice" onblur="calculateInstallments();" oninput="calculateInstallments();" step="0.01" type="number"/>
</div>
<!-- Dropdowns: Abschläge von/bis direkt unter Grundpreis -->
<div class="dropdowns">
<label for="fromMonth">Abschläge von:</label>
<input id="fromMonth" readonly="" type="text"/>
<label for="toMonth">Abschläge bis:</label>
<input id="toMonth" readonly="" type="text"/>
</div>
<!-- Feld 4: Anzahl der Monate -->
<div class="input-group">
<label for="monthsCount">4. Anzahl der Monate:</label>
<input id="monthsCount" readonly="" step="1" type="number"/>
</div>
<!-- Feld 5: Ergebnis -->
<div class="input-group">
<label for="installmentResult">5. Ergebnis:</label>
<input id="installmentResult" readonly="" type="text"/>
</div>
<!-- Feld 6: Gesamtsumme -->
<div class="total-sum">
<label for="totalSum">6. Gesamtsumme <span class="klein">Ergebnis:</span></label>
<span id="totalSum">0,00 €</span>
</div>
</div>
</div>
<!-- Rechte Spalte: Kostenberechnung 2 -->
<div class="cost-column-right">
<div class="cost-header-right">
<h2 style="font-weight:500;">Kostenberechnung</h2>
<p>( Manuelle Eingabe )
                
              </p>
</div>
<div class="bordered-costs" style="border: none; padding: 0; margin-top: 0;">
<!-- Feld 1: Menge kWh -->
<div class="input-group">
<label for="kwhAmountManual">1. Menge kWh:</label>
<input id="kwhAmountManual" onblur="calculateCostManual();" oninput="calculateCostManual(); checkResetButtonVisibility();" step="0.001" type="text"/>
<!-- Reset-Button und Hinweis, initial versteckt -->
</div>
<!-- Feld 2: Arbeitspreis Cent -->
<div class="input-group">
<label for="workPriceManual">2. Arbeitspreis Cent:</label>
<input id="workPriceManual" onblur="calculateCostManual();" oninput="calculateCostManual();" step="0.001" type="number"/>
<label class="klein">Ergebnis:</label>
<input id="costResultManual" readonly="" type="text"/>
</div>
<!-- Feld 3: Grundpreis -->
<div class="input-group">
<label for="basePriceManual">3. Grundpreis:</label>
<input id="basePriceManual" onblur="calculateInstallmentsManual();" oninput="calculateInstallmentsManual();" step="0.01" type="number"/>
</div>
<!-- Dropdowns: Abschläge von/bis direkt unter Grundpreis -->
<div class="dropdowns">
<label for="fromMonthManual">Abschläge von:</label>
<select class="input-field" id="fromMonthManual" onchange="calculateMonths();">
<option =""="" selected="" value="">Monat auswählen</option>
<option value="01">Januar</option>
<option value="02">Februar</option>
<option value="03">März</option>
<option value="04">April</option>
<option value="05">Mai</option>
<option value="06">Juni</option>
<option value="07">Juli</option>
<option value="08">August</option>
<option value="09">September</option>
<option value="10">Oktober</option>
<option value="11">November</option>
<option value="12">Dezember</option>
</select>
<label for="toMonthManual">Abschläge bis:</label>
<select class="input-field" id="toMonthManual" onchange="calculateMonths();">
<option =""="" selected="" value="">Monat auswählen</option>
<option value="01">Januar</option>
<option value="02">Februar</option>
<option value="03">März</option>
<option value="04">April</option>
<option value="05">Mai</option>
<option value="06">Juni</option>
<option value="07">Juli</option>
<option value="08">August</option>
<option value="09">September</option>
<option value="10">Oktober</option>
<option value="11">November</option>
<option value="12">Dezember</option>
</select>
</div>
<!-- Feld 4: Anzahl der Monate -->
<div class="input-group">
<label for="monthsCountManual">4. Anzahl der Monate:</label>
<input id="monthsCountManual" readonly="" step="1" type="number"/>
</div>
<!-- Feld 5: Ergebnis -->
<div class="input-group">
<label for="installmentResultManual">5. Ergebnis:</label>
<input id="installmentResultManual" readonly="" type="text"/>
</div>
<!-- Feld 6: Gesamtsumme -->
<div class="total-sum">
<label for="totalSumManual">6. Gesamtsumme <span class="klein">Ergebnis:</span></label>
<span id="totalSumManual">0,00 €</span>
</div>
</div>
</div>
</div>
</div>
</div><script>
    let defaultKwh = 0;
// Rubrik 7: Automatischer Abgleich mit Gesamtverbrauch aus Rubrik 6
(function syncKwhToRubrik7() {
  const kwhField = document.getElementById('kwhAmount');
  const rubrik6Kwh = document.getElementById('rubrik6TotalKwhValue');
  if (!kwhField || !rubrik6Kwh) return;
  const selectedMonths = document.querySelectorAll('#monthSelectionList input[type="checkbox"]:checked');
  if (selectedMonths.length === 0) {
    const raw = rubrik6Kwh.innerText.replace(/[.,]/g, m => m === ',' ? '.' : '');
    const parsed = parseFloat(raw);
    if (!isNaN(parsed)) kwhField.value = parsed.toFixed(3);
  }
})();

    let myChart = null;
    // Rubrik 6: Sichtbarkeitszustand des Rechenwegs merken
    let monthBlocksVisible = false;
    
    // Neue Funktion zur automatischen Vorbelegung der Dropdowns in Kostenberechnung 1 (linke Seite):
    // Wenn keine Checkbox ausgewählt ist, wird das komplette Array (alle Monate in DOM-Reihenfolge) als Standard verwendet.
    function updateCostCalculationLeftDropdowns(selected) {
      const checkboxes = document.querySelectorAll('#monthSelectionList input[type="checkbox"]');
      // Wenn keine Checkbox ausgewählt, alle Checkboxwerte als Default verwenden:
      let selValues = selected.length> 0 ? selected : Array.from(checkboxes).map(chk => chk.value);
      let firstMonth = null;
      let lastMonth = null;
      // Durchlaufe die Checkboxen in der Reihenfolge, wie sie im DOM erscheinen:
      checkboxes.forEach(chk => {
        if(selValues.includes(chk.value)) {
          if(firstMonth === null) {
            firstMonth = chk.value;
          }
          lastMonth = chk.value;
        }
      });
      if(firstMonth !== null && lastMonth !== null) {
        document.getElementById('fromMonth').value = monthNames[firstMonth];
        document.getElementById('toMonth').value = monthNames[lastMonth];
      }
    }
    
    function checkResetButtonVisibility() {
      const manualField = document.getElementById('kwhAmountManual');
      const resetBtn = document.getElementById('resetManualBtn');
      const resetHint = document.getElementById('resetManualHint');
      if (manualField.value.trim() !== "" && manualField.value !== defaultKwh) {
        resetBtn.style.display = "inline-block";
        resetHint.innerText = "Der Vorgabewert wird wieder hergestellt.";
      } else {
        resetBtn.style.display = "none";
        resetHint.innerText = "";
      }
    }
    
    function resetManualValue() {
      calculateCostManual();
      document.getElementById('resetManualBtn').style.display = "none";
      document.getElementById('resetManualHint').innerText = "";
    }
    
    function clearResults() {
      document.getElementById('monthWeightList').innerHTML = "";
      document.getElementById('monthWeightExplanation').innerHTML = "";
      document.getElementById('totalWeightSum').innerText = "";
      document.getElementById('m3Forecast').innerText = "";
      document.getElementById('m3ForecastExplanation').innerHTML = "";
      document.getElementById('kwhConversionResult').innerText = "";
      document.getElementById('kwhCalculationExplanation').innerHTML = "";
      document.getElementById('partialConsumptionResult').innerHTML = "";
      document.getElementById('m3ConversionList').innerHTML = "";
      if (myChart) {
        myChart.destroy();
        myChart = null;
      }
    }
    
    function resetAll() {
  clearWeightBasis();
  if (typeof updateSectionVisibility==='function') { try{ updateSectionVisibility(); }catch(e){} }

  // Rubriken 3-7 wieder ausblenden
  ['rubrik3','rubrik4','rubrik5','rubrik6','rubrik7'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
  // Rubrik 5 & 6: Platzhalter setzen
  var projectedM3 = document.getElementById('projectedM3Value');
  if (projectedM3) projectedM3.innerText = "(…)";
  var totalM3El  = document.getElementById('rubrik6TotalM3Value');
  var totalKwhEl = document.getElementById('rubrik6TotalKwhValue');
  if (totalM3El)  totalM3El.innerText  = "(…)";
  if (totalKwhEl) totalKwhEl.innerText = "(…)";
  // Zugehörige Summen/Caches invalidieren
  window.rubrik5MonthlyValues = null;
  window.rubrik5StartReading  = null;
  window.rubrik5EndMonth      = null;
  window.rubrik5EndYear       = null;

    // Hinweistext neben dem Kreis leeren
    var msgEl = document.getElementById('fetchMsg');
    if (msgEl) msgEl.innerText = '';

    
    // Rubrik 5: Custom-Datum-Feld und Anzeigen zurücksetzen
    var cd = document.getElementById('customDateInputRubrik5');
    if (cd) cd.value = '';
    var reading = document.getElementById('customDateReading');
    if (reading) reading.innerText = '';
    var exp = document.getElementById('customDateExplanation');
    if (exp) exp.innerText = '';
    var err = document.getElementById('customDateError');
    if (err) { err.innerText = ''; err.classList.remove('visible'); }
// Manuelles kWh-Eingabefeld zurücksetzen
    document.getElementById('kwhAmountManual').value = '';

    // Felder 'Abschläge von', 'Abschläge bis' und 'Monate Count' (manuell) zurücksetzen
    document.getElementById('fromMonthManual').value = '';
    document.getElementById('toMonthManual').value = '';
    document.getElementById('monthsCountManual').value = '';

    // Felder 'Abschläge von', 'Abschläge bis' und 'Monate Count' zurücksetzen
    document.getElementById('fromMonth').value = '';
    document.getElementById('toMonth').value = '';
    document.getElementById('monthsCount').value = '';

      // Rubrik 1
      document.getElementById('startDate').value = "";
      document.getElementById('endDate').value = "";
      document.getElementById('startMeter').value = "";
      document.getElementById('endMeter').value = "";
      document.getElementById('m3Difference').innerText = "0,000";
      document.getElementById('rubrik1Error').innerText = "";
      document.getElementById('dateWarning').innerText = "";
      document.getElementById('summerWarning').innerText = "";
      
      // Rubrik 1b
      document.getElementById('startDate2').value = "";
      document.getElementById('endDate2').value = "";
      document.getElementById('startMeter2').value = "";
      document.getElementById('endMeter2').value = "";
      document.getElementById('m3Difference2').innerText = "0,000";
      document.getElementById('winterWarning').innerText = "";
      document.getElementById('winterWarning').classList.remove("visible");
      document.getElementById('zweiterZeitraum').style.display = "none";
      // Buttons in Rubrik 1 und 1b zurücksetzen
      const btn1 = document.getElementById('toggleWeightBtn');
      if (btn1) btn1.innerText = 'Berechnung der Gewichtungen einblenden';
      const btn2 = document.querySelector('#zweiterZeitraum button.rechenweg');
      if (btn2) btn2.innerText = 'Berechnung der Gewichtungen einblenden';
      // Rubrik 2: Monate & Gewichtungen zurücksetzen
      const rub2 = document.getElementById('rubrik2');
      if (rub2) rub2.style.display = 'none';
      const wtSelect = document.getElementById('weightTableSelect');
      if (wtSelect) wtSelect.value = 'A';
      const monthList = document.getElementById('monthWeightList');
      if (monthList) monthList.innerHTML = '';
      const wtExp = document.getElementById('monthWeightExplanation');
      if (wtExp) { wtExp.innerHTML = ''; wtExp.classList.remove('visible');
      // Rubrik 3: Hochrechnung in m³ zurücksetzen
      const forecast = document.getElementById('m3Forecast');
      
      // Rubrik 4: Umrechnung in kWh zurücksetzen
      const kwhRes = document.getElementById('kwhConversionResult');
      
      // Rubrik 5: Verteilung des Verbrauchs zurücksetzen
      const header5 = document.getElementById('m3ConversionHeader');
      if (header5) header5.innerText = '';
      const list5 = document.getElementById('m3ConversionList');
      if (list5) list5.innerHTML = '';
      // Chart zurücksetzen
      if (window.myChart) {
        window.myChart.destroy();
        window.myChart = null;
    // Rubrik 5 Custom-Datum zurücksetzen bei resetAll
    var cd = document.getElementById('customDateInputRubrik5');
    if (cd) cd.value = '';
    var reading = document.getElementById('customDateReading');
    if (reading) reading.innerText = '';
    var exp = document.getElementById('customDateExplanation');
    if (exp) exp.innerText = '';
    var err = document.getElementById('customDateError');
    if (err) { err.innerText = ''; err.classList.remove('visible'); }
    // Rubrik 5 Custom-Datum zurücksetzen
    var cd = document.getElementById('customDateInputRubrik5');
    if (cd) cd.value = '';
    var reading = document.getElementById('customDateReading');
    if (reading) reading.innerText = '';
    var exp = document.getElementById('customDateExplanation');
    if (exp) exp.innerText = '';
    var err = document.getElementById('customDateError');
    if (err) { err.innerText = ''; err.classList.remove('visible'); }


      }
if (kwhRes) kwhRes.innerText = '';
      const kwhExp = document.getElementById('kwhCalculationExplanation');
      if (kwhExp) { kwhExp.innerHTML = ''; kwhExp.classList.remove('visible'); }
      const brenn = document.getElementById('brennwert');
      if (brenn) brenn.value = '10';
      const zust = document.getElementById('zustandszahl');
      if (zust) zust.value = '0.950';
      const factor = document.getElementById('factor');
      if (factor) factor.value = '';
if (forecast) forecast.innerText = '';
      const forecastExp = document.getElementById('m3ForecastExplanation');
      if (forecastExp) {
        forecastExp.innerHTML = '';
        forecastExp.classList.remove('visible');
      }
 }
      const wtSum = document.getElementById('totalWeightSum');
      if (wtSum) wtSum.innerText = '';
      const origW = document.getElementById('originalWeights');
      if (origW) origW.innerHTML = '';

      
      // Rubrik 6
      document.getElementById('monthSelectionList').innerHTML = "";
      document.getElementById('partialConsumptionResult').innerHTML = "";
      document.getElementById('kwhAmount').value = "";
      
      // Rubrik 7: Kostenberechnung 1
      document.getElementById('workPrice').value = "";
      document.getElementById('costResult').value = "";
      document.getElementById('basePrice').value = "";
      document.getElementById('installmentResult').value = "";
      document.getElementById('monthsCount').value = "";
      document.getElementById('totalSum').innerText = "0,00 €";
      
      // Rubrik 7: Kostenberechnung 2
      document.getElementById('workPriceManual').value = "";
      document.getElementById('costResultManual').value = "";
      document.getElementById('basePriceManual').value = "";
      document.getElementById('installmentResultManual').value = "";
      document.getElementById('monthsCountManual').value = "";
      document.getElementById('totalSumManual').innerText = "0,00 €";
      document.getElementById('resetManualBtn').style.display = "none";
      document.getElementById('resetManualHint').innerText = "";
      
      // Rubrik 2,3,4,5
      clearResults();
      calculate();
    
  // Ergänzung: Rubrik 4 Eingabefelder zurücksetzen
  (function(){
    var cb = document.getElementById('useCustomFactors');
    var customOn = !!(cb && cb.checked);
    if(!customOn){
      document.getElementById('brennwert').value = "10";
      document.getElementById('zustandszahl').value = "0.950";
      document.getElementById('factor').value = "";
    }
  })();

  // Ergänzung: Rubrik 5 - Verbrauchsüberschrift ausblenden
  // Ergänzung: Rubrik 6 - Monatsblöcke ausblenden
  document.getElementById('monthBlocksContainer').style.display = "none";

  // Ergänzung: Kostenberechnung 2 - manuelles Eingabefeld leeren
  document.getElementById('kwhAmountManual').value = "";

  // Rubrik 1: Eingabefelder direkt auf 0 oder leer setzen
  document.getElementById('startReading').value = "";
  document.getElementById('endReading').value = "";
  document.getElementById('startDate').value = "";
  document.getElementById('endDate').value = "";

  // Rubrik 1b (zweiter Zeitraum)
  document.getElementById('secondStartDate').value = "";
  document.getElementById('secondEndDate').value = "";
  document.getElementById('secondStartReading').value = "";
  document.getElementById('secondEndReading').value = "";

  // Rubrik 2: Gewichtungsanzeige zurücksetzen
  document.getElementById('gewichtungSumme').innerText = "0";

  // Rubrik 3: m³ Hochrechnung löschen
  document.getElementById('m3Forecast').innerText = "";

  // Rubrik 4: Ergebnisfeld leeren
  document.getElementById('kwhConversionResult').innerText = "";
  document.getElementById('kwhCalculationExplanation').innerText = "";

  // Rubrik 5: Tabelle & Chart zurücksetzen
  document.getElementById('verbrauchsTabelle').innerHTML = "";
  if (window.myChart) { myChart.destroy(); 
  // Rubrik 3: Hochrechnung zurücksetzen
  document.getElementById('m3Forecast').innerText = "";

  // Rubrik 5: Header, Tabelle und Diagramm leeren
  document.getElementById('verbrauchsTabelle').innerHTML = "";
  if (window.myChart) {
    window.myChart.destroy();
    window.myChart = null;
  }

  // Rubrik 7 Kostenberechnung 2: Manuelle Eingabe zurücksetzen
  const manualField = document.getElementById('kwhAmountManual');
  if (manualField) {
    manualField.value = "";
  }
    // Statusindikator zurücksetzen
    const statusEl = document.getElementById('fetchStatus');
    if (statusEl) statusEl.style.backgroundColor = '#ccc';

}

  // Rubrik 6: Monatsliste und Hinweis zurücksetzen
  document.getElementById('monthSelectionList').innerHTML = "";
  document.getElementById('noSelectionHint').style.display = "block";

  // Rubrik 7: Alle Eingabefelder und Summen zurücksetzen
  document.getElementById('kwhAmount').value = "";
  document.getElementById('arbeitspreis').value = "";
  document.getElementById('grundpreis').value = "";
  document.getElementById('anzahlMonate').value = "";
  document.getElementById('ergebnis1').innerText = "";
  document.getElementById('ergebnis2').innerText = "";
  document.getElementById('ergebnis3').innerText = "";
  document.getElementById('kwhAmountManual').value = "";
  document.getElementById('ergebnis4').innerText = "";
  document.getElementById('ergebnis5').innerText = "";
  document.getElementById('ergebnis6').innerText = "";

  // Rubrik 7 Hinweis zurücksetzen
  document.getElementById('cost1Hint').innerText = "( Gesamtverbrauch für alle 12 Monate )";
}
    
    function toggleCostCalc() {
      const content = document.getElementById("costCalcContent");
      const btn = document.getElementById("toggleCostCalcBtn");
      if (content.style.display === "none" || content.style.display === "") {
        content.style.display = "block";
        btn.innerText = "Weitere Berechnungsmöglichkeiten ausblenden";
      } else {
        content.style.display = "none";
        btn.innerText = "Weitere Berechnungsmöglichkeiten anzeigen";
      }
    }
    
    



function toggleWeightSection() {
  const section = document.getElementById("rubrik2");
  const btnA = document.getElementById("toggleWeightBtn");
  const btnB = document.getElementById("toggleWeightBtnB");
  const explanation = document.getElementById('monthWeightExplanation');
  const isHidden = section.style.display === "none" || section.style.display === "";
  if (isHidden) {
    section.style.display = "block";
    if (explanation) explanation.style.display = "block";
    updateMonthWeightList();
    if (btnA) btnA.innerText = "Berechnung der Gewichtungen verbergen";
    if (btnB) btnB.innerText = "Berechnung der Gewichtungen verbergen";
  } else {
    section.style.display = "none";
    if (explanation) explanation.style.display = "none";
    if (btnA) btnA.innerText = "Berechnung der Gewichtungen einblenden";
    if (btnB) btnB.innerText = "Berechnung der Gewichtungen einblenden";
  }
}


function toggleInfo(id) {
      const infoDiv = document.getElementById(id);
      infoDiv.style.display = (infoDiv.style.display === "none" || infoDiv.style.display === "") ? "block" : "none";
    }
    
    function validateRubrik7Dates() { return true; }
    
    const monthWeightsA = {
      '01': 16.224, '02': 13.202, '03': 12.765, '04': 9.102,
      '05': 4.786, '06': 2.382, '07': 0.790, '08': 0.772,
      '09': 3.297, '10': 8.224, '11': 12.680, '12': 15.776
    };
    let currentMonthWeights = {'01':0,'02':0,'03':0,'04':0,'05':0,'06':0,'07':0,'08':0,'09':0,'10':0,'11':0,'12':0};
    const monthNames = {
      '01': 'Januar', '02': 'Februar', '03': 'März', '04': 'April',
      '05': 'Mai', '06': 'Juni', '07': 'Juli', '08': 'August',
      '09': 'September', '10': 'Oktober', '11': 'November', '12': 'Dezember'
    };
    
    // Hilfsfunktion: Monatsname → Zahl
    function monthNameToNumber(name) {
      for (let key in monthNames) {
        if (monthNames[key] === name) {
          return parseInt(key, 10);
        }
      }
      return NaN;
    }
    
    
    
function updateStandardTable() {
  const originalWeightsDiv = document.getElementById('originalWeights');
  const tableSelect = document.getElementById('weightTableSelect').value;
  const headingText = tableSelect === 'A'
    ? "Monatsgewichtungen (Standardwerte)"
    : "Monatsgewichtungen (PLZ-basiert)";
  let html = `<h3>${headingText}</h3><ul>`;
  const orderedMonths = ["01","02","03","04","05","06","07","08","09","10","11","12"];
  orderedMonths.forEach(month => {
    html += `<li>${monthNames[month]}: ${(typeof currentMonthWeights[month] !== "undefined" ? currentMonthWeights[month] : 0)}</li>`;
  });
  html += "</ul>";
  originalWeightsDiv.innerHTML = html;
}

    
    function changeWeightTable() {
    const sel = document.getElementById("weightTableSelect").value;
    const rubrik2b = document.getElementById("rubrik2b");
    if (sel === "plz") {
        // rubrik2b remains hidden until "2b" button is pressed
        rubrik2b.style.display = "none";
    } else {
        rubrik2b.style.display = "none";
    }

      const select = document.getElementById('weightTableSelect');
      currentMonthWeights = monthWeightsA;
      calculate();
    calculateCost();
  if (document.getElementById("weightTableSelect").value === 'A') {
    ['rubrik3','rubrik4','rubrik5','rubrik6','rubrik7'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = 'block';
    });
  }

      if (document.getElementById('originalWeights').style.display === "block") {
        updateStandardTable();
      }
    
    // === Auto-recalc Rubrik 5 custom date with readiness polling ===
    try {
      var cd = document.getElementById('customDateInputRubrik5');
      if (cd && cd.value) {
        (function recalcWhenReady(tries){
          if ((window.rubrik5MonthlyValues && window.rubrik5MonthlyValues.length) && (window.rubrik5StartReading != null)) {
            var evt = new Event('change', { bubbles: true });
            cd.dispatchEvent(evt);
          } else if (tries > 0) {
            setTimeout(function(){ recalcWhenReady(tries-1); }, 0);
          }
        })(10);
      }
    } catch(e) {}
}

function showStandardTable() {
      const originalWeightsDiv = document.getElementById('originalWeights');
      const btn = document.getElementById('showStandardTableBtn');
      if (originalWeightsDiv.style.display === "block") {
        originalWeightsDiv.style.display = "none";
        btn.innerText = "Tabelle anzeigen";
      } else {
        updateStandardTable();
        originalWeightsDiv.style.display = "block";
        btn.innerText = "Tabelle ausblenden";
      }
    }
    
    function calculateMonths() {
      let fromName = document.getElementById('fromMonth').value;
    let toName   = document.getElementById('toMonth').value;
    let from     = monthNameToNumber(fromName);
      let to     = monthNameToNumber(toName);
      let count = (from <= to) ? (to - from + 1) : ((12 - from + 1) + to);
      document.getElementById('monthsCount').value = count;
      calculateInstallments();
      
      let fromManual = parseInt(document.getElementById('fromMonthManual').value, 10);
      let toManual = parseInt(document.getElementById('toMonthManual').value, 10);
      let countManual = (fromManual <= toManual) ? (toManual - fromManual + 1) : ((12 - fromManual + 1) + toManual);
      document.getElementById('monthsCountManual').value = countManual;
      calculateInstallmentsManual();
    }
    
    function isValidDateString(dateString) {
      const parts = dateString.split(".");
      if (parts.length !== 3) return false;
      if (parts[2].length !== 4) return false;
      const day = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10);
      const year = parseInt(parts[2], 10);
      const date = new Date(year, month - 1, day);
      return (date.getFullYear() === year && (date.getMonth() + 1) === month && date.getDate() === day);
    }
    
    function parseDate(dateString) {
      const parts = dateString.split(".");
      return new Date(parseInt(parts[2], 10), parseInt(parts[1], 10) - 1, parseInt(parts[0], 10));
    }
    
    




function validateDateInput(id, errorId) {
  const input = document.getElementById(id);
  const error = document.getElementById(errorId);
  const value = input.value.trim();

  // Zähle Punkte
  const dots = (value.match(/\./g) || []).length;
  const parts = value.split('.');

    // Sonderfall: keine Punkte, aber genau 8 Ziffern (z.B. 30062024) -> Formatfehler
  if (dots === 0 && /^\d{8}$/.test(value)) {
    error.innerText = "Bitte im Format TT.MM.JJJJ eingeben.";
    error.classList.add("visible");
    return;
  }

// 1) Kein Punkt → (noch keine Meldung)
  if (dots === 0) {
    error.innerText = "";
    error.classList.remove("visible");
    return;
  }

  // 2) Genau 1 Punkt
  if (dots === 1) {
    // Wenn nach dem Punkt mehr als 2 Ziffern kommen, ist es eindeutig kein reiner Monat
    if (parts[1].length> 2) {
      error.innerText = "Bitte im Format TT.MM.JJJJ eingeben.";
      error.classList.add("visible");
      return;
    }
    // sonst: unvollständige Eingabe (Tag oder Monat noch im Tippen) → keine Meldung
    error.innerText = "";
    error.classList.remove("visible");
    return;
  }

  // 3) Mehr als 2 Punkte → falsches Format
  if (dots> 2) {
    error.innerText = "Bitte im Format TT.MM.JJJJ eingeben.";
    error.classList.add("visible");
    return;
  }

  // Ab hier dots === 2 → drei Teile vorhanden
  const [d, m, y] = parts;
  // Prüfe, ob Tag und Monat 1–2 Ziffern, Jahr genau 4 Ziffern
  if (!/^\d{1,2}$/.test(d) || !/^\d{1,2}$/.test(m) || !/^\d{4}$/.test(y)) {
    error.innerText = "Bitte im Format TT.MM.JJJJ eingeben.";
    error.classList.add("visible");
    return;
  }

  // Existenz-Check
  const day   = parseInt(d, 10);
  const month = parseInt(m, 10) - 1;
  const year  = parseInt(y, 10);
  const date  = new Date(year, month, day);
  if (
    date.getFullYear() !== year ||
    date.getMonth()    !== month ||
    date.getDate()     !== day
  ) {
    error.innerText = "Ungültiges Datum.";
    error.classList.add("visible");
    return;
  }

  // Clear error if all checks passed
  error.innerText = "";
  error.classList.remove("visible");
}





    
    function toggleExplanationMonths(btn) {
      const container = document.getElementById('partialConsumptionResult');
      const explanations = container.querySelectorAll('.month-block .explanation');
      let anyVisible = false;
      explanations.forEach(exp => { if(exp.style.display === 'block') anyVisible = true; });
      explanations.forEach(exp => { exp.style.display = anyVisible ? 'none' : 'block'; });
      btn.innerText = anyVisible ? "Rechenweg anzeigen" : "Rechenweg ausblenden";
    }


function toggleBlocks(btn) {
  const container = document.getElementById('monthBlocksContainer');
  if (!container) return;
  // Zustand umkehren
  monthBlocksVisible = !monthBlocksVisible;
  // Container & Erklärungen anzeigen/verbergen
  container.style.display = monthBlocksVisible ? 'block' : 'none';
  container.querySelectorAll('.explanation')
           .forEach(e => e.style.display = monthBlocksVisible ? 'block' : 'none');
  // Button-Text synchron halten
  btn.innerText = monthBlocksVisible ? 'Rechenweg ausblenden' : 'Rechenweg anzeigen';
}


    
    function toggleExplanation(elementId, btn) {
      const explanationElement = document.getElementById(elementId);
      if (explanationElement.style.display === 'block') {
        explanationElement.style.display = 'none';
        btn.innerText = "Rechenweg anzeigen";
      } else {
        explanationElement.style.display = 'block';
        btn.innerText = "Rechenweg ausblenden";
      }
    }
    
    function toggleRechenwegInRubrik5(btn) {
      const explanations = document.querySelectorAll('#m3ConversionList .explanation');
      let anyVisible = false;
      explanations.forEach(exp => { if(exp.style.display === 'block') anyVisible = true; });
      explanations.forEach(exp => { exp.style.display = anyVisible ? 'none' : 'block'; });
      btn.innerText = anyVisible ? "Rechenweg anzeigen" : "Rechenweg ausblenden";
    }
    
    // Hier: processSelectedMonths wird nun immer aufgerufen, um die Default-Situation zu berücksichtigen,
    // und am Ende wird zusätzlich calculateMonths() aufgerufen, um das Feld "Anzahl der Monate" zu aktualisieren.
    function processSelectedMonths() {
      const checkboxes = Array.from(document.querySelectorAll('#monthSelectionList input[type="checkbox"]'));
      let monthList = checkboxes.filter(c => c.checked).map(c => c.value);
      if (monthList.length === 0) {
        monthList = checkboxes.map(c => c.value);
      }
      let total = 0;
      let blocks = '';
      monthList.forEach((m, i) => {
        const m3 = parseFloat(document.querySelector(`#month-${m}`).getAttribute('data-m3'));
        const dayInput = document.getElementById(`day-${m}`);
        const days = parseInt(dayInput?.value) || 0;
        const daysInMonth = new Date(new Date().getFullYear(), parseInt(m), 0).getDate();
        let partial, exp;
        if (i === 0 && days> 0) {
          partial = m3 * ((daysInMonth - days + 1) / daysInMonth);
          exp = `(Teil: (${m3.toFixed(3)}/${daysInMonth}) × (${daysInMonth}-${days}+1))`;
        } else if (i === monthList.length - 1 && days> 0) {
          partial = m3 * (days / daysInMonth);
          exp = `(Teil: (${m3.toFixed(3)}/${daysInMonth}) × ${days})`;
        } else {
          partial = m3;
          exp = `(Voll: ${m3.toFixed(3)} m³)`;
        }
        total += partial;
        blocks += `
      <div class="month-block">
        <p>Verbrauch ${monthNames[m]}: ${partial.toFixed(3).replace('.',',')} m³</p>
        ${days> 0 ? `<div class="explanation" style="display:none;">${exp} = ${partial.toFixed(3).replace('.',',')} m³</div>` : ''}
      </div>`;
      });
      const brenn = parseFloat(document.getElementById('brennwert').value.replace(',', '.')) || 10;
      const zust = parseFloat(document.getElementById('zustandszahl').value.replace(',', '.')) || 0.95;
      const totalKwh = total * brenn * zust;
      document.getElementById('kwhAmount').value = totalKwh.toFixed(3);
  const wp = document.getElementById('workPrice');
  if (wp) wp.dispatchEvent(new Event('input'));
      // replace dot with comma for display
      const kwhComma = document.getElementById('kwhAmount').value.replace('.', ',');
      document.getElementById('kwhAmount').value = kwhComma;
      const html = `
    ${blocks}
    <p class="highlighted">
      <strong>Gesamtverbrauch in m³: ${total.toFixed(3).replace('.',',')} m³</strong>
    </p>
    <p class="highlighted">
      <strong>Gesamtverbrauch in kWh: ${totalKwh.toFixed(3).replace('.',',')} kWh</strong>
    </p>`;
      document.getElementById('partialConsumptionResult').innerHTML = html;
      // Aktualisiere statische Gesamtsumme Rubrik 6
      var totalEl = document.getElementById('rubrik6TotalM3Value');
      if (totalEl) { totalEl.innerText = total.toFixed(3).replace('.',','); }
      // Aktualisiere statische kWh Gesamtsumme Rubrik 6
      var kwhEl = document.getElementById('rubrik6TotalKwhValue');
      if (kwhEl) { kwhEl.innerText = totalKwh.toFixed(3).replace('.',','); }

      updateCostCalculationLeftDropdowns(monthList);
      calculateMonths();
    
  // Sichtbarkeit/ Button-Text beibehalten bei Änderungen Rubrik 6
  const blocksBtn = document.querySelector('#rubrik6 button.rechenweg');
  const blocksContainer = document.getElementById('monthBlocksContainer');
  if (blocksContainer) {
    blocksContainer.style.display = monthBlocksVisible ? 'block' : 'none';
    blocksContainer.querySelectorAll('.explanation')
                   .forEach(e => e.style.display = monthBlocksVisible ? 'block' : 'none');
  }
  if (blocksBtn) {
    blocksBtn.innerText = monthBlocksVisible ? 'Rechenweg ausblenden' : 'Rechenweg anzeigen';
  }
}
    
    
    function calculateMonthlyDistribution(m3Hochrechnung, endMonth, endMeter, endYear) {
  var startMeterLocal = endMeter;
      const monthOrder = Array.from({ length: 12 }, (_, i) => (((endMonth - 1 + i) % 12) + 1));
      let cumulativeReading = endMeter;
      let monthlyValues = [];
      let m3ConversionListHtml = "";
      let currentYear = endYear;
      const isConsumptionMode = (window.consumptionMode === true);

      const startMonthIndex = endMonth - 1;
      for (let i = 0; i < 12; i++) {
        const monthIndex = (startMonthIndex + i) % 12;
        const yearOffset = Math.floor((startMonthIndex + i) / 12);
        const monthNum = monthIndex + 1;
        const year = endYear + yearOffset;
        // Insert year heading when crossing into a new calendar year
        if (i === 0 || year !== currentYear) {
          m3ConversionListHtml += `<li class="year-heading">${year}</li>`;
          currentYear = year;
        }

        const monthStr = monthNum.toString().padStart(2, '0');
        const weight = (typeof currentMonthWeights[monthStr] !== "undefined" ? currentMonthWeights[monthStr] : 0);
        const m3ForMonth = (m3Hochrechnung * weight) / 100;
        let eomForecast = null;
        // ---- NEU: Teilmonat-Rechenweg für den ersten (End-)Monat ----
        let extraExplanation = "";
        if (i === 0) {
          const endDateInput = document.getElementById('endDate')?.value || "";
          const startDateInput = document.getElementById('startDate')?.value || "";
          // Erwartetes Format: "DD.MM.YYYY"
          const [dEnd, mEnd, yEnd] = endDateInput.split('.').map(s => parseInt(s, 10));
          const [dStart, mStart, yStart] = startDateInput.split('.').map(s => parseInt(s, 10));
          if (!isNaN(dEnd) && !isNaN(mEnd) && !isNaN(yEnd)) {
            const daysInMonth = new Date(yEnd, mEnd, 0).getDate();
            let coveredDays = dEnd;
            if (yStart === yEnd && mStart === mEnd && !isNaN(dStart)) {
              coveredDays = Math.max(1, dEnd - dStart + 1);
            }
            coveredDays = Math.max(0, Math.min(daysInMonth, coveredDays));
            const restDays = Math.max(0, daysInMonth - coveredDays);
            const coveredWeightPct = weight * (coveredDays / daysInMonth);
            const restWeightPct    = weight * (restDays   / daysInMonth);
            const coveredM3 = (m3Hochrechnung / 100) * coveredWeightPct;
            const restM3    = (m3Hochrechnung / 100) * restWeightPct;
            const meterForecastEOM = (parseFloat(endMeter) || 0) + restM3;
            eomForecast = meterForecastEOM;
            const mm = String(mEnd).padStart(2, '0');
            const ddEnd = String(dEnd).padStart(2, '0');
            const ddEndPlus = String(Math.min(dEnd + 1, daysInMonth)).padStart(2, '0');
            if (restDays > 0 && coveredDays > 0 && coveredDays < daysInMonth) {
            extraExplanation =
              `<div class="explanation" style="display:none; margin-top:10px;">
                 <div><strong>Teilmonat-Aufschlüsselung ${monthNames[monthStr]}</strong></div>
                 <div>Teil (1.–${ddEnd}.${mm}): ${coveredM3.toFixed(3).replace('.', ',')} m³
                   &nbsp;(${m3Hochrechnung.toFixed(3).replace('.', ',')} / 100 × ${weight} × ${coveredDays}/${daysInMonth})</div>
                 <div>Rest (${ddEndPlus}.${mm}–${daysInMonth}.${mm}): ${restM3.toFixed(3).replace('.', ',')} m³
                   &nbsp;(${m3Hochrechnung.toFixed(3).replace('.', ',')} / 100 × ${weight} × ${restDays}/${daysInMonth})</div>
                 <div>Prognose Zählerstand zum ${daysInMonth}.${mm}.:
                   ${(parseFloat(endMeter)||0).toFixed(3).replace('.', ',')} + ${restM3.toFixed(3).replace('.', ',')}
                   = ${meterForecastEOM.toFixed(3).replace('.', ',')} m³</div>
               </div>`;
          }

          }
        }
        // ---- ENDE NEU ----

        monthlyValues.push(m3ForMonth);
        cumulativeReading += m3ForMonth;


// Insert year heading if it changes
        if (i === 0 || year !== currentYear) {
          currentYear = year;
        }

        const displayReading = (i === 0 && eomForecast !== null ? eomForecast : cumulativeReading);


        m3ConversionListHtml += `<li class="m3-conversion-item" data-month="${monthNames[monthStr]}" data-m3="${m3ForMonth.toFixed(3)}">
          ${monthNames[monthStr]}: ${m3ForMonth.toFixed(3).replace('.', ',')} m³${isConsumptionMode ? '' : ',\n          <span class="zaehlerstand">Zählerstand: ' + displayReading.toFixed(3).replace('.', ',') + '</span>'}
          <span class="explanation" style="display:none; margin-top: 10px;">
            (${m3Hochrechnung.toFixed(3).replace('.', ',')} / 100 × ${weight} = ${m3ForMonth.toFixed(3).replace('.', ',')})
          </span>
        ${extraExplanation}
        </li>`;
      }
      refreshChartFromRubrik5();
      window.rubrik5MonthlyValues = monthlyValues;

      window.rubrik5StartReading = startMeterLocal;

      window.rubrik5EndMonth = endMonth;
  window.rubrik5EndYear = endYear;
  return m3ConversionListHtml;
    }
    function updateChart(labels, data) {
      const ctx = document.getElementById("chartContainer").getContext("2d");
      if (myChart !== null) {
        myChart.data.labels = labels;
        myChart.data.datasets[0].data = data;
        myChart.update();
      } else {
        myChart = new Chart(ctx, {
          type: 'bar',
          data: { labels: labels, datasets: [{ label: 'Verbrauch in m³', data: data, backgroundColor: 'rgba(0,123,255,0.5)', borderColor: 'rgba(0,123,255,1)', borderWidth: 1 }] },
          options: { responsive: false, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
      }
    }
    
    function calculateKWh() {
      const m3ForecastText = document.getElementById('m3Forecast')?.innerText.split(': ')[1] || "0";
      const m3Hochrechnung = parseFloat(m3ForecastText.replace(',', '.')) || 0;
      const brennwert = parseFloat(document.getElementById('brennwert').value.replace(',', '.')) || 10;
      const zustandszahl = parseFloat(document.getElementById('zustandszahl').value.replace(',', '.')) || 0.95;
      const factorField = document.getElementById('factor');
      const factor = (factorField && factorField.value.trim() !== "") ? parseFloat(factorField.value.replace(',', '.')) : null;
      let kwhResult;
      if (factor && !isNaN(factor)) {
        kwhResult = m3Hochrechnung * factor;
        document.getElementById('kwhCalculationExplanation').innerHTML = `Rechenweg: ${m3Hochrechnung.toFixed(3).replace('.', ',')} m³ × ${factor} = ${kwhResult.toFixed(3).replace('.', ',')} kWh`;
      } else {
        kwhResult = m3Hochrechnung * brennwert * zustandszahl;
        document.getElementById('kwhCalculationExplanation').innerHTML = `Rechenweg: (${m3Hochrechnung.toFixed(3).replace('.', ',')} m³ × ${brennwert} × ${zustandszahl}) = ${kwhResult.toFixed(3).replace('.', ',')} kWh`;
      }
      document.getElementById('kwhConversionResult').innerText = `Umrechnung in kWh: ${kwhResult.toFixed(3).replace('.', ',')} kWh`;
      defaultKwh = kwhResult;  // Zahl vorhalten
      const kwhStr = kwhResult.toFixed(3);
      const kwhStrComma = kwhStr.replace('.', ',');
      document.getElementById('kwhAmount').value = kwhStrComma;
  const wp = document.getElementById('workPrice');
  if (wp) wp.dispatchEvent(new Event('input'));
      // Feld 1 in Kostenberechnung 1 immer befüllen
      processSelectedMonths();
    }
    
    function calculateCost() {
      const kwhAmount = parseFloat(document.getElementById('kwhAmount').value.replace(',', '.')) || 0;
      const workPrice = parseFloat(document.getElementById('workPrice').value) || 0;
      const cost = (kwhAmount * workPrice / 100).toFixed(3);
      document.getElementById('costResult').value = `${cost.replace('.', ',')} €`;
      calculateTotalSum();
    }
    
    function calculateCostManual() {
      const kwhAmount = parseFloat(document.getElementById('kwhAmountManual').value.replace(',', '.')) || 0;
      const workPrice = parseFloat(document.getElementById('workPriceManual').value) || 0;
      const cost = (kwhAmount * workPrice / 100).toFixed(3);
      document.getElementById('costResultManual').value = `${cost.replace('.', ',')} €`;
      calculateTotalSumManual();
    }
    
    function calculateInstallments() {
      const monthsCount = parseInt(document.getElementById('monthsCount').value) || 0;
      const basePrice = parseFloat(document.getElementById('basePrice').value.replace(',', '.')) || 0;
      const installmentCost = (monthsCount * basePrice).toFixed(3);
      document.getElementById('installmentResult').value = installmentCost.replace('.', ',') + ' €';
      calculateTotalSum();
    }
    
    function calculateTotalSum() {
      const costStr = document.getElementById('costResult').value.replace(',', '.').replace('€', '').trim();
      const cost = parseFloat(costStr) || 0;
      const installmentsStr = document.getElementById('installmentResult').value.replace(',', '.').replace('€', '').trim();
      const installments = parseFloat(installmentsStr) || 0;
      const total = (cost + installments).toFixed(3);
      document.getElementById('totalSum').innerText = total.replace('.', ',') + ' €';
    }
    
    function calculateInstallmentsManual() {
      const monthsCountManual = parseInt(document.getElementById('monthsCountManual').value) || 0;
      const basePriceManual = parseFloat(document.getElementById('basePriceManual').value.replace(',', '.')) || 0;
      const installmentCostManual = (monthsCountManual * basePriceManual).toFixed(3);
      document.getElementById('installmentResultManual').value = installmentCostManual.replace('.', ',') + ' €';
      calculateTotalSumManual();
    }
    
    function calculateTotalSumManual() {
      const costManualStr = document.getElementById('costResultManual').value.replace(',', '.').replace('€', '').trim();
      const costManual = parseFloat(costManualStr) || 0;
      const installmentManualStr = document.getElementById('installmentResultManual').value.replace(',', '.').replace('€', '').trim();
      const installmentManual = parseFloat(installmentManualStr) || 0;
      const totalManual = (costManual + installmentManual).toFixed(3);
      document.getElementById('totalSumManual').innerText = totalManual.replace('.', ',') + ' €';
    }
    
    function toggleDayInputs() {
      const checkboxes = document.querySelectorAll('#monthSelectionList input[type="checkbox"]');
      const checked = Array.from(checkboxes).filter(chk => chk.checked);
      checkboxes.forEach(chk => {
        const dayInput = document.getElementById(`day-input-${chk.value}`);
        dayInput.style.display = (chk.checked && (chk === checked[0] || chk === checked[checked.length - 1])) ? 'inline' : 'none';
      });
    }
    
    function validateDayInput(monthStr) {
      const dayInput = document.getElementById(`day-${monthStr}`);
      const maxDay = new Date(new Date().getFullYear(), parseInt(monthStr), 0).getDate();
      if (dayInput.value !== "" && parseInt(dayInput.value)> maxDay) {
        dayInput.value = maxDay;
        processSelectedMonths();
      }
    }
    
    function printAsPDF() {
      const opt = {
        margin: 1,
        filename: 'Gas-Verbrauchs-Prognose.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(document.body).save();
    }
    
    

    function printRubrik5PDF() {
      var el = document.getElementById('rubrik5');
      if (!el) return;
      const opt = {
        margin: 1,
        filename: 'GasTrend_Rubrik5_Verbrauchsverteilung.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(el).save();
    }

    function printRubrik7PDF() {
      var el = document.getElementById('rubrik7');
      if (!el) return;
      const opt = {
        margin: 1,
        filename: 'GasTrend_Rubrik7_Kostenberechnung.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(el).save();
    }

function calculate() {
  // Hinweis ausblenden, sobald alle vier Pflichtfelder gefüllt sind
  const hintEl = document.getElementById('mainDataHint');
  if (hintEl) {
    const inputsFilled = ['startDate','startMeter','endDate','endMeter'].every(id => {
      const el = document.getElementById(id);
      return el && el.value.trim() !== '';
    });
    hintEl.classList.toggle('stop', inputsFilled);
  }

      const startDateStr = document.getElementById('startDate').value;
      const endDateStr = document.getElementById('endDate').value;
      if (!isValidDateString(startDateStr) || !isValidDateString(endDateStr)) {
        document.getElementById('m3Difference').innerText = "0,000";
        return;
      calculateCost();
      const wp = document.getElementById('workPrice');
  if (wp) wp.dispatchEvent(new Event('input'));
}
    
      const startDate = parseDate(startDateStr);
      const endDate = parseDate(endDateStr);
    
      if (startDate> endDate) {
        document.getElementById('rubrik1Error').innerText = "Das Startdatum darf nicht nach dem Enddatum liegen.";
        document.getElementById('rubrik1Error').classList.add("visible");
        return;
      } else {
        document.getElementById('rubrik1Error').innerText = "";
        document.getElementById('rubrik1Error').classList.remove("visible");
      }

      const today = new Date();
      today.setHours(0,0,0,0);
      if (endDate> today) {
        document.getElementById('endDateError').innerText = "Das Enddatum darf nicht in der Zukunft liegen.";
        document.getElementById('endDateError').classList.add("visible");
        return;
      } else {
        document.getElementById('endDateError').innerText = "";
        document.getElementById('endDateError').classList.remove("visible");
      }
    
      const startMeter = parseFloat(document.getElementById('startMeter').value);
      const endMeter = parseFloat(document.getElementById('endMeter').value);
      window.consumptionMode = (startMeter === 0 && endMeter > 0);
      if (isNaN(startMeter) || isNaN(endMeter)) {
        document.getElementById('rubrik1Error').innerText = "Bitte geben Sie gültige Zahlenwerte für die Gaszählerstände ein.";
        document.getElementById('rubrik1Error').classList.add("visible");
        return;
      }
      if (startMeter> endMeter) {
        document.getElementById('endMeterError').innerText = "Der Startzählerstand darf nicht größer als der Endzählerstand sein.";
        document.getElementById('endMeterError').classList.add("visible");
        return;
      } else {
        document.getElementById('endMeterError').innerText = "";
        document.getElementById('endMeterError').classList.remove("visible");
      }
    
      const mainConsumption = endMeter - startMeter;
      document.getElementById('m3Difference').innerText = mainConsumption.toFixed(3).replace('.', ',');
    
      const diffInMonthsRaw = (endDate.getFullYear() - startDate.getFullYear()) * 12 + (endDate.getMonth() - startDate.getMonth());
      const numMonths = diffInMonthsRaw + 1;
    
      if (numMonths> 12) {
        document.getElementById('dateWarning').innerText = "Hinweis: Die Berechnung ist nicht möglich, weil der eingegebene Zeitraum länger als 12 Monate ist.";
        document.getElementById('dateWarning').classList.add("visible");
        clearResults();
        return;
      } else {
        document.getElementById('dateWarning').innerText = "";
        document.getElementById('dateWarning').classList.remove("visible");
      }
    
      let allSummer = true;
      for (let i = 0; i < numMonths; i++) {
        let month = ((startDate.getMonth() + i) % 12) + 1;
        if (month < 5 || month> 9) { allSummer = false; break; }
      }
      if (allSummer) {
        document.getElementById('zeitraum1Heading').style.display = "block";
        document.getElementById('summerWarning').innerText = "Ihr gewählter Zeitraum enthält nur Sommermonate. Um eine präzisere Hochrechnung zu ermöglichen, können Sie zusätzlich einen Zeitraum mit Wintermonaten erfassen.";
        document.getElementById('summerWarning').classList.add("visible");
        window._shouldSuggestPeriod2 = true; var __btn=document.getElementById('toggleRubrik1bBtn'); if(__btn){ __btn.style.display='inline-block'; __btn.textContent='2. Zeitraum einblenden'; }
      } else {
        document.getElementById('zeitraum1Heading').style.display = "none";
        document.getElementById('summerWarning').innerText = "";
        document.getElementById('summerWarning').classList.remove("visible");
      }
    
      let mainWeightSum = 0;
      let monthWeightExplanation = "";
      let monthOrder = [];
      for (let i = 0; i < numMonths; i++) {
        let monthIndex = (startDate.getMonth() + i) % 12 + 1;
        monthOrder.push(monthIndex.toString().padStart(2, '0'));
      }
      if (numMonths === 1) {
        let monthStr = monthOrder[0];
        let standardWeight = (typeof currentMonthWeights[monthStr] !== "undefined" ? currentMonthWeights[monthStr] : 0);
        let daysInMonth = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0).getDate();
        let daysCount = endDate.getDate() - startDate.getDate() + 1;
        let adjustedWeight = (standardWeight / daysInMonth) * daysCount;
        mainWeightSum += adjustedWeight;
        monthWeightExplanation += monthNames[monthStr] + ": (" + standardWeight + " / " + daysInMonth + ") × " + daysCount + " Resttage = " + adjustedWeight.toFixed(3) + "<br>";
      } else {
        monthOrder.forEach((monthStr, index) => {
          let standardWeight = (typeof currentMonthWeights[monthStr] !== "undefined" ? currentMonthWeights[monthStr] : 0);
          let adjustedWeight = standardWeight;
          if (index === 0) {
            let daysInMonth = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0).getDate();
            let daysCount = daysInMonth - startDate.getDate() + 1;
            adjustedWeight = (standardWeight / daysInMonth) * daysCount;
            monthWeightExplanation += monthNames[monthStr] + " (Teilmonat): (" + standardWeight + " / " + daysInMonth + ") × " + daysCount + " Resttage = " + adjustedWeight.toFixed(3) + "<br>";
          } else if (index === monthOrder.length - 1) {
            let daysInMonth = new Date(endDate.getFullYear(), endDate.getMonth() + 1, 0).getDate();
            let daysCount = endDate.getDate();
            if(daysCount === daysInMonth) {
              adjustedWeight = standardWeight;
              monthWeightExplanation += monthNames[monthStr] + ": " + standardWeight + "<br>";
            } else {
              adjustedWeight = (standardWeight / daysInMonth) * daysCount;
              monthWeightExplanation += monthNames[monthStr] + " (Teilmonat): (" + standardWeight + " / " + daysInMonth + ") × " + daysCount + "  = " + adjustedWeight.toFixed(3) + "<br>";
            }
          } else {
            monthWeightExplanation += monthNames[monthStr] + ": " + standardWeight + "<br>";
          }
          mainWeightSum += adjustedWeight;
        });
      }
    
      let secondConsumption = 0;
      let secondWeightSum = 0;
      const startDate2Str = document.getElementById('startDate2').value;
      const endDate2Str = document.getElementById('endDate2').value;
      const startMeter2Str = document.getElementById('startMeter2').value;
      const endMeter2Str = document.getElementById('endMeter2').value;
      let secondHasNonSummer = false;
      let secondExplanation = "";
      if (startDate2Str.trim() !== "" && endDate2Str.trim() !== "" && startMeter2Str.trim() !== "" && endMeter2Str.trim() !== "") {
          if (isValidDateString(startDate2Str) && isValidDateString(endDate2Str)) {
            const startDate2 = parseDate(startDate2Str);
            const endDate2 = parseDate(endDate2Str);
            if (startDate2 <= endDate2) {
              const diffInMonths2 = (endDate2.getFullYear() - startDate2.getFullYear()) * 12 + (endDate2.getMonth() - startDate2.getMonth()) + 1;
              for (let i = 0; i < diffInMonths2; i++) {
                let currentMonth = ((startDate2.getMonth() + i) % 12) + 1;
                if (currentMonth < 5 || currentMonth> 9) { secondHasNonSummer = true; break; }
              }
              if (!secondHasNonSummer) {
                document.getElementById('winterWarning').innerText = "Der zweite Zeitraum enthält keine zusätzlichen Wintermonate und wird daher nicht berücksichtigt.";
                document.getElementById('winterWarning').classList.add("visible");
              } else {
                document.getElementById('winterWarning').innerText = "";
                document.getElementById('winterWarning').classList.remove("visible");
                const consumption2 = parseFloat(endMeter2Str) - parseFloat(startMeter2Str);
                document.getElementById('m3Difference2').innerText = consumption2.toFixed(3).replace('.', ',');for (let i = 0; i < diffInMonths2; i++) {
                  let currentMonth = ((startDate2.getMonth() + i) % 12) + 1;
                  if (currentMonth>= 5 && currentMonth <= 9) continue;
                  let monthStr = currentMonth.toString().padStart(2, '0');
                  let standardWeight = (typeof currentMonthWeights[monthStr] !== "undefined" ? currentMonthWeights[monthStr] : 0);
                  let adjustedWeight = standardWeight;
                  let daysInMonth, daysCount;
                  if (diffInMonths2 === 1) {
                    daysInMonth = new Date(startDate2.getFullYear(), startDate2.getMonth() + 1, 0).getDate();
                    daysCount = endDate2.getDate() - startDate2.getDate() + 1;
                    adjustedWeight = (standardWeight / daysInMonth) * daysCount;
                    secondExplanation += monthNames[monthStr] + " (Teilmonat): (" + standardWeight + " / " + daysInMonth + ") × " + daysCount + " Resttage = " + adjustedWeight.toFixed(3) + "<br>";
                  } else {
                    if (i === 0) {
                      daysInMonth = new Date(startDate2.getFullYear(), startDate2.getMonth() + 1, 0).getDate();
                      daysCount = daysInMonth - startDate2.getDate() + 1;
                      adjustedWeight = (standardWeight / daysInMonth) * daysCount;
                      secondExplanation += monthNames[monthStr] + " (Teilmonat): (" + standardWeight + " / " + daysInMonth + ") × " + daysCount + " Resttage = " + adjustedWeight.toFixed(3) + "<br>";
                    } else if (i === diffInMonths2 - 1) {
                      daysInMonth = new Date(endDate2.getFullYear(), endDate2.getMonth() + 1, 0).getDate();
                      daysCount = endDate2.getDate();
                      if(daysCount === daysInMonth) {
                        adjustedWeight = standardWeight;
                        secondExplanation += monthNames[monthStr] + ": " + standardWeight + "<br>";
                      } else {
                        adjustedWeight = (standardWeight / daysInMonth) * daysCount;
                        secondExplanation += monthNames[monthStr] + " (Teilmonat): (" + standardWeight + " / " + daysInMonth + ") × " + daysCount + " Resttage = " + adjustedWeight.toFixed(3) + "<br>";
                      }
                    } else {
                      secondExplanation += monthNames[monthStr] + ": " + standardWeight + "<br>";
                    }
                  }
                  secondWeightSum += adjustedWeight;
                }
                const startMeter2 = parseFloat(startMeter2Str);
                const endMeter2 = parseFloat(endMeter2Str);
                if (!isNaN(startMeter2) && !isNaN(endMeter2) && startMeter2 <= endMeter2) {
                  secondConsumption = endMeter2 - startMeter2;
                }
              }
            }
          }
      }
      // Dynamische Überschriften anpassen
      let fullWeightExplanation;
      
if (secondHasNonSummer) {
  fullWeightExplanation = `<div class="weight-frame"><strong style="display:block; margin-bottom:0.5em;">Gewichtungs-Aufschlüsselung Zeitraum 1:</strong><br>${monthWeightExplanation}<br><strong>Summe: ${mainWeightSum.toFixed(3)}</strong><br></div>`;
  fullWeightExplanation += `<div class="weight-frame"><strong style="display:block; margin-top:1em; margin-bottom:0.5em;">Gewichtungs-Aufschlüsselung Zeitraum 2:</strong><br>${secondExplanation}<br><strong>Summe: ${secondWeightSum.toFixed(3)}</strong><br></div>`;
} else {
  fullWeightExplanation = `<div>` + monthWeightExplanation + `</div>`;
}

document.getElementById('monthWeightExplanation').innerHTML = fullWeightExplanation;

      document.getElementById('totalWeightSum').innerHTML = '<b>' + (mainWeightSum + secondWeightSum).toFixed(3) + '</b>';
          // Populate Rubrik 2: Monate gruppiert nach Jahr
          const monthWeightList = document.getElementById('monthWeightList');
          monthWeightList.innerHTML = '';
          let currentYear = null;
          for (let i = 0; i < numMonths; i++) {
            const monthDate = new Date(startDate.getFullYear(), startDate.getMonth() + i, 1);
            const year = monthDate.getFullYear();
            const monthStr = (monthDate.getMonth() + 1).toString().padStart(2,'0');
            if (year !== currentYear) {
              currentYear = year;
            }
            // Berechnung Teilgewichtung analog Rechenweg
            const monthStart = new Date(year, monthDate.getMonth(), 1);
            const monthEnd = new Date(year, monthDate.getMonth() + 1, 0);
            const overlapStart = (year === startDate.getFullYear() && monthDate.getMonth() === startDate.getMonth()) ? startDate : monthStart;
            const overlapEnd = (year === endDate.getFullYear() && monthDate.getMonth() === endDate.getMonth()) ? endDate : monthEnd;
            const daysCount = (overlapEnd - overlapStart) / (1000 * 60 * 60 * 24) + 1;
            const daysInMonth = (monthEnd - monthStart) / (1000 * 60 * 60 * 24) + 1;
            const fullWeight = (typeof currentMonthWeights[monthStr] !== "undefined" ? currentMonthWeights[monthStr] : 0);
            const partialWeight = ((fullWeight / daysInMonth) * daysCount).toFixed(3).replace('.', ',');
            monthWeightList.insertAdjacentHTML('beforeend', `<li>${monthNames[monthStr]}: ${partialWeight}</li>`);
          }
    
      const combinedConsumption = mainConsumption + secondConsumption;
      const combinedWeightSum = mainWeightSum + secondWeightSum;
      const m3Hochrechnung = (combinedConsumption / combinedWeightSum) * 100;
      document.getElementById('m3Forecast').innerText = `Hochrechnung: ${m3Hochrechnung.toFixed(3).replace('.', ',')} m³`;
    
      
      // Gruppierter Rechenweg nach Jahr für Rubrik 3
      // Monatliche Gewichtserklärungen als Array:
// für Rubrik 3: Überschriften für Zeiträume anpassen

const cleaned = fullWeightExplanation
    .replace(/<div class="weight-frame">/g, '')
    .replace(/<\/div>/g, '');
let m3WeightStr = cleaned
    .replace(/Gewichtungs-Aufschlüsselung Zeitraum 1/, 'Aufschlüsselung des Zeitraums 1')
    .replace(/Gewichtungs-Aufschlüsselung Zeitraum 2/, 'Aufschlüsselung des Zeitraums 2');
const detaill = m3WeightStr.split('<br>').filter(e => e.trim());
let grouped = '<strong>Detaillierte Aufschlüsselung:</strong>';

// Period 1 entries
grouped += '<div class="period1-frame"><ul>';
let inPeriod2 = false;
detaill.forEach(entry => {
  if (entry.includes('Aufschlüsselung des Zeitraums 2')) {
    // Close period1
    grouped += '</ul></div>';
    // Open period2
    grouped += '<div class="period2-frame"><ul>';
    inPeriod2 = true;
  }
  grouped += `<li>${entry}</li>`;
});
if (!inPeriod2) {
  grouped += '</ul></div>';
} else {
  grouped += '</ul></div>';
}

// Append summary paragraphs
// Compact view if only one period is used (no 2nd consumption)
if ((secondConsumption || 0) <= 0) {
  grouped += `<p><strong>Verbrauch:</strong> ${mainConsumption.toFixed(3).replace('.', ',')} m³</p>`;
  grouped += `<p><strong>Gewichtssumme:</strong> ${combinedWeightSum.toFixed(3)}</p>`;
  grouped += `<p><strong>Hochrechnung:</strong> ${m3Hochrechnung.toFixed(3).replace('.', ',')} m³</p>`;
} else {
  grouped += `<p>Verbrauch Zeitraum 1 = ${mainConsumption.toFixed(3).replace('.', ',')} m³</p>`;
  grouped += `<p>Verbrauch Zeitraum 2 = ${secondConsumption.toFixed(3).replace('.', ',')} m³</p>`;
  grouped += `<p>Gesamtverbrauch = ${combinedConsumption.toFixed(3).replace('.', ',')} m³</p>`;
  grouped += `<p>Gewichtssumme = ${combinedWeightSum.toFixed(3)}</p>`;
  grouped += `<p>Hochrechnung = ${m3Hochrechnung.toFixed(3).replace('.', ',')} m³</p>`;
}
grouped += `<div class="rechenweg-box"><p style="font-style:italic;">Rechenweg Hochrechnung:</p><ul>`;
grouped += `<li>${combinedConsumption.toFixed(3).replace('.', ',')} ÷ ${combinedWeightSum.toFixed(3)} = ${(combinedConsumption/combinedWeightSum).toFixed(5).replace('.', ',')}</li>`;
grouped += `<li>${(combinedConsumption/combinedWeightSum).toFixed(5).replace('.', ',')} × 100 = ${(combinedConsumption/combinedWeightSum * 100).toFixed(3).replace('.', ',')} m³</li>`;
grouped += `</ul></div>`;

document.getElementById('m3ForecastExplanation').innerHTML = grouped;

    
      calculateKWh();
      document.getElementById("projectedM3Value").innerText = "(" + m3Hochrechnung.toFixed(3).replace(".", ",") + " m³)";
      document.getElementById('m3ConversionList').innerHTML = calculateMonthlyDistribution(
        m3Hochrechnung,
        endDate.getMonth() + 1,
        endMeter,
        endDate.getFullYear()
      );
    
      let monthSelectionListHtml = '';
      let lastYear = null;
      for (let i = 0; i < 12; i++) {
        const dt = new Date(endDate.getFullYear(), endDate.getMonth() + i, 1);
        const year = dt.getFullYear();
        if (year !== lastYear) {
          lastYear = year;
        }
        let month = ((endDate.getMonth() + i) % 12) + 1;
        let monthStr = month.toString().padStart(2, '0');
        let m3ForMonth = (m3Hochrechnung * (typeof currentMonthWeights[monthStr] !== "undefined" ? currentMonthWeights[monthStr] : 0)) / 100;
        monthSelectionListHtml += `<li>
          <input type="checkbox" id="month-${monthStr}" value="${monthStr}" data-m3="${m3ForMonth}"
                 onchange="toggleDayInputs(); processSelectedMonths(); toggleNoSelectionHint(); toggleCost1Hint(); toggleCost1Hint();">
          ${monthNames[monthStr]}: ${m3ForMonth.toFixed(3).replace('.', ',')} m³
          <span class="day-input" id="day-input-${monthStr}">
            <label for="day-${monthStr}">Tag:</label>
            <input type="number" id="day-${monthStr}" min="1" max="31"
                   onblur="validateDayInput('${monthStr}');" oninput="processSelectedMonths();">
          </span>
        </li>`;
      }
      document.getElementById('monthSelectionList').innerHTML = monthSelectionListHtml;
      processSelectedMonths(); toggleNoSelectionHint(); toggleCost1Hint();
    }
  </script><script>
  // Validierung für Rubrik 1b (Zweiter Zeitraum)
  function validateRubrik1b() {
    const errDate = document.getElementById('rubrik1bError');
    const errMeter = document.getElementById('meterError2');
    // Reset messages and difference
    errDate.innerText = ''; errDate.classList.remove('visible');
    errMeter.innerText = ''; errMeter.classList.remove('visible');
    
    // Check if fields are empty
    const d1 = document.getElementById('startDate2').value.trim();
    const d2 = document.getElementById('endDate2').value.trim();
    const m1val = document.getElementById('startMeter2').value.trim();
    const m2val = document.getElementById('endMeter2').value.trim();
    if (!d1 || !d2 || !m1val || !m2val) {
      
  document.getElementById('m3Difference2').innerText = '0,000';
      if (typeof updateMonthWeightList === 'function'){ try{ updateMonthWeightList(); }catch(e){} }
      if (typeof calculate === 'function'){ try{ calculate(); }catch(e){} }
      return;
updateMonthWeightList();
return;
      if (typeof calculate === 'function'){ try{ calculate(); }catch(e){} }
}

    // Date validity and order
    if (isValidDateString(d1) && isValidDateString(d2)) {
      const sd = parseDate(d1);
      const ed = parseDate(d2);
      if (sd> ed) {
        errDate.innerText = 'Das Startdatum darf nicht nach dem Enddatum liegen.';
        errDate.classList.add('visible');
        return;
      }
    }
    // Meter values validity and order
    const m1 = parseFloat(m1val);
    const m2 = parseFloat(m2val);
    if (isNaN(m1) || isNaN(m2)) {
      errMeter.innerText = 'Bitte gültige Zahlen für Zählerstände eingeben.';
      errMeter.classList.add('visible');
      return;
    }
    if (m1> m2) {
      errMeter.innerText = 'Der Startzählerstand darf nicht größer als der Endzählerstand sein.';
      errMeter.classList.add('visible');
      return;
    }
    // All good: compute and display difference
    document.getElementById('m3Difference2').innerText = (m2 - m1).toFixed(3).replace('.', ',');
  }
  </script><script>
// Separater Logikblock NUR für Rubrik 1b
function validateRubrik1b() {
  const errDate = document.getElementById('rubrik1bError');
  const errMeter = document.getElementById('meterError2');
  errDate.innerText = ''; errDate.classList.remove('visible');
  errMeter.innerText = ''; errMeter.classList.remove('visible');
  document.getElementById('m3Difference2').innerText = '0,000';

  const d1 = document.getElementById('startDate2').value.trim();
  const d2 = document.getElementById('endDate2').value.trim();
  const m1val = document.getElementById('startMeter2').value.trim();
  const m2val = document.getElementById('endMeter2').value.trim();

  if (d1 && d2) {
    if (isValidDateString(d1) && isValidDateString(d2)) {
      const sd = parseDate(d1);
      const ed = parseDate(d2);
      if (sd> ed) {
        errDate.innerText = 'Das Startdatum darf nicht nach dem Enddatum liegen.';
        errDate.classList.add('visible');
        
  updateMonthWeightList();
return;
      }
    }
  }

  if (!m1val || !m2val) return;

  const m1 = parseFloat(m1val);
  const m2 = parseFloat(m2val);
  if (isNaN(m1) || isNaN(m2)) {
    errMeter.innerText = 'Bitte gültige Zahlen für Zählerstände eingeben.';
    errMeter.classList.add('visible');
    return;
  }
  if (m1> m2) {
    errMeter.innerText = 'Der Startzählerstand darf nicht größer als der Endzählerstand sein.';
    errMeter.classList.add('visible');
    return;
  }

  document.getElementById('m3Difference2').innerText = (m2 - m1).toFixed(3).replace('.', ',');
  // Automatische Neuberechnung nach Änderungen im 2. Zeitraum
  calculate();
      // Automatisch kWh neu berechnen und Kostenfeld befüllen
      calculateKWh();
    }

function toggleNoSelectionHint() {
  const hint = document.getElementById('noSelectionHint');
  const anyChecked = Array.from(
    document.querySelectorAll('#monthSelectionList input[type="checkbox"]')
  ).some(chk => chk.checked);
  hint.style.display = anyChecked ? 'none' : 'block';
}

function toggleCost1Hint() {
  const hint = document.getElementById('cost1Hint');
  const anyChecked = Array.from(
    document.querySelectorAll('#monthSelectionList input[type="checkbox"]')
  ).some(chk => chk.checked);
  hint.innerText = anyChecked ? '( der ausgewählten Monate )' : '( Gesamtverbrauch für alle 12 Monate )';
}

    function resetAll() {
  // Rubriken 3-7 wieder ausblenden
  ['rubrik3','rubrik4','rubrik5','rubrik6','rubrik7'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
  // Rubrik 5 & 6: Platzhalter setzen
  var projectedM3 = document.getElementById('projectedM3Value');
  if (projectedM3) projectedM3.innerText = "(…)";
  var totalM3El  = document.getElementById('rubrik6TotalM3Value');
  var totalKwhEl = document.getElementById('rubrik6TotalKwhValue');
  if (totalM3El)  totalM3El.innerText  = "(…)";
  if (totalKwhEl) totalKwhEl.innerText = "(…)";
  // Zugehörige Summen/Caches invalidieren
  window.rubrik5MonthlyValues = null;
  window.rubrik5StartReading  = null;
  window.rubrik5EndMonth      = null;
  window.rubrik5EndYear       = null;

    // Hinweistext neben dem Kreis leeren
    var msgEl = document.getElementById('fetchMsg');
    if (msgEl) msgEl.innerText = '';

    
    // Rubrik 5: Custom-Datum-Feld und Anzeigen zurücksetzen
    var cd = document.getElementById('customDateInputRubrik5');
    if (cd) cd.value = '';
    var reading = document.getElementById('customDateReading');
    if (reading) reading.innerText = '';
    var exp = document.getElementById('customDateExplanation');
    if (exp) exp.innerText = '';
    var err = document.getElementById('customDateError');
    if (err) { err.innerText = ''; err.classList.remove('visible'); }
// Manuelles kWh-Eingabefeld zurücksetzen
    document.getElementById('kwhAmountManual').value = '';

    // Felder 'Abschläge von', 'Abschläge bis' und 'Monate Count' (manuell) zurücksetzen
    document.getElementById('fromMonthManual').value = '';
    document.getElementById('toMonthManual').value = '';
    document.getElementById('monthsCountManual').value = '';

    // Felder 'Abschläge von', 'Abschläge bis' und 'Monate Count' zurücksetzen
    document.getElementById('fromMonth').value = '';
    document.getElementById('toMonth').value = '';
    document.getElementById('monthsCount').value = '';

      // Rubrik 1
      document.getElementById('startDate').value = "";
      document.getElementById('endDate').value = "";
      document.getElementById('startMeter').value = "";
      document.getElementById('endMeter').value = "";
      document.getElementById('m3Difference').innerText = "0,000";
      document.getElementById('rubrik1Error').innerText = "";
      document.getElementById('dateWarning').innerText = "";
      document.getElementById('summerWarning').innerText = "";

      // Rubrik 1b
      document.getElementById('startDate2').value = "";
      document.getElementById('endDate2').value = "";
      document.getElementById('startMeter2').value = "";
      document.getElementById('endMeter2').value = "";
      document.getElementById('m3Difference2').innerText = "0,000";
      document.getElementById('winterWarning').innerText = "";
      document.getElementById('winterWarning').classList.remove("visible");
      document.getElementById('zweiterZeitraum').style.display = "none";
      // Buttons in Rubrik 1 und 1b zurücksetzen
      const btn1 = document.getElementById('toggleWeightBtn');
      if (btn1) btn1.innerText = 'Berechnung der Gewichtungen einblenden';
      const btn2 = document.querySelector('#zweiterZeitraum button.rechenweg');
      if (btn2) btn2.innerText = 'Berechnung der Gewichtungen einblenden';
      // Rubrik 2
      const rub2 = document.getElementById('rubrik2');
      if (rub2) rub2.style.display = 'none';
      const wtSelect = document.getElementById('weightTableSelect');
      if (wtSelect) wtSelect.value = 'A';
      const monthList = document.getElementById('monthWeightList');
      if (monthList) monthList.innerHTML = '';
      const wtExp = document.getElementById('monthWeightExplanation');
      if (wtExp) { wtExp.innerHTML = ''; wtExp.classList.remove('visible'); }
      // Rubrik 3
      document.getElementById('m3Forecast').innerText = "";
      document.getElementById('m3ForecastExplanation').innerHTML = "";
      // Rubrik 4
      document.getElementById('kwhConversionResult').innerText = "";
      document.getElementById('kwhCalculationExplanation').innerHTML = "";
      // Rubrik 5
      
      document.getElementById('m3ConversionList').innerHTML = "";
      if (myChart) { myChart.destroy(); myChart = null; }
      // Rubrik 6
      document.getElementById('monthSelectionList').innerHTML = "";
      document.getElementById('partialConsumptionResult').innerHTML = "";
      document.getElementById('monthBlocksContainer').style.display = 'none';
      document.getElementById('kwhAmount').value = "";

      // Rubrik 7
      ['workPrice','costResult','basePrice','installmentResult','monthsCount'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.value = '';
      });
      ['workPriceManual','costResultManual','basePriceManual','installmentResultManual','monthsCountManual'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.value = '';
      });
      document.getElementById('totalSum').innerText = "0,00 €";
      document.getElementById('totalSumManual').innerText = "0,00 €";

      clearResults();
      calculate();
    }

</script><script>
// Hervorhebung der Ergebniswerte in Rubrik 3 nach Rendern

(?:\.\d{3})*(?:,\d+)?\s*m³)/g,
      '$1<span class="result">$2</span>'
    );
    // Wrap ohne m³
    expl.innerHTML = expl.innerHTML.replace(
      /(=\s*)(\d{1,3}(?:\.\d{3})*(?:,\d+)?)(?=\s|<|$)/g,
      '$1<span class="result">$2</span>'
    );
  });
}


// Direkt nach Laden und Umschalten des Rechenwegs ausführen
document.addEventListener('DOMContentLoaded', highlightRubrik3Results);
const origToggle = window.toggleExplanation;
window.toggleExplanation = function(id, btn) {
  origToggle(id, btn);
  if (id === 'm3ForecastExplanation')};
</script><script>
// Fett-Darstellung aller m³-Ergebnisse in Rubrik 3 Aufschlüsselung
(?:\.\d{3})*(?:,\d+)?\s*m³)/g,
    '$1<span class="result">$2</span>'
  );
}
document.addEventListener('DOMContentLoaded', highlightRubrik3Results);
const origToggle = window.toggleExplanation;
window.toggleExplanation = function(id, btn) {
  origToggle(id, btn);
  if (id === 'm3ForecastExplanation') {}
};
</script><script>
document.addEventListener('DOMContentLoaded', function() {
  var btn = document.getElementById('example1');
  btn.addEventListener('click', function() {
    const savedState = saveRubrik6State();
    // Beispiel mit Winter- UND Sommermonaten
        document.getElementById('startDate').value = '12.06.2024';
        document.getElementById('startMeter').value = '1000';
        document.getElementById('endDate').value   = '15.10.2024';
        document.getElementById('endMeter').value  = '1415';
    validateDateInput('startDate','startDateError');
    validateDateInput('endDate','endDateError');
    
        // Reset second period when switching to Beispiel 1
        document.getElementById('zweiterZeitraum').style.display = 'none';
        ['startDate2','startMeter2','endDate2','endMeter2'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('m3Difference2').textContent = '';
calculate();
    restoreRubrik6State(savedState);
  });
});
</script><script>
document.addEventListener('DOMContentLoaded', function() {
  var btn2 = document.getElementById('example2');
  btn2.addEventListener('click', function() {
    const savedState = saveRubrik6State();
    // Zeitraum 1: Sommermonate
    document.getElementById('startDate').value = '12.06.2024';
    document.getElementById('startMeter').value = '1934';
    document.getElementById('endDate').value   = '16.08.2024';
    document.getElementById('endMeter').value  = '2097';
    // Zeitraum 2: Sommer + Winter
    document.getElementById('startDate2').value = '03.08.2023';
    document.getElementById('startMeter2').value = '900';
        document.getElementById('endDate2').value  = '15.04.2024';
    document.getElementById('endMeter2').value  = '1743';
    // Reveal second period section
    document.getElementById('zweiterZeitraum').style.display = 'block';
    // Validate and calculate
    validateDateInput('startDate','startDateError');
    validateDateInput('endDate','endDateError');
    validateDateInput('startDate2','startDate2Error');
    validateDateInput('endDate2','endDate2Error');
    calculate();
    // Validate second period to update m3Difference2 and warnings
    if (typeof validateRubrik1b === 'function') validateRubrik1b();
    restoreRubrik6State(savedState);
  });
});
</script><script>
// Hilfsfunktion: alle Monate zwischen zwei Daten (einschließlich)
function getMonthsBetween(start, end) {
    const months = [];
    let cur = new Date(start.getFullYear(), start.getMonth(), 1);
    while (cur <= end) {
        months.push(cur.getMonth() + 1);
        cur.setMonth(cur.getMonth() + 1);
    }
    return months;
}

// Aktualisiert die Monatsliste in Rubrik 2 mit Überschriften für beide Zeiträume
function updateMonthWeightList() {
    const ul = document.getElementById('monthWeightList');
    ul.innerHTML = '';
    // Zeitraum 1
    const sd1 = parseDate(document.getElementById('startDate').value);
    const ed1 = parseDate(document.getElementById('endDate').value);
    if (isValidDateString(document.getElementById('startDate').value) && isValidDateString(document.getElementById('endDate').value)) {
        ul.insertAdjacentHTML('beforeend', '<li class="year-heading">Zeitraum 1</li>');
        getMonthsBetween(sd1, ed1).forEach(m => {
            const key = String(m).padStart(2, '0');
            ul.insertAdjacentHTML('beforeend',
              `<li>${monthNames[key]}: ${(typeof currentMonthWeights[key] !== "undefined" ? currentMonthWeights[key] : 0)}</li>`
            );
        });
    }
    // Zeitraum 2, falls eingeblendet
    const sec = document.getElementById('zweiterZeitraum');
    if (sec.style.display !== 'none') {
        const sd2 = parseDate(document.getElementById('startDate2').value);
        const ed2 = parseDate(document.getElementById('endDate2').value);
        const m1v = (document.getElementById('startMeter2').value || '').trim();
        const m2v = (document.getElementById('endMeter2').value || '').trim();
        if (isValidDateString(document.getElementById('startDate2').value)
            && isValidDateString(document.getElementById('endDate2').value)
            && m1v !== '' && m2v !== '') {
            ul.insertAdjacentHTML('beforeend', '<li class="year-heading">Zeitraum 2</li>');
            getMonthsBetween(sd2, ed2).forEach(m => {
                const key = String(m).padStart(2, '0');
                ul.insertAdjacentHTML('beforeend',
                  `<li>${monthNames[key]}: ${(typeof currentMonthWeights[key] !== "undefined" ? currentMonthWeights[key] : 0)}</li>`
                );
            });
        }
    }
}

// Override Show-Table button
document.addEventListener('DOMContentLoaded', () => {
    // Beispiel1: nur erster Zeitraum
    document.getElementById('example1').addEventListener('click', () => { document.body.classList.remove('hasPeriod2');
        document.getElementById('zweiterZeitraum').style.display = 'none';
        updateMonthWeightList();
    
    // Dispatch input events to trigger A-basis logic
    ['startDate','startMeter','endDate','endMeter'].forEach(id => {
      const el = document.getElementById(id);
      if(el) el.dispatchEvent(new Event('input'));
    });
});
    // Beispiel2: beide Zeiträume sichtbar
    document.getElementById('example2').addEventListener('click', () => { document.body.classList.add('hasPeriod2');
      const periodTwo = document.getElementById('zweiterZeitraum');
      const rubrik2 = document.getElementById('rubrik2');

      // Rubrik 1b einblenden und Liste aktualisieren
      periodTwo.style.display = 'block';
      updateMonthWeightList();

      
    // Dispatch input events to trigger A-basis logic
    ['startDate','startMeter','endDate','endMeter'].forEach(id => {
      const el = document.getElementById(id);
      if(el) el.dispatchEvent(new Event('input'));
    });
// Button-Text an Sichtbarkeitszustand von Rubrik 2 anpassen
      const isVisible = window.getComputedStyle(rubrik2).display !== 'none';
      const label = isVisible
        ? 'Berechnung der Gewichtungen ausblenden'
        : 'Berechnung der Gewichtungen einblenden';

      document.getElementById('toggleWeightBtn').innerText = label;
      const btn2 = periodTwo.querySelector('button.rechenweg');
      if (btn2) btn2.innerText = label;
    });

    const showBtn = document.getElementById('showStandardTableBtn');
    showBtn.addEventListener('click', () => {
        updateStandardTable();
        updateMonthWeightList();
    });
    const toggleBtn = document.getElementById('toggleWeightBtn');
    toggleBtn.addEventListener('click', updateMonthWeightList);
});
</script><script>
function checkToggleButtonVisibility() {
    const btn = document.getElementById('toggleWeightBtn');
    const z2 = document.getElementById('zweiterZeitraum');
    if (z2 && z2.style.display !== 'none') {
        btn.style.display = 'none';
    } else {
        btn.style.display = '';
    }
}
document.addEventListener('DOMContentLoaded', () => {
    checkToggleButtonVisibility();
    document.getElementById('example1').addEventListener('click', checkToggleButtonVisibility);
    document.getElementById('example2').addEventListener('click', checkToggleButtonVisibility);
    document.getElementById('resetButton').addEventListener('click', () => { document.body.classList.remove('hasPeriod2');
        setTimeout(checkToggleButtonVisibility, 100); // nach Reset-Logik
    });
});
</script><script>
// Handler for custom date input in Rubrik 5
document.addEventListener('DOMContentLoaded', function() {
  var customDate = document.getElementById('customDateInputRubrik5');
  if (!customDate) return;
  
customDate.addEventListener('change', function() {
    
    // Validate: custom date must not be before end date in Rubrik 1
    var endDateInput = document.getElementById('endDate');
    var endDateParts = endDateInput.value.split('.');
    var endDateObj = new Date(parseInt(endDateParts[2],10), parseInt(endDateParts[1],10)-1, parseInt(endDateParts[0],10));
    var customDateObj = new Date(this.value);
    // If custom date equals end date, show the exact end reading
    if (customDateObj.getTime() === endDateObj.getTime()) {
      var formattedDate = this.value.split('-').reverse().join('.');
      document.getElementById('customDateReading').innerText =
        'Geschätzter Zählerstand am ' + formattedDate + ': ' + startReading.toFixed(3).replace('.',',') + ' m³';
      
    try{ document.getElementById('customDateExplanation').style.display = 'none'; }catch(e){}
      return;
    }

    if (customDateObj < endDateObj) {
        var errSp = document.getElementById('customDateError');
errSp.innerText = 'Datum darf nicht vor dem Enddatum ( Datum 2 in Rubrik 1) liegen.';
errSp.classList.add('visible');
        document.getElementById('customDateReading').innerText = '';
        
    try{ document.getElementById('customDateExplanation').style.display = 'none'; }catch(e){}
        return;
    } else {
        var errSp = document.getElementById('customDateError');
errSp.innerText = '';
errSp.classList.remove('visible');
    }
    var d = new Date(this.value);
    // If custom date equals end date, show the exact end reading
    var endDateInput = document.getElementById('endDate');
    var parts = endDateInput.value.split('.');
    var endDateObj = new Date(parseInt(parts[2],10), parseInt(parts[1],10)-1, parseInt(parts[0],10));
    if (
      d.getFullYear() === endDateObj.getFullYear() &&
      d.getMonth()    === endDateObj.getMonth()    &&
      d.getDate()     === endDateObj.getDate()
    ) {
      var formattedDate = this.value.split('-').reverse().join('.');
      document.getElementById('customDateReading').innerText =
        'Geschätzter Zählerstand am ' + formattedDate + ': ' + window.rubrik5StartReading.toFixed(3).replace('.',',') + ' m³';
      
    try{ document.getElementById('customDateExplanation').style.display = 'none'; }catch(e){}
      return;
    }

    var monthlyValues = window.rubrik5MonthlyValues || [];
    var startReading = parseFloat(window.rubrik5StartReading || 0);
    var endMonth = window.rubrik5EndMonth;
    var endYear = window.rubrik5EndYear;
    var cumM3 = 0;
    // calculate months difference
    var yearDiff = d.getFullYear() - endYear;
    var monthDiff = yearDiff * 12 + (d.getMonth() + 1 - endMonth);
    if (monthDiff < 0) monthDiff += 12;
    // sum full months before custom month
    for (var i = 0; i < monthDiff; i++) {
      cumM3 += monthlyValues[i] || 0;
    }
    // prorate for custom month
    var index = monthDiff;
    var fullM3 = monthlyValues[index] || 0;
    var daysInMonth = new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
    var dailyUse = fullM3 / daysInMonth;
    var partialUse;
    if (index === 0) {
      // Sonderfall: erstes Prognosemonat ist zugleich Endmonat aus Rubrik 1.
      // Dann beginnt die Hochrechnung erst am Tag NACH dem Enddatum.
      var endParts2 = document.getElementById('endDate').value.split('.');
      var endDay2 = parseInt(endParts2[0], 10) || 0;
      var deltaDays = d.getDate() - endDay2;
      if (deltaDays < 0) { deltaDays = 0; }
      partialUse = dailyUse * deltaDays;
    } else {
      // spätere Monate: Zählung ab dem 1. des Monats
      partialUse = dailyUse * d.getDate();
    }
    cumM3 += partialUse;
    var projected = startReading + cumM3;
    var formattedDate = this.value.split('-').reverse().join('.');
    document.getElementById('customDateReading').innerText =
      'Geschätzter Zählerstand am ' + formattedDate + ': ' + projected.toFixed(3).replace('.',',') + ' m³';
    // Build explanation text
    var fullSum = cumM3 - partialUse;
    var explanationText = 'Berechnungsweg: Startwert ' + startReading.toFixed(3).replace('.',',') + ' m³';
    explanationText += ' + Volle Monate: ' + fullSum.toFixed(3).replace('.',',') + ' m³';
    explanationText += ' + Teilmonat: ' + partialUse.toFixed(3).replace('.',',') + ' m³';
    explanationText += ' = Gesamtverbrauch: ' + cumM3.toFixed(3).replace('.',',') + ' m³';
    
    try{ document.getElementById('customDateExplanation').style.display = 'block'; }catch(e){}

  
  
    // Nach Neuberechnung: Rechenweg standardmäßig ausblenden und Button zurücksetzen
    try {
      var expDiv = document.getElementById('customDateExplanation');
      if (expDiv) expDiv.style.display = 'none';
      var btn = document.getElementById('toggleCustomDateExp');
      if (btn) btn.innerText = 'Rechenweg anzeigen';
    } catch(e){}
    });
});
</script><script>
// Toggle Rechenweg für Custom-Datum-Projektion
document.addEventListener('DOMContentLoaded', function() {
  var btn = var btn = var btn = document.getElementById('toggleCustomDateExp');
  var expDiv = document.getElementById('customDateExplanation');
  if (!btn || !expDiv) return;
  btn.addEventListener('click', function(){
    if (expDiv.style.display === 'block') {
      expDiv.style.display = 'none';
      btn.innerText = 'Rechenweg anzeigen';
    } else {
      expDiv.style.display = 'block';
      btn.innerText = 'Rechenweg ausblenden';
    }
  });
});
</script><script>
// Toggle Rechenweg für Custom-Datum-Projektion
document.addEventListener('DOMContentLoaded', function() {
  var btn = var btn = var btn = document.getElementById('toggleCustomDateExp');
  var expDiv = document.getElementById('customDateExplanation');
  if (!btn || !expDiv) return;
  btn.addEventListener('click', function() {
    if (!expDiv.innerText.trim()) return; // nichts zu zeigen
    if (expDiv.style.display === 'block') {
      expDiv.style.display = 'none';
      btn.innerText = 'Rechenweg anzeigen';
    } else {
      expDiv.style.display = 'block';
      btn.innerText = 'Rechenweg ausblenden';
    }
  });
});
</script><script>
// Custom Date Change Handler with Enddate Check
document.addEventListener('DOMContentLoaded', function() {
  var customDate = document.getElementById('customDateInputRubrik5');
  if (!customDate) return;
  customDate.addEventListener('change', function() {
    var d = new Date(this.value);
            var warningDiv = document.getElementById('dateWarningCustom');
        var endYear = window.rubrik5EndYear;
        var endMonth = window.rubrik5EndMonth;
        var yearDiff = d.getFullYear() - endYear;
        var monthDiff = yearDiff * 12 + (d.getMonth()+1 - endMonth);
        if (monthDiff < 0) monthDiff += 12;
        if (monthDiff> 11) { warningDiv.style.display = 'block'; } else { warningDiv.style.display = 'none'; }
// Parse end date from Rubrik 1
    var endDateParts = document.getElementById('endDate').value.split('.');
    var endDateObj = new Date(
      parseInt(endDateParts[2],10),
      parseInt(endDateParts[1],10)-1,
      parseInt(endDateParts[0],10)
    );
    // If equal to end date, show exact value and exit
    if (
      d.getFullYear() === endDateObj.getFullYear() &&
      d.getMonth()    === endDateObj.getMonth()    &&
      d.getDate()     === endDateObj.getDate()
    ) {
      var formatted = this.value.split('-').reverse().join('.');
      document.getElementById('customDateReading').innerText =
        'Geschätzter Zählerstand am ' + formatted + ': ' +
        window.rubrik5StartReading.toFixed(3).replace('.',',') + ' m³';
      
    try{ document.getElementById('customDateExplanation').style.display = 'none'; }catch(e){}
      return;
    }
    // Original projection logic
    var monthlyValues = window.rubrik5MonthlyValues || [];
    var startReading = parseFloat(window.rubrik5StartReading || 0);
    var endMonth = window.rubrik5EndMonth;
    var endYear = window.rubrik5EndYear;
    // calculate month difference
    var yearDiff = d.getFullYear() - endYear;
    var monthDiff = yearDiff * 12 + (d.getMonth()+1 - endMonth);
    if (monthDiff < 0) monthDiff += 12;
    // sum full months
    var cumFull = 0;
    for (var i = 0; i < monthDiff; i++) {
      cumFull += monthlyValues[i] || 0;
    }
    // prorate for custom month
    var fullM3 = monthlyValues[monthDiff] || 0;
    var daysInMonth = new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
    var dailyUse = fullM3 / daysInMonth;
    var partialUse = dailyUse * d.getDate();
    var cumM3 = cumFull + partialUse;
    var projected = startReading + cumM3;
    var formattedDate = this.value.split('-').reverse().join('.');
    // Display reading
    document.getElementById('customDateReading').innerText =
      'Geschätzter Zählerstand am ' + formattedDate + ': ' +
      projected.toFixed(3).replace('.',',') + ' m³';
    // Build explanation
    var expText = 'Berechnungsweg: Startwert ' + startReading.toFixed(3).replace('.',',') +
      ' m³ + Volle Monate: ' + cumFull.toFixed(3).replace('.',',') +
      ' m³ + Teilmonat: ' + partialUse.toFixed(3).replace('.',',') +
      ' m³ = ' + cumM3.toFixed(3).replace('.',',') + ' m³';
    document.getElementById('customDateExplanation').innerText = expText;
  });
});
</script><script>
// Reset-Button für alternatives Datum in Rubrik 5
document.addEventListener('DOMContentLoaded', function() {
    var customInput = document.getElementById('customDateInputRubrik5');
    var resetBtn    = document.getElementById('resetCustomDate');
    var readingDiv  = document.getElementById('customDateReading');
    var explDiv     = document.getElementById('customDateExplanation');
    var warnDiv     = document.getElementById('dateWarningCustom');
    if (resetBtn && customInput) {
        resetBtn.addEventListener('click', function() {
            customInput.value = '';
            if (readingDiv) readingDiv.innerText = '';
            if (explDiv)    explDiv.innerText   = '';
            if (warnDiv)    warnDiv.style.display = 'none';
            return;
      // Rubrik 1: Eingabefelder leeren
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      document.getElementById('startMeter').value = '';
      document.getElementById('endMeter').value = '';
      document.getElementById('m3Difference').innerText = '0,000';
      document.getElementById('plzInputRubrik1').value = '';
      document.getElementById('rubrik1Error').innerText = '';
      document.getElementById('dateWarning').innerText = '';
      document.getElementById('summerWarning').innerText = '';

        
        // Statusindikator zurücksetzen beim Rubrik2-Reset
        const statusEl = document.getElementById('fetchStatus');
        if (statusEl) statusEl.style.backgroundColor = '#ccc';
    });
    }
});
</script><script>

// Berechnung kombinierter Gewichte aus Heizgradtagen und Warmwasseranteil
function calculateCombinedWeights(gtz, alpha = 0.8) {
  const totalHDD = Object.values(gtz).reduce((a, b) => a + b, 0);
  const heatingWeights = {};
  Object.keys(gtz).forEach(key => {
    heatingWeights[key] = totalHDD> 0 ? gtz[key] / totalHDD : 1/12;
  });
  const waterWeight = 1 / 12;
  const combined = {};
  Object.keys(heatingWeights).forEach(key => {
    combined[key] = alpha * heatingWeights[key] + (1 - alpha) * waterWeight;
  });
  const result = {};
  Object.entries(combined).forEach(([key, val]) => {
    result[key] = +(100 * val).toFixed(3);
  });
  return result;
}


// Holen und Anwenden von PLZ-basierten Gewichten

async function getGtzWeightsForPLZ(plz, year) {
  const geoResp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&postalcode=${plz}&country=de&limit=1`);
  const geoJson = await geoResp.json();
  if(!geoJson.length) throw new Error("PLZ nicht gefunden");
  const lat = parseFloat(geoJson[0].lat).toFixed(4);
  const lon = parseFloat(geoJson[0].lon).toFixed(4);
  const start = `${year}-01-01`, end = `${year}-12-31`;
  const meteoResp = await fetch(`https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${start}&end_date=${end}&daily=temperature_2m_max,temperature_2m_min&timezone=UTC`);
  const data = await meteoResp.json();
  if(!data.daily) throw new Error("Keine Wetterdaten gefunden");
  const tmax = data.daily.temperature_2m_max, tmin = data.daily.temperature_2m_min, dates = data.daily.time;
  const gtz = Array(12).fill(0);
  for(let i=0; i<dates.length; i++){
    const avg = (tmax[i] + tmin[i]) / 2;
    if(avg < 15) gtz[new Date(dates[i]).getUTCMonth()] += 20 - avg;
  }
  
  // Kombinierte Gewichtung: 80% Heizenergie nach HDD, 20% Warmwasser gleichverteilt
  const rawWeights = {};
  gtz.forEach((val, i) => {
    const key = String(i+1).padStart(2,'0');
    rawWeights[key] = val;
  });
  const combinedWeights = calculateCombinedWeights(rawWeights, 0.8);
  window.gtzData = rawWeights;
window.sumHdd = Object.values(rawWeights).reduce((a,b)=>a+b,0);
return combinedWeights;

}

document.addEventListener('DOMContentLoaded', () => {
  // Disable statische Tabellen-Auswahl
  const sel = document.getElementById('weightTableSelect');
  
  // Hide Rubrik 2b and ensure toggle visible
  const sec2b = document.getElementById('rubrik2b'); if(sec2b) sec2b.style.display = 'none';
  const btnToggle = document.getElementById('toggleWeightBtn'); if(btnToggle) btnToggle.style.display = 'inline-block';
  // Event-Listener für Gewichte-Abruf
  const fetchBtn = document.getElementById('fetchWeightsBtn');
  if(fetchBtn) {
    fetchBtn.addEventListener('click', async () => {
      const plz = document.getElementById('plzInputRubrik1').value.trim();
      const err = document.getElementById('plzErrorRubrik1');
      err.textContent = '';
      if(!/^\d{4,5}$/.test(plz)) {
        err.textContent = 'Bitte gültige PLZ eingeben';
        return;
      }
      const sd = document.getElementById('startDate').value;
      const year = sd ? sd.split('.').pop() : new Date().getFullYear();
      try {
        const plzWeights = await getGtzWeightsForPLZ(plz, year);
        if(document.getElementById('weightTableSelect').value === 'plz') { currentMonthWeights = plzWeights; updateMonthWeightList(); }
        updateStandardTable();
        calculate();
      // Statusindikator grün setzen
      const statusEl = document.getElementById('fetchStatus');
      if (statusEl) statusEl.style.backgroundColor = 'green';

        // Rubriken 3-7 einblenden
        ['rubrik3','rubrik4','rubrik5','rubrik6','rubrik7'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.style.display = 'block';
        });

      } catch (e) {
        err.textContent = e.message;
      }
    });
  }
});

document.addEventListener('DOMContentLoaded', () => {
  const goBtn = document.getElementById('go');
  if (goBtn) {
    goBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const rub2 = document.getElementById('rubrik2');
      if (rub2) rub2.style.display = 'block';
    });
  }
});

</script><script>
function showCalc(month) {
  
  // Display selected month
  const monthNames = {
    '01':'Januar','02':'Februar','03':'März','04':'April',
    '05':'Mai','06':'Juni','07':'Juli','08':'August',
    '09':'September','10':'Oktober','11':'November','12':'Dezember'
  };
  const selName = monthNames[month] || month;
  document.getElementById('selectedMonthDisplay').innerText = 'Ausgewählter Monat: ' + selName;
const gtz = window.gtzData || {};
  const sumHdd = window.sumHdd || Object.values(gtz).reduce((a,b)=>a+b,0);
  const hdd = gtz[month] || 0;
  const heatingWeight = sumHdd> 0 ? hdd / sumHdd : 0;
  const waterWeight = 1/12;
  const combined = 0.8 * heatingWeight + 0.2 * waterWeight;
  const percent = (combined * 100).toFixed(3);
  const html = `
    <ol>
      <li>Summe aller HDD / HDD[${month}] = ${sumHdd.toFixed(3)} / ${hdd.toFixed(3)} = ${heatingWeight.toFixed(5)}</li>
      <li>1 / 12 = ${waterWeight.toFixed(5)} (Warmwasser-Anteil gleich verteilt)</li>
      <li>0.8 × ${heatingWeight.toFixed(5)} + 0.2 × ${waterWeight.toFixed(5)} = ${combined.toFixed(5)} (80 % Heiz- / 20 % Warmwasser-Anteil) → ${percent}%</li>
    </ol>`;
  document.getElementById('calcList').innerHTML = html;
}

// Attach click events when table shown
document.addEventListener('click', function(e) {
  // Highlight the selected row
  const table = document.querySelector('#detailedTable table');
  if (e.target.closest('#detailedTable table tr')) {
    table.querySelectorAll('tr').forEach(r => r.classList.remove('selected-row'));
    const currentRow = e.target.closest('tr');
    if (currentRow) currentRow.classList.add('selected-row');
  }

  if (e.target.closest('#detailedTable table tr')) {
    const cell = e.target.closest('tr').cells[0];
    if (cell) showCalc(cell.textContent.trim());
  }
});
</script><script>
document.addEventListener('DOMContentLoaded', function() {
  const toggleBtn = document.getElementById('toggleDetailsBtn');
  const hintDiv = document.getElementById('buttonHint');
  const tableDiv = document.getElementById('detailedTable');
  toggleBtn.addEventListener('click', function() {
    // Determine visibility of table
    const isVisible = tableDiv.style.display === 'block' || getComputedStyle(tableDiv).display !== 'none';
    if (isVisible) {
      hintDiv.style.display = 'block';
    } else {
      hintDiv.style.display = 'none';
    }
  });
});
</script><script>
// Monkey-Patch für Rubrik 6: Berücksichtige #factor im Ergebnis und Rechenweg
(function(){
  const orig = window.processSelectedMonths;
  window.processSelectedMonths = function(){
    orig();
    const factorInput = document.getElementById('factor').value.trim();
    if(factorInput){
      const totalM3Text = document.getElementById('rubrik6TotalM3Value').innerText.replace(',', '.');
      const total = parseFloat(totalM3Text) || 0;
      const factor = parseFloat(factorInput.replace(',', '.'));
      const totalKWh = total * factor;
      document.getElementById('rubrik6TotalKwhValue').innerText = totalKWh.toFixed(3).replace('.', ',');
      // Rechenweg in Detail-Ansicht anpassen:
      let html = document.getElementById('partialConsumptionResult').innerHTML;
      html = html.replace(/×[^=]*=/g, '× Faktor ' + factor.toFixed(3) + ' =');
      document.getElementById('partialConsumptionResult').innerHTML = html;
    }
  };
})();
</script><script>
// Zusatz: Wenn keine Monate ausgewählt, Übernahme aus Rubrik 4
(function(){
  const orig = window.processSelectedMonths;
  window.processSelectedMonths = function(){
    orig();
    // Prüfen, ob selektierte Monate vorhanden sind
    const selected = document.querySelectorAll('#monthSelectionList input[type="checkbox"]:checked');
    if(selected.length === 0){
      // kWh aus Rubrik 4 auslesen
      let kwhText = document.getElementById('kwhConversionResult').innerText.split(': ')[1];
      kwhText = kwhText.replace(',', '.');
      const kwhValue = parseFloat(kwhText) || 0;
      // Anzeige in Rubrik 6 angleichen
      document.getElementById('rubrik6TotalKwhValue').innerText = kwhValue.toFixed(3).replace('.', ',');
document.getElementById('kwhAmount').value = kwhValue.toFixed(3);
      // Rechenweg-Summary anpassen
      let html = document.getElementById('partialConsumptionResult').innerHTML;
      html = html.replace(/Gesamtverbrauch in kWh: [0-9.,]+ kWh/, 
                          'Gesamtverbrauch in kWh: ' + kwhValue.toFixed(3).replace('.', ',') + ' kWh');
      document.getElementById('partialConsumptionResult').innerHTML = html;
    }
  };
})();
</script><script>
document.addEventListener('DOMContentLoaded', function() {
  const resetBtn = document.getElementById('resetRubrik2Btn');
  if (resetBtn) {
    resetBtn.addEventListener('click', function() {
      // HDD-Daten zurücksetzen
      window.gtzData = {};
      window.sumHdd = 0;
      // Tabelle leeren und verbergen
      const tableDiv = document.getElementById('detailedTable');
      if (tableDiv) {
        tableDiv.innerHTML = '';
        tableDiv.style.display = 'none';
      }
      // Aktuelle Monatsgewichte zurücksetzen
      if (typeof currentMonthWeights !== 'undefined') {
        currentMonthWeights = {'01':0,'02':0,'03':0,'04':0,'05':0,'06':0,'07':0,'08':0,'09':0,'10':0,'11':0,'12':0};
      }

      // Listen und Summen löschen
      document.getElementById('monthWeightList').innerHTML = '';
      document.getElementById('monthWeightExplanation').innerHTML = '';
      document.getElementById('totalWeightSum').innerText = '';
      document.getElementById('originalWeights').innerHTML = '';
      // Fehlermeldung ausblenden
      const errEl = document.getElementById('hddError');
      if (errEl) {
        errEl.textContent = '';
        errEl.classList.remove('visible');
      }
    });
  }
});
</script><script>
  function resetHddTable() {
    // Hinweistext neben dem Kreis leeren (optional für Rubrik 2)
    var msgEl = document.getElementById('fetchMsg');
    if (msgEl) msgEl.innerText = '';

    // HDD-Daten vollständig zurücksetzen
    if (window.gtzData) window.gtzData = {};
    if (typeof window.sumHdd !== 'undefined') window.sumHdd = 0;
    if (typeof currentMonthWeights !== 'undefined') {
      currentMonthWeights = {'01':0,'02':0,'03':0,'04':0,'05':0,'06':0,'07':0,'08':0,'09':0,'10':0,'11':0,'12':0};
    }
    // Anzeige zurücksetzen
    var tableDiv = document.getElementById('detailedTable');
    if (tableDiv) {
      tableDiv.innerHTML = '';
      tableDiv.style.display = 'none';
    }
    ['monthWeightList','monthWeightExplanation','totalWeightSum','originalWeights'].forEach(function(id) {
      var el = document.getElementById(id);
      if (el) el.innerHTML = '';
    });
    var errEl = document.getElementById('hddError');
    if (errEl) {
      errEl.textContent = '';
      errEl.classList.remove('visible');
    }
  }
</script><script>
document.addEventListener('DOMContentLoaded', function() {
  const statusEl = document.getElementById('fetchStatus');
  function resetIndicator() {
    if (statusEl) statusEl.style.backgroundColor = '#ccc';
  }
  const resetBtn = document.getElementById('resetButton');
  if (resetBtn) resetBtn.addEventListener('click', resetIndicator);
  const hddResetBtn = document.getElementById('resetRubrik2Btn');
  if (hddResetBtn) hddResetBtn.addEventListener('click', resetIndicator);
});
</script><script>
document.addEventListener('DOMContentLoaded', function() {
  // Ersetze alle alten Click-Listener
  let fetchBtn = document.getElementById('fetchWeightsBtn');
  if (fetchBtn) {
    const newBtn = fetchBtn.cloneNode(true);
    fetchBtn.parentNode.replaceChild(newBtn, fetchBtn);
    fetchBtn = newBtn;
  }
  const statusEl = document.getElementById('fetchStatus');
  const msgEl    = document.getElementById('fetchMsg');
  const plzInput = document.getElementById('plzInputRubrik1');
  const startIn  = document.getElementById('startDate');
  const endIn    = document.getElementById('endDate');
  const plzError = document.getElementById('plzErrorRubrik1') || document.getElementById('rubrik1Error');

  fetchBtn.addEventListener('click', async function() {
    // Reset
    if (statusEl) statusEl.style.backgroundColor = '#ccc';
    if (msgEl)    msgEl.innerText = '';
    if (plzError) plzError.textContent = '';

    // Determine which weighting basis is selected. If the user has selected
    // the static table ("Tabelle A"), skip the PLZ validation entirely and
    // use the predefined month weights. This allows calculations without
    // requiring a postcode when the static weighting is chosen.
    const selectedBasisEl = document.querySelector('input[name="weightBasis"]:checked');
    const selectedBasis   = selectedBasisEl ? selectedBasisEl.value : '';
    if (selectedBasis === 'A') {
      try {
        // Ensure the dropdown and radio stay in sync with the static selection
        const weightTableSelect = document.getElementById('weightTableSelect');
        if (weightTableSelect) {
          weightTableSelect.value = 'A';
        }
        // Apply the static month weights via the existing changeWeightTable() helper
        if (typeof changeWeightTable === 'function') {
          changeWeightTable();
        } else {
          // Fallback: directly assign monthWeightsA or tableA if helper unavailable
          const src = window.monthWeightsA || window.tableA || {};
          const map = {};
          for (let i = 1; i <= 12; i++) {
            const k = i.toString().padStart(2, '0');
            let found = 0;
            if (typeof src[k] !== 'undefined') found = src[k];
            else if (typeof src[i] !== 'undefined') found = src[i];
            map[k] = found;
          }
          currentMonthWeights = map;
        }
        // Update the month weight list and perform the main calculations
        if (typeof updateMonthWeightList === 'function') updateMonthWeightList();
        if (typeof calculate === 'function') {
          calculate();
          // calculate() is called twice in the original code to ensure all dependent
          // UI elements update properly; mimic that behaviour here.
          calculate();
        }
        // Indicate success and show Rubriken 3–7
        if (statusEl) statusEl.style.backgroundColor = 'green';
        ['rubrik3','rubrik4','rubrik5','rubrik6','rubrik7'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.style.display = 'block';
        });
        const inline=document.getElementById('tableAInlineMsg'); if(inline) inline.textContent='Daten geladen'; if(msgEl) msgEl.innerText='';
      } catch (e) {
        if (statusEl) statusEl.style.backgroundColor = 'red';
        if (msgEl) msgEl.innerText = 'Fehler bei der statischen Gewichtung.';
      }
      // Skip further processing – no PLZ check required for static table
      return;
    }

    const plz = plzInput ? plzInput.value.trim() : '';
    if (!plz) {
      if (statusEl) statusEl.style.backgroundColor = 'red';
      if (msgEl)    msgEl.innerText = 'Bitte PLZ eingeben.';
      return;
    }
    if (!/^\d{5}$/.test(plz)) {
      if (plzError) plzError.textContent = 'Bitte gültige PLZ eingeben';
      if (statusEl) statusEl.style.backgroundColor = 'red';
      if (msgEl)    msgEl.innerText = 'Ungültige PLZ. Bitte fünfstellige deutsche PLZ eingeben.';
      return;
    }
    const sd = startIn ? startIn.value.trim() : '';
    const ed = endIn ? endIn.value.trim() : '';
    if (!sd || !ed) {
      if (statusEl) statusEl.style.backgroundColor = 'red';
      if (msgEl)    msgEl.innerText = 'Bitte Start- und Enddatum eingeben.';
      return;
    }

    const sdYear = sd.split('.').pop();
            const inputYear = parseInt(sdYear, 10);
            const currentYear = new Date().getFullYear();
            const year = (inputYear>= currentYear) ? currentYear - 1 : inputYear;
    try {
      const weights = await getGtzWeightsForPLZ(plz, year);
      currentMonthWeights = weights;
      window.currentMonthWeights = weights;
      updateMonthWeightList();
      calculate();
      calculate();
      if (statusEl) statusEl.style.backgroundColor = 'green';

        // Rubriken 3-7 einblenden
        ['rubrik3','rubrik4','rubrik5','rubrik6','rubrik7'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.style.display = 'block';
        });

      if (msgEl)    msgEl.innerText = 'Daten geladen.';

      // Auto-recalc Rubrik 5 custom date after PLZ weights loaded (with readiness polling)
      try {
        var cd = document.getElementById('customDateInputRubrik5');
        if (cd && cd.value) {
          (function recalcWhenReady(tries){
            if ((window.rubrik5MonthlyValues && window.rubrik5MonthlyValues.length) && (window.rubrik5StartReading != null)) {
              var evt = new Event('change', { bubbles: true });
              cd.dispatchEvent(evt);
            } else if (tries > 0) {
              setTimeout(function(){ recalcWhenReady(tries-1); }, 0);
            }
          })(10);
        }
      } catch(e) {}

    } catch (e) {
      if (statusEl) statusEl.style.backgroundColor = 'red';
      if (msgEl)    msgEl.innerText = 'Keine Wetterdaten gefunden – bitte Eingaben prüfen. Sollte es weiterhin nicht funktionieren, versuchen Sie die PLZ eines nahegelegenen größeren Ortes.';
    }
  });
});
</script><script>
// Tabelle A: Statische Monatsgewichtungen (Beispielwerte)
const tableA = {
  "Jan": 16.224,
  "Feb": 13.202,
  "Mär": 12.765,
  "Apr": 9.102,
  "Mai": 4.786,
  "Jun": 2.382,
  "Jul": 0.790,
  "Aug": 0.772,
  "Sep": 3.297,
  "Okt": 8.224,
  "Nov": 12.680,
  "Dez": 15.776
};

function showHddTable() {
    const gtz = window.gtzData || {};
    const sumHdd = window.sumHdd || Object.values(gtz).reduce((a,b)=>a+b,0);
    const water = 1/12;
    
let html = '<table border="1" cellpadding="5"><tr>' +
           '<th>Monat</th>' +
           '<th>HDD</th>' +
           '<th>Heiz<br>W.</th>' +
           '<th>WW<br>W.</th>' +
           '<th>Komb.</th>' +
           '<th>%</th></tr>';

    Object.keys(gtz).forEach(m => {
      const hdd = gtz[m];
      const heating = sumHdd>0 ? hdd/sumHdd : 0;
      const comb = 0.8*heating + 0.2*water;
      html += `<tr><td>${m}</td><td>${hdd.toFixed(3)}</td><td>${heating.toFixed(5)}</td><td>${water.toFixed(5)}</td><td>${comb.toFixed(5)}</td><td>${(comb*100).toFixed(3)}</td></tr>`;
    });
    // Summen berechnen
    const sumHddFooter = Object.values(gtz).reduce((a,b)=>a+b, 0);
    const sumPercentFooter = Object.keys(gtz).reduce((sum, m) => {
      const hdd = gtz[m];
      const heating = sumHddFooter> 0 ? hdd / sumHddFooter : 0;
      const comb = 0.8 * heating + 0.2 * (1/12);
      return sum + comb * 100;
    }, 0);
    html += `<tfoot><tr><th>Summe</th><th>${sumHddFooter.toFixed(3)}</th><th></th><th></th><th></th><th>${sumPercentFooter.toFixed(3)}</th></tr></tfoot>`;
    html += '</table>';
    document.getElementById("detailedTable").innerHTML = html;
    document.getElementById("detailedTable").style.display = "block";
}

function showStandardTable() {
    let html = '<table border="1" cellpadding="5"><tr><th>Monat</th><th>Gewichtung (%)</th></tr>';
    let sum = 0;
    Object.keys(tableA).forEach(m => {
      html += `<tr><td>${m}</td><td>${tableA[m].toFixed(3)}</td></tr>`;
      sum += tableA[m];
    });
    html += `<tfoot><tr><th>Summe</th><th>${sum.toFixed(3)}</th></tr></tfoot>`;
    html += '</table>';
    document.getElementById("detailedTable").innerHTML = html;
    document.getElementById("detailedTable").style.display = "block";
}
</script><script>
function changeWeightTable() {
    var sel = document.getElementById('weightTableSelect');
    if (!sel) return;
    var value = sel.value;
    var rubrik2b = document.getElementById('rubrik2b');
    if (rubrik2b) { rubrik2b.style.display = (value === 'plz') ? 'block' : 'none'; }

    var map = {};
    if (value === 'plz') {
        var src = window.plzWeights || {};
        for (var i=1; i<=12; i++) {
            var k = i.toString().padStart(2,"0");
            map[k] = typeof src[k] !== "undefined" ? src[k] : (typeof src[i] !== "undefined" ? src[i] : 0);
        }
        currentMonthWeights = map;
    } else if (value === 'A') {
        var src = window.monthWeightsA || window.tableA || {};
        // Fange alle möglichen Key-Formate ab (string, int, deutsch/englisch)
        var lookup = {
            "Jan": "01", "Feb": "02", "Mär": "03", "Mrz": "03", "Apr": "04",
            "Mai": "05", "Jun": "06", "Jul": "07", "Aug": "08", "Sep": "09",
            "Okt": "10", "Nov": "11", "Dez": "12"
        };
        for (var i=1; i<=12; i++) {
            var k = i.toString().padStart(2,"0");
            // 1. direkt als "01" suchen, 2. als 1 suchen, 3. als Monatsschlüssel
            var found = 0;
            if(typeof src[k] !== "undefined") found = src[k];
            else if(typeof src[i] !== "undefined") found = src[i];
            else {
                for (var name in lookup) {
                    if (lookup[name] === k && typeof src[name] !== "undefined") found = src[name];
                }
            }
            map[k] = found;
        }
        currentMonthWeights = map;
    }
    else {
        var regSrc = (window.WEIGHTS_REGISTRY && window.WEIGHTS_REGISTRY.staticTables && window.WEIGHTS_REGISTRY.staticTables[value]) || null;
        if (regSrc && regSrc.length === 12) {
            var m = {};
            for (var i2=1; i2<=12; i2++) {
                var kk = i2.toString().padStart(2,"0");
                m[kk] = Number(regSrc[i2-1]) || 0;
            }
            currentMonthWeights = m;
        }
    }
    
    if (typeof updateMonthWeightList === 'function') updateMonthWeightList();
    if (typeof calculate === 'function') calculate();
    if (typeof calculateCost === 'function') calculateCost();
    // Debug: zeige currentMonthWeights in Konsole
    
    // F7: Toggle Rubriken 3–7 for A and registry tables (e.g., B)
    (function(){
      var ids = ['rubrik3','rubrik4','rubrik5','rubrik6','rubrik7'];
      var isRegistry = (value !== 'A' && value !== 'plz' &&
                        window.WEIGHTS_REGISTRY && window.WEIGHTS_REGISTRY.staticTables &&
                        !!window.WEIGHTS_REGISTRY.staticTables[value]);
      ids.forEach(function(id){
        var el = document.getElementById(id);
        if (!el) return;
        if (value === 'A' || isRegistry) {
          el.style.display = 'block';
        } else if (value === 'plz') {
          // For PLZ: only show if weights are available
          if (window.plzWeights) el.style.display = 'block';
          else el.style.display = 'none';
        } else {
          el.style.display = 'none';
        }
      });
    })();
    
    console.log('currentMonthWeights:', currentMonthWeights);

    // === Auto-recalc Rubrik 5 custom date with readiness polling ===
    try {
      var cd = document.getElementById('customDateInputRubrik5');
      if (cd && cd.value) {
        (function recalcWhenReady(tries){
          if ((window.rubrik5MonthlyValues && window.rubrik5MonthlyValues.length) && (window.rubrik5StartReading != null)) {
            var evt = new Event('change', { bubbles: true });
            cd.dispatchEvent(evt);
          } else if (tries > 0) {
            setTimeout(function(){ recalcWhenReady(tries-1); }, 0);
          }
        })(10);
      }
    } catch(e) {}
}
</script><script>
function getDaysInMonth(monat, jahr) {
  monat = parseInt(monat,10);
  jahr = jahr || (new Date()).getFullYear();
  return new Date(jahr, monat, 0).getDate();
}

// Hilfsfunktion: Liste aktiver Monate (nur Checkboxen, wie im Screenshot)
function getCheckedMonths() {
  const result = [];
  document.querySelectorAll('#monthSelectionList input[type=checkbox]').forEach(cb => {
    if (cb.checked) {
      result.push(cb.value);
    }
  });
  return result;
}

function getCurrentMonthTextValue(mid) {
  var input = document.getElementById('day-' + mid);
  if (!input) return null;
  var label = input.closest('li') || input.parentElement;
  if (!label) return null;
  var text = label.textContent || '';
  var m = text.match(/([0-9.,]+)\s*m³/);
  if (m) {
    var val = m[1].replace(/\./g, '').replace(',', '.');
    return parseFloat(val);
  }
  return null;
}

function updateOrigvalSpan(mid, role) {
  // role: "first", "last", sonst null
  var orig = getCurrentMonthTextValue(mid);
  var tageImMonat = getDaysInMonth(mid);
  var input = document.getElementById('day-' + mid);
  var days = input ? parseInt(input.value, 10) : NaN;
  var origSpan = document.getElementById('origval-' + mid);
  if (!origSpan) {
    if(input && input.parentNode) {
      origSpan = document.createElement('span');
      origSpan.id = 'origval-' + mid;
      origSpan.className = 'origval';
      origSpan.style.marginLeft = "0.7em";
      origSpan.style.fontSize = "0.95em";
      origSpan.style.color = "#007bff";
      origSpan.style.fontWeight = "bold";
      input.parentNode.insertBefore(origSpan, input.nextSibling);
    }
  }
  if (!origSpan) return;

  if (!orig || !input || isNaN(days) || days <= 0 || days> tageImMonat) {
    origSpan.textContent = (orig ? orig.toLocaleString('de-DE', {minimumFractionDigits:3}) : '-') + ' m³ (voll)';
  } else {
    let anteil = orig;
    let teilInfo = "";
    if (role === "first") {
      // Teilmonat am Anfang: (Monatswert / Tage_im_Monat) * (Tage_im_Monat - Starttag + 1)
      anteil = orig * ((tageImMonat - days + 1) / tageImMonat);
      teilInfo = " → " + anteil.toLocaleString('de-DE', {minimumFractionDigits:3}) + " m³ (" + days + ".-"
        + tageImMonat + ". Tag, " + (tageImMonat - days + 1) + " Tage)";
    } else if (role === "last") {
      // Teilmonat am Ende: (Monatswert / Tage_im_Monat) * Endtag
      anteil = orig * (days / tageImMonat);
      teilInfo = " → " + anteil.toLocaleString('de-DE', {minimumFractionDigits:3}) + " m³ (1.-" + days
        + ". Tag)";
    } else {
      // Sollte nicht vorkommen, nur bei vollen Monaten
      teilInfo = "";
    }
    origSpan.textContent =
      orig.toLocaleString('de-DE', {minimumFractionDigits:3}) + " m³ (voll)" + teilInfo;
  }
}

function patchRubrik6Spans() {
  const checked = getCheckedMonths();
  const first = checked.length ? checked[0] : null;
  const last = checked.length ? checked[checked.length-1] : null;

  for (let m = 1; m <= 12; m++) {
    let mid = m.toString().padStart(2, '0');
    let input = document.getElementById('day-' + mid);
    let role = null;
    if (mid === first) role = "first";
    if (mid === last && last !== first) role = "last";
    if (input && !input.dataset.patched) {
      updateOrigvalSpan(mid, role);
      input.addEventListener('input', function() {
        updateOrigvalSpan(mid, role);
      });
      input.dataset.patched = "1";
    } else if (input) {
      updateOrigvalSpan(mid, role);
    }
  }
}

document.addEventListener('DOMContentLoaded', function() {
  patchRubrik6Spans();
  document.addEventListener('rubrik6ListRedraw', function() {
    setTimeout(patchRubrik6Spans, 10);
  });
  setInterval(patchRubrik6Spans, 2000);
  document.querySelectorAll('#monthSelectionList input[type=checkbox]').forEach(cb => {
    cb.addEventListener('change', function() { setTimeout(patchRubrik6Spans, 10); });
  });
});
</script><script>
function getDaysInMonth(monat, jahr) {
  monat = parseInt(monat,10);
  jahr = jahr || (new Date()).getFullYear();
  return new Date(jahr, monat, 0).getDate();
}
function getCheckedMonths() {
  const result = [];
  document.querySelectorAll('#monthSelectionList input[type=checkbox]').forEach(cb => {
    if (cb.checked) {
      result.push(cb.value);
    }
  });
  return result;
}
function getCurrentMonthTextValue(mid) {
  var input = document.getElementById('day-' + mid);
  if (!input) return null;
  var label = input.closest('li') || input.parentElement;
  if (!label) return null;
  var text = label.textContent || '';
  var m = text.match(/([0-9.,]+)\s*m³/);
  if (m) {
    var val = m[1].replace(/\./g, '').replace(',', '.');
    return parseFloat(val);
  }
  return null;
}
function updateOrigvalSpan(mid, role) {
  // role: "first", "last", sonst null
  var orig = getCurrentMonthTextValue(mid);
  var tageImMonat = getDaysInMonth(mid);
  var input = document.getElementById('day-' + mid);
  var days = input ? parseInt(input.value, 10) : NaN;
  var origSpan = document.getElementById('origval-' + mid);
  if (!origSpan) {
    if(input && input.parentNode) {
      origSpan = document.createElement('span');
      origSpan.id = 'origval-' + mid;
      origSpan.className = 'origval';
      origSpan.style.marginLeft = "0.7em";
      origSpan.style.fontSize = "0.95em";
      origSpan.style.color = "#007bff";
      origSpan.style.fontWeight = "bold";
      input.parentNode.insertBefore(origSpan, input.nextSibling);
    }
  }
  if (!origSpan) return;

  let value = orig;
  if (!orig || !input || isNaN(days) || days <= 0 || days> tageImMonat) {
    value = orig;
  } else if (role === "first") {
    value = orig * ((tageImMonat - days + 1) / tageImMonat);
  } else if (role === "last") {
    value = orig * (days / tageImMonat);
  }
  origSpan.textContent = (value ? value.toLocaleString('de-DE', {minimumFractionDigits:3}) : '-');
}
function patchRubrik6Spans() {
  const checked = getCheckedMonths();
  const first = checked.length ? checked[0] : null;
  const last = checked.length ? checked[checked.length-1] : null;

  for (let m = 1; m <= 12; m++) {
    let mid = m.toString().padStart(2, '0');
    let input = document.getElementById('day-' + mid);
    let role = null;
    if (mid === first) role = "first";
    if (mid === last && last !== first) role = "last";
    if (input && !input.dataset.patched) {
      updateOrigvalSpan(mid, role);
      input.addEventListener('input', function() {
        updateOrigvalSpan(mid, role);
      });
      input.dataset.patched = "1";
    } else if (input) {
      updateOrigvalSpan(mid, role);
    }
  }
}
document.addEventListener('DOMContentLoaded', function() {
  patchRubrik6Spans();
  document.addEventListener('rubrik6ListRedraw', function() {
    setTimeout(patchRubrik6Spans, 10);
  });
  setInterval(patchRubrik6Spans, 2000);
  document.querySelectorAll('#monthSelectionList input[type=checkbox]').forEach(cb => {
    cb.addEventListener('change', function() { setTimeout(patchRubrik6Spans, 10); });
  });
});
</script><script>
function getDaysInMonth(monat, jahr) {
  monat = parseInt(monat,10);
  jahr = jahr || (new Date()).getFullYear();
  return new Date(jahr, monat, 0).getDate();
}
function getCheckedMonths() {
  const result = [];
  document.querySelectorAll('#monthSelectionList input[type=checkbox]').forEach(cb => {
    if (cb.checked) {
      result.push(cb.value);
    }
  });
  return result;
}
function getCurrentMonthTextValue(mid) {
  var input = document.getElementById('day-' + mid);
  if (!input) return null;
  var label = input.closest('li') || input.parentElement;
  if (!label) return null;
  var text = label.textContent || '';
  var m = text.match(/([0-9.,]+)\s*m³/);
  if (m) {
    var val = m[1].replace(/\./g, '').replace(',', '.');
    return parseFloat(val);
  }
  return null;
}
function updateOrigvalSpan(mid, role) {
  // role: "first", "last", sonst null
  var orig = getCurrentMonthTextValue(mid);
  var tageImMonat = getDaysInMonth(mid);
  var input = document.getElementById('day-' + mid);
  var days = input ? parseInt(input.value, 10) : NaN;
  var origSpan = document.getElementById('origval-' + mid);
  if (!origSpan) {
    if(input && input.parentNode) {
      origSpan = document.createElement('span');
      origSpan.id = 'origval-' + mid;
      origSpan.className = 'origval';
      origSpan.style.marginLeft = "0.7em";
      origSpan.style.fontSize = "0.95em";
      origSpan.style.color = "#007bff";
      origSpan.style.fontWeight = "bold";
      input.parentNode.insertBefore(origSpan, input.nextSibling);
    }
  }
  if (!origSpan) return;

  let value = orig;
  if (!orig || !input || isNaN(days) || days <= 0 || days> tageImMonat) {
    value = orig;
  } else if (role === "first") {
    value = orig * ((tageImMonat - days + 1) / tageImMonat);
  } else if (role === "last") {
    value = orig * (days / tageImMonat);
  }
  // Kaufmännische Rundung auf 3 Nachkommastellen wie im Rechenweg
  let gerundet = (typeof value === "number") ? Math.round(value * 1000) / 1000 : null;
  origSpan.textContent = (gerundet !== null ? gerundet.toLocaleString('de-DE', {minimumFractionDigits:3}) : '-');
}
function patchRubrik6Spans() {
  const checked = getCheckedMonths();
  const first = checked.length ? checked[0] : null;
  const last = checked.length ? checked[checked.length-1] : null;

  for (let m = 1; m <= 12; m++) {
    let mid = m.toString().padStart(2, '0');
    let input = document.getElementById('day-' + mid);
    let role = null;
    if (mid === first) role = "first";
    if (mid === last && last !== first) role = "last";
    if (input && !input.dataset.patched) {
      updateOrigvalSpan(mid, role);
      input.addEventListener('input', function() {
        updateOrigvalSpan(mid, role);
      });
      input.dataset.patched = "1";
    } else if (input) {
      updateOrigvalSpan(mid, role);
    }
  }
}
document.addEventListener('DOMContentLoaded', function() {
  patchRubrik6Spans();
  document.addEventListener('rubrik6ListRedraw', function() {
    setTimeout(patchRubrik6Spans, 10);
  });
  setInterval(patchRubrik6Spans, 2000);
  document.querySelectorAll('#monthSelectionList input[type=checkbox]').forEach(cb => {
    cb.addEventListener('change', function() { setTimeout(patchRubrik6Spans, 10); });
  });
});
</script><script>
function getDaysInMonth(monat, jahr) {
  monat = parseInt(monat,10);
  jahr = jahr || (new Date()).getFullYear();
  return new Date(jahr, monat, 0).getDate();
}
function getCheckedMonths() {
  const result = [];
  document.querySelectorAll('#monthSelectionList input[type=checkbox]').forEach(cb => {
    if (cb.checked) {
      result.push(cb.value);
    }
  });
  return result;
}
function getCurrentMonthTextValue(mid) {
  var input = document.getElementById('day-' + mid);
  if (!input) return null;
  var label = input.closest('li') || input.parentElement;
  if (!label) return null;
  var text = label.textContent || '';
  var m = text.match(/([0-9.,]+)\s*m³/);
  if (m) {
    var val = m[1].replace(/\./g, '').replace(',', '.');
    return parseFloat(val);
  }
  return null;
}
function updateOrigvalSpan(mid, role) {
  // role: "first", "last", sonst null
  var orig = getCurrentMonthTextValue(mid);
  var tageImMonat = getDaysInMonth(mid);
  var input = document.getElementById('day-' + mid);
  var days = input ? parseInt(input.value, 10) : NaN;
  var origSpan = document.getElementById('origval-' + mid);
  if (!origSpan) {
    if(input && input.parentNode) {
      origSpan = document.createElement('span');
      origSpan.id = 'origval-' + mid;
      origSpan.className = 'origval';
      origSpan.style.marginLeft = "0.7em";
      origSpan.style.fontSize = "0.95em";
      origSpan.style.color = "#007bff";
      origSpan.style.fontWeight = "bold";
      input.parentNode.insertBefore(origSpan, input.nextSibling);
    }
  }
  if (!origSpan) return;

  let value = orig;
  if (!orig || !input || isNaN(days) || days <= 0 || days> tageImMonat) {
    value = orig;
  } else if (role === "first") {
    value = orig * ((tageImMonat - days + 1) / tageImMonat);
  } else if (role === "last") {
    value = orig * (days / tageImMonat);
  }
  // Kaufmännische Rundung auf 3 Nachkommastellen wie im Rechenweg
  let gerundet = (typeof value === "number") ? Math.round(value * 1000) / 1000 : null;
  origSpan.textContent = (gerundet !== null ? gerundet.toLocaleString('de-DE', {minimumFractionDigits:3}) : '-');
}
function patchRubrik6Spans() {
  const checked = getCheckedMonths();
  const first = checked.length ? checked[0] : null;
  const last = checked.length ? checked[checked.length-1] : null;

  for (let m = 1; m <= 12; m++) {
    let mid = m.toString().padStart(2, '0');
    let input = document.getElementById('day-' + mid);
    let role = null;
    if (mid === first) role = "first";
    if (mid === last && last !== first) role = "last";
    if (input && !input.dataset.patched) {
      updateOrigvalSpan(mid, role);
      // Reagiere auf input, change UND blur!
      ['input', 'change', 'blur'].forEach(evt =>
        input.addEventListener(evt, function() {
          updateOrigvalSpan(mid, role);
        })
      );
      input.dataset.patched = "1";
    } else if (input) {
      updateOrigvalSpan(mid, role);
    }
  }
}
document.addEventListener('DOMContentLoaded', function() {
  patchRubrik6Spans();
  document.addEventListener('rubrik6ListRedraw', function() {
    setTimeout(patchRubrik6Spans, 10);
  });
  setInterval(patchRubrik6Spans, 2000);
  document.querySelectorAll('#monthSelectionList input[type=checkbox]').forEach(cb => {
    cb.addEventListener('change', function() { setTimeout(patchRubrik6Spans, 10); });
  });
});
</script><script>
  // Speichern der Rubrik-1-Eingaben
  function saveRubrik1Inputs() {
    const data = {
      startDate: document.getElementById("startDate").value,
      startMeter: document.getElementById("startMeter").value,
      endDate: document.getElementById("endDate").value,
      endMeter: document.getElementById("endMeter").value,
      plz: document.getElementById("plzInputRubrik1").value
    };
    localStorage.setItem("rubrik1Data", JSON.stringify(data));
  }

  // Wiederherstellen beim Laden
  document.addEventListener("DOMContentLoaded", function() {
    const saved = localStorage.getItem("rubrik1Data");
    if (saved) {
      const data = JSON.parse(saved);
      if (data.startDate) document.getElementById("startDate").value = data.startDate;
      if (data.startMeter) document.getElementById("startMeter").value = data.startMeter;
      if (data.endDate) document.getElementById("endDate").value = data.endDate;
      if (data.endMeter) document.getElementById("endMeter").value = data.endMeter;
      if (data.plz) document.getElementById("plzInputRubrik1").value = data.plz;
    }

    // Automatisch speichern bei Eingabe
    const fields = ["startDate", "startMeter", "endDate", "endMeter", "plzInputRubrik1"];
    fields.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener("input", saveRubrik1Inputs);
        el.addEventListener("blur", saveRubrik1Inputs);
      }
    });
  });

  // ResetAll um Speicher zu leeren
  const originalResetAll = resetAll;
  resetAll = function () {
    localStorage.removeItem("rubrik1Data");
    originalResetAll();
  };
</script><script>
function toggleHddTable() {
  const detailed = document.getElementById('detailedTable');
  const original = document.getElementById('originalWeights');
  const hddBtn = document.getElementById('showHddTableBtn');
  const stdBtn = document.getElementById('showStandardTableBtn');
  if (!detailed || !hddBtn) return;
  const vis = getComputedStyle(detailed).display === 'block';
  if (vis) {
    detailed.style.display = 'none';
    hddBtn.textContent = 'HDD-Tabelle einblenden';
  } else {
    // hide original weights
    if (original) original.style.display = 'none';
    // show detailed HDD
    showHddTable();
    detailed.style.display = 'block';
    hddBtn.textContent = 'HDD-Tabelle ausblenden';
    // reset other button
    if (stdBtn) stdBtn.textContent = 'Tabelle A einblenden';
  }
}

function toggleStandardTable() {
  const detailed = document.getElementById('detailedTable');
  const original = document.getElementById('originalWeights');
  const hddBtn = document.getElementById('showHddTableBtn');
  const stdBtn = document.getElementById('showStandardTableBtn');
  if (!stdBtn) return;
  const vis = original && getComputedStyle(original).display === 'block';
  if (vis) {
    original.style.display = 'none';
    stdBtn.textContent = 'Tabelle A einblenden';
  } else {
    // hide detailed HDD
    if (detailed) detailed.style.display = 'none';
    // show static A
    updateStandardTable();
    if (original) original.style.display = 'block';
    stdBtn.textContent = 'Tabelle A ausblenden';
    // reset other button
    if (hddBtn) hddBtn.textContent = 'HDD-Tabelle einblenden';
  }
}
</script><script>
(function(){
  const _origResetAll = window.resetAll;
  window.resetAll = function() {
    _origResetAll();
    // Clear PLZ field in Rubrik 1
    const plzEl = document.getElementById("plzInputRubrik1");
    const errEl = document.getElementById("plzErrorRubrik1");
    if (plzEl) plzEl.value = "";
    if (errEl) errEl.textContent = "";
  
  var wt = document.getElementById("weightTableSelect"); if (wt) wt.value = "plz";
  changeWeightTable();
};
})();
</script><script>
// Radio → Dropdown
document.querySelectorAll('input[name="weightBasis"]').forEach(radio => {
  radio.addEventListener('change', () => {
    const sel = document.getElementById('weightTableSelect');
    sel.value = radio.value;
    changeWeightTable();
  });
});

// Dropdown → Radio
document.getElementById('weightTableSelect').addEventListener('change', e => {
  const radio = document.querySelector(`input[name="weightBasis"][value="${e.target.value}"]`);
  if (radio) radio.checked = true;
});
</script><script>
document.addEventListener('DOMContentLoaded', () => {
  const radios = document.querySelectorAll('input[name="weightBasis"]');
  const rubriks = ['rubrik3','rubrik4','rubrik5','rubrik6','rubrik7'];

  function onBasisChange() {
    const val = this.value;  // 'plz' oder 'A'
    // Rubriken je nach Auswahl ein- oder ausblenden
    rubriks.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = (val === 'A' ? 'block' : 'none');
    });
    // Gewichte umschalten
    if (val === 'plz' && window.plzWeights) {
      currentMonthWeights = window.plzWeights;
    } else {
      currentMonthWeights = window.monthWeightsA;
    }
    // Berechnung erneut anstoßen
    if (typeof calculate === 'function') calculate();
    if (typeof calculateCost === 'function') calculateCost();
  }

  // Listener auf alle Radio‑Buttons hängen
  radios.forEach(radio => {
    radio.addEventListener('change', onBasisChange);
  });
});
</script><script>
(function(){
  document.addEventListener('DOMContentLoaded', function(){
    const radios   = document.querySelectorAll('input[name="weightBasis"]');
    const fetchBtn = document.getElementById('fetchWeightsBtn');
    const msgEl    = document.getElementById('fetchMsg');

    function onBasisChange() {
      const val = this.value;
      const sd = document.getElementById('startDate').value.trim();
      const sm = document.getElementById('startMeter').value.trim();
      const ed = document.getElementById('endDate').value.trim();
      const em = document.getElementById('endMeter').value.trim();
      const dataReady = sd && sm && ed && em;

      ['rubrik3','rubrik4','rubrik5','rubrik6','rubrik7'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.style.display = (val==='A' && dataReady) ? 'block' : 'none';
      });

      window.currentMonthWeights = (val==='plz' && window.plzWeights)
        ? window.plzWeights
        : window.monthWeightsA;
      if (typeof calculate==='function')    calculate();
      if (typeof calculateCost==='function') calculateCost();

      if (val==='A') {
        if (fetchBtn) fetchBtn.style.display = dataReady ? 'none' : '';
        const statusDot=document.getElementById('fetchStatus');
        if (statusDot){ statusDot.style.display='none'; statusDot.style.backgroundColor='#ccc'; }

        const inline=document.getElementById('tableAInlineMsg'); if(inline) inline.textContent = dataReady ? 'Daten geladen' : ''; if(msgEl) msgEl.innerText='';
      } else { if(fetchBtn) fetchBtn.style.display='';
        const statusDot=document.getElementById('fetchStatus');
        if (statusDot){ statusDot.style.display='inline-block'; }
 if(msgEl) msgEl.innerText=''; const inline=document.getElementById('tableAInlineMsg'); if(inline) inline.textContent=''; }
    }

    radios.forEach(radio => {
      radio.addEventListener('change', onBasisChange);
    });

    const select = document.getElementById('weightTableSelect');
    if (select) {
      select.addEventListener('change', function(e){
        const radio = document.querySelector(
          `input[name="weightBasis"][value="${e.target.value}"]`
        );
        if (radio) {
          radio.checked = true;
          onBasisChange.call(radio);
        }
      });
    }
  });
})();
</script><script>
(function(){
  document.addEventListener('DOMContentLoaded', function(){
    const weightRadios = document.querySelectorAll('input[name="weightBasis"]');
    const fetchBtn = document.getElementById('fetchWeightsBtn');
    const msgEl = document.getElementById('fetchMsg');
    function handleBasis() {
      const val = this.value;
      const sdEl = document.getElementById('startDate');
      const smEl = document.getElementById('startMeter');
      const edEl = document.getElementById('endDate');
      const emEl = document.getElementById('endMeter');
      if (!sdEl || !smEl || !edEl || !emEl) return;
      const sd = sdEl.value.trim();
      const sm = smEl.value.trim();
      const ed = edEl.value.trim();
      const em = emEl.value.trim();
      const dataReady = sd !== '' && sm !== '' && ed !== '' && em !== '';
      ['rubrik3','rubrik4','rubrik5','rubrik6','rubrik7'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          if (val === 'A' && dataReady) {
            el.style.display = 'block';
          } else if (val === 'A') {
            el.style.display = 'none';
          } else {
            el.style.display = 'block';
          }
        }
      });
      window.currentMonthWeights = (val === 'plz' && window.plzWeights) ? window.plzWeights : window.monthWeightsA;
      // F6: Registry support & UI sync for Rubrik 1
      if (val !== 'plz' && val !== 'A' && window.WEIGHTS_REGISTRY && window.WEIGHTS_REGISTRY.staticTables && window.WEIGHTS_REGISTRY.staticTables[val]) {
        var regSrc = window.WEIGHTS_REGISTRY.staticTables[val];
        var m = {};
        for (var i2=1; i2<=12; i2++) {
          var kk = i2.toString().padStart(2,"0");
          m[kk] = Number(regSrc[i2-1]) || 0;
        }
        window.currentMonthWeights = m;
      }
      var sel2 = document.getElementById('weightTableSelect');
      if (sel2) sel2.value = val;
      var rubrik2b = document.getElementById('rubrik2b');
      if (rubrik2b) rubrik2b.style.display = (val === 'plz') ? 'block' : 'none';
      if (val !== 'plz') {
        var fetchBtn = document.getElementById('fetchWeightsBtn');
        if (fetchBtn) fetchBtn.style.display = 'none';
        var statusDot = document.getElementById('fetchStatus');
        if (statusDot){ statusDot.style.display='none'; statusDot.style.backgroundColor='#ccc'; }
      }
    
      if (typeof calculate === 'function') calculate();
      if (typeof calculateCost === 'function') calculateCost();
      if (val === 'A') {
        if (fetchBtn) fetchBtn.style.display = 'none';
        const statusDot=document.getElementById('fetchStatus');
        if (statusDot){ statusDot.style.display='none'; statusDot.style.backgroundColor='#ccc'; }

        const inline=document.getElementById('tableAInlineMsg'); if(inline) inline.textContent = dataReady ? 'Daten geladen' : ''; if(msgEl) msgEl.innerText='';
      } else { if(fetchBtn) fetchBtn.style.display='';
        const statusDot=document.getElementById('fetchStatus');
        if (statusDot){ statusDot.style.display='inline-block'; }
 if(msgEl) msgEl.innerText=''; const inline=document.getElementById('tableAInlineMsg'); if(inline) inline.textContent=''; }
    
    if (typeof changeWeightTable === 'function') changeWeightTable();
}
    weightRadios.forEach(radio => {
      radio.addEventListener('change', handleBasis);
    });
    ['startDate','startMeter','endDate','endMeter'].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', function(){
          const radio = document.querySelector('input[name="weightBasis"]:checked');
          if (radio) handleBasis.call(radio);
        });
      }
    });
  });
})();
</script><script>
// Hervorhebung der 'Summe:'-Zeilen in Rubrik 3 nach Rendern und Toggle
function highlightRubrik3SumLines() {
  document.querySelectorAll('#m3ForecastExplanation li').forEach(li => {
    if (li.textContent.trim().startsWith('Summe:')) {
      li.classList.add('sum-highlight');
    }
  });
}
document.addEventListener('DOMContentLoaded', highlightRubrik3SumLines);
const origToggle = window.toggleExplanation;
window.toggleExplanation = function(id, btn) {
  origToggle(id, btn);
  if (id === 'm3ForecastExplanation') {
    highlightRubrik3SumLines();
  }
};
</script><script>
document.addEventListener('DOMContentLoaded', function toggleHintOnLoad(){
  const hintEl = document.getElementById('mainDataHint');
  if (hintEl){
    const inputsFilled = ['startDate','startMeter','endDate','endMeter']
      .every(id => document.getElementById(id)?.value.trim() !== '');
    hintEl.classList.toggle('stop', inputsFilled);
  }
});
</script><script>
document.addEventListener('DOMContentLoaded', function(){
  const aRadio = document.querySelector('input[name="weightBasis"][value="A"]');
  const statusDot = document.getElementById('fetchStatus');
  if (aRadio && aRadio.checked && statusDot){
    statusDot.style.display='none'; statusDot.style.backgroundColor='#ccc';
  }
});
</script><script>
(function(){
  // Weight Table Registry (non-invasive). Allows adding future static tables (e.g., "B").
  var REG = (window.WEIGHTS_REGISTRY = window.WEIGHTS_REGISTRY || { staticTables: {} });

  function registerWeightTable(key, arr){
    if(!key) return;
    if(!Array.isArray(arr) || arr.length !== 12) return;
    REG.staticTables[key] = arr.map(function(v){ return Number(v); });
  }
  window.registerWeightTable = registerWeightTable;

  function loadInlineWeightTables(){
    var blocks = document.querySelectorAll('script[type="application/json"][data-weight-table]');
    blocks.forEach(function(s){
      try{
        var key = (s.getAttribute('data-weight-table')||'').trim();
        if(!key) return;
        var arr = JSON.parse(s.textContent||"[]");
        registerWeightTable(key, arr);
      }catch(e){/* ignore malformed JSON */}
    });
  }

  function findWeightSelect(){
    var selects = Array.prototype.slice.call(document.querySelectorAll("select"));
    for(var i=0;i<selects.length;i++){
      var sel = selects[i];
      var text = (sel.innerText||"").toLowerCase();
      if(text.includes("plz") && (text.includes("tabelle a") || /\bA\b/.test(text))) return sel;
    }
    return null;
  }

  function ensureSelectOptions(){
    var sel = findWeightSelect();
    if(!sel) return;
    var existing = Array.prototype.slice.call(sel.options).map(function(o){
      return ((o.value||o.textContent||"") + "").trim().toLowerCase();
    });
    Object.keys(REG.staticTables).forEach(function(key){
      var k = (key+"").trim();
      if(!k) return;
      var low = k.toLowerCase();
      if(existing.indexOf(low) >= 0) return;
      var opt = document.createElement("option");
      opt.value = k;
      opt.textContent = /^[a-z]$/i.test(k) ? ("Tabelle " + k.toUpperCase()) : k;
      sel.appendChild(opt);
    });
  }

  document.addEventListener("DOMContentLoaded", function(){
    try{ loadInlineWeightTables(); ensureSelectOptions(); }catch(e){}
  });
})();
</script><script data-weight-table="B" type="application/json">[20.231,12.340,11.944,8.086,1.525,1.475,1.525,1.525,1.475,7.025,14.697,18.152]</script><script>
(function(){
  function updateBTable() {
    var bDiv = document.getElementById('originalWeightsB');
    if (!bDiv) return;
    var reg = (window.WEIGHTS_REGISTRY && window.WEIGHTS_REGISTRY.staticTables)
              ? window.WEIGHTS_REGISTRY.staticTables['B'] : null;
    if (!reg || reg.length !== 12) {
      bDiv.innerHTML = '<p><em>Keine Tabelle DWD vorhanden.</em></p>';
      return;
    }
    var headingText = "Monatsgewichtungen (Tabelle DWD)";
    var html = "<h3>"+headingText+"</h3><ul>";
    var ordered = ["01","02","03","04","05","06","07","08","09","10","11","12"];
    for (var i=0;i<12;i++){
      var k = ordered[i];
      var v = Number(reg[i]) || 0;
      var name = (window.monthNames && window.monthNames[k]) ? window.monthNames[k] : k;
      try { html += "<li>"+name+": "+v.toLocaleString('de-DE', {minimumFractionDigits:3})+"</li>"; }
      catch(e){ html += "<li>"+name+": "+v+"</li>"; }
    }
    html += "</ul>";
    bDiv.innerHTML = html;
  }
  window.updateBTable = updateBTable;

  function toggleBTable() {
    var detailed = document.getElementById('detailedTable');
    var aDiv = document.getElementById('originalWeights');
    var bDiv = document.getElementById('originalWeightsB');
    var hddBtn = document.getElementById('showHddTableBtn');
    var bBtn  = document.getElementById('showBTableBtn');
    if (!bBtn) return;
    var vis = bDiv && getComputedStyle(bDiv).display === 'block';
    if (vis) {
      if (bDiv) bDiv.style.display = 'none';
      bBtn.textContent = 'Tabelle DWD einblenden';
    } else {
      if (detailed) detailed.style.display = 'none';
      if (aDiv) aDiv.style.display = 'none';
      updateBTable();
      if (bDiv) bDiv.style.display = 'block';
      bBtn.textContent = 'Tabelle DWD ausblenden';
      if (hddBtn) hddBtn.textContent = 'HDD-Tabelle einblenden';
      var aBtn = document.getElementById('showStandardTableBtn');
      if (aBtn) aBtn.textContent = 'Tabelle A einblenden';
    }
  }
  window.toggleBTable = toggleBTable;

  document.addEventListener('DOMContentLoaded', function(){
    var bBtn = document.getElementById('showBTableBtn');
    if (!bBtn) return;
    var hasB = !!(window.WEIGHTS_REGISTRY && window.WEIGHTS_REGISTRY.staticTables && window.WEIGHTS_REGISTRY.staticTables['B']);
    if (!hasB) {
      // after registry loader runs
      setTimeout(function(){
        var hasB2 = !!(window.WEIGHTS_REGISTRY && window.WEIGHTS_REGISTRY.staticTables && window.WEIGHTS_REGISTRY.staticTables['B']);
        if (!hasB2) { bBtn.style.display = 'none'; }
      }, 0);
    }
  });
})();
</script><script>
(function(){
  function enforceRubrik2bGate() {
    var r2b = document.getElementById('rubrik2b');
    if (!r2b) return;
    var unlocked = document.body.classList.contains('code-unlocked');
    if (!unlocked) {
      r2b.style.display = 'none';
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    // 1) Hide on load
    enforceRubrik2bGate();

    // 2) Observe body class changes to detect code unlock
    var mo = new MutationObserver(function(muts){
      enforceRubrik2bGate();
      // If unlocked, leave further show/hide to existing logic (e.g., basis=PLZ)
      if (document.body.classList.contains('code-unlocked')) {
        // no-op
      }
    });
    mo.observe(document.body, { attributes: true, attributeFilter: ['class'] });

    // 3) Wrap changeWeightTable to enforce gate after it runs
    var orig = window.changeWeightTable;
    window.changeWeightTable = function(){
      if (typeof orig === 'function') orig.apply(this, arguments);
      enforceRubrik2bGate();
    };
  });
})();
</script><script>
(function(){
  function toggleRubrik2b(){
    var sec = document.getElementById('rubrik2b');
    if(!sec) return;
    if (sec.style.display === 'none' || sec.style.display === '') {
      sec.style.display = 'block';
      try{ sec.scrollIntoView({behavior:'smooth', block:'start'}); }catch(e){}
    } else {
      sec.style.display = 'none';
    }
  }
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('toggleRubrik2bBtn');
    if(btn) btn.addEventListener('click', toggleRubrik2b);
  });
  if (typeof changeWeightTable === 'function') {
    var _orig = changeWeightTable;
    changeWeightTable = function(){
      _orig.apply(this, arguments);
      var sel = document.getElementById('weightTableSelect');
      if (sel && sel.value === 'plz') {
        var sec = document.getElementById('rubrik2b');
        if (sec) sec.style.display = 'none';
      }
    };
  }
})();
</script><script id="fix-weights-sidepanel-js">
(function(){
  const MONTHS = ["01","02","03","04","05","06","07","08","09","10","11","12"];

  function renderWeightsInSidePanel(weightsObj, titleText){
    const panel = document.getElementById('originalWeights');
    if(!panel) return;
    const rows = MONTHS.map(m => {
      const v = (weightsObj && (m in weightsObj)) ? weightsObj[m] : "";
      return '<div style="display:flex;justify-content:space-between;padding:2px 0;"><span>'+m+'</span><strong>'+v+'</strong></div>';
    }).join("");
    panel.innerHTML = [
      '<div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;margin-bottom:.5rem;">',
        '<h4 style="margin:0;">'+(titleText||'Monatsgewichte')+'</h4>',
        '<button type="button" id="closeWeightsPanel" style="border:1px solid #999;background:#f5f5f5;padding:2px 6px;cursor:pointer;">×</button>',
      '</div>',
      rows,
      '<hr><small style="opacity:.7;">Statische Monatsgewichte</small>'
    ].join("");
    panel.style.display = 'block';
    document.body.classList.add('weights-panel-open');
    const closeBtn = document.getElementById('closeWeightsPanel');
    if(closeBtn){
      closeBtn.onclick = () => {
        panel.style.display = 'none';
        document.body.classList.remove('weights-panel-open');
      };
    }
  }

  function hideInlineWeightsTables(){
    ['monthWeightList','detailedTable','tbl'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.style.display = 'none';
    });
  }

  function tryExtractWeightsFromInline(){
    // Generic extractor that looks for a table listing months and values
    // Supported containers: #detailedTable, #tbl
    const cands = [document.querySelector('#detailedTable table'), document.querySelector('#tbl')];
    for(const table of cands){
      if(!table) continue;
      const map = {};
      const rows = table.querySelectorAll('tr');
      rows.forEach(tr=>{
        const tds = tr.querySelectorAll('td,th');
        if(!tds || tds.length < 2) return;
        const txt = (tds[0].innerText || '').trim();
        const m = txt.match(/^(0?[1-9]|1[0-2])|jan|feb|mär|mar|apr|mai|jun|jul|aug|sep|okt|nov|dez/i);
        if(m){
          // Try last numeric cell
          let val = null;
          for(let i=tds.length-1;i>=1;i--){
            const s = (tds[i].innerText||'').replace(',', '.').replace(/[^0-9.\-]/g,'');
            if(s && !isNaN(parseFloat(s))){ val = parseFloat(s); break; }
          }
          // Normalize month to "MM"
          let mm = txt.slice(0,2).padStart(2,'0');
          if(!/^\d{2}$/.test(mm)){
            const names = ['jan','feb','mär','mar','apr','mai','jun','jul','aug','sep','okt','nov','dez'];
            const idx = names.findIndex(n => new RegExp('^'+n,'i').test(txt));
            if(idx>=0) mm = String(idx+1).padStart(2,'0');
          }
          if(/^\d{2}$/.test(mm) && val!=null) map[mm] = val;
        }
      });
      if(Object.keys(map).length>=10) return map;
    }
    return null;
  }

  function ensureWeights(source){
    if(source==='A'){
      if(window.monthWeightsA) return window.monthWeightsA;
    }
    if(source==='B'){
      if(window.monthWeightsB) return window.monthWeightsB;
    }
    // Fallback: try to parse inline
    return tryExtractWeightsFromInline();
  }

  function openPanelFor(source){
    hideInlineWeightsTables();
    const weights = ensureWeights(source);
    const title = 'Tabelle '+source+' – Monatsgewichte';
    renderWeightsInSidePanel(weights||{}, title);
  }

  function setup(){
    // Hook select change
    const sel = document.getElementById('weightTableSelect');
    if(sel && !sel.dataset.weightsHooked){
      sel.addEventListener('change', function(){
        const v = (this.value||'').toString().trim().toUpperCase();
        if(v==='A' || v==='TAB_A' || /tabelle\s*A/i.test(v)){
          openPanelFor('A');
        } else if(v==='B' || v==='TAB_B' || /tabelle\s*B/i.test(v)){
          // slight delay to allow any inline render first (for extraction fallback)
          setTimeout(()=>openPanelFor('B'), 50);
        } else {
          // other modes -> close panel if open
          const p = document.getElementById('originalWeights');
          if(p){ p.style.display='none'; document.body.classList.remove('weights-panel-open'); }
          // re-show inline if previously hidden
          ['monthWeightList','detailedTable','tbl'].forEach(id=>{
            const el = document.getElementById(id);
            if(el) el.style.display = '';
          });
        }
      });
      sel.dataset.weightsHooked = '1';
    }

    // Hook optional buttons
    const btnA = document.getElementById('showTableA') || document.querySelector('[data-weight="A"]');
    const btnB = document.getElementById('showTableB') || document.querySelector('[data-weight="B"]');
    if(btnA && !btnA.dataset.weightsHooked){
      btnA.addEventListener('click', ()=>openPanelFor('A'));
      btnA.dataset.weightsHooked = '1';
    }
    if(btnB && !btnB.dataset.weightsHooked){
      btnB.addEventListener('click', ()=>setTimeout(()=>openPanelFor('B'), 50));
      btnB.dataset.weightsHooked = '1';
    }

    // MutationObserver: if inline detailed table for B pops in, move to side panel
    const target = document.getElementById('detailedTable') || document.getElementById('tbl');
    if(target && !target.dataset.weightsObserved){
      const obs = new MutationObserver(()=>{
        // If something rendered that looks like B (heuristic: heading contains "B")
        const txt = (target.innerText||'').toLowerCase();
        if(/tabelle\s*b/.test(txt) || /gewichte\s*b/.test(txt)){
          setTimeout(()=>openPanelFor('B'), 20);
        }
      });
      obs.observe(target, {subtree:true, childList:true, characterData:true});
      target.dataset.weightsObserved = '1';
    }
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', setup);
  } else {
    setup();
  }
})();
</script><script id="fix-weights-sidepanel-js-v3">
(function(){
  const MONTHS = ["01","02","03","04","05","06","07","08","09","10","11","12"];

  function hidePlzPopup(){
    try{
      const all = document.querySelectorAll('div,section,aside,article');
      for(const el of all){
        const t = (el.innerText||'').trim().toLowerCase();
        if(t.includes('monatsgewichtungen (plz-basiert)')){
          el.style.display = 'none';
        }
      }
    }catch(e){}
  }

  function renderWeightsInSidePanel(weightsObj, titleText){
    window.renderWeightsInSidePanel = renderWeightsInSidePanel;
    hidePlzPopup();
    const panel = document.getElementById('originalWeights');
    if(!panel) return;
    const rows = MONTHS.map(m => {
      const v = (weightsObj && (m in weightsObj)) ? weightsObj[m] : "";
      return '<div style="display:flex;justify-content:space-between;padding:2px 0;"><span>'+m+'</span><strong>'+v+'</strong></div>';
    }).join("");
    panel.innerHTML = [
      '<div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;margin-bottom:.5rem;">',
        '<h4 style="margin:0;">'+(titleText||'Monatsgewichte')+'</h4>',
        '<button type="button" id="closeWeightsPanel" style="border:1px solid #999;background:#f5f5f5;padding:2px 6px;cursor:pointer;">×</button>',
      '</div>',
      rows,
      '<hr><small style="opacity:.7;">Statische Monatsgewichte</small>'
    ].join("");
    panel.style.display = 'block';
    document.body.classList.add('weights-panel-open');
    const closeBtn = document.getElementById('closeWeightsPanel');
    if(closeBtn){
      closeBtn.onclick = () => {
        panel.style.display = 'none';
        document.body.classList.remove('weights-panel-open');
      };
    }
  }

  function hideInlineWeightsTables(){
    ['monthWeightList','detailedTable','tbl'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.style.display = 'none';
    });
  }

  function tryExtractWeightsFromInlineTables(){
    const cands = [document.querySelector('#detailedTable table'), document.querySelector('#tbl')];
    for(const table of cands){
      if(!table) continue;
      const map = {};
      const rows = table.querySelectorAll('tr');
      rows.forEach(tr=>{
        const tds = tr.querySelectorAll('td,th');
        if(!tds || tds.length < 1) return;
        const first = (tds[0].innerText || '').trim();
        // month like "01" or "01:" or "Januar"
        let mm = null;
        const numMatch = first.match(/^(\d{1,2})/);
        if(numMatch){ mm = numMatch[1].padStart(2,'0'); }
        else {
          const names = ['jan','feb','mär','mar','apr','mai','jun','jul','aug','sep','okt','nov','dez'];
          const idx = names.findIndex(n => new RegExp('^'+n,'i').test(first));
          if(idx>=0) mm = String(idx+1).padStart(2,'0');
        }
        if(!mm) return;
        // scan row for last number
        const rowText = tr.innerText.replace(/\s/g,'').replace(',', '.');
        const matches = rowText.match(/(-?\d+(?:\.\d+)?)/g);
        if(matches && matches.length){
          const val = parseFloat(matches[matches.length-1]);
          if(!isNaN(val)) map[mm] = val;
        }
      });
      if(Object.keys(map).length>=10) return map;
    }
    return null;
  }

  function tryExtractWeightsFromTextBlocks(){
    // Look for a block around "Monatsgewichtungen (Tabelle DWD)"
    const all = document.querySelectorAll('div,section,article,p,li');
    let startIdx = -1;
    let elements = Array.from(all);
    for(let i=0;i<elements.length;i++){
      const t = (elements[i].innerText||'').toLowerCase();
      if(t.includes('monatsgewichtungen') && t.includes('tabelle') && t.includes('b')){
        startIdx = i;
        break;
      }
    }
    const map = {};
    const regex = /(0[1-9]|1[0-2]|[1-9])\s*[:.-]?\s*([0-9]{1,3}(?:[.,][0-9]{3})*(?:[.,][0-9]+)?)/g;
    function parseText(text){
      let m;
      while((m = regex.exec(text))){
        const mm = m[1].padStart(2,'0');
        const num = m[2].replace(/\./g,'').replace(',','.');
        const v = parseFloat(num);
        if(!isNaN(v)) map[mm] = v;
      }
    }
    if(startIdx>=0){
      for(let i=startIdx;i<Math.min(startIdx+8, elements.length); i++){
        parseText(elements[i].innerText || '');
      }
    } else {
      // fallback: scan entire document text (last resort)
      parseText(document.body ? document.body.innerText || '' : '');
    }
    return Object.keys(map).length>=10 ? map : null;
  }

  function ensureWeights(source){
    if(source==='A' && window.monthWeightsA) return window.monthWeightsA;
    if(source==='B' && window.monthWeightsB) return window.monthWeightsB;
    return {};
  };
  }

  function openPanelFor(source){
    const weights = ensureWeights(source) || {};
    hideInlineWeightsTables(); // hide only after extraction
    renderWeightsInSidePanel(weights, 'Monatsgewichtungen (Tabelle '+source+')');
  }

  function interceptClicks(){
    document.addEventListener('click', function(ev){
      const el = ev.target;
      const txt = (el.innerText||'').toLowerCase();
      if(/tabelle\s*a/.test(txt)){
        ev.preventDefault(); ev.stopPropagation();
        openPanelFor('A');
      } else if(/tabelle\s*b/.test(txt)){
        ev.preventDefault(); ev.stopPropagation();
        openPanelFor('B');
      }
    }, true);
  }

  function hookSelector(){
    const sel = document.getElementById('weightTableSelect');
    if(sel && !sel.dataset.weightsHooked){
      sel.addEventListener('change', function(){
        const v = (this.value||'').toString().trim().toUpperCase();
        if(v==='A' || v==='TAB_A'){
          openPanelFor('A');
        } else if(v==='B' || v==='TAB_B'){
          openPanelFor('B');
        }
      });
      sel.dataset.weightsHooked = '1';
    }
  }

  function setup(){
    hookSelector();
    interceptClicks();
    const target = document.getElementById('detailedTable') || document.getElementById('tbl');
    if(target && !target.dataset.weightsObserved){
      const obs = new MutationObserver(()=>{
        // if B appears inline, move it
        const t = (target.innerText||'').toLowerCase();
        if(t.includes('tabelle b')){
          openPanelFor('B');
        }
      });
      obs.observe(target, {subtree:true, childList:true, characterData:true});
      target.dataset.weightsObserved = '1';
    }
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', setup);
  } else {
    setup();
  }
})();
</script><script id="enforce-static-A-B-v3">
(function(){
  function openA(){ window.showWeightsPanel(window.monthWeightsA||{}, 'Monatsgewichtungen (Tabelle A)'); }
  function openB(){ window.showWeightsPanel(window.monthWeightsB||{}, 'Tabelle DWD – Monatsgewichte'); }

  // Direct hooks for common IDs (if present)
  document.addEventListener('DOMContentLoaded', function(){
    var a = document.getElementById('showTableA');
    var b = document.getElementById('showTableB');
    if(a && !a.dataset.hooked){ a.addEventListener('click', function(e){ e.preventDefault(); e.stopPropagation(); openA(); }); a.dataset.hooked='1'; }
    if(b && !b.dataset.hooked){ b.addEventListener('click', function(e){ e.preventDefault(); e.stopPropagation(); openB(); }); b.dataset.hooked='1'; }
  });

  // Generic capture for any button/link labeled with Tabelle A/B
  document.addEventListener('click', function(ev){
    var btn = ev.target.closest && ev.target.closest('button, a, span, div');
    var txt = (btn ? btn.innerText : ev.target.innerText) || '';
    txt = txt.toLowerCase();
    if(/tabelle\s*a/.test(txt) && /(einblenden|anzeigen)/.test(txt)){
      ev.preventDefault(); ev.stopPropagation(); openA();
    } else if(/tabelle\s*b/.test(txt) && /(einblenden|anzeigen)/.test(txt)){
      ev.preventDefault(); ev.stopPropagation(); openB();
    }
  }, true);

  // Hide inline tables whenever panel is used
  function hideInline(){
    ['monthWeightList','detailedTable','tbl'].forEach(function(id){
      var el = document.getElementById(id);
      if(el) el.style.display = 'none';
    });
  }
  var _old = window.showWeightsPanel;
  window.showWeightsPanel = function(weights, title){
    hideInline();
    return _old(weights, title);
  };
})();
</script><script id="second-period-ready-controller">
(function(){
  function parseNum(s){
    if(s==null) return null;
    s = String(s).trim().replace(/\s/g,'');
    if(!s) return null;
    var n = Number(s.replace(/\./g,'').replace(',', '.'));
    return isNaN(n) ? null : n;
  }
  function parseDateDE(s){
    if(!s) return null;
    var m = String(s).trim().match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
    if(!m) return null;
    var d = new Date(+m[3], +m[2]-1, +m[1]);
    return isNaN(d.getTime()) ? null : d;
  }
  function updateFlag(){
    var d1 = document.getElementById('startDate2');
    var d2 = document.getElementById('endDate2');
    var m1 = document.getElementById('startMeter2');
    var m2 = document.getElementById('endMeter2');
    if(!d1 || !d2 || !m1 || !m2){ document.body.classList.remove('second-period-ready'); return; }
    var date1 = parseDateDE(d1.value||'');
    var date2 = parseDateDE(d2.value||'');
    var v1 = parseNum(m1.value);
    var v2 = parseNum(m2.value);
    var ok = !!(date1 && date2 && v1!=null && v2!=null && v2 > v1);
    document.body.classList.toggle('second-period-ready', ok);
  }
  function setup(){
    var ids = ['startDate2','endDate2','startMeter2','endMeter2'];
    ids.forEach(function(id){
      var el = document.getElementById(id);
      if(el){
        ['input','change','blur'].forEach(function(evt){
          el.addEventListener(evt, updateFlag, {passive:true});
        });
      }
    });
    var out = document.getElementById('m3Difference2');
    if(out){
      var obs = new MutationObserver(function(){ updateFlag(); });
      obs.observe(out, {childList:true, characterData:true, subtree:true});
    }
    setTimeout(updateFlag, 0);
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', setup); }
  else { setup(); }
})();
</script><script id="toggle-rubrik1b-safe">
(function(){
  var btn = document.getElementById('toggleRubrik1bBtn');
  var sec = document.getElementById('zweiterZeitraum');
  if(!btn || !sec) return;

  var userOpened = false;

  function showBtn(){ btn.style.display = 'inline-block'; }
  function hideBtn(){ btn.style.display = 'none'; }

  function toggleSec(){
    var isHidden = (sec.style.display === '' || sec.style.display === 'none');
    if(isHidden){
      sec.style.display = 'block';
      btn.textContent = '2. Zeitraum ausblenden';
      userOpened = true;
    } else {
      sec.style.display = 'none';
      btn.textContent = '2. Zeitraum einblenden';
      userOpened = false;
    }
  }
  btn.addEventListener('click', toggleSec);

  // Keep section hidden initially; user decides
  sec.style.display = 'none';
  btn.textContent = '2. Zeitraum einblenden';

  // Compute if Zeitraum 1 consists only of summer months (May-Sep)
  function parseDE(d){
    if(!d) return null;
    var m = String(d).trim().match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
    if(!m) return null;
    var dt = new Date(+m[3], +m[2]-1, +m[1]);
    return isNaN(dt.getTime()) ? null : dt;
  }
  function monthsBetween(start, end){
    var arr=[], cur=new Date(start.getFullYear(), start.getMonth(), 1);
    var last=new Date(end.getFullYear(), end.getMonth(), 1);
    while(cur <= last){ arr.push(cur.getMonth()+1); cur.setMonth(cur.getMonth()+1); }
    return arr;
  }
  function onlySummer(){
    var sEl = document.getElementById('startDate');
    var eEl = document.getElementById('endDate');
    if(!sEl || !eEl) return false;
    var s = parseDE(sEl.value||''), e = parseDE(eEl.value||'');
    if(!s || !e){ return false; }
    if(e < s){ var t=s; s=e; e=t; }
    var months = monthsBetween(s,e);
    return months.length>0 && months.every(function(m){ return m>=5 && m<=9; });
  }

  function updateButtonByRule(){
  // Always show the toggle button; keep section closed unless user opens it
  if (btn) btn.style.display = 'inline-block';
  if (sec && !userOpened){
    sec.style.display = 'none';
    btn.textContent = '2. Zeitraum einblenden';
  }
}


  // Observe attempts to auto-show; revert unless user opened
  var obs = new MutationObserver(function(muts){
    muts.forEach(function(m){
      if(m.attributeName === 'style'){
        var nowBlock = (sec.style.display === 'block');
        if(nowBlock && !userOpened && onlySummer()){
          sec.style.display = 'none';
          showBtn();
          btn.textContent = '2. Zeitraum einblenden';
        }
      }
    });
  });
  obs.observe(sec, {attributes:true, attributeFilter:['style']});

  // Hook date inputs to refresh the rule
  ['startDate','endDate'].forEach(function(id){
    var el = document.getElementById(id);
    if(el){
      ['input','change','blur'].forEach(function(evt){
        el.addEventListener(evt, updateButtonByRule);
      });
    }
  });

  // Initial apply
  setTimeout(updateButtonByRule, 0);
  document.addEventListener('calculate-finished', updateButtonByRule);
})();
</script><script>
(function(){
  function clearRubrik1b(){
    var ids = ['startDate2','endDate2','startMeter2','endMeter2'];
    ids.forEach(function(id){ var el = document.getElementById(id); if(el){ el.value=''; el.dispatchEvent(new Event('input',{bubbles:true})); } });
    var diff = document.getElementById('m3Difference2'); if(diff){ diff.textContent = '0,000'; }
    var err1 = document.getElementById('rubrik1bError'); if(err1){ err1.textContent=''; err1.classList.remove('visible'); }
    var err2 = document.getElementById('meterError2'); if(err2){ err2.textContent=''; err2.classList.remove('visible'); }
    var ww = document.getElementById('winterWarning'); if(ww){ ww.textContent=''; ww.classList.remove('visible'); }
    if (typeof validateRubrik1b === 'function'){ try{ validateRubrik1b(); }catch(e){} }
    document.body.classList.remove('second-period-ready');
  }
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('resetRubrik1bBtn');
    if(btn){ btn.addEventListener('click', clearRubrik1b); }
  });
})();
</script><script>
document.addEventListener('DOMContentLoaded', function(){
  function handleRubrik1bChange(){
    if (typeof validateRubrik1b === 'function') try{ validateRubrik1b(); }catch(e){}
    if (typeof updateMonthWeightList === 'function') try{ updateMonthWeightList(); }catch(e){}
    if (typeof calculate === 'function') try{ calculate(); }catch(e){}
  }
  ['startMeter2','endMeter2','startDate2','endDate2'].forEach(function(id){
    var el = document.getElementById(id);
    if (el){
      el.addEventListener('input', handleRubrik1bChange);
      el.addEventListener('change', handleRubrik1bChange);
      el.addEventListener('blur', handleRubrik1bChange);
    }
  });
});
</script><script id="fix-updateButtonByRule">
(function(){
  window.updateButtonByRule = function(){
    var btn = document.getElementById('toggleRubrik1bBtn');
    var sd  = document.getElementById('startDate');
    var ed  = document.getElementById('endDate');
    var summerWarn = document.getElementById('summerWarning');
    if (!btn || !sd || !ed){ return; }

    function parseDate(d){
      if(!d) return null;
      var p = d.split('.');
      if(p.length !== 3) return null;
      var dd = parseInt(p[0],10), mm = parseInt(p[1],10), yy = parseInt(p[2],10);
      if(isNaN(dd)||isNaN(mm)||isNaN(yy)) return null;
      return new Date(yy, mm-1, dd);
    }

    var startDate = parseDate(sd.value);
    var endDate   = parseDate(ed.value);

    // Default: remove summeronly and hide warning
    document.body.classList.remove('summeronly');
    if (summerWarn) summerWarn.style.display = 'none';

    if(!startDate || !endDate || startDate > endDate){ 
      // also ensure secondperiod closed if dates invalid
      document.body.classList.remove('secondperiod-open');
      if (btn) btn.textContent = '2. Zeitraum einblenden';
      return; 
    }

    var winterMonths = {1:1,2:1,3:1,4:1,10:1,11:1,12:1};
    var cur = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
    var endM = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
    var hasWinter = false;
    while(cur <= endM){
      var m = cur.getMonth() + 1;
      if (winterMonths[m]) { hasWinter = true; break; }
      cur.setMonth(cur.getMonth() + 1);
    }

    if (hasWinter){
      // Not allowed -> hide button and close second period
      document.body.classList.remove('summeronly');
      document.body.classList.remove('secondperiod-open');
      if (btn) btn.textContent = '2. Zeitraum einblenden';
      if (summerWarn) summerWarn.style.display = 'none';
    } else {
      // Summer-only -> show button; do not touch open state
      document.body.classList.add('summeronly');
      if (summerWarn) summerWarn.style.display = 'block';
      if (btn) {
        btn.textContent = document.body.classList.contains('secondperiod-open') ? '2. Zeitraum ausblenden' : '2. Zeitraum einblenden';
      }
    }
  };
})();
</script><script id="fix-bootstrap-summeronly">
document.addEventListener('DOMContentLoaded', function(){
  try{
    ['startDate','endDate'].forEach(function(id){
      var el = document.getElementById(id);
      if (el){
        ['input','change','blur'].forEach(function(evt){
          el.addEventListener(evt, function(){ if (window.updateButtonByRule) updateButtonByRule(); });
        });
      }
    });
    ['fetchWeightsBtn','resetButton','example1','example2','toggleRubrik1bBtn'].forEach(function(id){
      var el = document.getElementById(id);
      if (el){
        el.addEventListener('click', function(){ setTimeout(function(){ if (window.updateButtonByRule) updateButtonByRule(); }, 0); });
      }
    });
    if (window.updateButtonByRule) updateButtonByRule();
  }catch(e){}
});
</script><script id="fix-toggleRubrik1b-click">
(function(){
  var btn = document.getElementById('toggleRubrik1bBtn');
  var z2  = document.getElementById('zweiterZeitraum');
  if (!btn || !z2) return;

  function setText(){
    var open = document.body.classList.contains('secondperiod-open');
    btn.textContent = open ? '2. Zeitraum ausblenden' : '2. Zeitraum einblenden';
  }
  setText();

  btn.addEventListener('click', function(ev){
    if (!document.body.classList.contains('summeronly')) return;
    ev.preventDefault();
    ev.stopPropagation();
    document.body.classList.toggle('secondperiod-open');
    setText();
  }, true);
})();
</script><script id="inline-status-B">
(function(){
  function getVal(id){ var el=document.getElementById(id); return el? String(el.value||'').trim():''; }
  function updateInlineStatusForB(){
    try{
      var b = document.querySelector('input[name="weightBasis"][value="B"]');
      var isB = b && b.checked;
      var dot = document.getElementById('fetchStatus');
      var msg = document.getElementById('fetchMsg');
      var aMsg = document.getElementById('tableAInlineMsg');
      var bMsg = document.getElementById('tableBInlineMsg');
      if (!bMsg) return;
      if (isB){
        var sd=getVal('startDate'), sm=getVal('startMeter'), ed=getVal('endDate'), em=getVal('endMeter');
        var dataReady = sd && sm && ed && em;
        if (dot){ dot.style.display='none'; dot.style.backgroundColor='#ccc'; }
        if (bMsg) bMsg.textContent = dataReady ? 'Daten geladen' : '';
        if (msg) msg.innerText = '';
        if (aMsg) aMsg.textContent = '';
      } else {
        if (bMsg) bMsg.textContent = '';
      }
    }catch(e){}
  }
  document.addEventListener('DOMContentLoaded', function(){
    // react to radio changes
    document.querySelectorAll('input[name="weightBasis"]').forEach(function(r){
      r.addEventListener('change', updateInlineStatusForB);
    });
    // react to dropdown changes (keeps radio and select in sync)
    var sel = document.getElementById('weightTableSelect');
    if (sel) sel.addEventListener('change', updateInlineStatusForB);
    // after clicking "Berechnung starten"
    var fetchBtn = document.getElementById('fetchWeightsBtn');
    if (fetchBtn) fetchBtn.addEventListener('click', function(){ setTimeout(updateInlineStatusForB, 0); });
    // when main calculation completes (if event is used elsewhere)
    document.addEventListener('calculate-finished', updateInlineStatusForB);
    // initial state
    updateInlineStatusForB();
  });
})();
</script><script id="fx-rubrik1b-flash-hook">
(function(){
  function flashRubrik1b(){
    var box = document.getElementById('zweiterZeitraum');
    if (!box) return;
    box.classList.remove('fx-flash');
    void box.offsetWidth; // reflow
    box.classList.add('fx-flash');
    setTimeout(function(){ box.classList.remove('fx-flash'); }, 1000);
  }
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('resetRubrik1bBtn');
    if (btn && !btn.dataset.fxFlashHooked){
      btn.addEventListener('click', function(){
        setTimeout(flashRubrik1b, 0);
      });
      btn.dataset.fxFlashHooked = '1';
    }
  });
})();
</script><script id="rubrik5-monthstyle-enhancer">
(function(){
  function enhanceRubrik5(){
    var list = document.getElementById('m3ConversionList');
    if (!list) return;
    Array.prototype.forEach.call(list.querySelectorAll('li'), function(li){
      if (li.classList.contains('year-heading')) return;
      if (li.dataset.enhanced === '1') return;
      var html = li.innerHTML;
      // Suche nach "Zählerstand: 1234,567" und wickle nur die Zahl in ein Span
      html = html.replace(/(Zählerstand:\s*)([0-9\.\,]+)/, function(_, label, num){
        return label + '<span class="reading-strong">' + num + '</span>';
      });
      li.innerHTML = html;
      li.dataset.enhanced = '1';
    });
  }
  document.addEventListener('DOMContentLoaded', enhanceRubrik5);
  // Falls calculate() existiert, danach erneut verbessern
  try {
    var prev = window.calculate;
    window.calculate = function(){
      try { if (typeof prev === 'function') prev(); }
      finally { enhanceRubrik5(); }
    };
  } catch(e){}
  // Falls irgendwo im Code ein Custom-Event gefeuert wird
  document.addEventListener('calculate-finished', enhanceRubrik5);
})();
</script><script id="consumption-mode-rubrik5">
document.addEventListener('DOMContentLoaded', function(){
  function applyConsumptionModeUI(){
    var isMode = (window.consumptionMode === true);
    var el = document.getElementById('customDateReading');
    if (el){
      el.style.display = isMode ? 'none' : '';
      if (isMode) el.textContent = '';
    }
  }
  // run after each calculate()
  try {
    var prev = window.calculate;
    window.calculate = function(){
      try { if (typeof prev === 'function') prev(); } finally { applyConsumptionModeUI(); }
    };
  } catch(e){}
  applyConsumptionModeUI();
});
</script><script id="consumption-mode-hide-hints-v6">
(function(){
  function detectConsumptionMode(){
    if (window.consumptionMode === true) return true;
    try{
      var sEl = document.getElementById('startMeter');
      var eEl = document.getElementById('endMeter');
      if (!sEl || !eEl) return false;
      var sNum = parseFloat(String(sEl.value||'').replace(',','.'));
      var eNum = parseFloat(String(eEl.value||'').replace(',','.'));
      if (!isFinite(sNum) || !isFinite(eNum)) return false;
      return (sNum === 0 && eNum > 0);
    } catch(_) { return false; }
  }

  function isHeading(el){
    if (!el) return false;
    if (/^H[1-6]$/.test(el.tagName)) return true;
    var role = el.getAttribute && el.getAttribute('role');
    if (role && role.toLowerCase() === 'heading') return true;
    if (el.classList && (el.classList.contains('section-title') || el.classList.contains('rubrik-title'))) return true;
    return false;
  }

  function mentionsZaehler(text){
    if (!text) return false;
    var t = text.toLowerCase();
    return t.includes('z\u00e4hlerstand') || t.includes('z\u00e4hlerst\u00e4nde') || t.includes('zahlerstand') || t.includes('zahlerstande') || t.includes('zahlerstände');
  }

  function applyHide(){
    var root = document.getElementById('rubrik5');
    if (!root) return;

    var mode = detectConsumptionMode();
    // Fallback-Heuristik: Wenn es keine .zaehlerstand-Elemente in der Liste gibt,
    // sind wir de facto im Verbrauchsmodus-Darstellungszustand.
    var listHasZaehlerstand = !!root.querySelector('li .zaehlerstand');
    var hideMode = mode || !listHasZaehlerstand;

    // Detailzeile am individuellen Datum
    var custom = document.getElementById('customDateReading');
    if (custom){
      if (hideMode){
        if (!custom.dataset._prevDisplay) custom.dataset._prevDisplay = custom.style.display || '';
        custom.style.display = 'none'; custom.textContent='';
      } else {
        custom.style.display = custom.dataset._prevDisplay || '';
        delete custom.dataset._prevDisplay;
      }
    }

    // Zählerstand-Spans in Monatsliste
    root.querySelectorAll('li .zaehlerstand').forEach(function(sp){
      if (hideMode){
        if (!sp.dataset._prevDisplay) sp.dataset._prevDisplay = sp.style.display || '';
        sp.style.display = 'none';
      } else {
        sp.style.display = sp.dataset._prevDisplay || '';
        delete sp.dataset._prevDisplay;
      }
    });

    // Info-Absatz (Monats-Zählerstände ...) und andere Hinweise mit Zählerstand/‑stände
    root.querySelectorAll('*:not(li)').forEach(function(el){
      try{
        if (!el || !el.textContent) return;
        if (isHeading(el)) return;
        if (el.classList && el.classList.contains('info-box')){
          // explizit die Info-Box toggeln
          if (hideMode){
            if (!el.dataset._prevDisplay) el.dataset._prevDisplay = el.style.display || '';
            el.style.display = 'none';
          } else {
            el.style.display = el.dataset._prevDisplay || '';
            delete el.dataset._prevDisplay;
          }
          return;
        }
        if (mentionsZaehler(el.textContent)){
          if (hideMode){
            if (!el.dataset._prevDisplay) el.dataset._prevDisplay = el.style.display || '';
            el.style.display = 'none';
          } else {
            el.style.display = el.dataset._prevDisplay || '';
            delete el.dataset._prevDisplay;
          }
        }
      }catch(_){}
    });
  }

  // Beobachter, damit Änderungen in Rubrik 5 erneut gefiltert werden
  var mo;
  function observe(){
    var root = document.getElementById('rubrik5');
    if (!root) return;
    if (mo) try{ mo.disconnect(); }catch(_){}
    mo = new MutationObserver(function(){ applyHide(); });
    mo.observe(root, { childList: true, subtree: true });
  }

  document.addEventListener('DOMContentLoaded', function(){
    applyHide();
    observe();
    ['startMeter','endMeter'].forEach(function(id){
      var el = document.getElementById(id);
      if (el){ ['input','change','blur'].forEach(function(evt){ el.addEventListener(evt, applyHide); }); }
    });
  });

  try{
    var prev = window.calculate;
    window.calculate = function(){
      try { if (typeof prev === 'function') prev(); } finally { applyHide(); }
    };
  }catch(_){}
})();
</script><script id="consumption-mode-header-trim">
(function(){
  function inConsumptionMode(){
    try{
      if (window.consumptionMode === true) return true;
      var sEl = document.getElementById('startMeter');
      var eEl = document.getElementById('endMeter');
      if (!sEl || !eEl) return false;
      var s = parseFloat(String(sEl.value||'').replace(',','.'));
      var e = parseFloat(String(eEl.value||'').replace(',','.'));
      if (!isFinite(s) || !isFinite(e)) return false;
      return (s === 0 && e > 0);
    }catch(_){ return false; }
  }

  function ensureNormalPhrases(text){
    try{
      var out = String(text||'');
      var hasClause = /mit\s+voraussichtlichem\s+Zählerstand\s+zum\s+Monatsende/i.test(out);
      var hasAlt    = /\(alternativ[^)]*\)/i.test(out);
      if (!hasClause){
        if (/\)\s*$/.test(out)){
          out = out.replace(/\)\s*$/, ") – mit voraussichtlichem Zählerstand zum Monatsende");
        } else {
          out = out + " – mit voraussichtlichem Zählerstand zum Monatsende";
        }
      }
      if (!hasAlt){
        out = out + " (alternativ: Datum eingeben)";
      }
      return out;
    }catch(_){ return text; }
  }

  function trimConsumptionPhrases(text){
    try{
      return String(text||'')
        .replace(/[\s–-]*mit\s+voraussichtlichem\s+Zählerstand\s+zum\s+Monatsende\s*/i, ' ')
        .replace(/\s*\(alternativ[^)]*\)\s*/i, ' ')
        .replace(/\s{2,}/g, ' ')
        .replace(/\s*–\s*$/, '')
        .trim();
    }catch(_){ return text; }
  }

  var applying = false;
  var mo = null;

  function apply(force){
    if (applying) return;
    var h = document.getElementById('m3ConversionHeader');
    if (!h) return;
    try{
      applying = true;

      // Prevent observer feedback loops
      if (mo) mo.disconnect();

      // Start from current text (contains latest m³ value)
      var current = String(h.innerHTML || '');
      var last = h.dataset.lastSeen || '';
      if (!force && current === last) {
        // nothing changed; reattach observer and exit
        if (mo) observe(h);
        applying = false;
        return;
      }
      h.dataset.lastSeen = current;

      var result = inConsumptionMode() ? trimConsumptionPhrases(current)
                                       : ensureNormalPhrases(current);

      if (result !== current){
        h.innerHTML = result;
      }

    }catch(_){ /* swallow any header-trim errors to not break other logic */ }
    finally{
      if (mo) observe(h);
      applying = false;
    }
  }

  function observe(h){
    try{
      mo.observe(h, { childList: true, subtree: true, characterData: true });
    }catch(_){}
  }

  document.addEventListener('DOMContentLoaded', function(){
    try{
      var h = document.getElementById('m3ConversionHeader');
      mo = new MutationObserver(function(){ apply(false); });
      if (h) observe(h);
      apply(true);
      // Hook calculate safely
      try{
        var prev = window.calculate;
        window.calculate = function(){
          try { if (typeof prev === 'function') prev(); } finally { apply(true); }
        };
      }catch(_){}
      // Update when base inputs change
      ['startMeter','endMeter'].forEach(function(id){
        var el = document.getElementById(id);
        if (el){ ['input','change','blur'].forEach(function(evt){ el.addEventListener(evt, function(){ apply(true); }); }); }
      });
    }catch(_){}
  });
})();
</script><script id="consumption-mode-hide-customdate-v3">
(function(){
  function detectConsumptionMode(){
    if (window.consumptionMode === true) return true;
    try{
      var sEl = document.getElementById('startMeter');
      var eEl = document.getElementById('endMeter');
      if (!sEl || !eEl) return false;
      var sNum = parseFloat(String(sEl.value||'').replace(',','.'));
      var eNum = parseFloat(String(eEl.value||'').replace(',','.'));
      if (!isFinite(sNum) || !isFinite(eNum)) return false;
      return (sNum === 0 && eNum > 0);
    } catch(_) { return false; }
  }

  var nodeIds = ['customDateContainer','dateWarningCustom','customDateError','customDateReading','customDateExplanation'];

  function hideEl(el){
    if (!el) return;
    if (el.dataset._prevDisplay === undefined){
      el.dataset._prevDisplay = el.style.display || '';
    }
    el.style.display = 'none';
  }
  function restoreEl(el){
    if (!el) return;
    // Only restore if we had hidden it before; otherwise don't touch user toggles
    if (el.dataset._prevDisplay !== undefined){
      el.style.display = el.dataset._prevDisplay;
      delete el.dataset._prevDisplay;
    }
  }

  function applyHide(){
    var isCons = detectConsumptionMode();
    nodeIds.forEach(function(id){
      var el = document.getElementById(id);
      if (!el) return;
      if (isCons) hideEl(el);
      else restoreEl(el); // do nothing if we didn't hide it
    });
  }

  // Observe Rubrik 5, but avoid overriding Normalmodus state
  var mo;
  function observe(){
    var root = document.getElementById('rubrik5');
    if (!root) return;
    if (mo) try{ mo.disconnect(); }catch(_){}
    mo = new MutationObserver(function(){ applyHide(); });
    mo.observe(root, { childList: true, subtree: true });
  }

  document.addEventListener('DOMContentLoaded', function(){
    applyHide();
    observe();
    try{
      var prev = window.calculate;
      window.calculate = function(){
        try { if (typeof prev === 'function') prev(); } finally { applyHide(); }
      };
    }catch(_){}
    ['startMeter','endMeter'].forEach(function(id){
      var el = document.getElementById(id);
      if (el){ ['input','change','blur'].forEach(function(evt){ el.addEventListener(evt, applyHide); }); }
    });
  });
})();
</script><script id="rb1-inline-info-js">
document.addEventListener('DOMContentLoaded', function(){
  var btn = document.getElementById('rb1InfoBtn');
  var pop = document.getElementById('rb1InfoPopover');
  if (!btn || !pop) return;

  function togglePopover(force){
    if (typeof force === 'boolean'){ pop.classList.toggle('show', force); }
    else { pop.classList.toggle('show'); }
    pop.setAttribute('aria-hidden', pop.classList.contains('show') ? 'false' : 'true');
  }

  btn.addEventListener('click', function(e){ e.preventDefault(); togglePopover(); });
  btn.addEventListener('keydown', function(e){
    if (e.key === 'Enter' || e.key === ' '){ e.preventDefault(); togglePopover(); }
    if (e.key === 'Escape'){ togglePopover(false); }
  });

  document.addEventListener('click', function(e){
    if (!pop.classList.contains('show')) return;
    if (e.target === btn || btn.contains(e.target) || pop.contains(e.target)) return;
    togglePopover(false);
  });

  // Close on calculate to avoid stale popover
  try{
    var prev = window.calculate;
    window.calculate = function(){
      try { if (typeof prev === 'function') prev(); } finally { togglePopover(false); }
    };
  }catch(_){}
});
</script><script id="rb1b-inline-info-js">
document.addEventListener('DOMContentLoaded', function(){
  var btn = document.getElementById('rb1bInfoBtn');
  var pop = document.getElementById('rb1bInfoPopover');
  if (!btn || !pop) return;

  function togglePopover(force){
    if (typeof force === 'boolean'){ pop.classList.toggle('show', force); }
    else { pop.classList.toggle('show'); }
    pop.setAttribute('aria-hidden', pop.classList.contains('show') ? 'false' : 'true');
  }

  btn.addEventListener('click', function(e){ e.preventDefault(); togglePopover(); });
  btn.addEventListener('keydown', function(e){
    if (e.key === 'Enter' || e.key === ' '){ e.preventDefault(); togglePopover(); }
    if (e.key === 'Escape'){ togglePopover(false); }
  });
  document.addEventListener('click', function(e){
    if (!pop.classList.contains('show')) return;
    if (e.target === btn || btn.contains(e.target) || pop.contains(e.target)) return;
    togglePopover(false);
  });
  try{
    var prev = window.calculate;
    window.calculate = function(){
      try { if (typeof prev === 'function') prev(); } finally { togglePopover(false); }
    };
  }catch(_){}
});
</script><script id="hook-showBTableBtn-to-panel">
document.addEventListener('DOMContentLoaded', function(){
  try{
    var btnB = document.getElementById('showBTableBtn');
    if (btnB && !btnB.dataset.hooked) {
      btnB.addEventListener('click', function(e){
        e.preventDefault(); e.stopPropagation();
        if (window.showWeightsPanel) {
          var title = 'Tabelle DWD – Monatsgewichte';
          window.showWeightsPanel(window.monthWeightsB || {}, title);
        }
        return false;
      }, true);
      btnB.dataset.hooked = '1';
    }
  }catch(e){}
});
</script><script id="rb1DWD-popover-js">
document.addEventListener('DOMContentLoaded', function(){
  try{
    var btn = document.getElementById('rb1DWDInfoBtn');
    var pop = document.getElementById('rb1DWDInfoPopover');
    if (!btn || !pop) return;

    function togglePopover(force){
      if (typeof force === 'boolean'){ pop.classList.toggle('show', force); }
      else { pop.classList.toggle('show'); }
      pop.setAttribute('aria-hidden', pop.classList.contains('show') ? 'false' : 'true');
    }

    btn.addEventListener('click', function(e){ e.preventDefault(); togglePopover(); });
    btn.addEventListener('keydown', function(e){
      if (e.key === 'Enter' || e.key === ' '){ e.preventDefault(); togglePopover(); }
      if (e.key === 'Escape'){ togglePopover(false); }
    });

    document.addEventListener('click', function(e){
      if (!pop.classList.contains('show')) return;
      if (e.target === btn || btn.contains(e.target) || pop.contains(e.target)) return;
      togglePopover(false);
    });

    // Close on calculate (like others)
    try{
      var prev = window.calculate;
      window.calculate = function(){
        try { if (typeof prev === 'function') prev(); } finally { togglePopover(false); }
      };
    }catch(_){}
  }catch(e){}
});
</script><script>
document.addEventListener('DOMContentLoaded', function(){
  var btn = document.getElementById('rb1TableAInfoBtn');
  var pop = document.getElementById('rb1TableAInfoPopover');
  if (!btn || !pop) return;
  function close(){ pop.classList.remove('show'); pop.setAttribute('aria-hidden','true'); }
  function open(){ pop.classList.add('show'); pop.setAttribute('aria-hidden','false'); }
  function toggle(){ if (pop.classList.contains('show')) { close(); } else { open(); } }
  btn.addEventListener('click', function(e){ e.preventDefault(); e.stopPropagation(); toggle(); });
  btn.addEventListener('keydown', function(e){
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle(); }
    if (e.key === 'Escape') { close(); }
  });
  document.addEventListener('click', function(e){
    if (!e.target.closest('.rb1-inline-wrap')) { close(); }
  });
});
</script><script>window.addEventListener("load", () => {
  // 1) Nur sichtbare, vom Nutzer bearbeitbare Felder leeren
  const isHidden = (el) => {
    if (el.hidden || el.getAttribute("hidden") !== null) return True;
    const cs = window.getComputedStyle(el);
    if (cs.display === "none" || cs.visibility === "hidden") return True;
    if (el.getAttribute("aria-hidden") === "true") return True;
    return False;
  };

  // Formulare zurücksetzen
  document.querySelectorAll("form").forEach(form => form.reset());

  // Nur "User-facing" Felder leeren – keine internen/hidden Felder anfassen!
  const userFields = document.querySelectorAll([
    'input:not([type="button"]):not([type="submit"]):not([type="reset"]):not([type="hidden"]):not([data-preserve])',
    'select:not([data-preserve])',
    'textarea:not([data-preserve]):not([readonly])'
  ].join(","));

  userFields.forEach(el => {
    // Skip unsichtbare Elemente (z. B. Templates)
    try {
      if (isHidden(el)) return;
    } catch (e) {}

    if (el.tagName === "INPUT") {
      if (["checkbox","radio"].includes(el.type)) el.checked = false;
      else el.value = "";
    } else if (el.tagName === "SELECT") {
      el.selectedIndex = -1; // keine Vorauswahl
    } else if (el.tagName === "TEXTAREA") {
      el.value = "";
    }
  });

  // 2) Falls vorhanden: programmweite Reset-Funktion aufrufen
  if (typeof resetAll === "function") {
    try { resetAll(); } catch (e) { console.warn("resetAll() Fehler:", e); }
  }

  // 3) Autocomplete nur für sichtbare, nicht-hidden Inputs deaktivieren
  document.querySelectorAll('input:not([type="hidden"])').forEach(el => {
    try { el.setAttribute("autocomplete", "off"); } catch (e) {}
  });

  // 4) Nur Sitzungsspeicher leeren (nicht localStorage, um statische Tabellen/Daten zu bewahren)
  try { sessionStorage.clear(); } catch (e) { console.warn("sessionStorage clear fehlgeschlagen:", e); }
});</script><script id="rb1-plz-info-handler">
document.addEventListener('DOMContentLoaded', function(){
  var btn = document.getElementById('rb1PLZInfoBtn');
  var pop = document.getElementById('rb1PLZInfoPopover');
  if(!btn || !pop) return;
  function toggle(ev){
    if(ev) { ev.preventDefault(); ev.stopPropagation(); }
    var vis = pop.classList.contains('show');
    // hide all other rb1 popovers
    document.querySelectorAll('#rubrik1Container .rb1-info-popover').forEach(function(el){
      if(el !== pop) el.classList.remove('show');
    });
    if(vis){ pop.classList.remove('show'); }
    else   { pop.classList.add('show'); }
  }
  btn.addEventListener('click', toggle);
  btn.addEventListener('keydown', function(ev){
    if(ev.key === 'Enter' || ev.key === ' '){
      toggle(ev);
    }
  });
  // prevent label/radio selection when clicking inside the popover
  pop.addEventListener('click', function(ev){ ev.stopPropagation(); });
  // close popover when clicking elsewhere in Rubrik 1
  document.getElementById('rubrik1Container').addEventListener('click', function(){
    pop.classList.remove('show');
  });
});
</script><script>
var customDate = document.getElementById('customDateInputRubrik5');
  if (!customDate) return;
  
customDate.addEventListener('change', function() {
    
    // Validate: custom date must not be before end date in Rubrik 1
    var endDateInput = document.getElementById('endDate');
    var endDateParts = endDateInput.value.split('.');
    var endDateObj = new Date(parseInt(endDateParts[2],10), parseInt(endDateParts[1],10)-1, parseInt(endDateParts[0],10));
    var customDateObj = new Date(this.value);
    // If custom date equals end date, show the exact end reading
    if (customDateObj.getTime() === endDateObj.getTime()) {
      var formattedDate = this.value.split('-').reverse().join('.');
      document.getElementById('customDateReading').innerText =
        'Geschätzter Zählerstand am ' + formattedDate + ': ' + startReading.toFixed(3).replace('.',',') + ' m³';
      document.getElementById('customDateExplanation').innerText = '';
try{document.getElementById('customDateExplanation').style.display='none';}catch(e){}
      return;
    }

    if (customDateObj < endDateObj) {
        var errSp = document.getElementById('customDateError');
errSp.innerText = 'Datum darf nicht vor dem Enddatum ( Datum 2 in Rubrik 1) liegen.';
errSp.classList.add('visible');
        document.getElementById('customDateReading').innerText = '';
        document.getElementById('customDateExplanation').innerText = '';
try{document.getElementById('customDateExplanation').style.display='none';}catch(e){}
        return;
    } else {
        var errSp = document.getElementById('customDateError');
errSp.innerText = '';
errSp.classList.remove('visible');
    }
    var d = new Date(this.value);
    // If custom date equals end date, show the exact end reading
    var endDateInput = document.getElementById('endDate');
    var parts = endDateInput.value.split('.');
    var endDateObj = new Date(parseInt(parts[2],10), parseInt(parts[1],10)-1, parseInt(parts[0],10));
    if (
      d.getFullYear() === endDateObj.getFullYear() &&
      d.getMonth()    === endDateObj.getMonth()    &&
      d.getDate()     === endDateObj.getDate()
    ) {
      var formattedDate = this.value.split('-').reverse().join('.');
      document.getElementById('customDateReading').innerText =
        'Geschätzter Zählerstand am ' + formattedDate + ': ' + window.rubrik5StartReading.toFixed(3).replace('.',',') + ' m³';
      document.getElementById('customDateExplanation').innerText = '';
try{document.getElementById('customDateExplanation').style.display='none';}catch(e){}
      return;
    }

    var monthlyValues = window.rubrik5MonthlyValues || [];
    var startReading = parseFloat(window.rubrik5StartReading || 0);
    var endMonth = window.rubrik5EndMonth;
    var endYear = window.rubrik5EndYear;
    var cumM3 = 0;
    // calculate months difference
    var yearDiff = d.getFullYear() - endYear;
    var monthDiff = yearDiff * 12 + (d.getMonth() + 1 - endMonth);
    if (monthDiff < 0) monthDiff += 12;
    // sum full months before custom month
    for (var i = 0; i < monthDiff; i++) {
      cumM3 += monthlyValues[i] || 0;
    }
    // prorate for custom month
    var index = monthDiff;
    var fullM3 = monthlyValues[index] || 0;
    var daysInMonth = new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
    var dailyUse = fullM3 / daysInMonth;
    var partialUse;
    if (index === 0) {
      // Sonderfall: erstes Prognosemonat ist zugleich Endmonat aus Rubrik 1.
      // Dann beginnt die Hochrechnung erst am Tag NACH dem Enddatum.
      var endParts2 = document.getElementById('endDate').value.split('.');
      var endDay2 = parseInt(endParts2[0], 10) || 0;
      var deltaDays = d.getDate() - endDay2;
      if (deltaDays < 0) { deltaDays = 0; }
      partialUse = dailyUse * deltaDays;
    } else {
      // spätere Monate: Zählung ab dem 1. des Monats
      partialUse = dailyUse * d.getDate();
    }
    cumM3 += partialUse;
    var projected = startReading + cumM3;
    var formattedDate = this.value.split('-').reverse().join('.');
    document.getElementById('customDateReading').innerText =
      'Geschätzter Zählerstand am ' + formattedDate + ': ' + projected.toFixed(3).replace('.',',') + ' m³';
    // Build explanation text
    var fullSum = cumM3 - partialUse;
    var explanationText = 'Berechnungsweg: Startwert ' + startReading.toFixed(3).replace('.',',') + ' m³';
    explanationText += ' + Volle Monate: ' + fullSum.toFixed(3).replace('.',',') + ' m³';
    explanationText += ' + Teilmonat: ' + partialUse.toFixed(3).replace('.',',') + ' m³';
    explanationText += ' = Gesamtverbrauch: ' + cumM3.toFixed(3).replace('.',',') + ' m³';
    document.getElementById('customDateExplanation').innerText = explanationText;


  
  });
});
</script><script>
// Toggle Rechenweg für Custom-Datum-Projektion
document.addEventListener('DOMContentLoaded', function() {
  var btn = var btn = var btn = document.getElementById('toggleCustomDateExp');
  var expDiv = document.getElementById('customDateExplanation');
  if (!btn || !expDiv) return;
  btn.addEventListener('click', function(){
    if (expDiv.style.display === 'block') {
      expDiv.style.display = 'none';
      btn.innerText = 'Rechenweg anzeigen';
    } else {
      expDiv.style.display = 'block';
      btn.innerText = 'Rechenweg ausblenden';
    }
  });
});
</script><script>
// Toggle Rechenweg für Custom-Datum-Projektion
document.addEventListener('DOMContentLoaded', function() {
  var btn = var btn = var btn = document.getElementById('toggleCustomDateExp');
  var expDiv = document.getElementById('customDateExplanation');
  if (!btn || !expDiv) return;
  btn.addEventListener('click', function() {
    if (!expDiv.innerText.trim()) return; // nichts zu zeigen
    if (expDiv.style.display === 'block') {
      expDiv.style.display = 'none';
      btn.innerText = 'Rechenweg anzeigen';
    } else {
      expDiv.style.display = 'block';
      btn.innerText = 'Rechenweg ausblenden';
    }
  });
});
</script><script>
// Custom Date Change Handler with Enddate Check
document.addEventListener('DOMContentLoaded', function() {
  var customDate = document.getElementById('customDateInputRubrik5');
  if (!customDate) return;
  customDate.addEventListener('change', function() {
    var d = new Date(this.value);
            var warningDiv = document.getElementById('dateWarningCustom');
        var endYear = window.rubrik5EndYear;
        var endMonth = window.rubrik5EndMonth;
        var yearDiff = d.getFullYear() - endYear;
        var monthDiff = yearDiff * 12 + (d.getMonth()+1 - endMonth);
        if (monthDiff < 0) monthDiff += 12;
        if (monthDiff> 11) { warningDiv.style.display = 'block'; } else { warningDiv.style.display = 'none'; }
// Parse end date from Rubrik 1
    var endDateParts = document.getElementById('endDate').value.split('.');
    var endDateObj = new Date(
      parseInt(endDateParts[2],10),
      parseInt(endDateParts[1],10)-1,
      parseInt(endDateParts[0],10)
    );
    // If equal to end date, show exact value and exit
    if (
      d.getFullYear() === endDateObj.getFullYear() &&
      d.getMonth()    === endDateObj.getMonth()    &&
      d.getDate()     === endDateObj.getDate()
    ) {
      var formatted = this.value.split('-').reverse().join('.');
      document.getElementById('customDateReading').innerText =
        'Geschätzter Zählerstand am ' + formatted + ': ' +
        window.rubrik5StartReading.toFixed(3).replace('.',',') + ' m³';
      document.getElementById('customDateExplanation').innerText = '';
try{document.getElementById('customDateExplanation').style.display='none';}catch(e){}
      return;
    }
    // Original projection logic
    var monthlyValues = window.rubrik5MonthlyValues || [];
    var startReading = parseFloat(window.rubrik5StartReading || 0);
    var endMonth = window.rubrik5EndMonth;
    var endYear = window.rubrik5EndYear;
    // calculate month difference
    var yearDiff = d.getFullYear() - endYear;
    var monthDiff = yearDiff * 12 + (d.getMonth()+1 - endMonth);
    if (monthDiff < 0) monthDiff += 12;
    // sum full months
    var cumFull = 0;
    for (var i = 0; i < monthDiff; i++) {
      cumFull += monthlyValues[i] || 0;
    }
    // prorate for custom month
    var fullM3 = monthlyValues[monthDiff] || 0;
    var daysInMonth = new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
    var dailyUse = fullM3 / daysInMonth;
    var partialUse = dailyUse * d.getDate();
    var cumM3 = cumFull + partialUse;
    var projected = startReading + cumM3;
    var formattedDate = this.value.split('-').reverse().join('.');
    // Display reading
    document.getElementById('customDateReading').innerText =
      'Geschätzter Zählerstand am ' + formattedDate + ': ' +
      projected.toFixed(3).replace('.',',') + ' m³';
    // Build explanation
    var expText = 'Berechnungsweg: Startwert ' + startReading.toFixed(3).r
</script><script>
window.monthWeightsA = {
  "01": 16.224, "02": 13.202, "03": 12.765, "04": 9.102,
  "05": 4.786, "06": 2.382, "07": 0.790, "08": 0.772,
  "09": 3.297, "10": 8.224, "11": 12.680, "12": 15.776
};
</script><script src="https://cdn.jsdelivr.net/npm/chart.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script><script>
// Schalte Rechenweg-Buttons frei bei Eingabe des Codes 1202
document.addEventListener('DOMContentLoaded', function() {
  var codeInput = document.getElementById('secretCodeInput');
  if (!codeInput) return;
  codeInput.addEventListener('input', function() {
    if (this.value === '1202') {
      document.body.classList.add('code-unlocked');
    } else {
      document.body.classList.remove('code-unlocked');
    }
  });
});
</script><script id="panel-renderer-static">
(function(){
  // Simple, reliable renderer that does not depend on other scripts
  window.showWeightsPanel = function(weights, title){
    var panel = document.getElementById('originalWeights');
    if(!panel){
      panel = document.createElement('div');
      panel.id = 'originalWeights';
      document.body.prepend(panel);
    }
    // Basic styles if not present
    panel.style.position = 'absolute';
    panel.style.top = '5px';
    panel.style.right = '10px';
    panel.style.width = '260px';
    panel.style.maxHeight = '80vh';
    panel.style.overflow = 'auto';
    panel.style.background = 'antiquewhite';
    panel.style.borderLeft = '1px solid #aaa';
    panel.style.padding = '8px 10px';
    panel.style.zIndex = '1000';
    panel.style.display = 'block';

    var months = ["01","02","03","04","05","06","07","08","09","10","11","12"];
    function fmt(v){
      if(typeof v === 'number') return v.toLocaleString('de-DE', {minimumFractionDigits:3, maximumFractionDigits:3});
      if(typeof v === 'string'){
        var n = parseFloat(v.replace(/\./g,'').replace(',','.'));
        if(!isNaN(n)) return n.toLocaleString('de-DE', {minimumFractionDigits:3, maximumFractionDigits:3});
      }
      return (v==null?'':String(v));
    }
    var rows = months.map(function(m){
      var v = weights ? weights[m] : '';
      return '<div style="display:flex;justify-content:space-between;padding:2px 0;"><span>'+m+'</span><strong>'+fmt(v)+'</strong></div>';
    }).join('');

    panel.innerHTML = [
      '<div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;margin-bottom:.5rem;">',
        '<h4 style="margin:0;">'+(title||'Monatsgewichte')+'</h4>',
        '<button type="button" id="closeWeightsPanel" style="border:1px solid #999;background:#f5f5f5;padding:2px 6px;cursor:pointer;">×</button>',
      '</div>',
      rows,
      '<hr><small style="opacity:.7;">Statische Monatsgewichte</small>'
    ].join('');

    var closeBtn = document.getElementById('closeWeightsPanel');
    if(closeBtn){
      closeBtn.onclick = function(){
        panel.style.display = 'none';
        document.body.classList.remove('weights-panel-open');
      };
    }
    document.body.classList.add('weights-panel-open');
  };
})();
</script><script id="static-monthWeightsB">
window.monthWeightsB = {
  "01": 20.231, "02": 12.340, "03": 11.944, "04": 8.086,
  "05": 1.525,  "06": 1.475,  "07": 1.525,  "08": 1.525,
  "09": 1.475,  "10": 7.025,  "11": 14.697, "12": 18.152
};
</script><script>
    function saveRubrik6State() {
      return Array.from(document.querySelectorAll('#monthSelectionList input[type="checkbox"]')).map(cb => ({
        month: cb.value,
        checked: cb.checked,
        day: document.getElementById(`day-${cb.value}`).value
      }));
    }
    function restoreRubrik6State(saved) {
      if (!saved) return;
      saved.forEach(({month, checked, day}) => {
        const cb = document.querySelector(`#monthSelectionList input[value="${month}"]`);
        if (cb) {
          cb.checked = checked;
          const dayInput = document.getElementById(`day-${month}`);
          if (dayInput) dayInput.value = day;
        }
      });
      toggleDayInputs();
      processSelectedMonths();
    }
  </script><script>
    document.addEventListener('DOMContentLoaded', function() {
      const btn = document.getElementById('toggleDetailsBtn');
      const tableDiv = document.getElementById('detailedTable');
      btn.addEventListener('click', function() {
        if (tableDiv.style.display === 'none') {
          const gtz = window.gtzData || {};
          const sumHdd = window.sumHdd || Object.values(gtz).reduce((a,b)=>a+b,0);
          const water = 1/12;
          
let html = '<table border="1" cellpadding="5"><tr>' +
           '<th>Monat</th>' +
           '<th>HDD</th>' +
           '<th>Heiz<br>W.</th>' +
           '<th>WW<br>W.</th>' +
           '<th>Komb.</th>' +
           '<th>%</th></tr>';

          Object.keys(gtz).forEach(m => {
            const hdd = gtz[m];
            const heating = sumHdd>0 ? hdd/sumHdd : 0;
            const comb = 0.8*heating + 0.2*water;
            html += `<tr><td>${m}</td><td>${hdd.toFixed(3)}</td><td>${heating.toFixed(5)}</td><td>${water.toFixed(5)}</td><td>${comb.toFixed(5)}</td><td>${(comb*100).toFixed(3)}</td></tr>`;
          });
          
        // Summen berechnen
        const sumHddFooter = Object.values(gtz).reduce((a,b)=>a+b, 0);
        const sumPercentFooter = Object.keys(gtz).reduce((sum, m) => {
          const hdd = gtz[m];
          const heating = sumHddFooter> 0 ? hdd / sumHddFooter : 0;
          const comb = 0.8 * heating + 0.2 * (1/12);
          return sum + comb * 100;
        }, 0);
        html += `<tfoot><tr><th>Summe</th><th>${sumHddFooter.toFixed(3)}</th><th></th><th></th><th></th><th>${sumPercentFooter.toFixed(3)}</th></tr></tfoot>`;
    html += '</table>';
          tableDiv.innerHTML = html;
          tableDiv.style.display = 'block';
          btn.textContent = 'Monatanteile der Gradtage verbergen';
        } else {
          tableDiv.style.display = 'none';
          btn.textContent = 'Berechnung Monatanteile der Gradtage';
        }
      });
    });
  </script><script>
(function(){
  function setGtzDataFromCacheAndUpdate() {
    if (!window.cachedGtzData) return;
    window.gtzData = Object.assign({}, window.cachedGtzData);
    // Simuliere einen Klick auf den "Berechnung starten"-Button
    var btn = document.getElementById('fetchWeightsBtn');
    if(btn && btn.style.display !== 'none' && document.querySelector('input[name="weightBasis"][value="plz"]')?.checked) btn.click();
  }

  // Nach PLZ-Berechnung Cache befüllen
  let origFetch = window.fetch;
  window.fetch = function() {
    return origFetch.apply(this, arguments).then(resp => {
      let resp2 = resp.clone();
      resp2.json().then(data => {
        if (window.gtzData && typeof window.gtzData === "object") {
          window.cachedGtzData = Object.assign({}, window.gtzData);
        }
      }).catch(()=>{});
      return resp;
    });
  };

  // Umschalten im Dropdown abfangen
  document.addEventListener('DOMContentLoaded', function() {
    var select = document.getElementById('weightTableSelect');
    if(!select) return;
    select.addEventListener('change', function() {
      if(this.value === 'plz') {
        // Wenn Cache da, dynamische Daten wiederherstellen und UI aktualisieren
        if(window.cachedGtzData) setGtzDataFromCacheAndUpdate();
      }
    });
  });
})();
</script><script>
const months = ["Jan","Feb","Mär","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];

document.getElementById("go").addEventListener("click", async () => {
    const plz = document.getElementById("plz").value.trim();
    const year = parseInt(document.getElementById("jahr").value,10);
    const msg = document.getElementById("msg");
    msg.textContent = "";
    if(!/^\d{4,5}$/.test(plz)) { msg.textContent = "Bitte gültige deutsche PLZ eingeben."; return; }
    if(isNaN(year)) { msg.textContent = "Bitte gültiges Jahr eingeben."; return; }

    try {
        // 1) Geokodierung
        const geoUrl = `https://nominatim.openstreetmap.org/search?format=json&postalcode=${plz}&country=de&limit=1`;
        const geoResp = await fetch(geoUrl, { headers: { "User-Agent":"gtz-demo" }});
        const geoJson = await geoResp.json();
        if(!geoJson.length) throw new Error("PLZ nicht gefunden");
        const lat = parseFloat(geoJson[0].lat).toFixed(4);
        const lon = parseFloat(geoJson[0].lon).toFixed(4);

        // 2) Wetterdaten holen
        const start = `${year}-01-01`;
        const end   = `${year}-12-31`;
        const meteoUrl = `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${start}&end_date=${end}&daily=temperature_2m_max,temperature_2m_min&timezone=UTC`;
        const meteoResp = await fetch(meteoUrl);
        const data = await meteoResp.json();
        if(!data.daily || !data.daily.time) throw new Error("Keine Wetterdaten gefunden");

        // 3) HDD/GTZ berechnen
        const tmax = data.daily.temperature_2m_max;
        const tmin = data.daily.temperature_2m_min;
        const dates= data.daily.time;
        const gtzMonth = Array(12).fill(0);
        for(let i=0;i<dates.length;i++){
            const avg = (tmax[i] + tmin[i]) / 2;
            if(avg < 15){
                const hdd = 20 - avg;
                const m = new Date(dates[i]).getUTCMonth(); // 0-11
                gtzMonth[m] += hdd;
            }
        }

        // 4) Tabelle aktualisieren
        buildTable(gtzMonth);
        document.getElementById("upd").textContent = new Date().toLocaleString("de-DE");
        document.getElementById("tbl").hidden = false;

    } catch(err) {
        msg.textContent = err.message;
    }
});

function buildTable(gtzArr){
    const tbody = document.querySelector("#tbl tbody");
    tbody.innerHTML = "";
    const sum = gtzArr.reduce((a,b)=>a+b,0);
    gtzArr.forEach((v,idx)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${months[idx]}</td><td>${v.toFixed(3)}</td><td>${(v? 100*v/sum:0).toFixed(3)}</td>`;
        tbody.appendChild(tr);
    });
    document.getElementById("sumGtz").textContent = sum.toFixed(3);
    document.getElementById("sumWgt").textContent = "100.0";
}
</script><script>

const months = ["Jan","Feb","Mär","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];

document.getElementById("go").addEventListener("click", async () => {
    const plz = document.getElementById("plz").value.trim();
    const year = parseInt(document.getElementById("jahr").value,10);
    const msg = document.getElementById("msg");
    msg.textContent = "";
    if(!/^\d{4,5}$/.test(plz)) { msg.textContent = "Bitte gültige deutsche PLZ eingeben."; return; }
    if(isNaN(year)) { msg.textContent = "Bitte gültiges Jahr eingeben."; return; }

    try {
        // 1) Geokodierung
        const geoUrl = `https://nominatim.openstreetmap.org/search?format=json&postalcode=${plz}&country=de&limit=1`;
        const geoResp = await fetch(geoUrl, { headers: { "User-Agent":"gtz-demo" }});
        const geoJson = await geoResp.json();
        if(!geoJson.length) throw new Error("PLZ nicht gefunden");
        const lat = parseFloat(geoJson[0].lat).toFixed(4);
        const lon = parseFloat(geoJson[0].lon).toFixed(4);

        // 2) Wetterdaten holen
        const start = `${year}-01-01`;
        const end   = `${year}-12-31`;
        const meteoUrl = `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${start}&end_date=${end}&daily=temperature_2m_max,temperature_2m_min&timezone=UTC`;
        const meteoResp = await fetch(meteoUrl);
        const data = await meteoResp.json();
        if(!data.daily || !data.daily.time) throw new Error("Keine Wetterdaten gefunden");

        // 3) HDD/GTZ berechnen
        const tmax = data.daily.temperature_2m_max;
        const tmin = data.daily.temperature_2m_min;
        const dates= data.daily.time;
        const gtzMonth = Array(12).fill(0);
        for(let i=0;i<dates.length;i++){
            const avg = (tmax[i] + tmin[i]) / 2;
            if(avg < 15){
                const hdd = 20 - avg;
                const m = new Date(dates[i]).getUTCMonth(); // 0-11
                gtzMonth[m] += hdd;
            }
        }

        // 4) Tabelle aktualisieren
        buildTable(gtzMonth);
        document.getElementById("upd").textContent = new Date().toLocaleString("de-DE");
        document.getElementById("tbl").hidden = false;

    } catch(err) {
        msg.textContent = err.message;
    }
});

function buildTable(gtzArr){
    const tbody = document.querySelector("#tbl tbody");
    tbody.innerHTML = "";
    const sum = gtzArr.reduce((a,b)=>a+b,0);
    gtzArr.forEach((v,idx)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${months[idx]}</td><td>${v.toFixed(3)}</td><td>${(v? 100*v/sum:0).toFixed(3)}</td>`;
        tbody.appendChild(tr);
    });
    document.getElementById("sumGtz").textContent = sum.toFixed(3);
    document.getElementById("sumWgt").textContent = "100.0";
}

</script><script>
// Inline Toggle für Custom-Datum-Rechenweg
(function(){
  var btn = var btn = var btn = document.getElementById('toggleCustomDateExp');
  var expDiv = document.getElementById('customDateExplanation');
  if (!btn || !expDiv) return;
  btn.onclick = function(){
    if (expDiv.style.display === 'block') {
      expDiv.style.display = 'none';
      btn.innerText = 'Rechenweg anzeigen';
    } else {
      expDiv.style.display = 'block';
      btn.innerText = 'Rechenweg ausblenden';
    }
  };
})();
</script><script>
    let defaultKwh = 0;
// Rubrik 7: Automatischer Abgleich mit Gesamtverbrauch aus Rubrik 6
(function syncKwhToRubrik7() {
  const kwhField = document.getElementById('kwhAmount');
  const rubrik6Kwh = document.getElementById('rubrik6TotalKwhValue');
  if (!kwhField || !rubrik6Kwh) return;
  const selectedMonths = document.querySelectorAll('#monthSelectionList input[type="checkbox"]:checked');
  if (selectedMonths.length === 0) {
    const raw = rubrik6Kwh.innerText.replace(/[.,]/g, m => m === ',' ? '.' : '');
    const parsed = parseFloat(raw);
    if (!isNaN(parsed)) kwhField.value = parsed.toFixed(3);
  }
})();

    let myChart = null;
    // Rubrik 6: Sichtbarkeitszustand des Rechenwegs merken
    let monthBlocksVisible = false;
    
    // Neue Funktion zur automatischen Vorbelegung der Dropdowns in Kostenberechnung 1 (linke Seite):
    // Wenn keine Checkbox ausgewählt ist, wird das komplette Array (alle Monate in DOM-Reihenfolge) als Standard verwendet.
    function updateCostCalculationLeftDropdowns(selected) {
      const checkboxes = document.querySelectorAll('#monthSelectionList input[type="checkbox"]');
      // Wenn keine Checkbox ausgewählt, alle Checkboxwerte als Default verwenden:
      let selValues = selected.length> 0 ? selected : Array.from(checkboxes).map(chk => chk.value);
      let firstMonth = null;
      let lastMonth = null;
      // Durchlaufe die Checkboxen in der Reihenfolge, wie sie im DOM erscheinen:
      checkboxes.forEach(chk => {
        if(selValues.includes(chk.value)) {
          if(firstMonth === null) {
            firstMonth = chk.value;
          }
          lastMonth = chk.value;
        }
      });
      if(firstMonth !== null && lastMonth !== null) {
        document.getElementById('fromMonth').value = monthNames[firstMonth];
        document.getElementById('toMonth').value = monthNames[lastMonth];
      }
    }
    
    function checkResetButtonVisibility() {
      const manualField = document.getElementById('kwhAmountManual');
      const resetBtn = document.getElementById('resetManualBtn');
      const resetHint = document.getElementById('resetManualHint');
      if (manualField.value.trim() !== "" && manualField.value !== defaultKwh) {
        resetBtn.style.display = "inline-block";
        resetHint.innerText = "Der Vorgabewert wird wieder hergestellt.";
      } else {
        resetBtn.style.display = "none";
        resetHint.innerText = "";
      }
    }
    
    function resetManualValue() {
      calculateCostManual();
      document.getElementById('resetManualBtn').style.display = "none";
      document.getElementById('resetManualHint').innerText = "";
    }
    
    function clearResults() {
      document.getElementById('monthWeightList').innerHTML = "";
      document.getElementById('monthWeightExplanation').innerHTML = "";
      document.getElementById('totalWeightSum').innerText = "";
      document.getElementById('m3Forecast').innerText = "";
      document.getElementById('m3ForecastExplanation').innerHTML = "";
      document.getElementById('kwhConversionResult').innerText = "";
      document.getElementById('kwhCalculationExplanation').innerHTML = "";
      document.getElementById('partialConsumptionResult').innerHTML = "";
      document.getElementById('m3ConversionList').innerHTML = "";
      if (myChart) {
        myChart.destroy();
        myChart = null;
      }
    }
    
    function resetAll() {
  // Rubriken 3-7 wieder ausblenden
  ['rubrik3','rubrik4','rubrik5','rubrik6','rubrik7'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
  // Rubrik 5 & 6: Platzhalter setzen
  var projectedM3 = document.getElementById('projectedM3Value');
  if (projectedM3) projectedM3.innerText = "(…)";
  var totalM3El  = document.getElementById('rubrik6TotalM3Value');
  var totalKwhEl = document.getElementById('rubrik6TotalKwhValue');
  if (totalM3El)  totalM3El.innerText  = "(…)";
  if (totalKwhEl) totalKwhEl.innerText = "(…)";
  // Zugehörige Summen/Caches invalidieren
  window.rubrik5MonthlyValues = null;
  window.rubrik5StartReading  = null;
  window.rubrik5EndMonth      = null;
  window.rubrik5EndYear       = null;

    // Hinweistext neben dem Kreis leeren
    var msgEl = document.getElementById('fetchMsg');
    if (msgEl) msgEl.innerText = '';

    
    // Rubrik 5: Custom-Datum-Feld und Anzeigen zurücksetzen
    var cd = document.getElementById('customDateInputRubrik5');
    if (cd) cd.value = '';
    var reading = document.getElementById('customDateReading');
    if (reading) reading.innerText = '';
    var exp = document.getElementById('customDateExplanation');
    if (exp) exp.innerText = '';
    var err = document.getElementById('customDateError');
    if (err) { err.innerText = ''; err.classList.remove('visible'); }
// Manuelles kWh-Eingabefeld zurücksetzen
    document.getElementById('kwhAmountManual').value = '';

    // Felder 'Abschläge von', 'Abschläge bis' und 'Monate Count' (manuell) zurücksetzen
    document.getElementById('fromMonthManual').value = '';
    document.getElementById('toMonthManual').value = '';
    document.getElementById('monthsCountManual').value = '';

    // Felder 'Abschläge von', 'Abschläge bis' und 'Monate Count' zurücksetzen
    document.getElementById('fromMonth').value = '';
    document.getElementById('toMonth').value = '';
    document.getElementById('monthsCount').value = '';

      // Rubrik 1
      document.getElementById('startDate').value = "";
      document.getElementById('endDate').value = "";
      document.getElementById('startMeter').value = "";
      document.getElementById('endMeter').value = "";
      document.getElementById('m3Difference').innerText = "0,000";
      document.getElementById('rubrik1Error').innerText = "";
      document.getElementById('dateWarning').innerText = "";
      document.getElementById('summerWarning').innerText = "";
      
      // Rubrik 1b
      document.getElementById('startDate2').value = "";
      document.getElementById('endDate2').value = "";
      document.getElementById('startMeter2').value = "";
      document.getElementById('endMeter2').value = "";
      document.getElementById('m3Difference2').innerText = "0,000";
      document.getElementById('winterWarning').innerText = "";
      document.getElementById('winterWarning').classList.remove("visible");
      document.getElementById('zweiterZeitraum').style.display = "none";
      // Buttons in Rubrik 1 und 1b zurücksetzen
      const btn1 = document.getElementById('toggleWeightBtn');
      if (btn1) btn1.innerText = 'Berechnung der Gewichtungen einblenden';
      const btn2 = document.querySelector('#zweiterZeitraum button.rechenweg');
      if (btn2) btn2.innerText = 'Berechnung der Gewichtungen einblenden';
      // Rubrik 2: Monate & Gewichtungen zurücksetzen
      const rub2 = document.getElementById('rubrik2');
      if (rub2) rub2.style.display = 'none';
      const wtSelect = document.getElementById('weightTableSelect');
      if (wtSelect) wtSelect.value = 'A';
      const monthList = document.getElementById('monthWeightList');
      if (monthList) monthList.innerHTML = '';
      const wtExp = document.getElementById('monthWeightExplanation');
      if (wtExp) { wtExp.innerHTML = ''; wtExp.classList.remove('visible');
      // Rubrik 3: Hochrechnung in m³ zurücksetzen
      const forecast = document.getElementById('m3Forecast');
      
      // Rubrik 4: Umrechnung in kWh zurücksetzen
      const kwhRes = document.getElementById('kwhConversionResult');
      
      // Rubrik 5: Verteilung des Verbrauchs zurücksetzen
      const header5 = document.getElementById('m3ConversionHeader');
      if (header5) header5.innerText = '';
      const list5 = document.getElementById('m3ConversionList');
      if (list5) list5.innerHTML = '';
      // Chart zurücksetzen
      if (window.myChart) {
        window.myChart.destroy();
        window.myChart = null;
    // Rubrik 5 Custom-Datum zurücksetzen bei resetAll
    var cd = document.getElementById('customDateInputRubrik5');
    if (cd) cd.value = '';
    var reading = document.getElementById('customDateReading');
    if (reading) reading.innerText = '';
    var exp = document.getElementById('customDateExplanation');
    if (exp) exp.innerText = '';
    var err = document.getElementById('customDateError');
    if (err) { err.innerText = ''; err.classList.remove('visible'); }
    // Rubrik 5 Custom-Datum zurücksetzen
    var cd = document.getElementById('customDateInputRubrik5');
    if (cd) cd.value = '';
    var reading = document.getElementById('customDateReading');
    if (reading) reading.innerText = '';
    var exp = document.getElementById('customDateExplanation');
    if (exp) exp.innerText = '';
    var err = document.getElementById('customDateError');
    if (err) { err.innerText = ''; err.classList.remove('visible'); }


      }
if (kwhRes) kwhRes.innerText = '';
      const kwhExp = document.getElementById('kwhCalculationExplanation');
      if (kwhExp) { kwhExp.innerHTML = ''; kwhExp.classList.remove('visible'); }
      const brenn = document.getElementById('brennwert');
      if (brenn) brenn.value = '10';
      const zust = document.getElementById('zustandszahl');
      if (zust) zust.value = '0.950';
      const factor = document.getElementById('factor');
      if (factor) factor.value = '';
if (forecast) forecast.innerText = '';
      const forecastExp = document.getElementById('m3ForecastExplanation');
      if (forecastExp) {
        forecastExp.innerHTML = '';
        forecastExp.classList.remove('visible');
      }
 }
      const wtSum = document.getElementById('totalWeightSum');
      if (wtSum) wtSum.innerText = '';
      const origW = document.getElementById('originalWeights');
      if (origW) origW.innerHTML = '';

      
      // Rubrik 6
      document.getElementById('monthSelectionList').innerHTML = "";
      document.getElementById('partialConsumptionResult').innerHTML = "";
      document.getElementById('kwhAmount').value = "";
      
      // Rubrik 7: Kostenberechnung 1
      document.getElementById('workPrice').value = "";
      document.getElementById('costResult').value = "";
      document.getElementById('basePrice').value = "";
      document.getElementById('installmentResult').value = "";
      document.getElementById('monthsCount').value = "";
      document.getElementById('totalSum').innerText = "0,00 €";
      
      // Rubrik 7: Kostenberechnung 2
      document.getElementById('workPriceManual').value = "";
      document.getElementById('costResultManual').value = "";
      document.getElementById('basePriceManual').value = "";
      document.getElementById('installmentResultManual').value = "";
      document.getElementById('monthsCountManual').value = "";
      document.getElementById('totalSumManual').innerText = "0,00 €";
      document.getElementById('resetManualBtn').style.display = "none";
      document.getElementById('resetManualHint').innerText = "";
      
      // Rubrik 2,3,4,5
      clearResults();
      calculate();
    
  // Ergänzung: Rubrik 4 Eingabefelder zurücksetzen
  (function(){
    var cb = document.getElementById('useCustomFactors');
    var customOn = !!(cb && cb.checked);
    if(!customOn){
      document.getElementById('brennwert').value = "10";
      document.getElementById('zustandszahl').value = "0.950";
      document.getElementById('factor').value = "";
    }
  })();

  // Ergänzung: Rubrik 5 - Verbrauchsüberschrift ausblenden
  // Ergänzung: Rubrik 6 - Monatsblöcke ausblenden
  document.getElementById('monthBlocksContainer').style.display = "none";

  // Ergänzung: Kostenberechnung 2 - manuelles Eingabefeld leeren
  document.getElementById('kwhAmountManual').value = "";

  // Rubrik 1: Eingabefelder direkt auf 0 oder leer setzen
  document.getElementById('startReading').value = "";
  document.getElementById('endReading').value = "";
  document.getElementById('startDate').value = "";
  document.getElementById('endDate').value = "";

  // Rubrik 1b (zweiter Zeitraum)
  document.getElementById('secondStartDate').value = "";
  document.getElementById('secondEndDate').value = "";
  document.getElementById('secondStartReading').value = "";
  document.getElementById('secondEndReading').value = "";

  // Rubrik 2: Gewichtungsanzeige zurücksetzen
  document.getElementById('gewichtungSumme').innerText = "0";

  // Rubrik 3: m³ Hochrechnung löschen
  document.getElementById('m3Forecast').innerText = "";

  // Rubrik 4: Ergebnisfeld leeren
  document.getElementById('kwhConversionResult').innerText = "";
  document.getElementById('kwhCalculationExplanation').innerText = "";

  // Rubrik 5: Tabelle & Chart zurücksetzen
  document.getElementById('verbrauchsTabelle').innerHTML = "";
  if (window.myChart) { myChart.destroy(); 
  // Rubrik 3: Hochrechnung zurücksetzen
  document.getElementById('m3Forecast').innerText = "";

  // Rubrik 5: Header, Tabelle und Diagramm leeren
  document.getElementById('verbrauchsTabelle').innerHTML = "";
  if (window.myChart) {
    window.myChart.destroy();
    window.myChart = null;
  }

  // Rubrik 7 Kostenberechnung 2: Manuelle Eingabe zurücksetzen
  const manualField = document.getElementById('kwhAmountManual');
  if (manualField) {
    manualField.value = "";
  }
    // Statusindikator zurücksetzen
    const statusEl = document.getElementById('fetchStatus');
    if (statusEl) statusEl.style.backgroundColor = '#ccc';

}

  // Rubrik 6: Monatsliste und Hinweis zurücksetzen
  document.getElementById('monthSelectionList').innerHTML = "";
  document.getElementById('noSelectionHint').style.display = "block";

  // Rubrik 7: Alle Eingabefelder und Summen zurücksetzen
  document.getElementById('kwhAmount').value = "";
  document.getElementById('arbeitspreis').value = "";
  document.getElementById('grundpreis').value = "";
  document.getElementById('anzahlMonate').value = "";
  document.getElementById('ergebnis1').innerText = "";
  document.getElementById('ergebnis2').innerText = "";
  document.getElementById('ergebnis3').innerText = "";
  document.getElementById('kwhAmountManual').value = "";
  document.getElementById('ergebnis4').innerText = "";
  document.getElementById('ergebnis5').innerText = "";
  document.getElementById('ergebnis6').innerText = "";

  // Rubrik 7 Hinweis zurücksetzen
  document.getElementById('cost1Hint').innerText = "( Gesamtverbrauch für alle 12 Monate )";
}
    
    function toggleCostCalc() {
      const content = document.getElementById("costCalcContent");
      const btn = document.getElementById("toggleCostCalcBtn");
      if (content.style.display === "none" || content.style.display === "") {
        content.style.display = "block";
        btn.innerText = "Weitere Berechnungsmöglichkeiten ausblenden";
      } else {
        content.style.display = "none";
        btn.innerText = "Weitere Berechnungsmöglichkeiten anzeigen";
      }
    }
    
    



function toggleWeightSection() {
  const section = document.getElementById("rubrik2");
  const btnA = document.getElementById("toggleWeightBtn");
  const btnB = document.getElementById("toggleWeightBtnB");
  const explanation = document.getElementById('monthWeightExplanation');
  const isHidden = section.style.display === "none" || section.style.display === "";
  if (isHidden) {
    section.style.display = "block";
    if (explanation) explanation.style.display = "block";
    updateMonthWeightList();
    if (btnA) btnA.innerText = "Berechnung der Gewichtungen verbergen";
    if (btnB) btnB.innerText = "Berechnung der Gewichtungen verbergen";
  } else {
    section.style.display = "none";
    if (explanation) explanation.style.display = "none";
    if (btnA) btnA.innerText = "Berechnung der Gewichtungen einblenden";
    if (btnB) btnB.innerText = "Berechnung der Gewichtungen einblenden";
  }
}


function toggleInfo(id) {
      const infoDiv = document.getElementById(id);
      infoDiv.style.display = (infoDiv.style.display === "none" || infoDiv.style.display === "") ? "block" : "none";
    }
    
    function validateRubrik7Dates() { return true; }
    
    const monthWeightsA = {
      '01': 16.224, '02': 13.202, '03': 12.765, '04': 9.102,
      '05': 4.786, '06': 2.382, '07': 0.790, '08': 0.772,
      '09': 3.297, '10': 8.224, '11': 12.680, '12': 15.776
    };
    let currentMonthWeights = {'01':0,'02':0,'03':0,'04':0,'05':0,'06':0,'07':0,'08':0,'09':0,'10':0,'11':0,'12':0};
    const monthNames = {
      '01': 'Januar', '02': 'Februar', '03': 'März', '04': 'April',
      '05': 'Mai', '06': 'Juni', '07': 'Juli', '08': 'August',
      '09': 'September', '10': 'Oktober', '11': 'November', '12': 'Dezember'
    };
    
    // Hilfsfunktion: Monatsname → Zahl
    function monthNameToNumber(name) {
      for (let key in monthNames) {
        if (monthNames[key] === name) {
          return parseInt(key, 10);
        }
      }
      return NaN;
    }
    
    
    
function updateStandardTable() {
  const originalWeightsDiv = document.getElementById('originalWeights');
  const tableSelect = document.getElementById('weightTableSelect').value;
  const headingText = tableSelect === 'A'
    ? "Monatsgewichtungen (Standardwerte)"
    : "Monatsgewichtungen (PLZ-basiert)";
  let html = `<h3>${headingText}</h3><ul>`;
  const orderedMonths = ["01","02","03","04","05","06","07","08","09","10","11","12"];
  orderedMonths.forEach(month => {
    html += `<li>${monthNames[month]}: ${(typeof currentMonthWeights[month] !== "undefined" ? currentMonthWeights[month] : 0)}</li>`;
  });
  html += "</ul>";
  originalWeightsDiv.innerHTML = html;
}

    
    function changeWeightTable() {
    const sel = document.getElementById("weightTableSelect").value;
    const rubrik2b = document.getElementById("rubrik2b");
    if (sel === "plz") {
        // rubrik2b remains hidden until "2b" button is pressed
        rubrik2b.style.display = "none";
    } else {
        rubrik2b.style.display = "none";
    }

      const select = document.getElementById('weightTableSelect');
      currentMonthWeights = monthWeightsA;
      calculate();
    calculateCost();
  if (document.getElementById("weightTableSelect").value === 'A') {
    ['rubrik3','rubrik4','rubrik5','rubrik6','rubrik7'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = 'block';
    });
  }

      if (document.getElementById('originalWeights').style.display === "block") {
        updateStandardTable();
      }
    
    // === Auto-recalc Rubrik 5 custom date with readiness polling ===
    try {
      var cd = document.getElementById('customDateInputRubrik5');
      if (cd && cd.value) {
        (function recalcWhenReady(tries){
          if ((window.rubrik5MonthlyValues && window.rubrik5MonthlyValues.length) && (window.rubrik5StartReading != null)) {
            var evt = new Event('change', { bubbles: true });
            cd.dispatchEvent(evt);
          } else if (tries > 0) {
            setTimeout(function(){ recalcWhenReady(tries-1); }, 0);
          }
        })(10);
      }
    } catch(e) {}
}

function showStandardTable() {
      const originalWeightsDiv = document.getElementById('originalWeights');
      const btn = document.getElementById('showStandardTableBtn');
      if (originalWeightsDiv.style.display === "block") {
        originalWeightsDiv.style.display = "none";
        btn.innerText = "Tabelle anzeigen";
      } else {
        updateStandardTable();
        originalWeightsDiv.style.display = "block";
        btn.innerText = "Tabelle ausblenden";
      }
    }
    
    function calculateMonths() {
      let fromName = document.getElementById('fromMonth').value;
    let toName   = document.getElementById('toMonth').value;
    let from     = monthNameToNumber(fromName);
      let to     = monthNameToNumber(toName);
      let count = (from <= to) ? (to - from + 1) : ((12 - from + 1) + to);
      document.getElementById('monthsCount').value = count;
      calculateInstallments();
      
      let fromManual = parseInt(document.getElementById('fromMonthManual').value, 10);
      let toManual = parseInt(document.getElementById('toMonthManual').value, 10);
      let countManual = (fromManual <= toManual) ? (toManual - fromManual + 1) : ((12 - fromManual + 1) + toManual);
      document.getElementById('monthsCountManual').value = countManual;
      calculateInstallmentsManual();
    }
    
    function isValidDateString(dateString) {
      const parts = dateString.split(".");
      if (parts.length !== 3) return false;
      if (parts[2].length !== 4) return false;
      const day = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10);
      const year = parseInt(parts[2], 10);
      const date = new Date(year, month - 1, day);
      return (date.getFullYear() === year && (date.getMonth() + 1) === month && date.getDate() === day);
    }
    
    function parseDate(dateString) {
      const parts = dateString.split(".");
      return new Date(parseInt(parts[2], 10), parseInt(parts[1], 10) - 1, parseInt(parts[0], 10));
    }
    
    




function validateDateInput(id, errorId) {
  const input = document.getElementById(id);
  const error = document.getElementById(errorId);
  const value = input.value.trim();

  // Zähle Punkte
  const dots = (value.match(/\./g) || []).length;
  const parts = value.split('.');

    // Sonderfall: keine Punkte, aber genau 8 Ziffern (z.B. 30062024) -> Formatfehler
  if (dots === 0 && /^\d{8}$/.test(value)) {
    error.innerText = "Bitte im Format TT.MM.JJJJ eingeben.";
    error.classList.add("visible");
    return;
  }

// 1) Kein Punkt → (noch keine Meldung)
  if (dots === 0) {
    error.innerText = "";
    error.classList.remove("visible");
    return;
  }

  // 2) Genau 1 Punkt
  if (dots === 1) {
    // Wenn nach dem Punkt mehr als 2 Ziffern kommen, ist es eindeutig kein reiner Monat
    if (parts[1].length> 2) {
      error.innerText = "Bitte im Format TT.MM.JJJJ eingeben.";
      error.classList.add("visible");
      return;
    }
    // sonst: unvollständige Eingabe (Tag oder Monat noch im Tippen) → keine Meldung
    error.innerText = "";
    error.classList.remove("visible");
    return;
  }

  // 3) Mehr als 2 Punkte → falsches Format
  if (dots> 2) {
    error.innerText = "Bitte im Format TT.MM.JJJJ eingeben.";
    error.classList.add("visible");
    return;
  }

  // Ab hier dots === 2 → drei Teile vorhanden
  const [d, m, y] = parts;
  // Prüfe, ob Tag und Monat 1–2 Ziffern, Jahr genau 4 Ziffern
  if (!/^\d{1,2}$/.test(d) || !/^\d{1,2}$/.test(m) || !/^\d{4}$/.test(y)) {
    error.innerText = "Bitte im Format TT.MM.JJJJ eingeben.";
    error.classList.add("visible");
    return;
  }

  // Existenz-Check
  const day   = parseInt(d, 10);
  const month = parseInt(m, 10) - 1;
  const year  = parseInt(y, 10);
  const date  = new Date(year, month, day);
  if (
    date.getFullYear() !== year ||
    date.getMonth()    !== month ||
    date.getDate()     !== day
  ) {
    error.innerText = "Ungültiges Datum.";
    error.classList.add("visible");
    return;
  }

  // Clear error if all checks passed
  error.innerText = "";
  error.classList.remove("visible");
}





    
    function toggleExplanationMonths(btn) {
      const container = document.getElementById('partialConsumptionResult');
      const explanations = container.querySelectorAll('.month-block .explanation');
      let anyVisible = false;
      explanations.forEach(exp => { if(exp.style.display === 'block') anyVisible = true; });
      explanations.forEach(exp => { exp.style.display = anyVisible ? 'none' : 'block'; });
      btn.innerText = anyVisible ? "Rechenweg anzeigen" : "Rechenweg ausblenden";
    }


function toggleBlocks(btn) {
  const container = document.getElementById('monthBlocksContainer');
  if (!container) return;
  // Zustand umkehren
  monthBlocksVisible = !monthBlocksVisible;
  // Container & Erklärungen anzeigen/verbergen
  container.style.display = monthBlocksVisible ? 'block' : 'none';
  container.querySelectorAll('.explanation')
           .forEach(e => e.style.display = monthBlocksVisible ? 'block' : 'none');
  // Button-Text synchron halten
  btn.innerText = monthBlocksVisible ? 'Rechenweg ausblenden' : 'Rechenweg anzeigen';
}


    
    function toggleExplanation(elementId, btn) {
      const explanationElement = document.getElementById(elementId);
      if (explanationElement.style.display === 'block') {
        explanationElement.style.display = 'none';
        btn.innerText = "Rechenweg anzeigen";
      } else {
        explanationElement.style.display = 'block';
        btn.innerText = "Rechenweg ausblenden";
      }
    }
    
    function toggleRechenwegInRubrik5(btn) {
      const explanations = document.querySelectorAll('#m3ConversionList .explanation');
      let anyVisible = false;
      explanations.forEach(exp => { if(exp.style.display === 'block') anyVisible = true; });
      explanations.forEach(exp => { exp.style.display = anyVisible ? 'none' : 'block'; });
      btn.innerText = anyVisible ? "Rechenweg anzeigen" : "Rechenweg ausblenden";
    }
    
    // Hier: processSelectedMonths wird nun immer aufgerufen, um die Default-Situation zu berücksichtigen,
    // und am Ende wird zusätzlich calculateMonths() aufgerufen, um das Feld "Anzahl der Monate" zu aktualisieren.
    function processSelectedMonths() {
      const checkboxes = Array.from(document.querySelectorAll('#monthSelectionList input[type="checkbox"]'));
      let monthList = checkboxes.filter(c => c.checked).map(c => c.value);
      if (monthList.length === 0) {
        monthList = checkboxes.map(c => c.value);
      }
      let total = 0;
      let blocks = '';
      monthList.forEach((m, i) => {
        const m3 = parseFloat(document.querySelector(`#month-${m}`).getAttribute('data-m3'));
        const dayInput = document.getElementById(`day-${m}`);
        const days = parseInt(dayInput?.value) || 0;
        const daysInMonth = new Date(new Date().getFullYear(), parseInt(m), 0).getDate();
        let partial, exp;
        if (i === 0 && days> 0) {
          partial = m3 * ((daysInMonth - days + 1) / daysInMonth);
          exp = `(Teil: (${m3.toFixed(3)}/${daysInMonth}) × (${daysInMonth}-${days}+1))`;
        } else if (i === monthList.length - 1 && days> 0) {
          partial = m3 * (days / daysInMonth);
          exp = `(Teil: (${m3.toFixed(3)}/${daysInMonth}) × ${days})`;
        } else {
          partial = m3;
          exp = `(Voll: ${m3.toFixed(3)} m³)`;
        }
        total += partial;
        blocks += `
      <div class="month-block">
        <p>Verbrauch ${monthNames[m]}: ${partial.toFixed(3).replace('.',',')} m³</p>
        ${days> 0 ? `<div class="explanation" style="display:none;">${exp} = ${partial.toFixed(3).replace('.',',')} m³</div>` : ''}
      </div>`;
      });
      const brenn = parseFloat(document.getElementById('brennwert').value.replace(',', '.')) || 10;
      const zust = parseFloat(document.getElementById('zustandszahl').value.replace(',', '.')) || 0.95;
      const totalKwh = total * brenn * zust;
      document.getElementById('kwhAmount').value = totalKwh.toFixed(3);
  const wp = document.getElementById('workPrice');
  if (wp) wp.dispatchEvent(new Event('input'));
      // replace dot with comma for display
      const kwhComma = document.getElementById('kwhAmount').value.replace('.', ',');
      document.getElementById('kwhAmount').value = kwhComma;
      const html = `
    ${blocks}
    <p class="highlighted">
      <strong>Gesamtverbrauch in m³: ${total.toFixed(3).replace('.',',')} m³</strong>
    </p>
    <p class="highlighted">
      <strong>Gesamtverbrauch in kWh: ${totalKwh.toFixed(3).replace('.',',')} kWh</strong>
    </p>`;
      document.getElementById('partialConsumptionResult').innerHTML = html;
      // Aktualisiere statische Gesamtsumme Rubrik 6
      var totalEl = document.getElementById('rubrik6TotalM3Value');
      if (totalEl) { totalEl.innerText = total.toFixed(3).replace('.',','); }
      // Aktualisiere statische kWh Gesamtsumme Rubrik 6
      var kwhEl = document.getElementById('rubrik6TotalKwhValue');
      if (kwhEl) { kwhEl.innerText = totalKwh.toFixed(3).replace('.',','); }

      updateCostCalculationLeftDropdowns(monthList);
      calculateMonths();
    
  // Sichtbarkeit/ Button-Text beibehalten bei Änderungen Rubrik 6
  const blocksBtn = document.querySelector('#rubrik6 button.rechenweg');
  const blocksContainer = document.getElementById('monthBlocksContainer');
  if (blocksContainer) {
    blocksContainer.style.display = monthBlocksVisible ? 'block' : 'none';
    blocksContainer.querySelectorAll('.explanation')
                   .forEach(e => e.style.display = monthBlocksVisible ? 'block' : 'none');
  }
  if (blocksBtn) {
    blocksBtn.innerText = monthBlocksVisible ? 'Rechenweg ausblenden' : 'Rechenweg anzeigen';
  }
}
    
    
    function calculateMonthlyDistribution(m3Hochrechnung, endMonth, endMeter, endYear) {
  var startMeterLocal = endMeter;
      const monthOrder = Array.from({ length: 12 }, (_, i) => (((endMonth - 1 + i) % 12) + 1));
      let cumulativeReading = endMeter;
      let monthlyValues = [];
      let m3ConversionListHtml = "";
      let currentYear = endYear;
      const isConsumptionMode = (window.consumptionMode === true);

      const startMonthIndex = endMonth - 1;
      for (let i = 0; i < 12; i++) {
        const monthIndex = (startMonthIndex + i) % 12;
        const yearOffset = Math.floor((startMonthIndex + i) / 12);
        const monthNum = monthIndex + 1;
        const year = endYear + yearOffset;
        // Insert year heading when crossing into a new calendar year
        if (i === 0 || year !== currentYear) {
          m3ConversionListHtml += `<li class="year-heading">${year}</li>`;
          currentYear = year;
        }

        const monthStr = monthNum.toString().padStart(2, '0');
        const weight = (typeof currentMonthWeights[monthStr] !== "undefined" ? currentMonthWeights[monthStr] : 0);
        const m3ForMonth = (m3Hochrechnung * weight) / 100;
        monthlyValues.push(m3ForMonth);
        cumulativeReading += m3ForMonth;

        // Insert year heading if it changes
        if (i === 0 || year !== currentYear) {
          currentYear = year;
        }

        m3ConversionListHtml += `<li class="m3-conversion-item" data-month="${monthNames[monthStr]}" data-m3="${m3ForMonth.toFixed(3)}">
          ${monthNames[monthStr]}: ${m3ForMonth.toFixed(3).replace('.', ',')} m³${isConsumptionMode ? '' : ',\n          <span class="zaehlerstand">Zählerstand: ' + cumulativeReading.toFixed(3).replace('.', ',') + '</span>'}
          <span class="explanation" style="display:none; margin-top: 10px;">
            (${m3Hochrechnung.toFixed(3).replace('.', ',')} / 100 × ${weight} = ${m3ForMonth.toFixed(3).replace('.', ',')})
          </span>
        </li>`;
      }
      refreshChartFromRubrik5();
      window.rubrik5MonthlyValues = monthlyValues;

      window.rubrik5StartReading = startMeterLocal;

      window.rubrik5EndMonth = endMonth;
  window.rubrik5EndYear = endYear;
  return m3ConversionListHtml;
    }
    function updateChart(labels, data) {
      const ctx = document.getElementById("chartContainer").getContext("2d");
      if (myChart !== null) {
        myChart.data.labels = labels;
        myChart.data.datasets[0].data = data;
        myChart.update();
      } else {
        myChart = new Chart(ctx, {
          type: 'bar',
          data: { labels: labels, datasets: [{ label: 'Verbrauch in m³', data: data, backgroundColor: 'rgba(0,123,255,0.5)', borderColor: 'rgba(0,123,255,1)', borderWidth: 1 }] },
          options: { responsive: false, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
      }
    }
    
    function calculateKWh() {
      const m3ForecastText = document.getElementById('m3Forecast')?.innerText.split(': ')[1] || "0";
      const m3Hochrechnung = parseFloat(m3ForecastText.replace(',', '.')) || 0;
      const brennwert = parseFloat(document.getElementById('brennwert').value.replace(',', '.')) || 10;
      const zustandszahl = parseFloat(document.getElementById('zustandszahl').value.replace(',', '.')) || 0.95;
      const factorField = document.getElementById('factor');
      const factor = (factorField && factorField.value.trim() !== "") ? parseFloat(factorField.value.replace(',', '.')) : null;
      let kwhResult;
      if (factor && !isNaN(factor)) {
        kwhResult = m3Hochrechnung * factor;
        document.getElementById('kwhCalculationExplanation').innerHTML = `Rechenweg: ${m3Hochrechnung.toFixed(3).replace('.', ',')} m³ × ${factor} = ${kwhResult.toFixed(3).replace('.', ',')} kWh`;
      } else {
        kwhResult = m3Hochrechnung * brennwert * zustandszahl;
        document.getElementById('kwhCalculationExplanation').innerHTML = `Rechenweg: (${m3Hochrechnung.toFixed(3).replace('.', ',')} m³ × ${brennwert} × ${zustandszahl}) = ${kwhResult.toFixed(3).replace('.', ',')} kWh`;
      }
      document.getElementById('kwhConversionResult').innerText = `Umrechnung in kWh: ${kwhResult.toFixed(3).replace('.', ',')} kWh`;
      defaultKwh = kwhResult;  // Zahl vorhalten
      const kwhStr = kwhResult.toFixed(3);
      const kwhStrComma = kwhStr.replace('.', ',');
      document.getElementById('kwhAmount').value = kwhStrComma;
  const wp = document.getElementById('workPrice');
  if (wp) wp.dispatchEvent(new Event('input'));
      // Feld 1 in Kostenberechnung 1 immer befüllen
      processSelectedMonths();
    }
    
    function calculateCost() {
      const kwhAmount = parseFloat(document.getElementById('kwhAmount').value.replace(',', '.')) || 0;
      const workPrice = parseFloat(document.getElementById('workPrice').value) || 0;
      const cost = (kwhAmount * workPrice / 100).toFixed(3);
      document.getElementById('costResult').value = `${cost.replace('.', ',')} €`;
      calculateTotalSum();
    }
    
    function calculateCostManual() {
      const kwhAmount = parseFloat(document.getElementById('kwhAmountManual').value.replace(',', '.')) || 0;
      const workPrice = parseFloat(document.getElementById('workPriceManual').value) || 0;
      const cost = (kwhAmount * workPrice / 100).toFixed(3);
      document.getElementById('costResultManual').value = `${cost.replace('.', ',')} €`;
      calculateTotalSumManual();
    }
    
    function calculateInstallments() {
      const monthsCount = parseInt(document.getElementById('monthsCount').value) || 0;
      const basePrice = parseFloat(document.getElementById('basePrice').value.replace(',', '.')) || 0;
      const installmentCost = (monthsCount * basePrice).toFixed(3);
      document.getElementById('installmentResult').value = installmentCost.replace('.', ',') + ' €';
      calculateTotalSum();
    }
    
    function calculateTotalSum() {
      const costStr = document.getElementById('costResult').value.replace(',', '.').replace('€', '').trim();
      const cost = parseFloat(costStr) || 0;
      const installmentsStr = document.getElementById('installmentResult').value.replace(',', '.').replace('€', '').trim();
      const installments = parseFloat(installmentsStr) || 0;
      const total = (cost + installments).toFixed(3);
      document.getElementById('totalSum').innerText = total.replace('.', ',') + ' €';
    }
    
    function calculateInstallmentsManual() {
      const monthsCountManual = parseInt(document.getElementById('monthsCountManual').value) || 0;
      const basePriceManual = parseFloat(document.getElementById('basePriceManual').value.replace(',', '.')) || 0;
      const installmentCostManual = (monthsCountManual * basePriceManual).toFixed(3);
      document.getElementById('installmentResultManual').value = installmentCostManual.replace('.', ',') + ' €';
      calculateTotalSumManual();
    }
    
    function calculateTotalSumManual() {
      const costManualStr = document.getElementById('costResultManual').value.replace(',', '.').replace('€', '').trim();
      const costManual = parseFloat(costManualStr) || 0;
      const installmentManualStr = document.getElementById('installmentResultManual').value.replace(',', '.').replace('€', '').trim();
      const installmentManual = parseFloat(installmentManualStr) || 0;
      const totalManual = (costManual + installmentManual).toFixed(3);
      document.getElementById('totalSumManual').innerText = totalManual.replace('.', ',') + ' €';
    }
    
    function toggleDayInputs() {
      const checkboxes = document.querySelectorAll('#monthSelectionList input[type="checkbox"]');
      const checked = Array.from(checkboxes).filter(chk => chk.checked);
      checkboxes.forEach(chk => {
        const dayInput = document.getElementById(`day-input-${chk.value}`);
        dayInput.style.display = (chk.checked && (chk === checked[0] || chk === checked[checked.length - 1])) ? 'inline' : 'none';
      });
    }
    
    function validateDayInput(monthStr) {
      const dayInput = document.getElementById(`day-${monthStr}`);
      const maxDay = new Date(new Date().getFullYear(), parseInt(monthStr), 0).getDate();
      if (dayInput.value !== "" && parseInt(dayInput.value)> maxDay) {
        dayInput.value = maxDay;
        processSelectedMonths();
      }
    }
    
    function printAsPDF() {
      const opt = {
        margin: 1,
        filename: 'Gas-Verbrauchs-Prognose.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(document.body).save();
    }
    
    
function calculate() {
  // Hinweis ausblenden, sobald alle vier Pflichtfelder gefüllt sind
  const hintEl = document.getElementById('mainDataHint');
  if (hintEl) {
    const inputsFilled = ['startDate','startMeter','endDate','endMeter'].every(id => {
      const el = document.getElementById(id);
      return el && el.value.trim() !== '';
    });
    hintEl.classList.toggle('stop', inputsFilled);
  }

      const startDateStr = document.getElementById('startDate').value;
      const endDateStr = document.getElementById('endDate').value;
      if (!isValidDateString(startDateStr) || !isValidDateString(endDateStr)) {
        document.getElementById('m3Difference').innerText = "0,000";
        return;
      calculateCost();
      const wp = document.getElementById('workPrice');
  if (wp) wp.dispatchEvent(new Event('input'));
}
    
      const startDate = parseDate(startDateStr);
      const endDate = parseDate(endDateStr);
    
      if (startDate> endDate) {
        document.getElementById('rubrik1Error').innerText = "Das Startdatum darf nicht nach dem Enddatum liegen.";
        document.getElementById('rubrik1Error').classList.add("visible");
        return;
      } else {
        document.getElementById('rubrik1Error').innerText = "";
        document.getElementById('rubrik1Error').classList.remove("visible");
      }

      const today = new Date();
      today.setHours(0,0,0,0);
      if (endDate> today) {
        document.getElementById('endDateError').innerText = "Das Enddatum darf nicht in der Zukunft liegen.";
        document.getElementById('endDateError').classList.add("visible");
        return;
      } else {
        document.getElementById('endDateError').innerText = "";
        document.getElementById('endDateError').classList.remove("visible");
      }
    
      const startMeter = parseFloat(document.getElementById('startMeter').value);
      const endMeter = parseFloat(document.getElementById('endMeter').value);
      window.consumptionMode = (startMeter === 0 && endMeter > 0);
      if (isNaN(startMeter) || isNaN(endMeter)) {
        document.getElementById('rubrik1Error').innerText = "Bitte geben Sie gültige Zahlenwerte für die Gaszählerstände ein.";
        document.getElementById('rubrik1Error').classList.add("visible");
        return;
      }
      if (startMeter> endMeter) {
        document.getElementById('endMeterError').innerText = "Der Startzählerstand darf nicht größer als der Endzählerstand sein.";
        document.getElementById('endMeterError').classList.add("visible");
        return;
      } else {
        document.getElementById('endMeterError').innerText = "";
        document.getElementById('endMeterError').classList.remove("visible");
      }
    
      const mainConsumption = endMeter - startMeter;
      document.getElementById('m3Difference').innerText = mainConsumption.toFixed(3).replace('.', ',');
    
      const diffInMonthsRaw = (endDate.getFullYear() - startDate.getFullYear()) * 12 + (endDate.getMonth() - startDate.getMonth());
      const numMonths = diffInMonthsRaw + 1;
    
      if (numMonths> 12) {
        document.getElementById('dateWarning').innerText = "Hinweis: Die Berechnung ist nicht möglich, weil der eingegebene Zeitraum länger als 12 Monate ist.";
        document.getElementById('dateWarning').classList.add("visible");
        clearResults();
        return;
      } else {
        document.getElementById('dateWarning').innerText = "";
        document.getElementById('dateWarning').classList.remove("visible");
      }
    
      let allSummer = true;
      for (let i = 0; i < numMonths; i++) {
        let month = ((startDate.getMonth() + i) % 12) + 1;
        if (month < 5 || month> 9) { allSummer = false; break; }
      }
      if (allSummer) {
        document.getElementById('zeitraum1Heading').style.display = "block";
        document.getElementById('summerWarning').innerText = "Ihr gewählter Zeitraum enthält nur Sommermonate. Um eine präzisere Hochrechnung zu ermöglichen, können Sie zusätzlich einen Zeitraum mit Wintermonaten erfassen.";
        document.getElementById('summerWarning').classList.add("visible");
        window._shouldSuggestPeriod2 = true; var __btn=document.getElementById('toggleRubrik1bBtn'); if(__btn){ __btn.style.display='inline-block'; __btn.textContent='2. Zeitraum einblenden'; }
      } else {
        document.getElementById('zeitraum1Heading').style.display = "none";
        document.getElementById('summerWarning').innerText = "";
        document.getElementById('summerWarning').classList.remove("visible");
      }
    
      let mainWeightSum = 0;
      let monthWeightExplanation = "";
      let monthOrder = [];
      for (let i = 0; i < numMonths; i++) {
        let monthIndex = (startDate.getMonth() + i) % 12 + 1;
        monthOrder.push(monthIndex.toString().padStart(2, '0'));
      }
      if (numMonths === 1) {
        let monthStr = monthOrder[0];
        let standardWeight = (typeof currentMonthWeights[monthStr] !== "undefined" ? currentMonthWeights[monthStr] : 0);
        let daysInMonth = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0).getDate();
        let daysCount = endDate.getDate() - startDate.getDate() + 1;
        let adjustedWeight = (standardWeight / daysInMonth) * daysCount;
        mainWeightSum += adjustedWeight;
        monthWeightExplanation += monthNames[monthStr] + ": (" + standardWeight + " / " + daysInMonth + ") × " + daysCount + " Resttage = " + adjustedWeight.toFixed(3) + "<br>";
      } else {
        monthOrder.forEach((monthStr, index) => {
          let standardWeight = (typeof currentMonthWeights[monthStr] !== "undefined" ? currentMonthWeights[monthStr] : 0);
          let adjustedWeight = standardWeight;
          if (index === 0) {
            let daysInMonth = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0).getDate();
            let daysCount = daysInMonth - startDate.getDate() + 1;
            adjustedWeight = (standardWeight / daysInMonth) * daysCount;
            monthWeightExplanation += monthNames[monthStr] + " (Teilmonat): (" + standardWeight + " / " + daysInMonth + ") × " + daysCount + " Resttage = " + adjustedWeight.toFixed(3) + "<br>";
          } else if (index === monthOrder.length - 1) {
            let daysInMonth = new Date(endDate.getFullYear(), endDate.getMonth() + 1, 0).getDate();
            let daysCount = endDate.getDate();
            if(daysCount === daysInMonth) {
              adjustedWeight = standardWeight;
              monthWeightExplanation += monthNames[monthStr] + ": " + standardWeight + "<br>";
            } else {
              adjustedWeight = (standardWeight / daysInMonth) * daysCount;
              monthWeightExplanation += monthNames[monthStr] + " (Teilmonat): (" + standardWeight + " / " + daysInMonth + ") × " + daysCount + "  = " + adjustedWeight.toFixed(3) + "<br>";
            }
          } else {
            monthWeightExplanation += monthNames[monthStr] + ": " + standardWeight + "<br>";
          }
          mainWeightSum += adjustedWeight;
        });
      }
    
      let secondConsumption = 0;
      let secondWeightSum = 0;
      const startDate2Str = document.getElementById('startDate2').value;
      const endDate2Str = document.getElementById('endDate2').value;
      const startMeter2Str = document.getElementById('startMeter2').value;
      const endMeter2Str = document.getElementById('endMeter2').value;
      let secondHasNonSummer = false;
      let secondExplanation = "";
      if (startDate2Str.trim() !== "" && endDate2Str.trim() !== "" && startMeter2Str.trim() !== "" && endMeter2Str.trim() !== "") {
          if (isValidDateString(startDate2Str) && isValidDateString(endDate2Str)) {
            const startDate2 = parseDate(startDate2Str);
            const endDate2 = parseDate(endDate2Str);
            if (startDate2 <= endDate2) {
              const diffInMonths2 = (endDate2.getFullYear() - startDate2.getFullYear()) * 12 + (endDate2.getMonth() - startDate2.getMonth()) + 1;
              for (let i = 0; i < diffInMonths2; i++) {
                let currentMonth = ((startDate2.getMonth() + i) % 12) + 1;
                if (currentMonth < 5 || currentMonth> 9) { secondHasNonSummer = true; break; }
              }
              if (!secondHasNonSummer) {
                document.getElementById('winterWarning').innerText = "Der zweite Zeitraum enthält keine zusätzlichen Wintermonate und wird daher nicht berücksichtigt.";
                document.getElementById('winterWarning').classList.add("visible");
              } else {
                document.getElementById('winterWarning').innerText = "";
                document.getElementById('winterWarning').classList.remove("visible");
                const consumption2 = parseFloat(endMeter2Str) - parseFloat(startMeter2Str);
                document.getElementById('m3Difference2').innerText = consumption2.toFixed(3).replace('.', ',');for (let i = 0; i < diffInMonths2; i++) {
                  let currentMonth = ((startDate2.getMonth() + i) % 12) + 1;
                  if (currentMonth>= 5 && currentMonth <= 9) continue;
                  let monthStr = currentMonth.toString().padStart(2, '0');
                  let standardWeight = (typeof currentMonthWeights[monthStr] !== "undefined" ? currentMonthWeights[monthStr] : 0);
                  let adjustedWeight = standardWeight;
                  let daysInMonth, daysCount;
                  if (diffInMonths2 === 1) {
                    daysInMonth = new Date(startDate2.getFullYear(), startDate2.getMonth() + 1, 0).getDate();
                    daysCount = endDate2.getDate() - startDate2.getDate() + 1;
                    adjustedWeight = (standardWeight / daysInMonth) * daysCount;
                    secondExplanation += monthNames[monthStr] + " (Teilmonat): (" + standardWeight + " / " + daysInMonth + ") × " + daysCount + " Resttage = " + adjustedWeight.toFixed(3) + "<br>";
                  } else {
                    if (i === 0) {
                      daysInMonth = new Date(startDate2.getFullYear(), startDate2.getMonth() + 1, 0).getDate();
                      daysCount = daysInMonth - startDate2.getDate() + 1;
                      adjustedWeight = (standardWeight / daysInMonth) * daysCount;
                      secondExplanation += monthNames[monthStr] + " (Teilmonat): (" + standardWeight + " / " + daysInMonth + ") × " + daysCount + " Resttage = " + adjustedWeight.toFixed(3) + "<br>";
                    } else if (i === diffInMonths2 - 1) {
                      daysInMonth = new Date(endDate2.getFullYear(), endDate2.getMonth() + 1, 0).getDate();
                      daysCount = endDate2.getDate();
                      if(daysCount === daysInMonth) {
                        adjustedWeight = standardWeight;
                        secondExplanation += monthNames[monthStr] + ": " + standardWeight + "<br>";
                      } else {
                        adjustedWeight = (standardWeight / daysInMonth) * daysCount;
                        secondExplanation += monthNames[monthStr] + " (Teilmonat): (" + standardWeight + " / " + daysInMonth + ") × " + daysCount + " Resttage = " + adjustedWeight.toFixed(3) + "<br>";
                      }
                    } else {
                      secondExplanation += monthNames[monthStr] + ": " + standardWeight + "<br>";
                    }
                  }
                  secondWeightSum += adjustedWeight;
                }
                const startMeter2 = parseFloat(startMeter2Str);
                const endMeter2 = parseFloat(endMeter2Str);
                if (!isNaN(startMeter2) && !isNaN(endMeter2) && startMeter2 <= endMeter2) {
                  secondConsumption = endMeter2 - startMeter2;
                }
              }
            }
          }
      }
      // Dynamische Überschriften anpassen
      let fullWeightExplanation;
      
if (secondHasNonSummer) {
  fullWeightExplanation = `<div class="weight-frame"><strong style="display:block; margin-bottom:0.5em;">Gewichtungs-Aufschlüsselung Zeitraum 1:</strong><br>${monthWeightExplanation}<br><strong>Summe: ${mainWeightSum.toFixed(3)}</strong><br></div>`;
  fullWeightExplanation += `<div class="weight-frame"><strong style="display:block; margin-top:1em; margin-bottom:0.5em;">Gewichtungs-Aufschlüsselung Zeitraum 2:</strong><br>${secondExplanation}<br><strong>Summe: ${secondWeightSum.toFixed(3)}</strong><br></div>`;
} else {
  fullWeightExplanation = `<div>` + monthWeightExplanation + `</div>`;
}

document.getElementById('monthWeightExplanation').innerHTML = fullWeightExplanation;

      document.getElementById('totalWeightSum').innerHTML = '<b>' + (mainWeightSum + secondWeightSum).toFixed(3) + '</b>';
          // Populate Rubrik 2: Monate gruppiert nach Jahr
          const monthWeightList = document.getElementById('monthWeightList');
          monthWeightList.innerHTML = '';
          let currentYear = null;
          for (let i = 0; i < numMonths; i++) {
            const monthDate = new Date(startDate.getFullYear(), startDate.getMonth() + i, 1);
            const year = monthDate.getFullYear();
            const monthStr = (monthDate.getMonth() + 1).toString().padStart(2,'0');
            if (year !== currentYear) {
              currentYear = year;
            }
            // Berechnung Teilgewichtung analog Rechenweg
            const monthStart = new Date(year, monthDate.getMonth(), 1);
            const monthEnd = new Date(year, monthDate.getMonth() + 1, 0);
            const overlapStart = (year === startDate.getFullYear() && monthDate.getMonth() === startDate.getMonth()) ? startDate : monthStart;
            const overlapEnd = (year === endDate.getFullYear() && monthDate.getMonth() === endDate.getMonth()) ? endDate : monthEnd;
            const daysCount = (overlapEnd - overlapStart) / (1000 * 60 * 60 * 24) + 1;
            const daysInMonth = (monthEnd - monthStart) / (1000 * 60 * 60 * 24) + 1;
            const fullWeight = (typeof currentMonthWeights[monthStr] !== "undefined" ? currentMonthWeights[monthStr] : 0);
            const partialWeight = ((fullWeight / daysInMonth) * daysCount).toFixed(3).replace('.', ',');
            monthWeightList.insertAdjacentHTML('beforeend', `<li>${monthNames[monthStr]}: ${partialWeight}</li>`);
          }
    
      const combinedConsumption = mainConsumption + secondConsumption;
      const combinedWeightSum = mainWeightSum + secondWeightSum;
      const m3Hochrechnung = (combinedConsumption / combinedWeightSum) * 100;
      document.getElementById('m3Forecast').innerText = `Hochrechnung: ${m3Hochrechnung.toFixed(3).replace('.', ',')} m³`;
    
      
      // Gruppierter Rechenweg nach Jahr für Rubrik 3
      // Monatliche Gewichtserklärungen als Array:
// für Rubrik 3: Überschriften für Zeiträume anpassen

const cleaned = fullWeightExplanation
    .replace(/<div class="weight-frame">/g, '')
    .replace(/<\/div>/g, '');
let m3WeightStr = cleaned
    .replace(/Gewichtungs-Aufschlüsselung Zeitraum 1/, 'Aufschlüsselung des Zeitraums 1')
    .replace(/Gewichtungs-Aufschlüsselung Zeitraum 2/, 'Aufschlüsselung des Zeitraums 2');
const detaill = m3WeightStr.split('<br>').filter(e => e.trim());
let grouped = '<strong>Detaillierte Aufschlüsselung:</strong>';

// Period 1 entries
grouped += '<div class="period1-frame"><ul>';
let inPeriod2 = false;
detaill.forEach(entry => {
  if (entry.includes('Aufschlüsselung des Zeitraums 2')) {
    // Close period1
    grouped += '</ul></div>';
    // Open period2
    grouped += '<div class="period2-frame"><ul>';
    inPeriod2 = true;
  }
  grouped += `<li>${entry}</li>`;
});
if (!inPeriod2) {
  grouped += '</ul></div>';
} else {
  grouped += '</ul></div>';
}

// Append summary paragraphs
// Compact view if only one period is used (no 2nd consumption)
if ((secondConsumption || 0) <= 0) {
  grouped += `<p><strong>Verbrauch:</strong> ${mainConsumption.toFixed(3).replace('.', ',')} m³</p>`;
  grouped += `<p><strong>Gewichtssumme:</strong> ${combinedWeightSum.toFixed(3)}</p>`;
  grouped += `<p><strong>Hochrechnung:</strong> ${m3Hochrechnung.toFixed(3).replace('.', ',')} m³</p>`;
} else {
  grouped += `<p>Verbrauch Zeitraum 1 = ${mainConsumption.toFixed(3).replace('.', ',')} m³</p>`;
  grouped += `<p>Verbrauch Zeitraum 2 = ${secondConsumption.toFixed(3).replace('.', ',')} m³</p>`;
  grouped += `<p>Gesamtverbrauch = ${combinedConsumption.toFixed(3).replace('.', ',')} m³</p>`;
  grouped += `<p>Gewichtssumme = ${combinedWeightSum.toFixed(3)}</p>`;
  grouped += `<p>Hochrechnung = ${m3Hochrechnung.toFixed(3).replace('.', ',')} m³</p>`;
}
grouped += `<div class="rechenweg-box"><p style="font-style:italic;">Rechenweg Hochrechnung:</p><ul>`;
grouped += `<li>${combinedConsumption.toFixed(3).replace('.', ',')} ÷ ${combinedWeightSum.toFixed(3)} = ${(combinedConsumption/combinedWeightSum).toFixed(5).replace('.', ',')}</li>`;
grouped += `<li>${(combinedConsumption/combinedWeightSum).toFixed(5).replace('.', ',')} × 100 = ${(combinedConsumption/combinedWeightSum * 100).toFixed(3).replace('.', ',')} m³</li>`;
grouped += `</ul></div>`;

document.getElementById('m3ForecastExplanation').innerHTML = grouped;

    
      calculateKWh();
      document.getElementById("projectedM3Value").innerText = "(" + m3Hochrechnung.toFixed(3).replace(".", ",") + " m³)";
      document.getElementById('m3ConversionList').innerHTML = calculateMonthlyDistribution(
        m3Hochrechnung,
        endDate.getMonth() + 1,
        endMeter,
        endDate.getFullYear()
      );
    
      let monthSelectionListHtml = '';
      let lastYear = null;
      for (let i = 0; i < 12; i++) {
        const dt = new Date(endDate.getFullYear(), endDate.getMonth() + i, 1);
        const year = dt.getFullYear();
        if (year !== lastYear) {
          lastYear = year;
        }
        let month = ((endDate.getMonth() + i) % 12) + 1;
        let monthStr = month.toString().padStart(2, '0');
        let m3ForMonth = (m3Hochrechnung * (typeof currentMonthWeights[monthStr] !== "undefined" ? currentMonthWeights[monthStr] : 0)) / 100;
        monthSelectionListHtml += `<li>
          <input type="checkbox" id="month-${monthStr}" value="${monthStr}" data-m3="${m3ForMonth}"
                 onchange="toggleDayInputs(); processSelectedMonths(); toggleNoSelectionHint(); toggleCost1Hint(); toggleCost1Hint();">
          ${monthNames[monthStr]}: ${m3ForMonth.toFixed(3).replace('.', ',')} m³
          <span class="day-input" id="day-input-${monthStr}">
            <label for="day-${monthStr}">Tag:</label>
            <input type="number" id="day-${monthStr}" min="1" max="31"
                   onblur="validateDayInput('${monthStr}');" oninput="processSelectedMonths();">
          </span>
        </li>`;
      }
      document.getElementById('monthSelectionList').innerHTML = monthSelectionListHtml;
      processSelectedMonths(); toggleNoSelectionHint(); toggleCost1Hint();
    }
  </script><script>
  // Validierung für Rubrik 1b (Zweiter Zeitraum)
  function validateRubrik1b() {
    const errDate = document.getElementById('rubrik1bError');
    const errMeter = document.getElementById('meterError2');
    // Reset messages and difference
    errDate.innerText = ''; errDate.classList.remove('visible');
    errMeter.innerText = ''; errMeter.classList.remove('visible');
    
    // Check if fields are empty
    const d1 = document.getElementById('startDate2').value.trim();
    const d2 = document.getElementById('endDate2').value.trim();
    const m1val = document.getElementById('startMeter2').value.trim();
    const m2val = document.getElementById('endMeter2').value.trim();
    if (!d1 || !d2 || !m1val || !m2val) {
      
  document.getElementById('m3Difference2').innerText = '0,000';
      if (typeof updateMonthWeightList === 'function'){ try{ updateMonthWeightList(); }catch(e){} }
      if (typeof calculate === 'function'){ try{ calculate(); }catch(e){} }
      return;
updateMonthWeightList();
return;
      if (typeof calculate === 'function'){ try{ calculate(); }catch(e){} }
}

    // Date validity and order
    if (isValidDateString(d1) && isValidDateString(d2)) {
      const sd = parseDate(d1);
      const ed = parseDate(d2);
      if (sd> ed) {
        errDate.innerText = 'Das Startdatum darf nicht nach dem Enddatum liegen.';
        errDate.classList.add('visible');
        return;
      }
    }
    // Meter values validity and order
    const m1 = parseFloat(m1val);
    const m2 = parseFloat(m2val);
    if (isNaN(m1) || isNaN(m2)) {
      errMeter.innerText = 'Bitte gültige Zahlen für Zählerstände eingeben.';
      errMeter.classList.add('visible');
      return;
    }
    if (m1> m2) {
      errMeter.innerText = 'Der Startzählerstand darf nicht größer als der Endzählerstand sein.';
      errMeter.classList.add('visible');
      return;
    }
    // All good: compute and display difference
    document.getElementById('m3Difference2').innerText = (m2 - m1).toFixed(3).replace('.', ',');
  }
  </script><script>
// Separater Logikblock NUR für Rubrik 1b
function validateRubrik1b() {
  const errDate = document.getElementById('rubrik1bError');
  const errMeter = document.getElementById('meterError2');
  errDate.innerText = ''; errDate.classList.remove('visible');
  errMeter.innerText = ''; errMeter.classList.remove('visible');
  document.getElementById('m3Difference2').innerText = '0,000';

  const d1 = document.getElementById('startDate2').value.trim();
  const d2 = document.getElementById('endDate2').value.trim();
  const m1val = document.getElementById('startMeter2').value.trim();
  const m2val = document.getElementById('endMeter2').value.trim();

  if (d1 && d2) {
    if (isValidDateString(d1) && isValidDateString(d2)) {
      const sd = parseDate(d1);
      const ed = parseDate(d2);
      if (sd> ed) {
        errDate.innerText = 'Das Startdatum darf nicht nach dem Enddatum liegen.';
        errDate.classList.add('visible');
        
  updateMonthWeightList();
return;
      }
    }
  }

  if (!m1val || !m2val) return;

  const m1 = parseFloat(m1val);
  const m2 = parseFloat(m2val);
  if (isNaN(m1) || isNaN(m2)) {
    errMeter.innerText = 'Bitte gültige Zahlen für Zählerstände eingeben.';
    errMeter.classList.add('visible');
    return;
  }
  if (m1> m2) {
    errMeter.innerText = 'Der Startzählerstand darf nicht größer als der Endzählerstand sein.';
    errMeter.classList.add('visible');
    return;
  }

  document.getElementById('m3Difference2').innerText = (m2 - m1).toFixed(3).replace('.', ',');
  // Automatische Neuberechnung nach Änderungen im 2. Zeitraum
  calculate();
      // Automatisch kWh neu berechnen und Kostenfeld befüllen
      calculateKWh();
    }

function toggleNoSelectionHint() {
  const hint = document.getElementById('noSelectionHint');
  const anyChecked = Array.from(
    document.querySelectorAll('#monthSelectionList input[type="checkbox"]')
  ).some(chk => chk.checked);
  hint.style.display = anyChecked ? 'none' : 'block';
}

function toggleCost1Hint() {
  const hint = document.getElementById('cost1Hint');
  const anyChecked = Array.from(
    document.querySelectorAll('#monthSelectionList input[type="checkbox"]')
  ).some(chk => chk.checked);
  hint.innerText = anyChecked ? '( der ausgewählten Monate )' : '( Gesamtverbrauch für alle 12 Monate )';
}

    function resetAll() {
  // Rubriken 3-7 wieder ausblenden
  ['rubrik3','rubrik4','rubrik5','rubrik6','rubrik7'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
  // Rubrik 5 & 6: Platzhalter setzen
  var projectedM3 = document.getElementById('projectedM3Value');
  if (projectedM3) projectedM3.innerText = "(…)";
  var totalM3El  = document.getElementById('rubrik6TotalM3Value');
  var totalKwhEl = document.getElementById('rubrik6TotalKwhValue');
  if (totalM3El)  totalM3El.innerText  = "(…)";
  if (totalKwhEl) totalKwhEl.innerText = "(…)";
  // Zugehörige Summen/Caches invalidieren
  window.rubrik5MonthlyValues = null;
  window.rubrik5StartReading  = null;
  window.rubrik5EndMonth      = null;
  window.rubrik5EndYear       = null;

    // Hinweistext neben dem Kreis leeren
    var msgEl = document.getElementById('fetchMsg');
    if (msgEl) msgEl.innerText = '';

    
    // Rubrik 5: Custom-Datum-Feld und Anzeigen zurücksetzen
    var cd = document.getElementById('customDateInputRubrik5');
    if (cd) cd.value = '';
    var reading = document.getElementById('customDateReading');
    if (reading) reading.innerText = '';
    var exp = document.getElementById('customDateExplanation');
    if (exp) exp.innerText = '';
    var err = document.getElementById('customDateError');
    if (err) { err.innerText = ''; err.classList.remove('visible'); }
// Manuelles kWh-Eingabefeld zurücksetzen
    document.getElementById('kwhAmountManual').value = '';

    // Felder 'Abschläge von', 'Abschläge bis' und 'Monate Count' (manuell) zurücksetzen
    document.getElementById('fromMonthManual').value = '';
    document.getElementById('toMonthManual').value = '';
    document.getElementById('monthsCountManual').value = '';

    // Felder 'Abschläge von', 'Abschläge bis' und 'Monate Count' zurücksetzen
    document.getElementById('fromMonth').value = '';
    document.getElementById('toMonth').value = '';
    document.getElementById('monthsCount').value = '';

      // Rubrik 1
      document.getElementById('startDate').value = "";
      document.getElementById('endDate').value = "";
      document.getElementById('startMeter').value = "";
      document.getElementById('endMeter').value = "";
      document.getElementById('m3Difference').innerText = "0,000";
      document.getElementById('rubrik1Error').innerText = "";
      document.getElementById('dateWarning').innerText = "";
      document.getElementById('summerWarning').innerText = "";

      // Rubrik 1b
      document.getElementById('startDate2').value = "";
      document.getElementById('endDate2').value = "";
      document.getElementById('startMeter2').value = "";
      document.getElementById('endMeter2').value = "";
      document.getElementById('m3Difference2').innerText = "0,000";
      document.getElementById('winterWarning').innerText = "";
      document.getElementById('winterWarning').classList.remove("visible");
      document.getElementById('zweiterZeitraum').style.display = "none";
      // Buttons in Rubrik 1 und 1b zurücksetzen
      const btn1 = document.getElementById('toggleWeightBtn');
      if (btn1) btn1.innerText = 'Berechnung der Gewichtungen einblenden';
      const btn2 = document.querySelector('#zweiterZeitraum button.rechenweg');
      if (btn2) btn2.innerText = 'Berechnung der Gewichtungen einblenden';
      // Rubrik 2
      const rub2 = document.getElementById('rubrik2');
      if (rub2) rub2.style.display = 'none';
      const wtSelect = document.getElementById('weightTableSelect');
      if (wtSelect) wtSelect.value = 'A';
      const monthList = document.getElementById('monthWeightList');
      if (monthList) monthList.innerHTML = '';
      const wtExp = document.getElementById('monthWeightExplanation');
      if (wtExp) { wtExp.innerHTML = ''; wtExp.classList.remove('visible'); }
      // Rubrik 3
      document.getElementById('m3Forecast').innerText = "";
      document.getElementById('m3ForecastExplanation').innerHTML = "";
      // Rubrik 4
      document.getElementById('kwhConversionResult').innerText = "";
      document.getElementById('kwhCalculationExplanation').innerHTML = "";
      // Rubrik 5
      
      document.getElementById('m3ConversionList').innerHTML = "";
      if (myChart) { myChart.destroy(); myChart = null; }
      // Rubrik 6
      document.getElementById('monthSelectionList').innerHTML = "";
      document.getElementById('partialConsumptionResult').innerHTML = "";
      document.getElementById('monthBlocksContainer').style.display = 'none';
      document.getElementById('kwhAmount').value = "";

      // Rubrik 7
      ['workPrice','costResult','basePrice','installmentResult','monthsCount'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.value = '';
      });
      ['workPriceManual','costResultManual','basePriceManual','installmentResultManual','monthsCountManual'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.value = '';
      });
      document.getElementById('totalSum').innerText = "0,00 €";
      document.getElementById('totalSumManual').innerText = "0,00 €";

      clearResults();
      calculate();
    }

</script><script>
// Hervorhebung der Ergebniswerte in Rubrik 3 nach Rendern

(?:\.\d{3})*(?:,\d+)?\s*m³)/g,
      '$1<span class="result">$2</span>'
    );
    // Wrap ohne m³
    expl.innerHTML = expl.innerHTML.replace(
      /(=\s*)(\d{1,3}(?:\.\d{3})*(?:,\d+)?)(?=\s|<|$)/g,
      '$1<span class="result">$2</span>'
    );
  });
}


// Direkt nach Laden und Umschalten des Rechenwegs ausführen
document.addEventListener('DOMContentLoaded', highlightRubrik3Results);
const origToggle = window.toggleExplanation;
window.toggleExplanation = function(id, btn) {
  origToggle(id, btn);
  if (id === 'm3ForecastExplanation')};
</script><script>
// Fett-Darstellung aller m³-Ergebnisse in Rubrik 3 Aufschlüsselung
(?:\.\d{3})*(?:,\d+)?\s*m³)/g,
    '$1<span class="result">$2</span>'
  );
}
document.addEventListener('DOMContentLoaded', highlightRubrik3Results);
const origToggle = window.toggleExplanation;
window.toggleExplanation = function(id, btn) {
  origToggle(id, btn);
  if (id === 'm3ForecastExplanation') {}
};
</script><script>
document.addEventListener('DOMContentLoaded', function() {
  var btn = document.getElementById('example1');
  btn.addEventListener('click', function() {
    const savedState = saveRubrik6State();
    // Beispiel mit Winter- UND Sommermonaten
        document.getElementById('startDate').value = '12.06.2024';
        document.getElementById('startMeter').value = '1000';
        document.getElementById('endDate').value   = '15.10.2024';
        document.getElementById('endMeter').value  = '1415';
    validateDateInput('startDate','startDateError');
    validateDateInput('endDate','endDateError');
    
        // Reset second period when switching to Beispiel 1
        document.getElementById('zweiterZeitraum').style.display = 'none';
        ['startDate2','startMeter2','endDate2','endMeter2'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('m3Difference2').textContent = '';
calculate();
    restoreRubrik6State(savedState);
  });
});
</script><script>
document.addEventListener('DOMContentLoaded', function() {
  var btn2 = document.getElementById('example2');
  btn2.addEventListener('click', function() {
    const savedState = saveRubrik6State();
    // Zeitraum 1: Sommermonate
    document.getElementById('startDate').value = '12.06.2024';
    document.getElementById('startMeter').value = '1934';
    document.getElementById('endDate').value   = '16.08.2024';
    document.getElementById('endMeter').value  = '2097';
    // Zeitraum 2: Sommer + Winter
    document.getElementById('startDate2').value = '03.08.2023';
    document.getElementById('startMeter2').value = '900';
        document.getElementById('endDate2').value  = '15.04.2024';
    document.getElementById('endMeter2').value  = '1743';
    // Reveal second period section
    document.getElementById('zweiterZeitraum').style.display = 'block';
    // Validate and calculate
    validateDateInput('startDate','startDateError');
    validateDateInput('endDate','endDateError');
    validateDateInput('startDate2','startDate2Error');
    validateDateInput('endDate2','endDate2Error');
    calculate();
    // Validate second period to update m3Difference2 and warnings
    if (typeof validateRubrik1b === 'function') validateRubrik1b();
    restoreRubrik6State(savedState);
  });
});
</script><script>
// Hilfsfunktion: alle Monate zwischen zwei Daten (einschließlich)
function getMonthsBetween(start, end) {
    const months = [];
    let cur = new Date(start.getFullYear(), start.getMonth(), 1);
    while (cur <= end) {
        months.push(cur.getMonth() + 1);
        cur.setMonth(cur.getMonth() + 1);
    }
    return months;
}

// Aktualisiert die Monatsliste in Rubrik 2 mit Überschriften für beide Zeiträume
function updateMonthWeightList() {
    const ul = document.getElementById('monthWeightList');
    ul.innerHTML = '';
    // Zeitraum 1
    const sd1 = parseDate(document.getElementById('startDate').value);
    const ed1 = parseDate(document.getElementById('endDate').value);
    if (isValidDateString(document.getElementById('startDate').value) && isValidDateString(document.getElementById('endDate').value)) {
        ul.insertAdjacentHTML('beforeend', '<li class="year-heading">Zeitraum 1</li>');
        getMonthsBetween(sd1, ed1).forEach(m => {
            const key = String(m).padStart(2, '0');
            ul.insertAdjacentHTML('beforeend',
              `<li>${monthNames[key]}: ${(typeof currentMonthWeights[key] !== "undefined" ? currentMonthWeights[key] : 0)}</li>`
            );
        });
    }
    // Zeitraum 2, falls eingeblendet
    const sec = document.getElementById('zweiterZeitraum');
    if (sec.style.display !== 'none') {
        const sd2 = parseDate(document.getElementById('startDate2').value);
        const ed2 = parseDate(document.getElementById('endDate2').value);
        const m1v = (document.getElementById('startMeter2').value || '').trim();
        const m2v = (document.getElementById('endMeter2').value || '').trim();
        if (isValidDateString(document.getElementById('startDate2').value)
            && isValidDateString(document.getElementById('endDate2').value)
            && m1v !== '' && m2v !== '') {
            ul.insertAdjacentHTML('beforeend', '<li class="year-heading">Zeitraum 2</li>');
            getMonthsBetween(sd2, ed2).forEach(m => {
                const key = String(m).padStart(2, '0');
                ul.insertAdjacentHTML('beforeend',
                  `<li>${monthNames[key]}: ${(typeof currentMonthWeights[key] !== "undefined" ? currentMonthWeights[key] : 0)}</li>`
                );
            });
        }
    }
}

// Override Show-Table button
document.addEventListener('DOMContentLoaded', () => {
    // Beispiel1: nur erster Zeitraum
    document.getElementById('example1').addEventListener('click', () => { document.body.classList.remove('hasPeriod2');
        document.getElementById('zweiterZeitraum').style.display = 'none';
        updateMonthWeightList();
    
    // Dispatch input events to trigger A-basis logic
    ['startDate','startMeter','endDate','endMeter'].forEach(id => {
      const el = document.getElementById(id);
      if(el) el.dispatchEvent(new Event('input'));
    });
});
    // Beispiel2: beide Zeiträume sichtbar
    document.getElementById('example2').addEventListener('click', () => { document.body.classList.add('hasPeriod2');
      const periodTwo = document.getElementById('zweiterZeitraum');
      const rubrik2 = document.getElementById('rubrik2');

      // Rubrik 1b einblenden und Liste aktualisieren
      periodTwo.style.display = 'block';
      updateMonthWeightList();

      
    // Dispatch input events to trigger A-basis logic
    ['startDate','startMeter','endDate','endMeter'].forEach(id => {
      const el = document.getElementById(id);
      if(el) el.dispatchEvent(new Event('input'));
    });
// Button-Text an Sichtbarkeitszustand von Rubrik 2 anpassen
      const isVisible = window.getComputedStyle(rubrik2).display !== 'none';
      const label = isVisible
        ? 'Berechnung der Gewichtungen ausblenden'
        : 'Berechnung der Gewichtungen einblenden';

      document.getElementById('toggleWeightBtn').innerText = label;
      const btn2 = periodTwo.querySelector('button.rechenweg');
      if (btn2) btn2.innerText = label;
    });

    const showBtn = document.getElementById('showStandardTableBtn');
    showBtn.addEventListener('click', () => {
        updateStandardTable();
        updateMonthWeightList();
    });
    const toggleBtn = document.getElementById('toggleWeightBtn');
    toggleBtn.addEventListener('click', updateMonthWeightList);
});
</script><script>
function checkToggleButtonVisibility() {
    const btn = document.getElementById('toggleWeightBtn');
    const z2 = document.getElementById('zweiterZeitraum');
    if (z2 && z2.style.display !== 'none') {
        btn.style.display = 'none';
    } else {
        btn.style.display = '';
    }
}
document.addEventListener('DOMContentLoaded', () => {
    checkToggleButtonVisibility();
    document.getElementById('example1').addEventListener('click', checkToggleButtonVisibility);
    document.getElementById('example2').addEventListener('click', checkToggleButtonVisibility);
    document.getElementById('resetButton').addEventListener('click', () => { document.body.classList.remove('hasPeriod2');
        setTimeout(checkToggleButtonVisibility, 100); // nach Reset-Logik
    });
});
</script><script>
// Handler for custom date input in Rubrik 5
document.addEventListener('DOMContentLoaded', function() {
  var customDate = document.getElementById('customDateInputRubrik5');
  if (!customDate) return;
  
customDate.addEventListener('change', function() {
    
    // Validate: custom date must not be before end date in Rubrik 1
    var endDateInput = document.getElementById('endDate');
    var endDateParts = endDateInput.value.split('.');
    var endDateObj = new Date(parseInt(endDateParts[2],10), parseInt(endDateParts[1],10)-1, parseInt(endDateParts[0],10));
    var customDateObj = new Date(this.value);
    // If custom date equals end date, show the exact end reading
    if (customDateObj.getTime() === endDateObj.getTime()) {
      var formattedDate = this.value.split('-').reverse().join('.');
      document.getElementById('customDateReading').innerText =
        'Geschätzter Zählerstand am ' + formattedDate + ': ' + startReading.toFixed(3).replace('.',',') + ' m³';
      document.getElementById('customDateExplanation').innerText = '';
try{document.getElementById('customDateExplanation').style.display='none';}catch(e){}
      return;
    }

    if (customDateObj < endDateObj) {
        var errSp = document.getElementById('customDateError');
errSp.innerText = 'Datum darf nicht vor dem Enddatum ( Datum 2 in Rubrik 1) liegen.';
errSp.classList.add('visible');
        document.getElementById('customDateReading').innerText = '';
        document.getElementById('customDateExplanation').innerText = '';
try{document.getElementById('customDateExplanation').style.display='none';}catch(e){}
        return;
    } else {
        var errSp = document.getElementById('customDateError');
errSp.innerText = '';
errSp.classList.remove('visible');
    }
    var d = new Date(this.value);
    // If custom date equals end date, show the exact end reading
    var endDateInput = document.getElementById('endDate');
    var parts = endDateInput.value.split('.');
    var endDateObj = new Date(parseInt(parts[2],10), parseInt(parts[1],10)-1, parseInt(parts[0],10));
    if (
      d.getFullYear() === endDateObj.getFullYear() &&
      d.getMonth()    === endDateObj.getMonth()    &&
      d.getDate()     === endDateObj.getDate()
    ) {
      var formattedDate = this.value.split('-').reverse().join('.');
      document.getElementById('customDateReading').innerText =
        'Geschätzter Zählerstand am ' + formattedDate + ': ' + window.rubrik5StartReading.toFixed(3).replace('.',',') + ' m³';
      document.getElementById('customDateExplanation').innerText = '';
try{document.getElementById('customDateExplanation').style.display='none';}catch(e){}
      return;
    }

    var monthlyValues = window.rubrik5MonthlyValues || [];
    var startReading = parseFloat(window.rubrik5StartReading || 0);
    var endMonth = window.rubrik5EndMonth;
    var endYear = window.rubrik5EndYear;
    var cumM3 = 0;
    // calculate months difference
    var yearDiff = d.getFullYear() - endYear;
    var monthDiff = yearDiff * 12 + (d.getMonth() + 1 - endMonth);
    if (monthDiff < 0) monthDiff += 12;
    // sum full months before custom month
    for (var i = 0; i < monthDiff; i++) {
      cumM3 += monthlyValues[i] || 0;
    }
    // prorate for custom month
    var index = monthDiff;
    var fullM3 = monthlyValues[index] || 0;
    var daysInMonth = new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
    var dailyUse = fullM3 / daysInMonth;
    var partialUse;
    if (index === 0) {
      // Sonderfall: erstes Prognosemonat ist zugleich Endmonat aus Rubrik 1.
      // Dann beginnt die Hochrechnung erst am Tag NACH dem Enddatum.
      var endParts2 = document.getElementById('endDate').value.split('.');
      var endDay2 = parseInt(endParts2[0], 10) || 0;
      var deltaDays = d.getDate() - endDay2;
      if (deltaDays < 0) { deltaDays = 0; }
      partialUse = dailyUse * deltaDays;
    } else {
      // spätere Monate: Zählung ab dem 1. des Monats
      partialUse = dailyUse * d.getDate();
    }
    cumM3 += partialUse;
    var projected = startReading + cumM3;
    var formattedDate = this.value.split('-').reverse().join('.');
    document.getElementById('customDateReading').innerText =
      'Geschätzter Zählerstand am ' + formattedDate + ': ' + projected.toFixed(3).replace('.',',') + ' m³';
    // Build explanation text
    var fullSum = cumM3 - partialUse;
    var explanationText = 'Berechnungsweg: Startwert ' + startReading.toFixed(3).replace('.',',') + ' m³';
    explanationText += ' + Volle Monate: ' + fullSum.toFixed(3).replace('.',',') + ' m³';
    explanationText += ' + Teilmonat: ' + partialUse.toFixed(3).replace('.',',') + ' m³';
    explanationText += ' = Gesamtverbrauch: ' + cumM3.toFixed(3).replace('.',',') + ' m³';
    document.getElementById('customDateExplanation').innerText = explanationText;


  
  });
});
</script><script>
// Toggle Rechenweg für Custom-Datum-Projektion
document.addEventListener('DOMContentLoaded', function() {
  var btn = var btn = var btn = document.getElementById('toggleCustomDateExp');
  var expDiv = document.getElementById('customDateExplanation');
  if (!btn || !expDiv) return;
  btn.addEventListener('click', function(){
    if (expDiv.style.display === 'block') {
      expDiv.style.display = 'none';
      btn.innerText = 'Rechenweg anzeigen';
    } else {
      expDiv.style.display = 'block';
      btn.innerText = 'Rechenweg ausblenden';
    }
  });
});
</script><script>
document.addEventListener('DOMContentLoaded', function(){
  var exp = document.getElementById('customDateExplanation');
  if (exp) exp.style.display = 'none';
});
</script><script>
document.addEventListener('DOMContentLoaded', function(){
  var btn = document.getElementById('toggleCustomDateExp');
  var exp = document.getElementById('customDateExplanation');
  var input = document.getElementById('customDateInputRubrik5');
  if (!btn || !exp) return;
  btn.addEventListener('click', function(){
    try{
      // Falls noch kein Rechenweg-Text vorhanden ist, versuche Berechnung anzustoßen
      if (exp.innerText.trim() === '' && input && input.value) {
        input.dispatchEvent(new Event('change', { bubbles: true }));
        // kleine Verzögerung, damit evtl. asynchrone Logik greifen kann
        setTimeout(function(){
          var show = (exp.style.display === '' || exp.style.display === 'none');
          if (exp.innerText.trim() !== '') {
            exp.style.display = show ? 'block' : 'none';
            btn.innerText = show ? 'Rechenweg ausblenden' : 'Rechenweg anzeigen';
          }
        }, 0);
        return;
      }
      var show = (exp.style.display === '' || exp.style.display === 'none');
      exp.style.display = show ? 'block' : 'none';
      btn.innerText = show ? 'Rechenweg ausblenden' : 'Rechenweg anzeigen';
    }catch(e){}
  });
});
</script><style>
.hasPeriod2 #rubrik1Container #toggleWeightBtn {display: none !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#rubrik2b {display: none;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
.example-group {display: none !important;}
body.code-unlocked .example-group {display: block !important;}
#resetCustomDate {margin-left: 0.5em;
    padding: 0.2em 0.4em;
    font-size: 1em;
    vertical-align: middle;
    cursor: pointer;
    background: transparent;
    border: none;}
#resetCustomDate:hover {color: #c00;}
.warning-custom {color: #c00;
    font-size: 0.9em;
    margin-top: 0.5em;
    display: none;}
button[onclick="printAsPDF()"] {font-size: 14px !important;
  padding: 8px 16px !important;}
#toggleCostCalcBtn {font-size: 14px !important;
  background-color: #f0f0f0 !important;
  color: #555 !important;
  border: 1px solid #ccc !important;
  box-shadow: none !important;
  padding: 6px 12px !important;}
*, *::before, *::after {box-sizing: border-box;}
body {background-color: #dcdcdc; margin: 0; padding: 0;}
#container {max-width: 500px; margin: 0 auto; padding: 20px; background-color: #fff;}
#zweiterZeitraum label[for="endDate2"] {margin-top: 2rem;
  display: block;}
#rubrik1Container label[for="endDate"] {margin-top:  2rem;}
#rubrik1Container {padding-bottom: 64px;}
.rubrik1-columns {display: flex; gap: 20px;}
.rubrik1-column, .input-left, .input-right {flex: 1;}
.rubrik1-column h3 {margin-bottom: 10px;}
.vertical-input-group {margin-bottom: 15px;}
.vertical-input-group label {display: block; margin-bottom: 5px; font-weight: bold;}
#zweiterZeitraum {margin-top: 20px; padding: 15px; border: 2px solid #333; border-radius: 5px; background-color: antiquewhite; display: none;}
input[type="text"], input[type="number"], input[type="date"], select {font-size: 15px;
      font-weight: bold;
      width: 100%;
      max-width: 150px;
      padding: 5px;
      border: 2px solid #000;
      background: #eee;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
      text-align: center;
      transition: border-color 0.3s, box-shadow 0.3s, background 0.3s;}
input[type="text"]:hover, input[type="number"]:hover, input[type="date"]:hover {background: #f7f7f7;}
input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus {background: #fff;
      border-color: #007BFF;
      box-shadow: 0 0 8px rgba(0,123,255,0.5);}
.errorMessage, .dateError, .warningMessage {color: red;
      font-size: 0.9em;
      margin-top: 5px;
      display: block;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;}
.errorMessage.visible, .dateError.visible, .warningMessage.visible {opacity: 1;}
button {font-size: 20px;
      padding: 15px 30px;
      margin: 10px 5px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      box-shadow: 0 5px 10px rgba(0,0,0,0.1);}
button:hover {background-color: #0056b3;}
button.rechenweg {font-size: 12px;
      padding: 5px 10px;
      background-color: #f0f0f0;
      color: #333;
      border: 1px solid #ccc;
      border-radius: 3px;
      box-shadow: none;}
button.rechenweg:hover {background-color: #e0e0e0;}
button.resetBtn {font-size: 12px;
      padding: 5px 10px;
      background-color: #f9f9f9;
      color: #555;
      border: 1px solid #ccc;
      border-radius: 3px;
      box-shadow: none;}
button.resetBtn:hover {background-color: #e9e9e9;}
.result {font-weight: bold; margin: 10px 0;}
.explanation {display: none; margin-top: 10px; font-style: italic; color: #333;}
.m3-conversion-item {margin-bottom: 20px;}
.kwh-calculation, .bordered-section {border: 2px solid #333;
      padding: 15px;
      margin-top: 20px;
      border-radius: 5px;
      background-color: antiquewhite;
      position: relative;}
.kwh-calculation {border-color: #007BFF;}
.section-number {position: absolute;
      top: 5px;
      right: 10px;
      font-size: 16px;
      font-weight: bold;
      color: #FF5733;}
.weight-sum {text-align: left;}
.day-input {display: none; margin-left: 10px;}
.highlighted {font-weight: bold; font-size: 16px; color: black;}
.input-group {display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-bottom: 15px;}
.aligned-inputs label {display: block; margin-bottom: 5px;}
.input-row {display: flex; flex-direction: row; gap: 20px; width: 100%;}
.info-icon {display: inline-block;
      font-size: 12px;
      color: #007BFF;
      margin-left: 5px;
      cursor: pointer;
      border: 1px solid #007BFF;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      text-align: center;
      line-height: 14px;}
.info-text {display: none;
      font-size: 0.9em;
      font-style: italic;
      color: #555;
      margin-top: 5px;
      border: 1px solid #ccc;
      padding: 5px;
      border-radius: 3px;
      background-color: #f9f9f9;
      text-align: center;}
#zaehlerstandInfo {display: none;
      font-size: 0.9em;
      font-style: italic;
      color: #555;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      padding: 5px;
      border-radius: 3px;
      background-color: #f9f9f9;
      text-align: center;}
#rubrik7 {border: 2px solid #FF5733;
      padding: 15px;
      background-color: antiquewhite;
      position: relative;
      display: block;
      text-align: left;}
.cost-columns {display: flex; flex-wrap: nowrap; gap: 10px; width: 100%;}
.cost-column-left, .cost-column-right {flex: 1 1 45%;}
.cost-column-left input, .cost-column-right input {width: 100%; max-width: 100%;}
.cost-column-left select, .cost-column-right select {width: 100%; max-width: 150px; font-size: 15px; font-weight: bold;}
.cost-column-left input[type="date"], .cost-column-right input[type="date"], #kwhAmount, #workPrice, #costResult, #kwhAmountManual, #workPriceManual, #costResultManual, #monthsCount, #basePrice, #installmentResult, #monthsCountManual, #basePriceManual, #installmentResultManual {max-width: 150px;}
.input-group label.klein {font-size: 0.8em;}
@media screen and (max-width: 600px) {
    
    #kwhAmount,
    #workPrice,
    #basePrice,
    #monthsCount,
    #kwhAmountManual,
    #workPriceManual,
    #basePriceManual,
    #monthsCountManual {
      width: 150px !important;
      max-width: 150px !important;
    }

    
    #kwhAmount,
    #workPrice,
    #basePrice,
    #monthsCount {
      width: 150px !important;
      max-width: 150px !important;
    }

      h2 { font-size: 1em; }
      .input-group input[type="number"],
      .input-group input[type="text"],
      input[type="date"],
      .cost-column-left select, .cost-column-right select { width: 90px; }
      .input-group label { font-size: 0.8em; }
    }
#showStandardTableBtn {display: block;
      font-size: 12px;
      padding: 5px 10px;
      margin: 10px 0;
      cursor: pointer;
      border: 1px solid #333;
      border-radius: 3px;
      background-color: #333;
      color: #fff;}
#originalWeights {position: absolute;
      top: 5px;
      right: 10px;
      width: 200px;
      background-color: antiquewhite;
      text-align: right;
      padding: 5px;
      border-left: 1px solid #aaa;
      z-index: 1000;
      display: none;}
#rubrik2 h2, .bordered-section h2 {font-size: 1.2em;}
#toggleWeightBtn {font-size: 14px;
      padding: 5px 10px;
      position: absolute;
      bottom: 10px;
      left: 10px;
      background-color: #e0e0e0;
      color: #333;
      border: 1px solid #ccc;
      box-shadow: none;}
#factor-container {margin-left: 90px;}
.highlight-or {font-weight: bold; color: #007BFF; margin-right: 5px;}
#zustandszahl {position: relative; left: -20px;}
#chartContainer {width: 100%;
      height: 200px;
      display: block;}
.month-block {margin-bottom: 15px;}
.dropdowns {margin: 5px 0;}
.dropdowns label {font-size: 0.9em;
      font-weight: normal;
      margin-top: 5px;}
#rubrik7 .cost-column-left input#fromMonth, #rubrik7 .cost-column-left input#toMonth {max-width: 150px;
  width: auto;}
#rubrik2 ul#monthWeightList .year-heading {list-style: none !important; margin-top: 0.5em; font-size: 1.1em; color: #007BFF;}
#rubrik3 .year-heading {margin-top: 0.5em; font-weight: bold; color: #FF5733;}
.bordered-section h1 {font-size: 1.4em;}
.bordered-section h3 {font-size: 1em;}
.section-number {font-size: 0.9em;}
@media (max-width: 600px) and (orientation: landscape) {
    .cost-columns {
      display: flex;
      flex-wrap: wrap;
    }
    .cost-column-left {
      order: 1;
      flex: 1 1 100%;
      max-width: 100%;
    }
    .cost-column-right {
      order: 2;
      flex: 1 1 100%;
      max-width: 100%;
    }
    .cost-column-left input, .cost-column-right input,
    .cost-column-left select, .cost-column-right select {
      width: 100%;
      max-width: none;
    }
  }
.cost-column-left, .cost-column-right {flex: 1 1 100%;
      max-width: 100%;}
.cost-column-left input, .cost-column-right input, .cost-column-left select, .cost-column-right select {width: 100%;
      max-width: none;}
}


    
    .cost-column-left input, .cost-column-right input, .cost-column-left select, .cost-column-right select {width: 150px !important;
      max-width: 150px !important;}
.cost-header-left p, .cost-header-right p {min-height: 2.4em;}
.cost-column-left .input-group label, .cost-column-right .input-group label {min-height: 1.6em;}
.cost-column-right .input-group:nth-of-type(4), .cost-column-right .input-group:nth-of-type(5) {margin-top: 1.6em;}
select:hover {background: #f7f7f7;}
select:focus {background: #fff;
  border-color: #007BFF;
  box-shadow: 0 0 8px rgba(0,123,255,0.5);
  outline: none;}
#m3ForecastExplanation span.result {font-weight: bold;
    color: #d32f2f;
    background-color: #fff3b0;
    padding: 1px 4px;
    border-radius: 3px;}
#m3ForecastExplanation span.result, #m3ForecastExplanation2 span.result {font-weight: bold !important;
  color: #d32f2f;
  background-color: #fff3b0;
  padding: 1px 4px;
  border-radius: 2px;}
#m3ForecastExplanation .result {font-weight: bold !important;
    color: inherit !important;
    background: none !important;}
.date1-wrapper button#example1, .date1-wrapper button#example2 {margin-top: 5px;
  font-size: 12px;
  padding: 5px 10px;}
#rubrik2 select#weightTableSelect {font-size: 12px !important;
  padding: 4px !important;}
#rubrik1Container .button-container button {padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    background-color: transparent;
    border: 1px solid #999;
    border-radius: 0.25rem;
    color: inherit;}
#rubrik1Container .button-container button:hover {background-color: rgba(0,0,0,0.05);}
#rubrik1Container .button-container {margin-top: 2rem !important;
    margin-bottom: 2rem !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
.cost-column-left input#costResult, .cost-column-right input#costResultManual, .cost-column-left input#installmentResult, .cost-column-right input#installmentResultManual {width: 150px !important;
  max-width: 150px !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
.cost-column-left select, .cost-column-right select {width: 150px !important;
  max-width: 150px !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
@media (max-width: 576px) {
  
  label[for="monthsCountManual"],
  #monthsCountManual {
    display: inline-block !important;
    vertical-align: middle !important;
    margin: 0 !important;
  }
}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
@media (max-width: 600px) {
  .cost-column-right label[for="monthsCountManual"],
  .cost-column-right input#monthsCountManual {
    margin-top: -0.5rem !important;
  }
}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
.day-input input[type=number] {width: 50px !important;
      max-width: 50px !important;
      padding: 4px !important;
      font-size: 16px !important;
      -moz-appearance: textfield !important;}
.day-input input[type=number]::-webkit-outer-spin-button, .day-input input[type=number]::-webkit-inner-spin-button {-webkit-appearance: none !important;
      margin: 0 !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#rubrik1Container .button-container {margin-top:  2rem;
    display: flex;
    flex-direction: row;
    gap: 0.5rem;
    align-items: flex-start;
    margin-top:  2rem;
  
    margin-bottom: 2rem;}
@media (max-width: 600px) {
    #rubrik1Container .button-container {
    margin-top:  2rem;
      flex-direction: column;
      width: 100%;
    
    margin-bottom: 2rem;
  }
    #rubrik1Container .date-inputs {
      display: block;
    }
  }
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#rubrik1Container .button-container {margin-top:  2rem;
    display: flex;
    flex-direction: row;
    gap: 0.5rem;
    align-items: flex-start;
    margin-top:  2rem;
  
    margin-bottom: 2rem;}
#rubrik1Container .button-container button {display: block;
    margin: 0;}
@media (max-width: 600px) {
    #rubrik1Container .button-container {
    margin-top:  2rem;
      flex-direction: column;
      width: 100%;
    
    margin-bottom: 2rem;
  }
    #rubrik1Container .date-inputs {
      display: block;
    }
  }
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
.example-group {display: inline-block; text-align: center; margin-right: 1em;}
.example-description {margin: 0.25em 0; font-size: 0.9em;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#rubrik7 .cost-column-right .input-group:nth-of-type(4) label {position: relative;
  top: -0.6em;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#rubrik7 .cost-column-right .input-group:nth-of-type(4), #rubrik7 .cost-column-right .input-group:nth-of-type(5) {margin-top: 0 !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
button.rechenweg {display: none !important;}
body.code-unlocked button.rechenweg {display: inline-block !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#secretCodeInput {width: 30px !important;
  border: none !important;
  background: transparent !important;
  opacity: 0.2 !important;
  font-size: 0.75em !important;}
#secretCodeInput:focus {opacity: 1 !important;
  outline: none !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#toggleCustomDateExp {display: inline-block !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#toggleCustomDateExp {display: none !important;}
body.code-unlocked #toggleCustomDateExp {display: inline-block !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#detailedTable {overflow-x: auto;
    max-width: 100%;}
#detailedTable table {width: 100%;
    border-collapse: collapse;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
.selected-row {background-color: #def;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#rubrik3, #rubrik4, #rubrik5, #rubrik6, #rubrik7 {display: none;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
.cost-column-left input, .cost-column-right input, .cost-column-left select, .cost-column-right select {width: 150px !important;
  max-width: 150px !important;
  font-size: 14px;
  padding: 5px;
  box-sizing: border-box;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#monthsCount, #monthsCountManual {width: 150px !important;
  max-width: 150px !important;
  font-size: 14px;
  padding: 5px;
  box-sizing: border-box;
  height: 30px;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#rubrik7 .cost-column-right .input-group:nth-of-type(4) label {position: static !important;
  top: auto !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#monthsCount, #monthsCountManual {padding-top: 6px !important;
  padding-bottom: 6px !important;
  line-height: 1.2 !important;
  height: 32px !important;
  vertical-align: middle !important;}
#rubrik7 .cost-column-left .input-group label, #rubrik7 .cost-column-right .input-group label {line-height: 1.2 !important;
  vertical-align: middle !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#monthsCount, #monthsCountManual {height: 36px !important;
  padding: 6px 10px !important;
  font-size: 16px !important;
  line-height: 1.2 !important;
  margin-top: 0 !important;
  vertical-align: middle !important;}
#rubrik7 .input-group label {display: inline-block;
  margin-bottom: 6px !important;
  font-size: 15px;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#rubrik7 .input-group {display: flex;
  flex-direction: column;
  justify-content: flex-start;}
#monthsCount, #monthsCountManual {height: 34px !important;
  padding: 6px 10px !important;
  font-size: 16px;
  margin: 0 !important;
  box-sizing: border-box;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#rubrik7 .cost-column-right .input-group:nth-of-type(4), #rubrik7 .cost-column-right .input-group:nth-of-type(5) {margin-top: 0 !important;}
#rubrik7 .input-group {margin-bottom: 10px;}
#monthsCount, #monthsCountManual {height: 34px;
  padding: 6px 10px;
  font-size: 16px;
  margin: 0;
  box-sizing: border-box;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#rubrik7 .cost-column-right .input-group:nth-of-type(4), #rubrik7 .cost-column-right .input-group:nth-of-type(5), #rubrik7 .cost-column-left .input-group:nth-of-type(4), #rubrik7 .cost-column-left .input-group:nth-of-type(5) {margin-top: 0 !important;}
#rubrik7 .cost-column-left .input-group, #rubrik7 .cost-column-right .input-group {margin-bottom: 10px !important;}
#monthsCount, #monthsCountManual, #installmentResult, #installmentResultManual {height: 34px !important;
  padding: 6px 10px !important;
  font-size: 16px;
  margin: 0 !important;
  box-sizing: border-box;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
.gas-meter-input {font-family: 'VT323', monospace;
      font-size: 20px !important;
      color: #000 !important;
      background: #000;
      border: 4px inset #333;
      border-radius: 8px;
      width: 200px;
      padding: 0.2em 0.5em;
      text-align: center;
      letter-spacing: 0.1em;
      box-shadow: 0 0 10px rgba(0,255,0,0.5);}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#tbl, #detailedTable table {width: 100% !important;
    table-layout: fixed !important;}
#tbl th, #tbl td, #detailedTable th, #detailedTable td {overflow-wrap: break-word;
    word-wrap: break-word;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#tbl td, #tbl th, #detailedTable td, #detailedTable th {white-space: nowrap !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
ul {list-style: none !important;
    margin: 0;
    padding-left: 0;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
ul, li {list-style: none !important;
    margin: 0 !important;
    padding: 0 !important;}
li::marker {content: none !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#m3ForecastExplanation > strong {display: block;
  margin-bottom: 1em;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#m3ForecastExplanation .sum-highlight {font-weight: normal !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
.period1-frame, .period2-frame {border: 2px solid #888;
  padding: 0.5em;
  margin-bottom: 1em;
  border-radius: 4px;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
.weight-frame {border: 2px solid #666;
    padding: 0.5em;
    margin-bottom: 1em;
    border-radius: 4px;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#rubrik3 .weight-frame {border: none !important;
  padding: 0 !important;
  margin: 0 !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#rubrik3 .weight-frame {border: none !important;
  padding: 0 !important;
  margin: 0 !important;}
#rubrik3 .period1-frame, #rubrik3 .period2-frame {border: 2px solid #888 !important;
  padding: 0.5em !important;
  margin-bottom: 1em !important;
  border-radius: 4px !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
#rubrik3 .weight-frame {border: none !important;
  padding: 0 !important;
  margin: 0 !important;}
#rubrik3 .period1-frame, #rubrik3 .period2-frame {border: 2px solid #888 !important;
  padding: 0.5em !important;
  margin-bottom: 1em !important;
  border-radius: 4px !important;
  display: block !important;}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style><style>
@keyframes pulse{
  0%,100%{opacity:1;transform:scale(1);}
  50%   {opacity:.6;transform:scale(1.03);}
}
#mainDataHint {animation:pulse 1.8s ease-in-out infinite;}
#mainDataHint.stop {animation:none;
  opacity:0;
  transition:opacity .4s;}
@media (prefers-reduced-motion: reduce){
  #mainDataHint{animation:none!important}
}
</style><style>
#rubrik2 .rub2b-fixed-btn {position: absolute; right: 8px; bottom: 8px; z-index: 9999; pointer-events: auto;}
#rubrik2 #toggleRubrik2bBtn {font-size:10px; padding:2px 6px; opacity:0.8;}
</style><style>
#rubrik2 .weight-btn-row {display: flex;
  gap: 8px;
  margin-bottom: 10px;
  flex-wrap: wrap;}
#rubrik2 .weight-btn-row > button {flex: 1 1 33%;
  min-width: 161px;}
@media (max-width: 600px) {
  #rubrik2 label[for="weightTableSelect"] {
    display: block;
    margin-bottom: 6px;
  }
  #rubrik2 select#weightTableSelect {
    width: 100% !important;
    max-width: 100% !important;
  }
  #rubrik2 .weight-btn-row {
    flex-direction: column;
  }
  #rubrik2 .weight-btn-row > button {
    width: 100%;
    min-width: 0;
    font-size: 14px;
    padding: 10px;
  }
}
</style><style>
@media (min-width: 601px) and (max-width: 900px) {
  #rubrik2 .weight-btn-row { justify-content: space-between; }
  #rubrik2 .weight-btn-row > button {
    flex: 0 1 calc(50% - 8px);
    max-width: calc(50% - 8px);
  }
  
  #rubrik2 .weight-btn-row > button:last-child {
    margin-left: auto;
    margin-right: auto;
  }
}
</style><style id="fix-weights-sidepanel-css">
#originalWeights {position:absolute; top:5px; right:10px; width:260px; max-height:80vh;
  overflow:auto; background:antiquewhite; border-left:1px solid #aaa;
  padding:8px 10px; z-index:1000; display:none; box-shadow:0 2px 10px rgba(0,0,0,.15);}
body.weights-panel-open #container {margin-right:280px;}
@media (max-width:700px){
  #originalWeights{ position:static; width:100%; max-height:none; box-shadow:none; }
  body.weights-panel-open #container{ margin-right:0; }
}
</style><style id="fix-weights-sidepanel-css-v2">
#originalWeights h4 {font-weight:bold;}
</style><style id="summer-warning-css-override">
body.second-period-ready #summerWarning {display: none !important;}
</style><style id="toggle-rubrik1b-css">
#toggleRubrik1bBtn {display: inline-block;
  margin-top: 10px;
  padding: 5px 10px;
  background-color: #e0e0e0;
  color: #000;
  border: 1px solid #bbb;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9em;}
#toggleRubrik1bBtn:hover {background-color: #c8c8c8;}
</style><style id="fix-toggle-rubrik1b">
#toggleRubrik1bBtn { display: none !important; }
body.summeronly #toggleRubrik1bBtn { display: inline-block !important; }
</style><style id="fix-secondperiod-open">
body.secondperiod-open #zweiterZeitraum { display: block !important; }
</style><style id="fx-rubrik1b-flash-css-v2">
#zweiterZeitraum { position: relative; }
#zweiterZeitraum.fx-flash {
  animation: rubrik1bFlash 900ms ease-out;
}
@keyframes rubrik1bFlash {
  0%   { box-shadow: inset 0 0 0 3px #ffd54f, 0 0 12px rgba(255,195,7,0.8); background-color: #fff3cd; }
  40%  { box-shadow: inset 0 0 0 2px #ffe082, 0 0 8px rgba(255,193,7,0.5); background-color: #fff8e1; }
  100% { box-shadow: none; background-color: transparent; }
}
</style><style id="rubrik5-yearheadings-css">
#rubrik5 #m3ConversionList .year-heading{
  margin: 8px 0 4px;
  padding-top: 6px;
  font-weight: 700;
  border-top: 1px dashed #bbb;
  color: #333;
}
</style><style id="rubrik5-monthstyle-css">
#rubrik5 #m3ConversionList li strong {
  font-weight: 700;            /* deutlich fetter für Monatsnamen */
}
#rubrik5 #m3ConversionList li .reading-strong {
  font-weight: 600;            /* Zählerstands-Zahl leicht fetter */
}
#rubrik5 #m3ConversionList li {
  font-size: 1.08em;           /* etwas größer als zuvor */
}
</style><style id="rubrik1b-inline-hint-css">
#rubrik1b-inline-hint {
  display: block;
  font-size: 0.9em;
  color: #555;
  margin-top: 6px;
  font-style: italic;
}
</style><style id="rubrik1-verbrauch-hinweis-css">
#rubrik1Container .verbrauch-hinweis {
  display: block;
  font-size: 0.9em;
  color: #555;
  margin-top: 6px;
  font-style: italic;
  border: 1px solid #ddd;
  background: #f9f9f9;
  padding: 6px 8px;
  border-radius: 3px;
}
</style><style id="rb1-inline-info-css">
#rubrik1Container .rb1-inline-wrap{
  position: relative;
  display: inline-block;
  margin-left: 6px;
  vertical-align: middle;
}
#rubrik1Container .rb1-inline-info{
  cursor:pointer;
  user-select:none;
  font-size: 0.95em;
  line-height:1;
  color:#444;
  display:inline-block;
}
#rubrik1Container .rb1-inline-info:focus{ outline: 2px solid #bbb; outline-offset:2px; border-radius: 3px; }
#rubrik1Container .rb1-info-popover{
  position:absolute;
  top: -2px;          /* leicht oberhalb ausrichten */
  left: 22px;         /* direkt rechts neben dem Icon */
  max-width: 360px;
  padding:8px 10px;
  background:#f6f6f6;
  border:1px solid #ddd;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  border-radius:6px;
  font-size:0.92em;
  color:#333;
  z-index: 100;
  display:none;
}
#rubrik1Container .rb1-info-popover.show{ display:block; }
</style><style id="rb1b-inline-info-css">
#rubrik1b, #rubrik1bContainer, #zweiterZeitraum, #rubrik1b-container { position: relative; }
#rubrik1b .rb1b-inline-wrap,
#rubrik1bContainer .rb1b-inline-wrap,
#zweiterZeitraum .rb1b-inline-wrap,
#rubrik1b-container .rb1b-inline-wrap{
  position: relative;
  display: inline-block;
  margin-left: 6px;
  vertical-align: middle;
}
#rubrik1b .rb1b-inline-info,
#rubrik1bContainer .rb1b-inline-info,
#zweiterZeitraum .rb1b-inline-info,
#rubrik1b-container .rb1b-inline-info{
  cursor:pointer;
  user-select:none;
  font-size: 0.95em;
  line-height:1;
  color:#444;
  display:inline-block;
}
#rubrik1b .rb1b-inline-info:focus,
#rubrik1bContainer .rb1b-inline-info:focus,
#zweiterZeitraum .rb1b-inline-info:focus,
#rubrik1b-container .rb1b-inline-info:focus{ outline: 2px solid #bbb; outline-offset:2px; border-radius: 3px; }
#rubrik1b .rb1b-info-popover,
#rubrik1bContainer .rb1b-info-popover,
#zweiterZeitraum .rb1b-info-popover,
#rubrik1b-container .rb1b-info-popover{
  position:absolute;
  top: -2px;
  left: 22px;
  max-width: 360px;
  padding:8px 10px;
  background:#f6f6f6;
  border:1px solid #ddd;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  border-radius:6px;
  font-size:0.92em;
  color:#333;
  z-index: 100;
  display:none;
}
#rubrik1b .rb1b-info-popover.show,
#rubrik1bContainer .rb1b-info-popover.show,
#zweiterZeitraum .rb1b-info-popover.show,
#rubrik1b-container .rb1b-info-popover.show{ display:block; }
</style><style>#zweiterZeitraum #rubrik1b-inline-hint{display:none!important}</style><style id="infoicons-scoped">
/* Nur Optik der Info-Icons ändern – ohne andere Styles zu berühren */
#rubrik1Container .rb1-inline-wrap .rb1-inline-info,
#rubrik1b .rb1b-inline-wrap .rb1b-inline-info,
#rubrik1b .rb1b-inline-wrap .rb1b-inline-info-top {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background-color: #007BFF;
  color: #fff;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  margin-left: 6px;
  line-height: 1;
  text-align: center;
  vertical-align: middle;
  transition: background-color 0.3s, transform 0.2s;
}
#rubrik1Container .rb1-inline-wrap .rb1-inline-info:hover,
#rubrik1b .rb1b-inline-wrap .rb1b-inline-info:hover,
#rubrik1b .rb1b-inline-wrap .rb1b-inline-info-top:hover {
  background-color: #0056b3;
  transform: scale(1.1);
}
</style><style id="infoicons-rubrik1b-top">
/* Rubrik 1b (Zweiter Zeitraum): oberes Info-Icon (class="info-icon") im gleichen Stil wie Rubrik 1 */
#zweiterZeitraum .info-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background-color: #007BFF;
  color: #fff;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  margin-left: 6px;
  line-height: 1;
  text-align: center;
  vertical-align: middle;
  transition: background-color 0.3s, transform 0.2s;
}
#zweiterZeitraum .info-icon:hover {
  background-color: #0056b3;
  transform: scale(1.1);
}
</style><style id="infoicons-rubrik1b-field">
/* Rubrik 1b: Info-Icon neben "Gaszählerstand Datum 1" angleichen */
#zweiterZeitraum .rb1b-inline-info,
#rubrik1b .rb1b-inline-info,
#rubrik1bContainer .rb1b-inline-info,
#rubrik1b-container .rb1b-inline-info {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background-color: #007BFF;
  color: #fff;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  margin-left: 6px;
  line-height: 1;
  text-align: center;
  vertical-align: middle;
  transition: background-color 0.3s, transform 0.2s;
}
#zweiterZeitraum .rb1b-inline-info:hover,
#rubrik1b .rb1b-inline-info:hover,
#rubrik1bContainer .rb1b-inline-info:hover,
#rubrik1b-container .rb1b-inline-info:hover {
  background-color: #0056b3;
  transform: scale(1.1);
}
</style><style id="infoicons-unify-look">
/* Gleicher Look für beide Icons in Rubrik 1b (oben + neben Feld) */
#zweiterZeitraum .info-icon,
#zweiterZeitraum .rb1b-inline-info {
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  width: 18px !important;
  height: 18px !important;
  border-radius: 50% !important;
  background-color: #007BFF !important;
  color: #fff !important;
  font-size: 14px !important;
  font-weight: bold !important;
  line-height: 1 !important;
  margin-left: 6px !important;
  text-align: center !important;
  vertical-align: middle !important;
  border: none !important;
  box-shadow: none !important;
  padding: 0 !important;
}
#zweiterZeitraum .info-icon:hover,
#zweiterZeitraum .rb1b-inline-info:hover {
  background-color: #0056b3 !important;
  transform: scale(1.1);
}
</style><style id="infoicons-rubrik4-scoped">
/* Rubrik 4: Info-Icons als blauer Kreis mit weißem "i" (wie Rubrik 1/1b) */
#rubrik4 .info-icon,
#rubrik4 .rb4-inline-info {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background-color: #007BFF;
  color: #fff;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  margin-left: 6px;
  line-height: 1;
  text-align: center;
  vertical-align: middle;
  transition: background-color 0.3s, transform 0.2s;
}
#rubrik4 .info-icon:hover,
#rubrik4 .rb4-inline-info:hover {
  background-color: #0056b3;
  transform: scale(1.1);
}
</style><style id="hide-inline-dwd">
/* Verhindert die doppelte Anzeige: Inline-Darstellung der Tabelle DWD ausblenden */
#originalWeightsB { display: none !important; }
</style><style>
.rechenweg-box { border: 1px solid #ccc; border-radius: 6px; padding: 8px 12px; margin-top: 8px; }
.rechenweg-box p {
  margin: 4px 0;
}
</style><style id="fix-plz-info-css">
#rb1PLZInfoPopover {
  font-weight: normal !important;
}
</style><style id="fix-a-info-css">
#rb1TableAInfoPopover {
  font-weight: normal !important;
  font-size: 0.9em !important;
  font-style: italic !important;
}
</style><style>
body {font-family:Arial,Helvetica,sans-serif;max-width:800px;margin:0 auto;padding:18px;}
h1 {font-size:1.6rem;margin-top:0}
label {display:inline-block;margin:6px 0}
input[type=text], input[type=number] {padding:4px 6px;font-size:1rem;margin-right:6px;width:120px}
button {padding:6px 16px;font-size:1rem;cursor:pointer;margin-top:10px}
table {border-collapse:collapse;width:100%;margin-top:14px}
th, td {border:1px solid #ccc;padding:6px 4px;text-align:right}
th:first-child, td:first-child {text-align:left}
tfoot th {background:#f3f3f3;font-weight:bold}
.hint {font-size:0.9rem;color:#555}
.error {color:#c00;font-weight:bold;padding:6px 0}
#m3ConversionList li {margin-bottom: 12px;}
#m3ConversionList {list-style: none !important;
  padding-left: 0 !important;}
#m3ConversionList li {display: block !important;
  margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li {margin-bottom: 20px !important;
  padding-bottom: 8px !important;
  border-bottom: 1px dashed #aaa !important;}
#m3ConversionList li span.zaehlerstand {display: block !important;
  font-size: 0.9em !important;
  color: #555 !important;
  margin-top: 4px !important;}
</style>
<script>
(function(){
  function inputsReady(){
  const ids = ['startDate','startMeter','endDate','endMeter'];
  const baseOk = !!document.querySelector('input[name="weightBasis"]:checked');
  return baseOk && ids.every(id => {
    const el = document.getElementById(id);
    return el && String(el.value).trim() !== '';
  });
}
);
  }
  window.updateSectionVisibility = function(){
    var ready = inputsReady();
    ['rubrik2','rubrik3','rubrik4','rubrik5','rubrik6','rubrik7'].forEach(function(id){
      var el = document.getElementById(id);
      if (!el) return;
      el.style.display = ready ? (id==='rubrik2' && el.style.display ? el.style.display : 'block') : 'none';
      if (!ready) {
        // also clear charts/lists if hidden
        var list = document.getElementById('m3ConversionList');
        if (list) list.innerHTML='';
      }
    });
  };
  document.addEventListener('DOMContentLoaded', function(){
    ['startDate','startMeter','endDate','endMeter'].forEach(function(id){
      var el = document.getElementById(id);
      if (el){
        el.addEventListener('input', window.updateSectionVisibility);
        el.addEventListener('change', window.updateSectionVisibility);
      }
    });
    // Also react to weightBasis radio changes
    document.querySelectorAll('input[name="weightBasis"]').forEach(function(r){
      r.addEventListener('change', window.updateSectionVisibility);
    });
    window.updateSectionVisibility();
  });
})();
</script>

<script>
(function(){
  function updateFetchButtonVisibility(){
    var btn = document.getElementById('fetchWeightsBtn');
    if (!btn) return;
    var rb = document.querySelector('input[name="weightBasis"]:checked');
    var isPlz = rb && (rb.value.toLowerCase() === 'plz');
    btn.style.display = isPlz ? 'inline-block' : 'none';
  }
  document.addEventListener('DOMContentLoaded', function(){
    // react to weight basis changes
    document.querySelectorAll('input[name="weightBasis"]').forEach(function(r){
      r.addEventListener('change', updateFetchButtonVisibility);
    });
    updateFetchButtonVisibility();
  });
  // Expose in case other code wants to sync
  window.updateFetchButtonVisibility = updateFetchButtonVisibility;
})();
</script>


<script id="rubrik4-fields-toggle-js">
document.addEventListener('DOMContentLoaded', function(){
  var cb = document.getElementById('useCustomFactors');
  var fields = document.getElementById('rubrik4-fields');
  if(!cb || !fields) return;
  function update(){
    fields.style.display = cb.checked ? 'block' : 'none';
  }
  cb.addEventListener('change', update);
  update(); // initial
});
</script>

<script id="rubrik4-hint-js-factor">
(function(){
  function parseDE(v){
    if(v==null) return NaN;
    v = String(v).trim().replace(/\./g,'').replace(',', '.');
    var m = v.match(/-?\d+(?:\.\d+)?/);
    return m ? parseFloat(m[0]) : NaN;
  }
  function ownValuesValid(){
    var bw = document.getElementById('brennwert');
    var zz = document.getElementById('zustandszahl');
    var fac = document.getElementById('factor');
    var bwV = parseDE(bw && bw.value);
    var zzV = parseDE(zz && zz.value);
    var facV = parseDE(fac && fac.value);
    // valid if both bw & zz >0 OR factor >0
    if(isFinite(bwV) && bwV > 0 && isFinite(zzV) && zzV > 0) return true;
    if(isFinite(facV) && facV > 0) return true;
    return false;
  }
  function updateR4Hint(){
    var cb = document.getElementById('useCustomFactors');
    var hint = document.getElementById('rubrik4-hint');
    var std = document.getElementById('rubrik4Hint');
    if(!hint) return;
    var enabled = !!(cb && cb.checked);
    if(!enabled){
      if(std){ std.style.display = 'block'; std.style.color = '#555'; std.style.fontStyle = 'italic'; }
      hint.style.display = 'none';
      return;
    }
    if(std){ std.style.display = 'none'; }
    if(ownValuesValid()){
      hint.textContent = 'Eigene Werte aktiv.';
      hint.style.display = 'block';
      hint.style.color = '#000';
      hint.style.fontStyle = 'normal';
    } else {
      hint.textContent = 'Bitte Brennwert und Zustandszahl eingeben, sonst werden weiterhin Standardwerte genutzt.';
      hint.style.display = 'block';
      hint.style.color = '#555';
      hint.style.fontStyle = 'italic';
    }
  }
  function hook(id, evts, fn){
    var el = document.getElementById(id);
    if(!el) return;
    evts.forEach(function(e){ el.addEventListener(e, fn); });
  }
  document.addEventListener('DOMContentLoaded', function(){
    updateR4Hint();
    hook('useCustomFactors', ['change','click'], updateR4Hint);
    hook('brennwert', ['input','change','blur'], updateR4Hint);
    hook('zustandszahl', ['input','change','blur'], updateR4Hint);
    hook('factor', ['input','change','blur'], updateR4Hint);
  });
  window.updateRubrik4HintFactor = updateR4Hint;
})();
</script>


<script id="refreshChartFromR5-helper">
(function(){
  window.refreshChartFromRubrik5 = function(){
    try{
      // Only real month rows, not year headings or other lis
      var items = document.querySelectorAll('#m3ConversionList li[data-m3]');
      if(!items || !items.length){ return; }
      var labels = [];
      var data = [];
      items.forEach(function(li){
        // Label: prefer data-month; else any strong text inside li
        var label = li.getAttribute('data-month');
        if(!label){
          var strong = li.querySelector('strong');
          label = strong ? strong.textContent.trim() : (li.textContent.trim() || '');
        }
        // Value: prefer [data-m3] on li or inner span with [data-m3] or class .m3-value
        var raw = li.getAttribute('data-m3');
        if(!raw){
          var valEl = li.querySelector('[data-m3], .m3-value');
          raw = valEl ? (valEl.getAttribute('data-m3') || valEl.textContent) : '0';
        }
        var _str = String(raw).trim();
        if(_str.indexOf(',')>=0 && _str.indexOf('.')>=0){ _str = _str.replace(/\./g,'').replace(',', '.'); }
        else if(_str.indexOf(',')>=0){ _str = _str.replace(',', '.'); }
        var val = parseFloat(_str) || 0;
        labels.push(label);
        data.push(val);
      });
      if(typeof updateChart === 'function') updateChart(labels, data);
    }catch(e){ /* noop */ }
  };
})();
</script>


<script id="rubrik4-clear-on-uncheck">
document.addEventListener('DOMContentLoaded', function(){
  var cb = document.getElementById('useCustomFactors');
  if(!cb) return;
  function clearIfUnchecked(){
    if(!cb.checked){
      var ids = ['brennwert','zustandszahl','factor'];
      ids.forEach(function(id){
        var el = document.getElementById(id);
        if(el){
          el.value = '';
          // remove any visual state classes
          el.classList && (el.className = el.className
            .replace(/\binvalid\b/g,'')
            .replace(/\bwarning\b/g,''));
        }
      });
      // hide dynamic hint line under checkbox
      var dyn = document.getElementById('rubrik4-hint');
      if(dyn){ dyn.style.display = 'none'; }
      // show standard hint again (if present)
      var std = document.getElementById('rubrik4Hint');
      if(std){ std.style.display = 'block'; std.style.color='#555'; std.style.fontStyle='italic'; }
      // re-run any validators/hints
      try{ if(typeof updateR4Hint==='function') updateR4Hint(); }catch(e){}
      try{ if(typeof validateBrennwertFresh==='function') validateBrennwertFresh('toggle'); }catch(e){}
      try{ if(typeof validateZustandszahlFresh==='function') validateZustandszahlFresh('toggle'); }catch(e){}
      try{ if(typeof validateBrennwertClean==='function') validateBrennwertClean('toggle'); }catch(e){}
      try{ if(typeof validateZustandszahlClean==='function') validateZustandszahlClean('toggle'); }catch(e){}
      // trigger recalculation so that standardwerte are applied
      try{ if(typeof calculateKWh==='function') calculateKWh(); }catch(e){}
      try{ if(typeof processSelectedMonths==='function') processSelectedMonths(); }catch(e){}
      try{ if(typeof refreshChartFromRubrik5==='function') refreshChartFromRubrik5(); }catch(e){}
    }
  }
  cb.addEventListener('change', clearIfUnchecked);
  // also enforce once at load in case the page starts unchecked
  clearIfUnchecked();
});
</script>
<script>
function printRubrik(rubrikId) {
  try {
    var sections = document.querySelectorAll('#rubrik1Container, #rubrik2, #rubrik3, #rubrik4, #rubrik5, #rubrik6, #rubrik7');
    var originalDisplays = [];
    for (var i = 0; i < sections.length; i++) {
      originalDisplays.push(sections[i].style.display);
      if (sections[i].id === rubrikId) {
        sections[i].style.display = 'block';
      } else {
        sections[i].style.display = 'none';
      }
    }
    window.print();
    for (var j = 0; j < sections.length; j++) {
      sections[j].style.display = originalDisplays[j] || '';
    }
  } catch (e) {
    console.error(e);
    window.print();
  }
}
</script>

